
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>grafs_e.app &#8212; GRAFS-E 01/02/25 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=390ba95b"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/grafs_e/app';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">GRAFS-E 01/02/25 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../grafs_e.html" class="nav-link">grafs_e</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">grafs_e.app</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for grafs_e.app</h1><div class="highlight"><pre>
<span></span><span class="c1"># %%</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">importlib.metadata</span><span class="w"> </span><span class="kn">import</span> <span class="n">version</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">branca</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">folium</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.cm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cm</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcolors</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">streamlit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">st</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.subplots</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">streamlit_folium</span><span class="w"> </span><span class="kn">import</span> <span class="n">st_folium</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">grafs_e.donnees</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grafs_e.N_class</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">NitrogenFlowModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grafs_e.prospective</span><span class="w"> </span><span class="kn">import</span> <span class="n">NitrogenFlowModel_prospect</span><span class="p">,</span> <span class="n">scenario</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grafs_e.sankey</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">streamlit_sankey_app</span><span class="p">,</span>
    <span class="n">streamlit_sankey_fertilization</span><span class="p">,</span>
    <span class="n">streamlit_sankey_food_flows</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grafs_e.system_flows_svg</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapping_svg_fluxes</span><span class="p">,</span> <span class="n">streamlit_sankey_systemic_flows_svg</span>

<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>

<span class="n">geojson_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;contour-GRAFS.geojson&quot;</span><span class="p">)</span>
<span class="n">image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;metabolism.png&quot;</span><span class="p">)</span>
<span class="n">icon_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">,</span> <span class="s2">&quot;logo.jpg&quot;</span><span class="p">)</span>

<span class="c1"># Déterminer le chemin du fichier de config Streamlit</span>
<span class="n">config_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/.streamlit&quot;</span><span class="p">)</span>
<span class="n">config_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_dir</span><span class="p">,</span> <span class="s2">&quot;config.toml&quot;</span><span class="p">)</span>

<span class="c1"># Vérifier si le dossier ~/.streamlit existe, sinon le créer</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config_dir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">config_dir</span><span class="p">)</span>

<span class="c1"># Écrire ou modifier le fichier config.toml pour imposer le dark mode</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">config_file</span><span class="p">:</span>
    <span class="n">config_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[theme]</span><span class="se">\n</span><span class="s2">base=&#39;dark&#39;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">st</span><span class="o">.</span><span class="n">set_page_config</span><span class="p">(</span><span class="n">page_title</span><span class="o">=</span><span class="s2">&quot;GRAFS-E App&quot;</span><span class="p">,</span> <span class="n">page_icon</span><span class="o">=</span><span class="n">icon_path</span><span class="p">,</span> <span class="n">layout</span><span class="o">=</span><span class="s2">&quot;wide&quot;</span><span class="p">)</span>  <span class="c1"># , layout=&quot;wide&quot;)</span>


<span class="c1"># Charger les données</span>
<div class="viewcode-block" id="load_data">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.load_data">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">load_data</span><span class="p">():</span>
    <span class="c1"># votre DataLoader (ou équivalent)</span>
    <span class="k">return</span> <span class="n">DataLoader</span><span class="p">()</span></div>



<span class="k">if</span> <span class="s2">&quot;data&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">()</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>

<span class="c1"># Initialisation de l&#39;état des variables</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">{</span>
    <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;year_run&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;year_pros&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;selected_region&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;selected_region_run&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;selected_region_pros&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;prod_func&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;heatmap_fig_pros&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;pkl_blob&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># ← binaire pour download</span>
    <span class="s2">&quot;load_error&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="c1"># état provisoire (Excel upload)</span>
    <span class="s2">&quot;prep_name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;prep_region&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;prep_year&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;prep_func&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;prep_xlsx_path&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s2">&quot;excel_uploaded_done&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;orig&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<span class="c1"># %%</span>
<span class="c1"># Initialisation de l&#39;interface Streamlit</span>
<span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;GRAFS-E&quot;</span><span class="p">)</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="n">version</span><span class="p">(</span><span class="s2">&quot;grafs_e&quot;</span><span class="p">)</span>
<span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;📦 GRAFS-E version: </span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;Contact: Adrien Fauste-Gay, adrien.fauste-gay@univ-grenoble-alpes.fr&quot;</span><span class="p">)</span>
<span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Nitrogen Flow Simulation Model: A Territorial Ecology Approach&quot;</span><span class="p">)</span>

<span class="c1"># # 🔹 Initialiser les valeurs dans session_state si elles ne sont pas encore définies</span>
<span class="c1"># if &quot;selected_region&quot; not in st.session_state:</span>
<span class="c1">#     st.session_state.selected_region = None</span>
<span class="c1"># if &quot;year&quot; not in st.session_state:</span>
<span class="c1">#     st.session_state.year = None</span>

<span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Selected territory: </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;⚠️ Please select a region&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Selected year : </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;⚠️ Please select a year&quot;</span><span class="p">)</span>

<span class="c1"># -- Sélection des onglets --</span>
<span class="n">tab1</span><span class="p">,</span> <span class="n">tab2</span><span class="p">,</span> <span class="n">tab3</span><span class="p">,</span> <span class="n">tab4</span><span class="p">,</span> <span class="n">tab5</span><span class="p">,</span> <span class="n">tab6</span><span class="p">,</span> <span class="n">tab7</span><span class="p">,</span> <span class="n">tab8</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">tabs</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;Documentation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Run&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Sankey&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Detailed data&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Map&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Historic Evolution&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Scenario Generator&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Prospective Mode&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="k">with</span> <span class="n">tab1</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Documentation&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;GRAFS-Extended: Comprehensive Analysis of Nitrogen Flux in Agricultural Systems&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Overview&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &lt;p style=&#39;text-align: justify&#39;&gt;</span>
<span class="sd">        The GRAFS-extended model serves as an advanced tool designed to analyze and map the evolution of nitrogen utilization within agricultural systems, with a particular focus on 33 regions of France from 1852 to 2014. This model builds upon the GRAFS framework developed at IEES and integrates graph theory to provide a detailed analysis of nitrogen flows in agriculture, identifying key patterns, transformations, and structural invariants. The model enables researchers to construct robust prospective scenarios and examine the global structure of nitrogen flows in agricultural ecosystems. Technical documentation can be accessed here :</span>
<span class="sd">    &lt;/p&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># import functools</span>
    <span class="c1"># import threading</span>
    <span class="c1"># from http.server import SimpleHTTPRequestHandler, ThreadingHTTPServer</span>

    <span class="c1"># # Chemin absolu vers .../docs/_build/html/index.html</span>
    <span class="c1"># INDEX_HTML = Path(__file__).parent.parent.parent / &quot;docs&quot; / &quot;source&quot; / &quot;.docs&quot; / &quot;_build&quot; / &quot;html&quot; / &quot;index.html&quot;</span>

    <span class="c1"># import os</span>

    <span class="c1"># DOC_DIR = Path(__file__).parent.parent.parent / &quot;docs&quot; / &quot;source&quot; / &quot;.docs&quot; / &quot;_build&quot; / &quot;html&quot;</span>
    <span class="c1"># PORT = 8765</span>

    <span class="c1"># # --- HTTP Server Setup ---</span>
    <span class="c1"># def run_server(server_class=ThreadingHTTPServer, handler_class=SimpleHTTPRequestHandler, port=PORT, directory=None):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Starts a simple HTTP server in a background thread to serve files from a specific directory.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     if directory is None:</span>
    <span class="c1">#         # Fallback to the current directory if no specific directory is provided</span>
    <span class="c1">#         directory = os.getcwd()</span>

    <span class="c1">#     # Use functools.partial to create a handler that serves files from the specified directory.</span>
    <span class="c1">#     # This is the key change: we avoid using os.chdir().</span>
    <span class="c1">#     handler = functools.partial(handler_class, directory=str(directory))</span>

    <span class="c1">#     server_address = (&quot;0.0.0.0&quot;, port)</span>

    <span class="c1">#     try:</span>
    <span class="c1">#         httpd = server_class(server_address, handler)</span>
    <span class="c1">#         # Inform the user that the server is running</span>
    <span class="c1">#         print(f&quot;Serving documentation from &#39;{directory}&#39; on http://localhost:{port}&quot;)</span>
    <span class="c1">#         # Start the server. It will run forever in its thread until the main app stops.</span>
    <span class="c1">#         httpd.serve_forever()</span>
    <span class="c1">#     except Exception as e:</span>
    <span class="c1">#         # Log any errors that occur during server startup</span>
    <span class="c1">#         print(f&quot;Error starting server: {e}&quot;)</span>

    <span class="c1"># # Start the documentation server in a background thread.</span>
    <span class="c1"># # The &#39;daemon=True&#39; flag ensures the thread will close when the main Streamlit app terminates.</span>
    <span class="c1"># # We pass the DOC_DIR to the server so it knows where to find the HTML files.</span>
    <span class="c1"># server_thread = threading.Thread(target=run_server, kwargs={&quot;directory&quot;: DOC_DIR, &quot;port&quot;: PORT}, daemon=True)</span>
    <span class="c1"># if not getattr(st, &quot;server_started&quot;, False):</span>
    <span class="c1">#     server_thread.start()</span>
    <span class="c1">#     st.server_started = True  # Use session state to ensure the server is only started once.</span>

    <span class="c1"># # The URL for the link button points to the localhost server we started.</span>
    <span class="c1"># DOC_URL = f&quot;http://localhost:{PORT}/index.html&quot;</span>

    <span class="c1"># Create a link button to the documentation</span>
    <span class="n">st</span><span class="o">.</span><span class="n">link_button</span><span class="p">(</span>
        <span class="s2">&quot;📖  Python Documentation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;https://adrienfaustegay.github.io/Doc_grafse/index.html&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Opens the project&#39;s technical documentation in a new tab.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># def run_server():</span>
    <span class="c1">#     os.chdir(DOC_DIR)</span>
    <span class="c1">#     ThreadingHTTPServer((&quot;0.0.0.0&quot;, PORT), SimpleHTTPRequestHandler).serve_forever()</span>

    <span class="c1"># threading.Thread(target=run_server, daemon=True).start()</span>
    <span class="c1"># ----------------------------------------------------------------------</span>

    <span class="c1"># DOC_URL = f&quot;http://localhost:{PORT}/index.html&quot;</span>
    <span class="c1"># st.link_button(&quot;📖  Python Documentation&quot;, DOC_URL)</span>

    <span class="c1"># 🔹 Mise en cache du chargement de l&#39;image</span>
<div class="viewcode-block" id="load_image">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.load_image">[docs]</a>
    <span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_image</span><span class="p">():</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">image_path</span><span class="p">)</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>
        <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">height</span>  <span class="c1"># Calcul du ratio</span>
        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">aspect_ratio</span></div>


    <span class="c1"># 🔹 Création d&#39;une carte avec l&#39;image en cache</span>
<div class="viewcode-block" id="create_image_map">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.create_image_map">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_image_map</span><span class="p">():</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">()</span>

        <span class="c1"># Définir les bounds pour garder les proportions</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">aspect_ratio</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">aspect_ratio</span><span class="p">]]</span>

        <span class="c1"># Créer une carte sans fond de carte</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">zoom_start</span><span class="o">=</span><span class="mf">9.5</span><span class="p">,</span> <span class="n">zoom_control</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tiles</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Ajouter l&#39;image avec les bonnes proportions</span>
        <span class="n">image_overlay</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">raster_layers</span><span class="o">.</span><span class="n">ImageOverlay</span><span class="p">(</span>
            <span class="n">image</span><span class="o">=</span><span class="n">image_path</span><span class="p">,</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">opacity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">interactive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">cross_origin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">image_overlay</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">m</span></div>


    <span class="c1"># 🔹 Affichage de l&#39;image dans Streamlit</span>
    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Metabolism Overview&quot;</span><span class="p">)</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">create_image_map</span><span class="p">()</span>  <span class="c1"># Création de la carte avec l&#39;image mise en cache</span>

    <span class="c1"># 🟢 Affichage de la carte avec Streamlit-Folium</span>
    <span class="n">st_folium</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Features&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="s2">&quot;Historical Data: Covers nitrogen flow analysis for the period from 1852 to 2014 across 33 French regions.      </span><span class="se">\n</span><span class="s2">Comprehensive Nitrogen Flux Model: Includes 36 varieties of crops, 6 livestock categories, 2 population categories, 2 industrial sectors and 20 mores objects for environmental interactions and trade.&quot;</span>
    <span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="s2">&quot;Go to &#39;Run&#39; tab to select a year and region to run GRAFS-E. This will display the nitrogen transition matrix for this territory&quot;</span>
    <span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;Then use &#39;Sankey&#39; tab to analyse direct input and output flows for each object.&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;Use map tab to display agricultural maps.&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Methods&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &lt;p style=&#39;text-align: justify&#39;&gt;</span>
<span class="sd">        The GRAFS-E model is designed to encapsulate the nitrogen utilization process in agricultural systems by considering historical transformations in French agricultural practices. It captures the transition from traditional crop-livestock agriculture to more intensive, specialized systems.</span>
<span class="sd">    &lt;/p&gt;</span>
<span class="sd">    &lt;p style=&#39;text-align: justify&#39;&gt;</span>
<span class="sd">        GRAFS-E uses optimization model to allocate plant productions to livestock, population and trade.</span>
<span class="sd">    &lt;/p&gt;</span>
<span class="sd">    &lt;p style=&#39;text-align: justify&#39;&gt;</span>
<span class="sd">        By integrating optimization techniques and new mechanisms, GRAFS-E allows for the detailed study of nitrogen flows at a finer resolution than the original GRAFS model, covering 64 distinct objects, including various types of crops, livestock, population groups, industrial sectors, import/export category, and 6 environment category. The extension of GRAFS makes it possible to examine the topology and properties of the graph built with this flow model. This approach provides a deeper understanding of the structure of the system, notably identifying invariants and hubs.</span>
<span class="sd">    &lt;/p&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Results&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="s2">&quot;The model generates extensive transition matrices representing nitrogen flows between different agricultural components.&quot;</span>
    <span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="s2">&quot;These matrices can be used for several analysis as network analysis, input-output analysis, environmental footprint analysis and so on.&quot;</span>
    <span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Future Work&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="s2">&quot;- Prospective tool: a prospective mode will be developped to allow creation of various agricultural futurs and analyse their realism.&quot;</span>
    <span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="s2">&quot;- Implementation in a general inductrial ecology model : GRAFS-E will be integrated to MATER as agricultural sector sub-model.&quot;</span>
    <span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="s2">&quot;- Network Resilience: Further analysis using Ecological Network Analysis (ENA) can help improve the model&#39;s understanding of resilience in nitrogen flows.&quot;</span>
    <span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="s2">&quot;- Multi-Layer Models: Future versions may include additional structural flows such as energy, water, and financial transfers.&quot;</span>
    <span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Data&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &lt;p style=&#39;text-align: justify&#39;&gt;</span>
<span class="sd">        The GRAFS-E model relies on agronomic data and technical coefficients from previous research, which were initially used in the seminal GRAFS framework. It consists in production and area data from all cultures, livestock size and production, mean use of synthetic fertilization and total net feed import.</span>
<span class="sd">    &lt;/p&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;License&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="s2">&quot;This project is licensed under the GNU General Public License v3.0 (GPL-3.0). See the LICENSE file for details.&quot;</span>
    <span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Contact&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="s2">&quot;For any questions or contributions, feel free to reach out to Adrien Fauste-Gay at adrien.fauste-gay@univ-grenoble-alpes.fr.&quot;</span>
    <span class="p">)</span>

<span class="k">with</span> <span class="n">tab2</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Territory selection&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Please select a year and a territory then click on Run.&quot;</span><span class="p">)</span>

    <span class="c1"># 🟢 Sélection de l&#39;année</span>
    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Select a year&quot;</span><span class="p">)</span>
    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year_run</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">annees_disponibles</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># 🔹 Vérifier la connexion Internet</span>
<div class="viewcode-block" id="is_online">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.is_online">[docs]</a>
    <span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_online</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://www.google.com&quot;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


    <span class="c1"># 🔹 Charger les données GeoJSON avec cache</span>
<div class="viewcode-block" id="load_geojson">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.load_geojson">[docs]</a>
    <span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_geojson</span><span class="p">():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">geojson_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span></div>


    <span class="c1"># 🔹 Fonction pour ajouter le rectangle englobant toute la France (AU DÉBUT)</span>
<div class="viewcode-block" id="add_france_rectangle">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.add_france_rectangle">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_france_rectangle</span><span class="p">(</span><span class="n">geojson_data</span><span class="p">):</span>
        <span class="n">all_coords</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">geojson_data</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">:</span>
                <span class="n">all_coords</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">feature</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">][</span><span class="s2">&quot;coordinates&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MultiPolygon&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">polygon</span> <span class="ow">in</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">][</span><span class="s2">&quot;coordinates&quot;</span><span class="p">]:</span>
                    <span class="n">all_coords</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">polygon</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Extraire les bornes extrêmes</span>
        <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_coords</span><span class="p">)</span>
        <span class="n">min_lon</span><span class="p">,</span> <span class="n">min_lat</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">max_lon</span><span class="p">,</span> <span class="n">max_lat</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Créer le rectangle pour la France entière</span>
        <span class="n">france_rectangle</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;nom&quot;</span><span class="p">:</span> <span class="s2">&quot;France&quot;</span><span class="p">},</span>
            <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Polygon&quot;</span><span class="p">,</span>
                <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">[[</span><span class="n">min_lon</span><span class="p">,</span> <span class="n">min_lat</span><span class="p">],</span> <span class="p">[</span><span class="n">min_lon</span><span class="p">,</span> <span class="n">max_lat</span><span class="p">],</span> <span class="p">[</span><span class="n">max_lon</span><span class="p">,</span> <span class="n">max_lat</span><span class="p">],</span> <span class="p">[</span><span class="n">max_lon</span><span class="p">,</span> <span class="n">min_lat</span><span class="p">],</span> <span class="p">[</span><span class="n">min_lon</span><span class="p">,</span> <span class="n">min_lat</span><span class="p">]]</span>
                <span class="p">],</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="c1"># ✅ Insérer le rectangle AVANT les autres régions =&gt; En dessous des autres polygones</span>
        <span class="n">geojson_data</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">france_rectangle</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">geojson_data</span></div>


    <span class="c1"># 🔹 Création de la carte avec ou sans fond de carte</span>
<div class="viewcode-block" id="create_map">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.create_map">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_map</span><span class="p">():</span>
        <span class="n">geojson_data</span> <span class="o">=</span> <span class="n">load_geojson</span><span class="p">()</span>  <span class="c1"># Charger les données JSON</span>
        <span class="n">geojson_data</span> <span class="o">=</span> <span class="n">add_france_rectangle</span><span class="p">(</span><span class="n">geojson_data</span><span class="p">)</span>
        <span class="n">map_center</span> <span class="o">=</span> <span class="p">[</span><span class="mf">46.6034</span><span class="p">,</span> <span class="mf">1.8883</span><span class="p">]</span>  <span class="c1"># Centre approximatif de la France</span>

        <span class="c1"># Vérifier la connexion Internet</span>
        <span class="n">online</span> <span class="o">=</span> <span class="n">is_online</span><span class="p">()</span>

        <span class="c1"># Si Internet est disponible, utiliser un fond de carte normal</span>
        <span class="k">if</span> <span class="n">online</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">map_center</span><span class="p">,</span> <span class="n">zoom_start</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;⚠️ No Internet connection detected. The map will be displayed without background tiles.&quot;</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">map_center</span><span class="p">,</span> <span class="n">zoom_start</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">tiles</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># Pas de fond de carte</span>

        <span class="c1"># Style des régions survolées</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">on_click</span><span class="p">(</span><span class="n">feature</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;fillColor&quot;</span><span class="p">:</span> <span class="s2">&quot;#ffaf00&quot;</span> <span class="k">if</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;nom&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;France&quot;</span> <span class="k">else</span> <span class="s2">&quot;#0078ff&quot;</span><span class="p">,</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;fillOpacity&quot;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span>
                <span class="s2">&quot;highlight&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="c1"># Ajouter les polygones GeoJSON</span>
        <span class="n">geo_layer</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">GeoJson</span><span class="p">(</span>
            <span class="n">geojson_data</span><span class="p">,</span>
            <span class="n">style_function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">feature</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;fillColor&quot;</span><span class="p">:</span> <span class="s2">&quot;#ffaf00&quot;</span> <span class="k">if</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;nom&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;France&quot;</span> <span class="k">else</span> <span class="s2">&quot;#0078ff&quot;</span><span class="p">,</span>
                <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;fillOpacity&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">tooltip</span><span class="o">=</span><span class="n">folium</span><span class="o">.</span><span class="n">GeoJsonTooltip</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nom&quot;</span><span class="p">],</span> <span class="n">aliases</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Territory :&quot;</span><span class="p">]),</span>
            <span class="n">highlight_function</span><span class="o">=</span><span class="n">on_click</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">geo_layer</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">m</span></div>


    <span class="c1"># 🔹 Affichage de la carte dans Streamlit</span>
    <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Select a territory&quot;</span><span class="p">)</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">create_map</span><span class="p">()</span>  <span class="c1"># Crée la carte en fonction de l&#39;état de la connexion Internet</span>

    <span class="c1"># 🟢 Affichage de la carte avec Streamlit-Folium</span>
    <span class="n">map_data</span> <span class="o">=</span> <span class="n">st_folium</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 🔹 Mettre à jour `st.session_state.selected_region` avec la sélection utilisateur</span>
    <span class="k">if</span> <span class="n">map_data</span> <span class="ow">and</span> <span class="s2">&quot;last_active_drawing&quot;</span> <span class="ow">in</span> <span class="n">map_data</span><span class="p">:</span>
        <span class="n">last_drawing</span> <span class="o">=</span> <span class="n">map_data</span><span class="p">[</span><span class="s2">&quot;last_active_drawing&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">last_drawing</span> <span class="ow">and</span> <span class="s2">&quot;properties&quot;</span> <span class="ow">in</span> <span class="n">last_drawing</span> <span class="ow">and</span> <span class="s2">&quot;nom&quot;</span> <span class="ow">in</span> <span class="n">last_drawing</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_run</span> <span class="o">=</span> <span class="n">last_drawing</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;nom&quot;</span><span class="p">]</span>

    <span class="c1"># ✅ Affichage des sélections (se met à jour dynamiquement)</span>
    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_run</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Région sélectionnée : </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_run</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;⚠️ Veuillez sélectionner une région&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year_run</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Année sélectionnée : </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year_run</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;⚠️ Veuillez sélectionner une année&quot;</span><span class="p">)</span>

    <span class="c1"># 🟢 Fonction pour générer la heatmap et éviter les recalculs inutiles</span>
<div class="viewcode-block" id="generate_heatmap">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.generate_heatmap">[docs]</a>
    <span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_heatmap</span><span class="p">(</span><span class="n">_model</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
        <span class="n">_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">_model</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_model</span><span class="o">.</span><span class="n">plot_heatmap_interactive</span><span class="p">()</span></div>


    <span class="c1"># 🔹 Bouton &quot;Run&quot; avec les valeurs mises à jour</span>
    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;Run&quot;</span><span class="p">):</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_run</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year_run</span>
        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region</span> <span class="ow">and</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year</span><span class="p">:</span>
            <span class="c1"># Initialiser le modèle avec les paramètres</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">NitrogenFlowModel</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">year</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                <span class="n">region</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region</span><span class="p">,</span>
                <span class="n">categories_mapping</span><span class="o">=</span><span class="n">categories_mapping</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">cultures</span><span class="o">=</span><span class="n">cultures</span><span class="p">,</span>
                <span class="n">legumineuses</span><span class="o">=</span><span class="n">legumineuses</span><span class="p">,</span>
                <span class="n">prairies</span><span class="o">=</span><span class="n">prairies</span><span class="p">,</span>
                <span class="n">betail</span><span class="o">=</span><span class="n">betail</span><span class="p">,</span>
                <span class="n">Pop</span><span class="o">=</span><span class="n">Pop</span><span class="p">,</span>
                <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># st.session_state[&quot;model&quot;] = model</span>

            <span class="c1"># ✅ Générer la heatmap et la stocker</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">heatmap_fig</span> <span class="o">=</span> <span class="n">generate_heatmap</span><span class="p">(</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;❌ Please select a year and a region before running the analysis.&quot;</span><span class="p">)</span>

    <span class="c1"># 🔹 Indépendance de l&#39;affichage de la heatmap 🔹</span>
    <span class="k">if</span> <span class="s2">&quot;heatmap_fig&quot;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total Throughflow : </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_transition_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> ktN/yr.&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Heatmap of the nitrogen flows for </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">plotly_chart</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">heatmap_fig</span><span class="p">,</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tab3</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Sankey&quot;</span><span class="p">)</span>

    <span class="c1"># Vérifier si le modèle a été exécuté</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;⚠️ Please run the model first in the &#39;Run&#39; tab or &#39;Prospective mode&#39; tab.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Récupérer l&#39;objet model</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>

        <span class="c1"># 🔹 Ajouter un bouton de mode</span>
        <span class="n">mode_complet</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="s2">&quot;Detailed view&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>

        <span class="n">streamlit_sankey_app</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">mode_complet</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Fertilization in the territory&quot;</span><span class="p">)</span>

        <span class="n">mode_complet_ferti</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="s2">&quot;Detailed view&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;ferti&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode_complet_ferti</span><span class="p">:</span>
            <span class="n">merge</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Population&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;urban&quot;</span><span class="p">,</span> <span class="s2">&quot;rural&quot;</span><span class="p">],</span>
                <span class="s2">&quot;Livestock&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;bovines&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ovines&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;equine&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;poultry&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;porcines&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;caprines&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Industry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">,</span> <span class="s2">&quot;other sectors&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">tre</span> <span class="o">=</span> <span class="mf">1e-1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merge</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Livestock and human&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;bovines&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ovines&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;equine&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;poultry&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;porcines&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;caprines&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;urban&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;rural&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Industry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">,</span> <span class="s2">&quot;other sectors&quot;</span><span class="p">],</span>
                <span class="s2">&quot;Cereals&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Wheat&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Oat&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Barley&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Grain maize&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Rye&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Other cereals&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Rice&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Forages&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Straw&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Forage maize&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Forage cabbages&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Temporary meadows&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Non-legume temporary meadow&quot;</span><span class="p">,</span> <span class="s2">&quot;Alfalfa and clover&quot;</span><span class="p">],</span>
                <span class="s2">&quot;Oleaginous&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Rapeseed&quot;</span><span class="p">,</span> <span class="s2">&quot;Sunflower&quot;</span><span class="p">,</span> <span class="s2">&quot;Hemp&quot;</span><span class="p">,</span> <span class="s2">&quot;Flax&quot;</span><span class="p">],</span>
                <span class="s2">&quot;Leguminous&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Soybean&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Other oil crops&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Horse beans and faba beans&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Peas&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Other protein crops&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Green peas&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Dry beans&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Green beans&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Fruits and vegetables&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Dry vegetables&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Dry fruits&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Squash and melons&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Cabbage&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Leaves vegetables&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Fruits&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Olives&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Citrus&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Roots&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Sugar beet&quot;</span><span class="p">,</span> <span class="s2">&quot;Potatoes&quot;</span><span class="p">,</span> <span class="s2">&quot;Other roots&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">tre</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nodes for which throughflow is below </span><span class="si">{</span><span class="n">tre</span><span class="si">}</span><span class="s2"> ktN/yr are not shown here.&quot;</span><span class="p">)</span>

        <span class="n">streamlit_sankey_fertilization</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">cultures</span><span class="p">,</span> <span class="n">legumineuses</span><span class="p">,</span> <span class="n">prairies</span><span class="p">,</span> <span class="n">merges</span><span class="o">=</span><span class="n">merge</span><span class="p">,</span> <span class="n">THRESHOLD</span><span class="o">=</span><span class="n">tre</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Feed for livestock and Food for local population&quot;</span><span class="p">)</span>

        <span class="n">mode_complet_food</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="s2">&quot;Detailed view&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;food&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode_complet_food</span><span class="p">:</span>
            <span class="n">merge</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Cereals (excluding rice) trade&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;cereals (excluding rice) food trade&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;cereals (excluding rice) feed trade&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Fruits and vegetables trade&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;fruits and vegetables food trade&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;fruits and vegetables feed trade&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Leguminous trade&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;leguminous food trade&quot;</span><span class="p">,</span> <span class="s2">&quot;leguminous feed trade&quot;</span><span class="p">],</span>
                <span class="s2">&quot;Oleaginous trade&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;oleaginous food trade&quot;</span><span class="p">,</span> <span class="s2">&quot;oleaginous feed trade&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">tre</span> <span class="o">=</span> <span class="mf">1e-1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merge</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Cereals (excluding rice) trade&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;cereals (excluding rice) food trade&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;cereals (excluding rice) feed trade&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Fruits and vegetables trade&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;fruits and vegetables food trade&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;fruits and vegetables feed trade&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Leguminous trade&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;leguminous food trade&quot;</span><span class="p">,</span> <span class="s2">&quot;leguminous feed trade&quot;</span><span class="p">],</span>
                <span class="s2">&quot;Oleaginous trade&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;oleaginous food trade&quot;</span><span class="p">,</span> <span class="s2">&quot;oleaginous feed trade&quot;</span><span class="p">],</span>
                <span class="s2">&quot;Population&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;urban&quot;</span><span class="p">,</span> <span class="s2">&quot;rural&quot;</span><span class="p">],</span>
                <span class="s2">&quot;Livestock&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;bovines&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ovines&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;equine&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;poultry&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;porcines&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;caprines&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Cereals&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Wheat&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Oat&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Barley&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Grain maize&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Rye&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Other cereals&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Rice&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Forages&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Straw&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Forage maize&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Forage cabbages&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Temporary meadows&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Non-legume temporary meadow&quot;</span><span class="p">,</span> <span class="s2">&quot;Alfalfa and clover&quot;</span><span class="p">],</span>
                <span class="s2">&quot;Oleaginous&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Rapeseed&quot;</span><span class="p">,</span> <span class="s2">&quot;Sunflower&quot;</span><span class="p">,</span> <span class="s2">&quot;Hemp&quot;</span><span class="p">,</span> <span class="s2">&quot;Flax&quot;</span><span class="p">],</span>
                <span class="s2">&quot;Leguminous&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Soybean&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Other oil crops&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Horse beans and faba beans&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Peas&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Other protein crops&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Green peas&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Dry beans&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Green beans&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Fruits and vegetables&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&quot;Dry vegetables&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Dry fruits&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Squash and melons&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Cabbage&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Leaves vegetables&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Fruits&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Olives&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Citrus&quot;</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="s2">&quot;Roots&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Sugar beet&quot;</span><span class="p">,</span> <span class="s2">&quot;Potatoes&quot;</span><span class="p">,</span> <span class="s2">&quot;Other roots&quot;</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="n">tre</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nodes for which throughflow is below </span><span class="si">{</span><span class="n">tre</span><span class="si">}</span><span class="s2"> ktN/yr are not shown here.&quot;</span><span class="p">)</span>

        <span class="n">trades</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;animal trade&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cereals (excluding rice) food trade&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fruits and vegetables food trade&quot;</span><span class="p">,</span>
            <span class="s2">&quot;leguminous food trade&quot;</span><span class="p">,</span>
            <span class="s2">&quot;oleaginous food trade&quot;</span><span class="p">,</span>
            <span class="s2">&quot;roots food trade&quot;</span><span class="p">,</span>
            <span class="s2">&quot;rice food trade&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cereals (excluding rice) feed trade&quot;</span><span class="p">,</span>
            <span class="s2">&quot;forages feed trade&quot;</span><span class="p">,</span>
            <span class="s2">&quot;leguminous feed trade&quot;</span><span class="p">,</span>
            <span class="s2">&quot;oleaginous feed trade&quot;</span><span class="p">,</span>
            <span class="s2">&quot;grasslands feed trade&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temporary meadows feed trade&quot;</span><span class="p">,</span>
            <span class="s2">&quot;natural meadows feed trade&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">streamlit_sankey_food_flows</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">cultures</span><span class="p">,</span> <span class="n">legumineuses</span><span class="p">,</span> <span class="n">prairies</span><span class="p">,</span> <span class="n">trades</span><span class="p">,</span> <span class="n">merges</span><span class="o">=</span><span class="n">merge</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Territorial Systemic Overview&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;This Sankey diagram presents nitrogen flows in the agricultural system organized by key categories (10% = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2"> ktN/yr).&quot;</span>
        <span class="p">)</span>
        <span class="c1"># st.write(&quot;For optimal visualization, please switch to full screen mode.&quot;)</span>

        <span class="c1"># streamlit_sankey_systemic_flows(model)</span>
        <span class="c1"># os.path.join(os.getcwd(), &quot;data/system_flows.svg&quot;)</span>
        <span class="c1"># 1) Point de départ : le dossier racine du projet</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>  <span class="c1"># par exemple, un dossier au-dessus de app.py</span>
        <span class="c1"># 2) Construire le chemin vers le SVG</span>
        <span class="n">svg_template_path</span> <span class="o">=</span> <span class="n">base</span> <span class="o">/</span> <span class="s2">&quot;grafs_e&quot;</span> <span class="o">/</span> <span class="s2">&quot;data&quot;</span> <span class="o">/</span> <span class="s2">&quot;system_flows.svg&quot;</span>

        <span class="n">streamlit_sankey_systemic_flows_svg</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">mapping_svg_fluxes</span><span class="p">,</span> <span class="n">svg_template_path</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tab4</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Detailed data&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;⚠️ Please run the model first in the &#39;Run&#39; tab or in the &#39;Prospective mode&#39; tab.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;This tab is to access to detailed data used in input but also processed by the model&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Cultures data&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">df_cultures_display</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Livestock data&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">df_elevage_display</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Culture allocation to livestock and population&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Diet deviations from defined diet&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">deviations_df</span><span class="p">)</span>


<span class="c1"># 📌 Stocker et récupérer les modèles pour chaque région en cache</span>
<div class="viewcode-block" id="run_models_for_all_regions">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.run_models_for_all_regions">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_resource</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run_models_for_all_regions</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">_data_loader</span><span class="p">):</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">region</span> <span class="o">==</span> <span class="s2">&quot;Savoie&quot;</span> <span class="ow">and</span> <span class="n">year</span> <span class="o">==</span> <span class="s2">&quot;1852&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">models</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">NitrogenFlowModel</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">_data_loader</span><span class="p">,</span>
                <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span>
                <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                <span class="n">categories_mapping</span><span class="o">=</span><span class="n">categories_mapping</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">cultures</span><span class="o">=</span><span class="n">cultures</span><span class="p">,</span>
                <span class="n">legumineuses</span><span class="o">=</span><span class="n">legumineuses</span><span class="p">,</span>
                <span class="n">prairies</span><span class="o">=</span><span class="n">prairies</span><span class="p">,</span>
                <span class="n">betail</span><span class="o">=</span><span class="n">betail</span><span class="p">,</span>
                <span class="n">Pop</span><span class="o">=</span><span class="n">Pop</span><span class="p">,</span>
                <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">models</span></div>



<span class="c1"># 📌 Calculer et stocker les métriques pour chaque région en cache</span>
<div class="viewcode-block" id="get_metrics_for_all_regions">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.get_metrics_for_all_regions">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_metrics_for_all_regions</span><span class="p">(</span><span class="n">_models</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
    <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Total imported nitrogen&quot;</span><span class="p">:</span> <span class="s2">&quot;imported_nitrogen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total net plant import&quot;</span><span class="p">:</span> <span class="s2">&quot;net_imported_plant&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total net animal import&quot;</span><span class="p">:</span> <span class="s2">&quot;net_imported_animal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total plant production&quot;</span><span class="p">:</span> <span class="s2">&quot;total_plant_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Environmental Footprint&quot;</span><span class="p">:</span> <span class="s2">&quot;net_footprint&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NUE&quot;</span><span class="p">:</span> <span class="s2">&quot;NUE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;System NUE&quot;</span><span class="p">:</span> <span class="s2">&quot;NUE_system&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Livestock density&quot;</span><span class="p">:</span> <span class="s2">&quot;LU_density&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Cereals production&quot;</span><span class="p">:</span> <span class="s2">&quot;cereals_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Leguminous production&quot;</span><span class="p">:</span> <span class="s2">&quot;leguminous_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Oleaginous production&quot;</span><span class="p">:</span> <span class="s2">&quot;oleaginous_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Grassland and forage production&quot;</span><span class="p">:</span> <span class="s2">&quot;grassland_and_forages_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Roots production&quot;</span><span class="p">:</span> <span class="s2">&quot;roots_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Fruits and vegetables production&quot;</span><span class="p">:</span> <span class="s2">&quot;fruits_and_vegetable_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Cereals production&quot;</span><span class="p">:</span> <span class="s2">&quot;cereals_production_r&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Leguminous production&quot;</span><span class="p">:</span> <span class="s2">&quot;leguminous_production_r&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Oleaginous production&quot;</span><span class="p">:</span> <span class="s2">&quot;oleaginous_production_r&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Grassland and forage production&quot;</span><span class="p">:</span> <span class="s2">&quot;grassland_and_forages_production_r&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Roots production&quot;</span><span class="p">:</span> <span class="s2">&quot;roots_production_r&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Fruits and vegetables production&quot;</span><span class="p">:</span> <span class="s2">&quot;fruits_and_vegetable_production_r&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total animal production&quot;</span><span class="p">:</span> <span class="s2">&quot;animal_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">:</span> <span class="s2">&quot;NH3_vol&quot;</span><span class="p">,</span>
        <span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="s2">&quot;N2O_em&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Effective number of nodes&quot;</span><span class="p">:</span> <span class="s2">&quot;N_eff&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Effective connectivity&quot;</span><span class="p">:</span> <span class="s2">&quot;C_eff&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Effective number of links&quot;</span><span class="p">:</span> <span class="s2">&quot;F_eff&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Effective number of role&quot;</span><span class="p">:</span> <span class="s2">&quot;R_eff&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">metric_function_name</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">area</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">region</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">metric_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">metric_function_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">metric_function</span><span class="p">):</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_function</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Si la méthode n&#39;existe pas, on met None</span>
        <span class="n">area</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">surfaces_tot</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">area</span></div>



<div class="viewcode-block" id="get_metric_range">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.get_metric_range">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_metric_range</span><span class="p">(</span><span class="n">metrics</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Récupère les valeurs min et max de l&#39;indicateur sélectionné.&quot;&quot;&quot;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>  <span class="c1"># Ignore les NaN</span></div>



<div class="viewcode-block" id="add_color_legend">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.add_color_legend">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">add_color_legend</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ajoute une légende de la colormap à la carte.&quot;&quot;&quot;</span>
    <span class="n">colormap</span> <span class="o">=</span> <span class="n">branca</span><span class="o">.</span><span class="n">colormap</span><span class="o">.</span><span class="n">LinearColormap</span><span class="p">(</span>
        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
        <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="n">mcolors</span><span class="o">.</span><span class="n">to_hex</span><span class="p">(</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">)],</span>
    <span class="p">)</span><span class="o">.</span><span class="n">to_step</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">25</span><span class="p">))</span>  <span class="c1"># 5 niveaux de couleur</span>

    <span class="n">colormap</span><span class="o">.</span><span class="n">caption</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_name</span><span class="p">)</span>
    <span class="n">colormap</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span></div>



<span class="c1"># 📌 Fonction pour créer la carte et stocker dans `st.session_state`</span>
<div class="viewcode-block" id="create_map_with_metrics">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.create_map_with_metrics">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_resource</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_map_with_metrics</span><span class="p">(</span><span class="n">geojson_data</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
    <span class="n">map_center</span> <span class="o">=</span> <span class="p">[</span><span class="mf">46.6034</span><span class="p">,</span> <span class="mf">1.8883</span><span class="p">]</span>  <span class="c1"># Centre approximatif de la France</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="n">map_center</span><span class="p">,</span> <span class="n">zoom_start</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">tiles</span><span class="o">=</span><span class="s2">&quot;OpenStreetMap&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">geojson_data</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]:</span>
        <span class="n">region_name</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;nom&quot;</span><span class="p">]</span>
        <span class="n">metric_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">region_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">metric_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># 📌 Obtenir min et max du metric sélectionné</span>
            <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="n">get_metric_range</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;net&quot;</span> <span class="ow">in</span> <span class="n">metric_name</span> <span class="ow">or</span> <span class="s2">&quot;Footprint&quot;</span> <span class="ow">in</span> <span class="n">metric_name</span><span class="p">:</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;bwr&quot;</span><span class="p">)</span>
                <span class="n">min_val</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_val</span><span class="p">,</span> <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">max_val</span><span class="p">))</span>
                <span class="n">max_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">min_val</span><span class="p">),</span> <span class="n">max_val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;plasma&quot;</span><span class="p">)</span>  <span class="c1"># Utilisation de la colormap &quot;plasma&quot;</span>

            <span class="c1"># 📌 Normaliser et mapper les couleurs</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">min_val</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">max_val</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;Relative&quot;</span> <span class="ow">in</span> <span class="n">metric_name</span> <span class="ow">or</span> <span class="s2">&quot;NUE&quot;</span> <span class="ow">in</span> <span class="n">metric_name</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;Eff&quot;</span> <span class="ow">in</span> <span class="n">metric_name</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;Footprint&quot;</span> <span class="ow">in</span> <span class="n">metric_name</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;Mha&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;Livestock density&quot;</span> <span class="o">==</span> <span class="n">metric_name</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;LU/ha&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;ktN/yr&quot;</span>

            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">geojson_data</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]:</span>
                <span class="n">region_name</span> <span class="o">=</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;nom&quot;</span><span class="p">]</span>
                <span class="n">metric_value</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">region_name</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>  <span class="c1"># Valeur de l&#39;indicateur</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">metric_value</span><span class="p">):</span>  <span class="c1"># Si pas de donnée, couleur grise</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;#CCCCCC&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rgba</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">metric_value</span><span class="p">))</span>  <span class="c1"># Convertir en RGBA</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">to_hex</span><span class="p">(</span><span class="n">rgba</span><span class="p">)</span>  <span class="c1"># Convertir en HEX</span>

                <span class="k">def</span><span class="w"> </span><span class="nf">style_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">=</span><span class="n">color</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">{</span>
                        <span class="s2">&quot;fillColor&quot;</span><span class="p">:</span> <span class="n">fill_color</span><span class="p">,</span>  <span class="c1"># ✅ Corrected: capture current `color`</span>
                        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;fillOpacity&quot;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span>
                    <span class="p">}</span>

                <span class="n">folium</span><span class="o">.</span><span class="n">GeoJson</span><span class="p">(</span>
                    <span class="n">feature</span><span class="p">,</span>
                    <span class="n">style_function</span><span class="o">=</span><span class="n">style_function</span><span class="p">,</span>
                    <span class="n">tooltip</span><span class="o">=</span><span class="n">folium</span><span class="o">.</span><span class="n">Tooltip</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">region_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">metric_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="n">add_color_legend</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span></div>



<div class="viewcode-block" id="weighted_mean">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.weighted_mean">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">weighted_mean</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">area</span><span class="p">):</span>
    <span class="c1"># Calcul de la somme des produits des valeurs et des poids</span>
    <span class="n">weighted_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">*</span> <span class="n">area</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">)</span>

    <span class="c1"># Calcul de la somme des poids</span>
    <span class="n">total_area</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">area</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">area</span><span class="p">)</span>

    <span class="c1"># Retourner la moyenne pondérée</span>
    <span class="k">return</span> <span class="n">weighted_sum</span> <span class="o">/</span> <span class="n">total_area</span> <span class="k">if</span> <span class="n">total_area</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span></div>



<span class="c1"># 🔹 Assurer la persistance de la carte dans `st.session_state`</span>
<span class="k">if</span> <span class="s2">&quot;map_html&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">map_html</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">with</span> <span class="n">tab5</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Map Configuration&quot;</span><span class="p">)</span>

    <span class="c1"># 🟢 Sélection de l&#39;année</span>
    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">map_year</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s2">&quot;Select a year&quot;</span><span class="p">,</span> <span class="n">annees_disponibles</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;year_map_selection&quot;</span><span class="p">)</span>

    <span class="c1"># 🟢 Sélection de la métrique</span>
    <span class="n">metric_map</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;Total imported nitrogen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total net plant import&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total net animal import&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total plant production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total animal production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Environmental Footprint&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NUE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;System NUE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Livestock density&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Cereals production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Leguminous production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Grassland and forage production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Roots production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Oleaginous production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Fruits and vegetables production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Cereals production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Leguminous production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Grassland and forage production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Roots production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Oleaginous production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Fruits and vegetables production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">,</span>
        <span class="s2">&quot;N2O emission&quot;</span><span class="p">,</span>
        <span class="c1"># &quot;Effective number of nodes&quot;,</span>
        <span class="c1"># &quot;Effective connectivity&quot;,</span>
        <span class="c1"># &quot;Effective number of links&quot;,</span>
        <span class="c1"># &quot;Effective number of role&quot;,</span>
    <span class="p">]</span>
    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s2">&quot;Select a metric&quot;</span><span class="p">,</span> <span class="n">metric_map</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;metric_selection&quot;</span><span class="p">)</span>

    <span class="c1"># 🔹 Bouton &quot;Run&quot;</span>
    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;Run&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;map_button&quot;</span><span class="p">):</span>

        <span class="nd">@st</span><span class="o">.</span><span class="n">cache_resource</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_cached_map</span><span class="p">(</span><span class="n">geojson_data</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">create_map_with_metrics</span><span class="p">(</span><span class="n">geojson_data</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">map_year</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;🚀 Running models and calculating metrics...&quot;</span><span class="p">):</span>
            <span class="c1"># 📌 Exécuter les modèles et récupérer les métriques</span>
            <span class="n">models</span> <span class="o">=</span> <span class="n">run_models_for_all_regions</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">map_year</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">metrics</span><span class="p">,</span> <span class="n">area</span> <span class="o">=</span> <span class="n">get_metrics_for_all_regions</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">map_year</span><span class="p">)</span>

            <span class="c1"># 📌 Charger le GeoJSON et créer la carte</span>
            <span class="n">geojson_data</span> <span class="o">=</span> <span class="n">load_geojson</span><span class="p">()</span>

            <span class="n">map_obj</span> <span class="o">=</span> <span class="n">get_cached_map</span><span class="p">(</span><span class="n">geojson_data</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">map_year</span><span class="p">)</span>

            <span class="c1"># 📌 Convertir la carte en HTML pour éviter la disparition</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">map_html</span> <span class="o">=</span> <span class="n">map_obj</span><span class="o">.</span><span class="n">_repr_html_</span><span class="p">()</span>

            <span class="c1"># 🔹 Vérifier si la carte est déjà générée et l&#39;afficher</span>
            <span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Nitrogen Map&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;NUE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;System NUE&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Livestock density&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Relative Cereals production&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Relative Leguminous production&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Relative Grassland and forage production&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Relative Roots production&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Relative Oleaginous production&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Relative Fruits and vegetables production&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Environmental Footprint&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;Livestock density&quot;</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean for France: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">weighted_mean</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span><span class="w"> </span><span class="n">area</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> LU/ha&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;Environmental Footprint&quot;</span><span class="p">:</span>
                    <span class="c1"># st.text(f&quot;Mean for France: {np.round(weighted_mean(metrics, area), 2)} Mha&quot;)</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean for France: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">weighted_mean</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span><span class="w"> </span><span class="n">area</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> %&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total for France: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> ktN/yr&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">map_html</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">html</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">map_html</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">scrolling</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Please run the model to generate the map.&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="run_models_for_all_years">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.run_models_for_all_years">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_resource</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run_models_for_all_years</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">_data_loader</span><span class="p">):</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">annees_disponibles</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">year</span> <span class="o">==</span> <span class="s2">&quot;1852&quot;</span> <span class="ow">and</span> <span class="n">region</span> <span class="o">==</span> <span class="s2">&quot;Savoie&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">models</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="n">NitrogenFlowModel</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">_data_loader</span><span class="p">,</span>
                <span class="n">year</span><span class="o">=</span><span class="n">year</span><span class="p">,</span>
                <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
                <span class="n">categories_mapping</span><span class="o">=</span><span class="n">categories_mapping</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">cultures</span><span class="o">=</span><span class="n">cultures</span><span class="p">,</span>
                <span class="n">legumineuses</span><span class="o">=</span><span class="n">legumineuses</span><span class="p">,</span>
                <span class="n">prairies</span><span class="o">=</span><span class="n">prairies</span><span class="p">,</span>
                <span class="n">betail</span><span class="o">=</span><span class="n">betail</span><span class="p">,</span>
                <span class="n">Pop</span><span class="o">=</span><span class="n">Pop</span><span class="p">,</span>
                <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">models</span></div>



<span class="c1"># 📌 Calculer et stocker les métriques pour chaque région en cache</span>
<div class="viewcode-block" id="get_metrics_for_all_years">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.get_metrics_for_all_years">[docs]</a>
<span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_metrics_for_all_years</span><span class="p">(</span><span class="n">_models</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
    <span class="n">metric_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Total imported nitrogen&quot;</span><span class="p">:</span> <span class="s2">&quot;imported_nitrogen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total net plant import&quot;</span><span class="p">:</span> <span class="s2">&quot;net_imported_plant&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total net animal import&quot;</span><span class="p">:</span> <span class="s2">&quot;net_imported_animal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total plant production&quot;</span><span class="p">:</span> <span class="s2">&quot;stacked_plant_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Area&quot;</span><span class="p">:</span> <span class="s2">&quot;surfaces&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Environmental Footprint&quot;</span><span class="p">:</span> <span class="s2">&quot;env_footprint&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Area tot&quot;</span><span class="p">:</span> <span class="s2">&quot;surfaces_tot&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total Fertilization&quot;</span><span class="p">:</span> <span class="s2">&quot;tot_fert&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Fertilization&quot;</span><span class="p">:</span> <span class="s2">&quot;rel_fert&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Primary Nitrogen fertilization use&quot;</span><span class="p">:</span> <span class="s2">&quot;primXsec&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Emissions&quot;</span><span class="p">:</span> <span class="s2">&quot;emissions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NUE&quot;</span><span class="p">:</span> <span class="s2">&quot;NUE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;System NUE&quot;</span><span class="p">:</span> <span class="s2">&quot;NUE_system_2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Livestock density&quot;</span><span class="p">:</span> <span class="s2">&quot;LU_density&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Self-Sufficiency&quot;</span><span class="p">:</span> <span class="s2">&quot;N_self_sufficient&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Cereals production&quot;</span><span class="p">:</span> <span class="s2">&quot;cereals_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Leguminous production&quot;</span><span class="p">:</span> <span class="s2">&quot;leguminous_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Oleaginous production&quot;</span><span class="p">:</span> <span class="s2">&quot;oleaginous_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Grassland and forage production&quot;</span><span class="p">:</span> <span class="s2">&quot;grassland_and_forages_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Roots production&quot;</span><span class="p">:</span> <span class="s2">&quot;roots_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Fruits and vegetables production&quot;</span><span class="p">:</span> <span class="s2">&quot;fruits_and_vegetable_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Cereals production&quot;</span><span class="p">:</span> <span class="s2">&quot;cereals_production_r&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Leguminous production&quot;</span><span class="p">:</span> <span class="s2">&quot;leguminous_production_r&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Oleaginous production&quot;</span><span class="p">:</span> <span class="s2">&quot;oleaginous_production_r&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Grassland and forage production&quot;</span><span class="p">:</span> <span class="s2">&quot;grassland_and_forages_production_r&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Roots production&quot;</span><span class="p">:</span> <span class="s2">&quot;roots_production_r&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Fruits and vegetables production&quot;</span><span class="p">:</span> <span class="s2">&quot;fruits_and_vegetable_production_r&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total animal production&quot;</span><span class="p">:</span> <span class="s2">&quot;animal_production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Effective number of nodes&quot;</span><span class="p">:</span> <span class="s2">&quot;N_eff&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Effective connectivity&quot;</span><span class="p">:</span> <span class="s2">&quot;C_eff&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Effective number of links&quot;</span><span class="p">:</span> <span class="s2">&quot;F_eff&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Effective number of role&quot;</span><span class="p">:</span> <span class="s2">&quot;R_eff&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">metric_function_name</span> <span class="o">=</span> <span class="n">metric_dict</span><span class="p">[</span><span class="n">metric_name</span><span class="p">]</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">_models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">metric_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">metric_function_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">metric_function</span><span class="p">):</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric_function</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Si la méthode n&#39;existe pas, on met None</span>
    <span class="k">return</span> <span class="n">metrics</span></div>



<div class="viewcode-block" id="plot_standard_graph">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.plot_standard_graph">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_standard_graph</span><span class="p">(</span><span class="n">_models</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">get_metrics_for_all_years</span><span class="p">(</span><span class="n">_models</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>

    <span class="c1"># 📊 Préparation des données pour le graphique</span>
    <span class="n">years</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
    <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="c1"># 🔄 Affichage conditionnel des labels</span>
    <span class="n">min_gap</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># ⚙️ Seuil minimum entre deux labels</span>
    <span class="n">visible_years</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">last_visible_year</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">last_visible_year</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">year</span> <span class="o">-</span> <span class="n">last_visible_year</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_gap</span><span class="p">:</span>
            <span class="n">visible_years</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">))</span>
            <span class="n">last_visible_year</span> <span class="o">=</span> <span class="n">year</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">visible_years</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Pas de label si trop proche</span>

    <span class="c1"># 🔵 Détection du thème actuel</span>
    <span class="n">current_theme</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s2">&quot;theme.base&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">current_theme</span> <span class="o">==</span> <span class="s2">&quot;light&quot;</span><span class="p">:</span>
        <span class="n">line_color</span> <span class="o">=</span> <span class="s2">&quot;royalblue&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">line_color</span> <span class="o">=</span> <span class="s2">&quot;white&quot;</span>

    <span class="c1"># 📊 Création du graphique avec Plotly</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">years</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines+markers&quot;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">metric_hist</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">line_color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;royalblue&quot;</span><span class="p">,</span> <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;circle&quot;</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;Eff&quot;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;#&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;NUE&quot;</span> <span class="ow">in</span> <span class="n">metric</span> <span class="ow">or</span> <span class="s2">&quot;Primary&quot;</span> <span class="ow">in</span> <span class="n">metric</span> <span class="ow">or</span> <span class="s2">&quot;Sufficiency&quot;</span> <span class="ow">in</span> <span class="n">metric</span> <span class="ow">or</span> <span class="s2">&quot;Relative&quot;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;Livestock density&quot;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;LU/ha&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;ktN/yr&quot;</span>

    <span class="c1"># 🎨 Personnalisation du style du graphique</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Historical Evolution of </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">metric_hist</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_hist</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span>
        <span class="n">template</span><span class="o">=</span><span class="s2">&quot;plotly_white&quot;</span><span class="p">,</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s2">&quot;x unified&quot;</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(255, 255, 255, 0.5)&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># 🔍 Amélioration des axes</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span>
        <span class="n">showgrid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">tickmode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
        <span class="n">tickvals</span><span class="o">=</span><span class="n">years</span><span class="p">,</span>
        <span class="n">ticktext</span><span class="o">=</span><span class="n">visible_years</span><span class="p">,</span>
        <span class="n">tickangle</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span>
        <span class="c1"># tickfont=dict(size=10),</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 🚀 Affichage dans Streamlit</span>
    <span class="n">st</span><span class="o">.</span><span class="n">plotly_chart</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<div class="viewcode-block" id="stacked_area_chart">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.stacked_area_chart">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">stacked_area_chart</span><span class="p">(</span><span class="n">_models</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Affiche un graphique en courbes empilées pour l&#39;évolution des surfaces cultivées</span>
<span class="sd">    avec une légende par catégorie et un hover individuel par culture.&quot;&quot;&quot;</span>

    <span class="c1"># -----------------------------------------------------------------</span>
    <span class="c1"># 1) Récupération &amp; Transformation des données</span>
    <span class="c1"># -----------------------------------------------------------------</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">get_metrics_for_all_years</span><span class="p">(</span><span class="n">_models</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>  <span class="c1"># Dict { année(str) : df_cultures }</span>

    <span class="n">all_years</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># Suppose qu&#39;on prend la première année comme référence pour l&#39;index (les cultures)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">metrics</span><span class="p">[</span><span class="n">all_years</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">all_years</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Remplir le DataFrame (Cultures x Années)</span>
    <span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">df_year</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_year</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_year</span>

    <span class="n">df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Calcul cumulatif pour l&#39;affichage empilé par colonnes</span>
    <span class="n">df_cumsum</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Ajouter une ligne &quot;Base&quot; (0) pour le fill=&#39;tonexty&#39;</span>
    <span class="n">df_cumsum</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># df_cumsum = df_cumsum.sort_index()</span>

    <span class="c1"># -----------------------------------------------------------------</span>
    <span class="c1"># 2) Création du Sankey Plotly</span>
    <span class="c1"># -----------------------------------------------------------------</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

    <span class="c1"># On veut regrouper les cultures par catégorie pour la légende</span>
    <span class="c1"># =&gt; On utilise &#39;legendgroup&#39; + &#39;showlegend&#39; seulement au 1er trace de chaque catégorie</span>
    <span class="n">categories_seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># On veut hover = seulement la courbe survolée =&gt; hovermode=&#39;closest&#39;</span>
    <span class="c1"># =&gt; On n&#39;utilise plus &#39;x unified&#39;</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;Area&quot;</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Agricultural Area - </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;Cumulated Area (ha)&quot;</span><span class="p">,</span>
            <span class="n">hovermode</span><span class="o">=</span><span class="s2">&quot;closest&quot;</span><span class="p">,</span>  <span class="c1"># ❗️ Montre seulement la courbe survolée</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Parcourir chaque culture dans l&#39;ordre de l&#39;index (df.index)</span>
        <span class="c1"># &#39;Base&#39; doit être ignoré =&gt; On ne fait pas de trace pour &#39;Base&#39;</span>
        <span class="n">cultures_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_cumsum</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;Base&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_list</span><span class="p">:</span>
            <span class="c1"># Courbe du haut = df_cumsum.loc[culture]</span>
            <span class="c1"># fill=&#39;tonexty&#39; =&gt; se remplit entre cette courbe et la précédente</span>
            <span class="c1"># =&gt; l&#39;ordre du df_cumsum doit être correct (Base, ..., culture)</span>
            <span class="c1"># Couleur en fonction de la catégorie</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="n">categories_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
            <span class="n">culture_color</span> <span class="o">=</span> <span class="n">node_color</span><span class="p">[</span><span class="n">label_to_index</span><span class="p">[</span><span class="n">culture</span><span class="p">]]</span>

            <span class="c1"># Groupe de légende = cat</span>
            <span class="c1"># On affiche la légende qu&#39;une seule fois par catégorie</span>
            <span class="n">show_in_legend</span> <span class="o">=</span> <span class="n">cat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categories_seen</span>
            <span class="k">if</span> <span class="n">show_in_legend</span><span class="p">:</span>
                <span class="n">categories_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">all_years</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">df_cumsum</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">],</span>
                    <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;tonexty&quot;</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">culture_color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span>  <span class="c1"># ❗️ Nom affiché = Catégorie</span>
                    <span class="n">legendgroup</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span>  <span class="c1"># ❗️ On groupe par Catégorie</span>
                    <span class="n">customdata</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="n">showlegend</span><span class="o">=</span><span class="n">show_in_legend</span><span class="p">,</span>  <span class="c1"># ❗️ Un seul trace par groupe dans la légende</span>
                    <span class="n">hovertemplate</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Culture: %</span><span class="si">{text}</span><span class="s2">&lt;br&gt;Year: %</span><span class="si">{x}</span><span class="s2">&lt;br&gt;Value: %</span><span class="si">{customdata:.2f}</span><span class="s2"> ha&lt;extra&gt;&lt;/extra&gt;&quot;</span><span class="p">),</span>
                    <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">culture</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_years</span><span class="p">),</span>  <span class="c1"># Pour afficher le nom de la culture au survol</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;Total plant production&quot;</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s2">&quot;secondary_y&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}]])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Agricultural Production - </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span>
            <span class="n">hovermode</span><span class="o">=</span><span class="s2">&quot;closest&quot;</span><span class="p">,</span>  <span class="c1"># ❗️ Montre seulement la courbe survolée</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Parcourir chaque culture dans l&#39;ordre de l&#39;index (df.index)</span>
        <span class="c1"># &#39;Base&#39; doit être ignoré =&gt; On ne fait pas de trace pour &#39;Base&#39;</span>
        <span class="n">cultures_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_cumsum</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;Base&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_list</span><span class="p">:</span>
            <span class="c1"># Courbe du haut = df_cumsum.loc[culture]</span>
            <span class="c1"># fill=&#39;tonexty&#39; =&gt; se remplit entre cette courbe et la précédente</span>
            <span class="c1"># =&gt; l&#39;ordre du df_cumsum doit être correct (Base, ..., culture)</span>
            <span class="c1"># Couleur en fonction de la catégorie</span>
            <span class="n">cat</span> <span class="o">=</span> <span class="n">categories_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
            <span class="n">culture_color</span> <span class="o">=</span> <span class="n">node_color</span><span class="p">[</span><span class="n">label_to_index</span><span class="p">[</span><span class="n">culture</span><span class="p">]]</span>

            <span class="c1"># Groupe de légende = cat</span>
            <span class="c1"># On affiche la légende qu&#39;une seule fois par catégorie</span>
            <span class="n">show_in_legend</span> <span class="o">=</span> <span class="n">cat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categories_seen</span>
            <span class="k">if</span> <span class="n">show_in_legend</span><span class="p">:</span>
                <span class="n">categories_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">all_years</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">df_cumsum</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">],</span>
                    <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;tonexty&quot;</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">culture_color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span>
                    <span class="n">legendgroup</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span>
                    <span class="n">customdata</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="n">showlegend</span><span class="o">=</span><span class="n">show_in_legend</span><span class="p">,</span>
                    <span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;Culture: %</span><span class="si">{text}</span><span class="s2">&lt;br&gt;Year: %</span><span class="si">{x}</span><span class="s2">&lt;br&gt;Value: %</span><span class="si">{customdata:.2f}</span><span class="s2"> ha&lt;extra&gt;&lt;/extra&gt;&quot;</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">culture</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_years</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="n">secondary_y</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Axe Y principal</span>
            <span class="p">)</span>

        <span class="n">prod_tot</span> <span class="o">=</span> <span class="n">get_metrics_for_all_years</span><span class="p">(</span><span class="n">_models</span><span class="p">,</span> <span class="s2">&quot;Area tot&quot;</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>

        <span class="c1"># Ajouter la ligne de production végétale totale</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">prod_tot</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                <span class="n">y</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">prod_tot</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines+markers&quot;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s2">&quot;dash&quot;</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Total agricultural Area&quot;</span><span class="p">,</span>
                <span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;Year: %</span><span class="si">{x}</span><span class="s2">&lt;br&gt;Value: %</span><span class="si">{y:.2f}</span><span class="s2"> ha&lt;extra&gt;&lt;/extra&gt;&quot;</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">secondary_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Axe Y secondaire (à droite)</span>
        <span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Cumulated Production (ktN/yr)&quot;</span><span class="p">,</span> <span class="n">secondary_y</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Total Area (ha)&quot;</span><span class="p">,</span> <span class="n">secondary_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;Emissions&quot;</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Nitrogen emissions - </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;kTon/yr&quot;</span><span class="p">,</span>
            <span class="n">hovermode</span><span class="o">=</span><span class="s2">&quot;closest&quot;</span><span class="p">,</span>  <span class="c1"># ❗️ Montre seulement la courbe survolée</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Parcourir chaque culture dans l&#39;ordre de l&#39;index (df.index)</span>
        <span class="c1"># &#39;Base&#39; doit être ignoré =&gt; On ne fait pas de trace pour &#39;Base&#39;</span>
        <span class="n">emissions_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_cumsum</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;Base&quot;</span><span class="p">]</span>

        <span class="n">color</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">emission</span> <span class="ow">in</span> <span class="n">emissions_list</span><span class="p">:</span>
            <span class="c1"># Courbe du haut = df_cumsum.loc[culture]</span>
            <span class="c1"># fill=&#39;tonexty&#39; =&gt; se remplit entre cette courbe et la précédente</span>
            <span class="c1"># =&gt; l&#39;ordre du df_cumsum doit être correct (Base, ..., culture)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">all_years</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">df_cumsum</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">emission</span><span class="p">],</span>
                    <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;tonexty&quot;</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">emission</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                    <span class="n">customdata</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">emission</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">emission</span><span class="p">,</span>  <span class="c1"># ❗️ Nom affiché = Catégorie</span>
                    <span class="n">hovertemplate</span><span class="o">=</span><span class="p">(</span>
                        <span class="s2">&quot;Emission: %</span><span class="si">{text}</span><span class="s2">&lt;br&gt;Year: %</span><span class="si">{x}</span><span class="s2">&lt;br&gt;Value: %</span><span class="si">{customdata:.2f}</span><span class="s2"> kton/yr&lt;extra&gt;&lt;/extra&gt;&quot;</span>
                    <span class="p">),</span>
                    <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">emission</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_years</span><span class="p">),</span>  <span class="c1"># Pour afficher le nom de la culture au survol</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;Total Fertilization&quot;</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Total Fertilization Use - </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;ktN&quot;</span><span class="p">,</span>
            <span class="n">hovermode</span><span class="o">=</span><span class="s2">&quot;closest&quot;</span><span class="p">,</span>  <span class="c1"># ❗️ Montre seulement la courbe survolée</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Parcourir chaque culture dans l&#39;ordre de l&#39;index (df.index)</span>
        <span class="c1"># &#39;Base&#39; doit être ignoré =&gt; On ne fait pas de trace pour &#39;Base&#39;</span>
        <span class="n">emissions_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_cumsum</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;Base&quot;</span><span class="p">]</span>

        <span class="n">color</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Atmospheric deposition&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Mining&quot;</span><span class="p">:</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Seeds&quot;</span><span class="p">:</span> <span class="s2">&quot;pink&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Animal excretion&quot;</span><span class="p">:</span> <span class="s2">&quot;lightblue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Human excretion&quot;</span><span class="p">:</span> <span class="s2">&quot;darkblue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Leguminous soil enrichment&quot;</span><span class="p">:</span> <span class="s2">&quot;darkgreen&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">emission</span> <span class="ow">in</span> <span class="n">emissions_list</span><span class="p">:</span>
            <span class="c1"># Courbe du haut = df_cumsum.loc[culture]</span>
            <span class="c1"># fill=&#39;tonexty&#39; =&gt; se remplit entre cette courbe et la précédente</span>
            <span class="c1"># =&gt; l&#39;ordre du df_cumsum doit être correct (Base, ..., culture)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">all_years</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">df_cumsum</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">emission</span><span class="p">],</span>
                    <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;tonexty&quot;</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">emission</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                    <span class="n">customdata</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">emission</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">emission</span><span class="p">,</span>  <span class="c1"># ❗️ Nom affiché = Catégorie</span>
                    <span class="n">hovertemplate</span><span class="o">=</span><span class="p">(</span>
                        <span class="s2">&quot;Fertilization vector: %</span><span class="si">{text}</span><span class="s2">&lt;br&gt;Year: %</span><span class="si">{x}</span><span class="s2">&lt;br&gt;Value: %</span><span class="si">{customdata:.2f}</span><span class="s2"> ktN/yr&lt;extra&gt;&lt;/extra&gt;&quot;</span>
                    <span class="p">),</span>
                    <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">emission</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_years</span><span class="p">),</span>  <span class="c1"># Pour afficher le nom de la culture au survol</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">prod_tot</span> <span class="o">=</span> <span class="n">get_metrics_for_all_years</span><span class="p">(</span><span class="n">_models</span><span class="p">,</span> <span class="s2">&quot;Total plant production&quot;</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>

        <span class="c1"># Ajouter la ligne de production végétale totale</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">prod_tot</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>  <span class="c1"># Clés du dictionnaire comme années</span>
                <span class="n">y</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">prod_tot</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>  <span class="c1"># Valeurs du dictionnaire comme données</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines+markers&quot;</span><span class="p">,</span>  <span class="c1"># Ligne avec des marqueurs</span>
                <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s2">&quot;dash&quot;</span><span class="p">),</span>  <span class="c1"># Ligne noire en pointillés pour la distinguer</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Total Plant Production&quot;</span><span class="p">,</span>  <span class="c1"># Légende</span>
                <span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;Year: %</span><span class="si">{x}</span><span class="s2">&lt;br&gt;Value: %</span><span class="si">{y:.2f}</span><span class="s2"> ktN/yr&lt;extra&gt;&lt;/extra&gt;&quot;</span><span class="p">,</span>  <span class="c1"># Tooltip personnalisé</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;Relative Fertilization&quot;</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Relative Fertilization Use - </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;%&quot;</span><span class="p">,</span>
            <span class="n">hovermode</span><span class="o">=</span><span class="s2">&quot;closest&quot;</span><span class="p">,</span>  <span class="c1"># ❗️ Montre seulement la courbe survolée</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Parcourir chaque culture dans l&#39;ordre de l&#39;index (df.index)</span>
        <span class="c1"># &#39;Base&#39; doit être ignoré =&gt; On ne fait pas de trace pour &#39;Base&#39;</span>
        <span class="n">emissions_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_cumsum</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;Base&quot;</span><span class="p">]</span>

        <span class="n">color</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Atmospheric deposition&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Mining&quot;</span><span class="p">:</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Seeds&quot;</span><span class="p">:</span> <span class="s2">&quot;pink&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Animal excretion&quot;</span><span class="p">:</span> <span class="s2">&quot;lightblue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Human excretion&quot;</span><span class="p">:</span> <span class="s2">&quot;darkblue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Leguminous soil enrichment&quot;</span><span class="p">:</span> <span class="s2">&quot;darkgreen&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">emission</span> <span class="ow">in</span> <span class="n">emissions_list</span><span class="p">:</span>
            <span class="c1"># Courbe du haut = df_cumsum.loc[culture]</span>
            <span class="c1"># fill=&#39;tonexty&#39; =&gt; se remplit entre cette courbe et la précédente</span>
            <span class="c1"># =&gt; l&#39;ordre du df_cumsum doit être correct (Base, ..., culture)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">all_years</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">df_cumsum</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">emission</span><span class="p">],</span>
                    <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;tonexty&quot;</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">emission</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                    <span class="n">customdata</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">emission</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">emission</span><span class="p">,</span>  <span class="c1"># ❗️ Nom affiché = Catégorie</span>
                    <span class="n">hovertemplate</span><span class="o">=</span><span class="p">(</span>
                        <span class="s2">&quot;Fertilization vector: %</span><span class="si">{text}</span><span class="s2">&lt;br&gt;Year: %</span><span class="si">{x}</span><span class="s2">&lt;br&gt;Value: %</span><span class="si">{customdata:.2f}</span><span class="s2"> %&lt;extra&gt;&lt;/extra&gt;&quot;</span>
                    <span class="p">),</span>
                    <span class="n">text</span><span class="o">=</span><span class="p">[</span><span class="n">emission</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_years</span><span class="p">),</span>  <span class="c1"># Pour afficher le nom de la culture au survol</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;Environmental Footprint&quot;</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Local Food&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Local Feed&quot;</span><span class="p">:</span> <span class="s2">&quot;lightgreen&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Import Food&quot;</span><span class="p">:</span> <span class="s2">&quot;lightgray&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Import Feed&quot;</span><span class="p">:</span> <span class="s2">&quot;darkgray&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Import Livestock&quot;</span><span class="p">:</span> <span class="s2">&quot;cyan&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Export Livestock&quot;</span><span class="p">:</span> <span class="s2">&quot;lightblue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Export Feed&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Export Food&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">color</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Local – bleus</span>
            <span class="s2">&quot;Local Food&quot;</span><span class="p">:</span> <span class="s2">&quot;#1f77b4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Local Feed&quot;</span><span class="p">:</span> <span class="s2">&quot;#5fa2ce&quot;</span><span class="p">,</span>
            <span class="c1"># Import – violets</span>
            <span class="s2">&quot;Import Food&quot;</span><span class="p">:</span> <span class="s2">&quot;#9467bd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Import Feed&quot;</span><span class="p">:</span> <span class="s2">&quot;#b799d3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Import Livestock&quot;</span><span class="p">:</span> <span class="s2">&quot;#d4c2e5&quot;</span><span class="p">,</span>
            <span class="c1"># Export – rouges / corail</span>
            <span class="s2">&quot;Export Food&quot;</span><span class="p">:</span> <span class="s2">&quot;#d62728&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Export Feed&quot;</span><span class="p">:</span> <span class="s2">&quot;#ff796c&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Export Livestock&quot;</span><span class="p">:</span> <span class="s2">&quot;#ffb1a8&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">net_curve_color</span> <span class="o">=</span> <span class="s2">&quot;#c48b00&quot;</span>  <span class="c1"># très lisible sur fond noir</span>

        <span class="c1"># Séparer les catégories</span>
        <span class="n">import_categories</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Import Food&quot;</span><span class="p">,</span> <span class="s2">&quot;Import Feed&quot;</span><span class="p">,</span> <span class="s2">&quot;Import Livestock&quot;</span><span class="p">,</span> <span class="s2">&quot;Local Food&quot;</span><span class="p">,</span> <span class="s2">&quot;Local Feed&quot;</span><span class="p">]</span>
        <span class="n">export_categories</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Export Food&quot;</span><span class="p">,</span> <span class="s2">&quot;Export Feed&quot;</span><span class="p">,</span> <span class="s2">&quot;Export Livestock&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">import_categories</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">all_years</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>  <span class="c1"># pas de cumul</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>  <span class="c1"># juste l&#39;aire</span>
                    <span class="n">stackgroup</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">,</span>  <span class="c1"># pile positive</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">fillcolor</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                    <span class="n">customdata</span><span class="o">=</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">hovertemplate</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;/b&gt;&lt;br&gt;Year %</span><span class="se">{{</span><span class="s2">x</span><span class="se">}}</span><span class="s2">&lt;br&gt;%</span><span class="se">{{</span><span class="s2">customdata[0]:.2f</span><span class="se">}}</span><span class="s2"> M ha&lt;extra&gt;&lt;/extra&gt;&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># -------- EXPORTS (négatifs) -------------------------------</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">export_categories</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">all_years</span><span class="p">,</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>  <span class="c1"># on passe en négatif</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                    <span class="n">stackgroup</span><span class="o">=</span><span class="s2">&quot;n&quot;</span><span class="p">,</span>  <span class="c1"># pile négative</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">fillcolor</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                    <span class="n">customdata</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">hovertemplate</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&lt;b&gt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&lt;/b&gt;&lt;br&gt;Year %</span><span class="se">{{</span><span class="s2">x</span><span class="se">}}</span><span class="s2">&lt;br&gt;%</span><span class="se">{{</span><span class="s2">customdata[0]:.2f</span><span class="se">}}</span><span class="s2"> M ha&lt;extra&gt;&lt;/extra&gt;&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Calculer le total importé - exporté</span>
        <span class="n">df_total_import</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;Import Food&quot;</span><span class="p">,</span> <span class="s2">&quot;Import Feed&quot;</span><span class="p">,</span> <span class="s2">&quot;Import Livestock&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df_total_export</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">export_categories</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df_net_import_export</span> <span class="o">=</span> <span class="n">df_total_import</span> <span class="o">+</span> <span class="n">df_total_export</span>

        <span class="c1"># Ajouter la ligne total</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">all_years</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">df_net_import_export</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines+markers&quot;</span><span class="p">,</span>
                <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">net_curve_color</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s2">&quot;dash&quot;</span>
                <span class="p">),</span>  <span class="c1"># line=dict(color=&quot;Black&quot;, width=4, dash=&quot;dash&quot;),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Net Land Import&quot;</span><span class="p">,</span>
                <span class="n">hovertemplate</span><span class="o">=</span><span class="s2">&quot;Year: %</span><span class="si">{x}</span><span class="s2">&lt;br&gt;Value: %</span><span class="si">{customdata:.2f}</span><span class="s2"> Mha&lt;extra&gt;&lt;/extra&gt;&quot;</span><span class="p">,</span>
                <span class="n">customdata</span><span class="o">=</span><span class="n">df_net_import_export</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span>  <span class="c1"># Utiliser les valeurs non cumulées pour le hover, divisées par 1e6</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Mise à jour du layout</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Environmental Footprint - </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;ha&quot;</span><span class="p">,</span>
            <span class="c1"># hovermode=&quot;closest&quot;,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">hovermode</span><span class="o">=</span><span class="s2">&quot;x unified&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># -----------------------------------------------------------------</span>
    <span class="c1"># 3) Affichage</span>
    <span class="c1"># -----------------------------------------------------------------</span>
    <span class="n">st</span><span class="o">.</span><span class="n">plotly_chart</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>



<span class="k">with</span> <span class="n">tab6</span><span class="p">:</span>
    <span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Historic evolution of agrarian landscape&quot;</span><span class="p">)</span>

    <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;Discover how agriculture changes during time. Choose a metric and a territory :&quot;</span><span class="p">)</span>

    <span class="n">metric_hist</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;Total imported nitrogen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total net plant import&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total net animal import&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total plant production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total animal production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Area&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Environmental Footprint&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Total Fertilization&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Fertilization&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Primary Nitrogen fertilization use&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Emissions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NUE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;System NUE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Self-Sufficiency&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Livestock density&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Cereals production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Leguminous production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Grassland and forage production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Roots production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Oleaginous production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Fruits and vegetables production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Cereals production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Leguminous production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Grassland and forage production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Roots production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Oleaginous production&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Relative Fruits and vegetables production&quot;</span><span class="p">,</span>
        <span class="c1"># &quot;Effective number of nodes&quot;,</span>
        <span class="c1"># &quot;Effective connectivity&quot;,</span>
        <span class="c1"># &quot;Effective number of links&quot;,</span>
        <span class="c1"># &quot;Effective number of role&quot;,</span>
    <span class="p">]</span>

    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">metric_hist</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s2">&quot;Select a metric&quot;</span><span class="p">,</span> <span class="n">metric_hist</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;hist_metric_selection&quot;</span><span class="p">)</span>

    <span class="n">m_hist</span> <span class="o">=</span> <span class="n">create_map</span><span class="p">()</span>
    <span class="n">map_data_hist</span> <span class="o">=</span> <span class="n">st_folium</span><span class="p">(</span><span class="n">m_hist</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;hist_map&quot;</span><span class="p">)</span>

    <span class="c1"># 🔹 Mettre à jour `st.session_state.selected_region` avec la sélection utilisateur</span>
    <span class="k">if</span> <span class="n">map_data_hist</span> <span class="ow">and</span> <span class="s2">&quot;last_active_drawing&quot;</span> <span class="ow">in</span> <span class="n">map_data_hist</span><span class="p">:</span>
        <span class="n">last_drawing</span> <span class="o">=</span> <span class="n">map_data_hist</span><span class="p">[</span><span class="s2">&quot;last_active_drawing&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">last_drawing</span> <span class="ow">and</span> <span class="s2">&quot;properties&quot;</span> <span class="ow">in</span> <span class="n">last_drawing</span> <span class="ow">and</span> <span class="s2">&quot;nom&quot;</span> <span class="ow">in</span> <span class="n">last_drawing</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_hist</span> <span class="o">=</span> <span class="n">last_drawing</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;nom&quot;</span><span class="p">]</span>

    <span class="c1"># ✅ Affichage des sélections (se met à jour dynamiquement)</span>
    <span class="k">if</span> <span class="s2">&quot;selected_region_hist&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_hist</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_hist</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Région sélectionnée : </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_hist</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;⚠️ Veuillez sélectionner une région&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;Run&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;map_button_hist&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;🚀 Running models and calculating metrics...&quot;</span><span class="p">):</span>
            <span class="c1"># 📌 Exécuter les modèles et récupérer les métriques</span>
            <span class="n">models</span> <span class="o">=</span> <span class="n">run_models_for_all_years</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_hist</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">metric_hist</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;Area&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Emissions&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Relative Fertilization&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Total Fertilization&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Total plant production&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Environmental Footprint&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="n">plot_standard_graph</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">metric_hist</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_hist</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stacked_area_chart</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">metric_hist</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_hist</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tab7</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Scenario generator&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;Welcome to the prospective mode. Here you can imagine the future of agriculture according to your vision.&quot;</span>
        <span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;How to proceed ?&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="s2">&quot;You have to fill a scenario excel. Several tokens are needed to run the model in prospective mode. They are splitted in 3 tabs :&quot;</span>
        <span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
            <span class="s2">&quot;- Main: In this tab, you have to fill the main characteristics of the future of your territory : population, access to international trade, access to industrial input...&quot;</span>
        <span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
            <span class="s2">&quot;- Area: In this tab, you have to distribute the total agricultural area between crops and check the parameters of the production function. The production function gives the yield (Y) in function of the fertilisation amount (F). There is one set of parameters by crop type. The parameters of this function depend of the production function chosen :&quot;</span>
        <span class="p">)</span>
        <span class="c1"># st.markdown(&quot;The yield is computed as $Y = Y_{\\text{max}} \\cdot (1 - e^{-F/k})$&quot;)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot; Ratio: $Y(F) = </span><span class="se">\\</span><span class="s2">frac{Y_</span><span class="si">{max}</span><span class="s2">F}{Y_</span><span class="si">{max}</span><span class="s2">+F}$&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot; Linear: $Y(F) = min(a*F, b)$&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot; Exponential: $Y(F) = Y_</span><span class="si">{max}</span><span class="s2">(1-e^{F/F^*})$&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
            <span class="s2">&quot;- Technical: This tab encompass all technical coefficient (excretion per LU, weight of the optimization model, time spend by livestock in crops). It reflects potential technical evolution in agriculture and physical constraints.&quot;</span>
        <span class="p">)</span>

        <span class="c1">#     st.subheader(&quot;Scenario file&quot;)</span>

        <span class="c1">#     st.markdown(</span>
        <span class="c1">#         &quot;Here you can find a blank scenario sheet. Please fill all items in main and technical tabs. Fill as many lines in area as you need crops. Make sure the sum of proportion column is 1 and for each crop $Y_{max}$&lt;$k$.&quot;</span>
        <span class="c1">#     )</span>

        <span class="c1">#     # Absolute path to the folder where the script is located</span>
        <span class="c1">#     base_path = os.path.dirname(os.path.abspath(__file__))</span>

        <span class="c1">#     # Join with your relative file</span>
        <span class="c1">#     file_path = os.path.join(base_path, &quot;data&quot;, &quot;scenario.xlsx&quot;)</span>
        <span class="c1">#     # Read the binary content of the file</span>
        <span class="c1">#     with open(file_path, &quot;rb&quot;) as file:</span>
        <span class="c1">#         file_bytes = file.read()</span>

        <span class="c1">#     # Create the download button</span>
        <span class="c1">#     st.download_button(</span>
        <span class="c1">#         label=&quot;📥 Download blank Scenario Excel&quot;,</span>
        <span class="c1">#         data=file_bytes,</span>
        <span class="c1">#         file_name=&quot;scenario.xlsx&quot;,</span>
        <span class="c1">#         mime=&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;,</span>
        <span class="c1">#     )</span>

        <span class="c1">#     st.markdown(&quot;Once you have your scenario ready, go to Prospective mode tab.&quot;)</span>

        <span class="c1">#     st.subheader(&quot;Hard to find these numbers ?&quot;)</span>
        <span class="c1">#     st.text(</span>
        <span class="c1">#         &quot;It might be hard to create from scratch a physical functioning agro-system. To oversome this difficulty, you can use the scenario generator. To do so, choose a territory, a futur year. The scenario generator will automatically create a &#39;Business as usual&#39; scenario. This scenario is created based on historical trajectory of the territory.&quot;</span>
        <span class="c1">#     )</span>

        <span class="c1">#     st.title(&quot;Scenario Generator&quot;)</span>

        <span class="c1"># 🟢 Sélection de l&#39;année</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">pros_year</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span>
            <span class="s2">&quot;Select a year&quot;</span><span class="p">,</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2025</span><span class="p">,</span> <span class="mi">2061</span><span class="p">)],</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;year_pros_selection&quot;</span>
        <span class="p">)</span>
        <span class="c1"># 🟢 Sélection de la fonction de production</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">pros_func</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span>
            <span class="s2">&quot;Select Production function&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;Linear&quot;</span><span class="p">,</span> <span class="s2">&quot;Exponential&quot;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;func_pros_selection&quot;</span>
        <span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s2">&quot;Scenario name&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;scenario_name_input&quot;</span><span class="p">)</span>

        <span class="n">m_hist</span> <span class="o">=</span> <span class="n">create_map</span><span class="p">()</span>
        <span class="n">map_data_pros</span> <span class="o">=</span> <span class="n">st_folium</span><span class="p">(</span><span class="n">m_hist</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;pros_map&quot;</span><span class="p">)</span>

        <span class="c1"># 🔹 Mettre à jour `st.session_state.selected_region` avec la sélection utilisateur</span>
        <span class="k">if</span> <span class="n">map_data_pros</span> <span class="ow">and</span> <span class="s2">&quot;last_active_drawing&quot;</span> <span class="ow">in</span> <span class="n">map_data_pros</span><span class="p">:</span>
            <span class="n">last_drawing</span> <span class="o">=</span> <span class="n">map_data_pros</span><span class="p">[</span><span class="s2">&quot;last_active_drawing&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">last_drawing</span> <span class="ow">and</span> <span class="s2">&quot;properties&quot;</span> <span class="ow">in</span> <span class="n">last_drawing</span> <span class="ow">and</span> <span class="s2">&quot;nom&quot;</span> <span class="ow">in</span> <span class="n">last_drawing</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_pros</span> <span class="o">=</span> <span class="n">last_drawing</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;nom&quot;</span><span class="p">]</span>

        <span class="c1"># ✅ Affichage des sélections (se met à jour dynamiquement)</span>
        <span class="k">if</span> <span class="s2">&quot;selected_region_pros&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_pros</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_pros</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Région sélectionnée : </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_pros</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;⚠️ Veuillez sélectionner une région&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="generate_scenario">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.generate_scenario">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="nf">generate_scenario</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
            <span class="n">scenar</span><span class="o">.</span><span class="n">generate_scenario_excel</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span></div>


        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;Create business as usual scenario&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;map_button_scenario&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Generating the business as usual scenario...&quot;</span><span class="p">):</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">scenario_name_input</span>
                    <span class="n">scenar</span> <span class="o">=</span> <span class="n">scenario</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
                    <span class="c1"># threading.Thread(</span>
                    <span class="c1">#     target=generate_scenario,</span>
                    <span class="c1">#     args=(</span>
                    <span class="c1">#         st.session_state.pros_year,</span>
                    <span class="c1">#         st.session_state.selected_region_pros,</span>
                    <span class="c1">#         st.session_state.name,</span>
                    <span class="c1">#         st.session_state.pros_func,</span>
                    <span class="c1">#     ),</span>
                    <span class="c1">#     daemon=True,</span>
                    <span class="c1"># ).start()</span>
                    <span class="n">generate_scenario</span><span class="p">(</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">pros_year</span><span class="p">,</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_pros</span><span class="p">,</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">pros_func</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.xlsx&quot;</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">file_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">download_button</span><span class="p">(</span>
                        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;📥 Download scenario sheet&quot;</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">file_data</span><span class="p">,</span>
                        <span class="n">file_name</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.xlsx&quot;</span><span class="p">,</span>
                        <span class="n">mime</span><span class="o">=</span><span class="s2">&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;Once you have your scenario ready, go to Prospective mode tab.&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">tab8</span><span class="p">:</span>
        <span class="n">st</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Prospective mode&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;How to use GRAFS-E Prospective Mode&quot;</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;To run the prospective mode, two options are available:\\</span>
<span class="sd">        1. **Upload an Excel sheet scenario** then click *Run scenario*  </span>
<span class="sd">        2. **Upload a model \*.pkl** saved from a previous session&quot;&quot;&quot;</span>
        <span class="p">)</span>

        <span class="c1"># ─────────── A • Excel scenario</span>
        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;① Excel scenario → Run&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="excel_uploaded">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.excel_uploaded">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="nf">excel_uploaded</span><span class="p">():</span>
            <span class="c1"># if st.session_state.excel_uploaded_done:</span>
            <span class="c1">#     return</span>
            <span class="n">up</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;xlsx_up&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">up</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.xlsx&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp</span><span class="p">:</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">up</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_xlsx_path</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">name</span>

            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_xlsx_path</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_name</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_region</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_func</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span></div>


        <span class="n">st</span><span class="o">.</span><span class="n">file_uploader</span><span class="p">(</span><span class="s2">&quot;📂 Upload .xlsx&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;xlsx&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;xlsx_up&quot;</span><span class="p">,</span> <span class="n">on_change</span><span class="o">=</span><span class="n">excel_uploaded</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_name</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Scenario: **</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_name</span><span class="si">}</span><span class="s2">**  &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_region</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_year</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_func</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;🚀 Run scenario&quot;</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="s2">&quot;Running prospective model…&quot;</span><span class="p">):</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">NitrogenFlowModel_prospect</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_xlsx_path</span><span class="p">)</span>
                    <span class="c1"># remplir les variables finales</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">orig</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_name</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year_pros</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_year</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year_pros</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_pros</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_region</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_pros</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prep_func</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">heatmap_fig_pros</span> <span class="o">=</span> <span class="n">generate_heatmap</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">excel_uploaded_done</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
                    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>
                    <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">pkl_blob</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
                <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Model generated!&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">rerun</span><span class="p">()</span>
                <span class="c1"># on peut laisser Streamlit relancer automatiquement (pas de st.rerun)</span>

        <span class="c1"># ─────────── B • Load .pkl</span>
        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;② Load existing model (.pkl)&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="load_pkl">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.app.load_pkl">[docs]</a>
        <span class="k">def</span><span class="w"> </span><span class="nf">load_pkl</span><span class="p">():</span>
            <span class="n">up</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s2">&quot;pkl_up&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">up</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">up</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">NitrogenFlowModel_prospect</span><span class="p">):</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">load_error</span> <span class="o">=</span> <span class="s2">&quot;⛔️ Wrong file.&quot;</span>
                    <span class="k">return</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">obj</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">up</span><span class="o">.</span><span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year_pros</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">year</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">year</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_pros</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">region</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">region</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">prod_func</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">heatmap_fig_pros</span> <span class="o">=</span> <span class="n">generate_heatmap</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">pkl_blob</span> <span class="o">=</span> <span class="n">up</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">load_error</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">load_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


        <span class="n">st</span><span class="o">.</span><span class="n">file_uploader</span><span class="p">(</span><span class="s2">&quot;📥 Upload .pkl&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;pickle&quot;</span><span class="p">,</span> <span class="s2">&quot;joblib&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;pkl_up&quot;</span><span class="p">,</span> <span class="n">on_change</span><span class="o">=</span><span class="n">load_pkl</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">load_error</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">load_error</span><span class="p">)</span>

        <span class="c1"># ─────────── C • Résultats</span>
        <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="s2">&quot;Active model&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No model loaded or generated yet.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Model ready&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;📘 Name : **</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">**  </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;🗺️ Region : **</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_pros</span><span class="si">}</span><span class="s2">**  </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;📆 Year : **</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year_pros</span><span class="si">}</span><span class="s2">**  </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;⚙️ Prod. function : **</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prod_func</span><span class="si">}</span><span class="s2">**&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">pkl_blob</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">download_button</span><span class="p">(</span>
                    <span class="s2">&quot;💾 Download this model&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">pkl_blob</span><span class="p">,</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">,</span>
                    <span class="n">mime</span><span class="o">=</span><span class="s2">&quot;application/octet-stream&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;🔄 Reset model&quot;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;model&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;year_pros&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;selected_region_pros&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;prod_func&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;heatmap_fig_pros&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;pkl_blob&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">excel_uploaded_done</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">st</span><span class="o">.</span><span class="n">rerun</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">heatmap_fig_pros</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Total Throughflow : </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get_transition_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> ktN/yr.&quot;</span>
                <span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">subheader</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Heatmap – </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">selected_region_pros</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">year_pros</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">plotly_chart</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">heatmap_fig_pros</span><span class="p">,</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025, Adrien Fauste-Gay.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>