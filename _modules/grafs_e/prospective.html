
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>grafs_e.prospective &#8212; GRAFS-E 01/02/25 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=390ba95b"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/grafs_e/prospective';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">GRAFS-E 01/02/25 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../grafs_e.html" class="nav-link">grafs_e</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">grafs_e.prospective</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for grafs_e.prospective</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span><span class="p">,</span> <span class="n">as_completed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyomo.contrib.appsi.solvers</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_appsi_solvers</span>  <span class="c1"># active les solveurs APPSI</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogNorm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyomo.environ</span><span class="w"> </span><span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span><span class="p">,</span> <span class="n">minimize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">linregress</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">r2_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">grafs_e.graphes_objet</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grafs_e.donnees</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grafs_e.N_class</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">FluxGenerator</span><span class="p">,</span> <span class="n">NitrogenFlowModel</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">_appsi_solvers</span>


<div class="viewcode-block" id="scenario">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.scenario">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">scenario</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads and prepares scenario input sheets for prospective nitrogen flow modeling.</span>

<span class="sd">    This class is used to initialize and manage scenario-specific data, which can be integrated</span>
<span class="sd">    into the `NitrogenFlowModel` to simulate future or alternative configurations of agro-food systems.</span>

<span class="sd">    It either takes a pre-initialized `DataLoader` instance or initializes one internally if not provided.</span>

<span class="sd">    :param scenario_path: Path to the scenario configuration file or directory.</span>
<span class="sd">    :type scenario_path: str</span>
<span class="sd">    :param dataloader: Optional pre-loaded DataLoader instance. If None, a default one is initialized.</span>
<span class="sd">    :type dataloader: DataLoader, optional</span>

<span class="sd">    :ivar scenario_path: Absolute path to the scenario data file.</span>
<span class="sd">    :vartype scenario_path: str</span>
<span class="sd">    :ivar dataloader: Instance of the DataLoader used to retrieve or modify base data.</span>
<span class="sd">    :vartype dataloader: DataLoader</span>
<span class="sd">    :ivar data_path: Path to the general data folder used for model input files.</span>
<span class="sd">    :vartype data_path: str</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenario_path</span><span class="p">,</span> <span class="n">dataloader</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;src&quot;</span><span class="p">,</span> <span class="s2">&quot;grafs_e&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataloader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span> <span class="o">=</span> <span class="n">dataloader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scenario_path</span> <span class="o">=</span> <span class="n">scenario_path</span>

<div class="viewcode-block" id="scenario.historic_trend">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.scenario.historic_trend">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">historic_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">excel_line</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts the historical trend of a value for a given region and Excel row in GRAFS_full.xslx.</span>

<span class="sd">        :param region: The region of interest.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :param excel_line: The row identifier (Excel line) to track.</span>
<span class="sd">        :type excel_line: int</span>
<span class="sd">        :return: List of historical values over available years.</span>
<span class="sd">        :rtype: list[float]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">L</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">annees_disponibles</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">pre_process_df</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
            <span class="n">L</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">excel_line</span><span class="p">,</span> <span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">L</span></div>


<div class="viewcode-block" id="scenario.LU_excretion">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.scenario.LU_excretion">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">LU_excretion</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes average nitrogen excretion per livestock unit (LU) by species over time.</span>

<span class="sd">        :param dataloader: The DataLoader object to use.</span>
<span class="sd">        :type dataloader: DataLoader</span>
<span class="sd">        :param region: Region name.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :param t: Optional key to extract values at a specific year.</span>
<span class="sd">        :type t: str or int, optional</span>
<span class="sd">        :return: Dictionary (or list) of excretion values by livestock type.</span>
<span class="sd">        :rtype: dict or list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">L</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">livestock</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bovines&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">1150</span><span class="p">,</span> <span class="mi">1164</span><span class="p">),</span> <span class="p">(</span><span class="mi">1196</span><span class="p">,</span> <span class="mi">1210</span><span class="p">)],</span>
            <span class="s2">&quot;caprines&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">1166</span><span class="p">,</span> <span class="mi">1168</span><span class="p">),</span> <span class="p">(</span><span class="mi">1212</span><span class="p">,</span> <span class="mi">1214</span><span class="p">)],</span>
            <span class="s2">&quot;ovines&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">1170</span><span class="p">,</span> <span class="mi">1172</span><span class="p">),</span> <span class="p">(</span><span class="mi">1216</span><span class="p">,</span> <span class="mi">1218</span><span class="p">)],</span>
            <span class="s2">&quot;porcines&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">1174</span><span class="p">,</span> <span class="mi">1178</span><span class="p">),</span> <span class="p">(</span><span class="mi">1220</span><span class="p">,</span> <span class="mi">1224</span><span class="p">)],</span>
            <span class="s2">&quot;poultry&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">1180</span><span class="p">,</span> <span class="mi">1190</span><span class="p">),</span> <span class="p">(</span><span class="mi">1226</span><span class="p">,</span> <span class="mi">1236</span><span class="p">)],</span>
            <span class="s2">&quot;equines&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">1192</span><span class="p">,</span> <span class="mi">1193</span><span class="p">),</span> <span class="p">(</span><span class="mi">1238</span><span class="p">,</span> <span class="mi">1239</span><span class="p">)],</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">annees_disponibles</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">dataloader</span><span class="o">.</span><span class="n">pre_process_df</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
            <span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">livestock</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">heads</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">livestock</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">livestock</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="n">region</span><span class="p">]</span>
                <span class="n">heads_type</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">livestock</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">livestock</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="s2">&quot;nom&quot;</span><span class="p">]</span>
                <span class="c1"># Récupérer les coefficients LU correspondant à chaque type</span>
                <span class="n">Lu</span> <span class="o">=</span> <span class="n">heads_type</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">lu_coefficients</span><span class="p">)</span>
                <span class="c1"># Calcul total LU</span>
                <span class="n">LU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">heads</span><span class="p">,</span> <span class="n">Lu</span><span class="p">)</span>
                <span class="n">excr_cap</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">livestock</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">livestock</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="n">region</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">heads</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">L</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">heads</span><span class="p">,</span> <span class="n">excr_cap</span><span class="p">)</span> <span class="o">/</span> <span class="n">LU</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">L</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">L</span></div>


<div class="viewcode-block" id="scenario.livestock_LU">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.scenario.livestock_LU">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">livestock_LU</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the number of livestock units (LU) per species over time.</span>

<span class="sd">        :param dataloader: The DataLoader object to use.</span>
<span class="sd">        :type dataloader: DataLoader</span>
<span class="sd">        :param region: Region name.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :param t: Optional key to extract values at a specific year.</span>
<span class="sd">        :type t: str or int, optional</span>
<span class="sd">        :return: Dictionary (or list) of LU values by species.</span>
<span class="sd">        :rtype: dict or list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LU</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">livestock</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bovines&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">1150</span><span class="p">,</span> <span class="mi">1164</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">)],</span>
            <span class="s2">&quot;caprines&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">1166</span><span class="p">,</span> <span class="mi">1168</span><span class="p">),</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">18</span><span class="p">)],</span>
            <span class="s2">&quot;ovines&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">1170</span><span class="p">,</span> <span class="mi">1172</span><span class="p">),</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">21</span><span class="p">)],</span>
            <span class="s2">&quot;porcines&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">1174</span><span class="p">,</span> <span class="mi">1178</span><span class="p">),</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">26</span><span class="p">)],</span>
            <span class="s2">&quot;poultry&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">1180</span><span class="p">,</span> <span class="mi">1190</span><span class="p">),</span> <span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">37</span><span class="p">)],</span>
            <span class="s2">&quot;equines&quot;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">1192</span><span class="p">,</span> <span class="mi">1193</span><span class="p">),</span> <span class="p">(</span><span class="mi">37</span><span class="p">,</span> <span class="mi">39</span><span class="p">)],</span>
        <span class="p">}</span>
        <span class="n">lu_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lu_coefficients</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">annees_disponibles</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">dataloader</span><span class="o">.</span><span class="n">pre_process_df</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
            <span class="n">LU</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">livestock</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">heads</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">livestock</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">livestock</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="n">region</span><span class="p">]</span>
                <span class="n">lu_coef</span> <span class="o">=</span> <span class="n">lu_list</span><span class="p">[</span><span class="n">livestock</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">livestock</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
                <span class="n">LU</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">heads</span><span class="p">,</span> <span class="n">lu_coef</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">LU</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">LU</span></div>


<div class="viewcode-block" id="scenario.LU_prod">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.scenario.LU_prod">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">LU_prod</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes productivity (and dairy productivity) per LU for each livestock species.</span>

<span class="sd">        :param dataloader: The DataLoader object to use.</span>
<span class="sd">        :type dataloader: DataLoader</span>
<span class="sd">        :param region: Region name.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :param t: Optional key to extract values at a specific year.</span>
<span class="sd">        :type t: str or int, optional</span>
<span class="sd">        :return: Dictionary (or list) of productivity values.</span>
<span class="sd">        :rtype: dict or list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LU_prod</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bovines&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1017</span><span class="p">,</span> <span class="mi">1024</span><span class="p">],</span>
            <span class="s2">&quot;ovines&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1018</span><span class="p">,</span> <span class="mi">1025</span><span class="p">],</span>
            <span class="s2">&quot;caprines&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1019</span><span class="p">],</span>
            <span class="s2">&quot;equines&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1022</span><span class="p">],</span>
            <span class="s2">&quot;porcines&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1020</span><span class="p">],</span>
            <span class="s2">&quot;poultry&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1021</span><span class="p">,</span> <span class="mi">1023</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">LU</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">livestock_LU</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">annees_disponibles</span><span class="p">:</span>
            <span class="n">LU_prod</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">dataloader</span><span class="o">.</span><span class="n">pre_process_df</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
            <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">index</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">LU</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="nb">type</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">LU_prod</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2"> productivity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bovines&quot;</span><span class="p">,</span> <span class="s2">&quot;ovines&quot;</span><span class="p">,</span> <span class="s2">&quot;caprines&quot;</span><span class="p">,</span> <span class="s2">&quot;poultry&quot;</span><span class="p">]:</span>
                        <span class="n">LU_prod</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2"> dairy productivity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LU_prod</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2"> productivity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">index</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="n">LU</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="nb">type</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bovines&quot;</span><span class="p">,</span> <span class="s2">&quot;ovines&quot;</span><span class="p">,</span> <span class="s2">&quot;caprines&quot;</span><span class="p">,</span> <span class="s2">&quot;poultry&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ovines&quot;</span><span class="p">,</span> <span class="s2">&quot;caprines&quot;</span><span class="p">]:</span>
                            <span class="n">LU_prod</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2"> dairy productivity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">index</span><span class="p">[</span><span class="s2">&quot;ovines&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                                <span class="o">*</span> <span class="n">LU</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="nb">type</span><span class="p">]</span>
                                <span class="o">/</span> <span class="p">(</span><span class="n">LU</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;ovines&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">LU</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;caprines&quot;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
                                <span class="o">*</span> <span class="mf">1e6</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">LU_prod</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2"> dairy productivity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">index</span><span class="p">[</span><span class="nb">type</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="n">LU</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="nb">type</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>
                                <span class="k">if</span> <span class="n">LU</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="nb">type</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
                                <span class="k">else</span> <span class="mi">0</span>
                            <span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">LU_prod</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">LU_prod</span></div>


<div class="viewcode-block" id="scenario.extrapolate_recent_trend">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.scenario.extrapolate_recent_trend">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extrapolate_recent_trend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">future_year</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span> <span class="n">seuil_bas</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">seuil_haut</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extrapolates a trend into the future using a weighted slope method.</span>

<span class="sd">        Recent years are given higher weight. No predefined functional form is assumed.</span>

<span class="sd">        :param data: List or array of historical values.</span>
<span class="sd">        :type data: list or np.array</span>
<span class="sd">        :param future_year: Year until which to extrapolate.</span>
<span class="sd">        :type future_year: int</span>
<span class="sd">        :param alpha: Slope weighting coefficient for recent years.</span>
<span class="sd">        :type alpha: float</span>
<span class="sd">        :param seuil_bas: Lower bound of extrapolated values.</span>
<span class="sd">        :type seuil_bas: float</span>
<span class="sd">        :param seuil_haut: Upper bound of extrapolated values.</span>
<span class="sd">        :type seuil_haut: float or None</span>
<span class="sd">        :return: (extended_years, extended_values, slope)</span>
<span class="sd">        :rtype: tuple[np.array, np.array, float]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">annees_disponibles</span><span class="p">])</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">data</span>

        <span class="c1"># Calcul du poids exponentiel basé sur la distance à x[-1]</span>
        <span class="c1"># distances normalisées [0..1], 0 = point le plus récent, 1 = point le plus ancien</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">dist</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">/</span> <span class="n">dist</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">dist</span><span class="p">)</span>

        <span class="c1"># Calcul des deltas et des pentes associées</span>
        <span class="c1"># delta_i = (y[i+1]-y[i]) / (x[i+1]-x[i])</span>
        <span class="n">deltas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">delta_weights</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">dx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">slope_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">dx</span>
            <span class="c1"># Pondérer par le poids du 2e point (ou la moyenne w[i], w[i+1] au choix)</span>
            <span class="n">w_slope</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">deltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slope_i</span><span class="p">)</span>
            <span class="n">delta_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w_slope</span><span class="p">)</span>

        <span class="n">deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span>
        <span class="n">delta_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">delta_weights</span><span class="p">)</span>

        <span class="c1"># Pente moyenne pondérée par w[i+1]</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">deltas</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">delta_weights</span><span class="p">)</span>

        <span class="c1"># Extrapolation &quot;an par an&quot; depuis x[-1] jusqu&#39;à future_year</span>
        <span class="n">year_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">year_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">future_year</span><span class="p">)</span>
        <span class="n">extended_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">year_start</span><span class="p">,</span> <span class="n">year_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># On démarre à la dernière valeur historique</span>
        <span class="n">current_val</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">extended_values</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">yr</span> <span class="ow">in</span> <span class="n">extended_years</span><span class="p">:</span>
            <span class="c1"># On avance d&#39;une année =&gt; + slope * 1 an</span>
            <span class="c1"># (Si besoin, gérer un delta en jours ou fraction, mais ici 1 an)</span>
            <span class="n">new_val</span> <span class="o">=</span> <span class="n">current_val</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="p">(</span><span class="n">yr</span> <span class="o">-</span> <span class="p">(</span><span class="n">yr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

            <span class="c1"># Application des seuils</span>
            <span class="k">if</span> <span class="n">seuil_bas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="n">seuil_bas</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seuil_haut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">new_val</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">new_val</span><span class="p">,</span> <span class="n">seuil_haut</span><span class="p">)</span>

            <span class="n">extended_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
            <span class="n">current_val</span> <span class="o">=</span> <span class="n">new_val</span>

        <span class="k">return</span> <span class="n">extended_years</span><span class="p">,</span> <span class="n">extended_values</span></div>


<div class="viewcode-block" id="scenario.get_import_net">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.scenario.get_import_net">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_import_net</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts net nitrogen import value for a given region over all years.</span>

<span class="sd">        :param region: Region name.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: List of net import values.</span>
<span class="sd">        :rtype: list[float]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">L</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">yr</span> <span class="ow">in</span> <span class="n">annees_disponibles</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">sheets_dict</span><span class="p">[</span><span class="s2">&quot;GRAFS&quot;</span> <span class="o">+</span> <span class="n">yr</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">correct_region</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Pyrénées occid&quot;</span><span class="p">:</span> <span class="s2">&quot;Pyrénées occidentales&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Pyrénées Orient&quot;</span><span class="p">:</span> <span class="s2">&quot;Pyrénées Orientales&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">correct_region</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">region</span> <span class="o">=</span> <span class="n">correct_region</span><span class="p">[</span><span class="n">region</span><span class="p">]</span>
            <span class="n">L</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">78</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">L</span></div>


<div class="viewcode-block" id="scenario.logistic_urb_pop">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.scenario.logistic_urb_pop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">logistic_urb_pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">year</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimates the proportion of urban population using a logistic regression on historical data.</span>

<span class="sd">        :param region: Region name.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :param year: Target year for projection.</span>
<span class="sd">        :type year: int</span>
<span class="sd">        :return: Estimated urban population share (%).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">int_year</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">annees_disponibles</span><span class="p">]</span>
        <span class="n">prop_urb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">logit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prop_urb</span> <span class="o">/</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">))</span>
        <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">linregress</span><span class="p">(</span><span class="n">int_year</span><span class="p">,</span> <span class="n">logit</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">100.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">intercept</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">))))</span></div>


<div class="viewcode-block" id="scenario.generate_crop_tab">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.scenario.generate_crop_tab">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_crop_tab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">function_name</span><span class="o">=</span><span class="s2">&quot;Linear&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a crop area table and fits a yield projection model for each crop.</span>

<span class="sd">        Available models: &#39;linear&#39;, &#39;linear2&#39;, &#39;exp&#39;, &#39;ratio&#39;.</span>

<span class="sd">        :param region: Region to generate data for.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :param function_name: The model type used for yield extrapolation.</span>
<span class="sd">        :type function_name: str</span>
<span class="sd">        :return: DataFrame with crop areas and model fit parameters.</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">pre_process_df</span><span class="p">(</span><span class="n">annees_disponibles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">region</span><span class="p">)</span>

        <span class="n">cultures_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">259</span><span class="p">,</span> <span class="mi">294</span><span class="p">)),</span> <span class="p">(</span><span class="s2">&quot;nom&quot;</span><span class="p">,</span> <span class="n">region</span><span class="p">)]</span>
        <span class="n">cultures_df</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">=</span> <span class="n">cultures_df</span><span class="p">[</span><span class="n">region</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">cultures_df</span><span class="p">[</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">df_insert</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cultures_df</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Crops&quot;</span><span class="p">,</span> <span class="s2">&quot;Area proportion (%)&quot;</span><span class="p">])</span>
        <span class="n">df_insert</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">df_insert</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">df_insert</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_insert</span><span class="p">[</span><span class="s2">&quot;Crops&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Forage cabbages &amp; roots&quot;</span><span class="p">,</span> <span class="s2">&quot;Crops&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Forage cabbages&quot;</span>
        <span class="n">df_insert</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_insert</span><span class="p">[</span><span class="s2">&quot;Crops&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rice&quot;</span><span class="p">,</span> <span class="s2">&quot;Crops&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Rice&quot;</span>

        <span class="n">df_insert</span><span class="p">[</span><span class="s2">&quot;Enforce Area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">df_insert</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_insert</span><span class="p">[</span><span class="s2">&quot;Crops&quot;</span><span class="p">]</span>

        <span class="n">Y_pros</span> <span class="o">=</span> <span class="n">Y</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">fit_and_store</span><span class="p">(</span><span class="n">culture</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calibre le modèle désigné par function_name pour &lt;culture&gt;.</span>
<span class="sd">            Ne renvoie que les paramètres utiles à ce modèle,</span>
<span class="sd">            plus le R² et le nom de la culture.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">F</span><span class="p">,</span> <span class="n">Yr</span> <span class="o">=</span> <span class="n">Y_pros</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>

            <span class="c1"># --- Cas sans données ---</span>
            <span class="n">empty_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">Yr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">function_name</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Y_pros</span><span class="o">.</span><span class="n">fit_Y_lin</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">empty_data</span> <span class="k">else</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Yr</span><span class="p">,</span> <span class="n">Y_pros</span><span class="o">.</span><span class="n">Y_th_lin</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;culture&quot;</span><span class="p">:</span> <span class="n">culture</span><span class="p">,</span>
                    <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="s2">&quot;r2&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">}</span>

            <span class="k">elif</span> <span class="n">function_name</span> <span class="o">==</span> <span class="s2">&quot;linear2&quot;</span><span class="p">:</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Y_pros</span><span class="o">.</span><span class="n">fit_Y_lin_2_scipy</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">empty_data</span> <span class="k">else</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Yr</span><span class="p">,</span> <span class="n">Y_pros</span><span class="o">.</span><span class="n">Y_th_lin_2</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;culture&quot;</span><span class="p">:</span> <span class="n">culture</span><span class="p">,</span>
                    <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="s2">&quot;xb&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">xb</span><span class="p">),</span>
                    <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="s2">&quot;r2&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">}</span>

            <span class="k">elif</span> <span class="n">function_name</span> <span class="o">==</span> <span class="s2">&quot;exp&quot;</span><span class="p">:</span>
                <span class="n">ym</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Y_pros</span><span class="o">.</span><span class="n">fit_Y_exp</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">empty_data</span> <span class="k">else</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Yr</span><span class="p">,</span> <span class="n">Y_pros</span><span class="o">.</span><span class="n">Y_th_exp_cap</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">ym</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;culture&quot;</span><span class="p">:</span> <span class="n">culture</span><span class="p">,</span>
                    <span class="s2">&quot;Ymax (kgN/ha)&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">ym</span><span class="p">),</span>
                    <span class="s2">&quot;k (kgN/ha)&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">),</span>
                    <span class="s2">&quot;r2&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">}</span>

            <span class="k">elif</span> <span class="n">function_name</span> <span class="o">==</span> <span class="s2">&quot;ratio&quot;</span><span class="p">:</span>
                <span class="n">ym</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Y_pros</span><span class="o">.</span><span class="n">fit_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
                <span class="n">r2</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">empty_data</span> <span class="k">else</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Yr</span><span class="p">,</span> <span class="n">Y_pros</span><span class="o">.</span><span class="n">Y_th</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">ym</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;culture&quot;</span><span class="p">:</span> <span class="n">culture</span><span class="p">,</span>
                    <span class="s2">&quot;Ymax (kgN/ha)&quot;</span><span class="p">:</span> <span class="n">ym</span><span class="p">,</span>
                    <span class="s2">&quot;r2&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="p">}</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unknown model : </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2">. Available models are &#39;linear&#39;, &#39;linear2&#39;, &#39;exp&#39;, &#39;ratio&#39;.&quot;</span>
                <span class="p">)</span>

        <span class="n">all_cultures</span> <span class="o">=</span> <span class="n">cultures</span> <span class="o">+</span> <span class="n">legumineuses</span> <span class="o">+</span> <span class="n">prairies</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">run_fit</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">fit_and_store</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">{</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">run_fit</span><span class="p">,</span> <span class="n">culture</span><span class="p">):</span> <span class="n">culture</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">all_cultures</span><span class="p">}</span>

            <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">all_cultures</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Fitting models (</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">leave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dynamic_ncols</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="n">df_temp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;culture&quot;</span><span class="p">)</span>

        <span class="c1"># Ajouter (ou mettre à jour) les colonnes dans df_insert</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_temp</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">df_insert</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_temp</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">df_insert</span></div>


<div class="viewcode-block" id="scenario.pre_generate_scenario_excel">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.scenario.pre_generate_scenario_excel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pre_generate_scenario_excel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="o">=</span><span class="s2">&quot;Linear&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates pre-filled scenario Excel files for each region based on fitted crop data.</span>

<span class="sd">        :param function_name: The model type used for yield extrapolation (&#39;Linear&#39;, &#39;exp&#39;, etc.).</span>
<span class="sd">        :type function_name: str</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_sheets</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;scenario.xlsx&quot;</span><span class="p">),</span> <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="n">regions</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Régions&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">):</span>  <span class="c1"># tqdm(regions[23:], total=len(regions[23:]), desc=&quot;Regions&quot;, position=0):</span>
            <span class="n">sheets</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sheet_corres</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;doc&quot;</span><span class="p">:</span> <span class="s2">&quot;doc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;main scenario&quot;</span><span class="p">:</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Surface changes&quot;</span><span class="p">:</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span>
                <span class="s2">&quot;technical scenario&quot;</span><span class="p">:</span> <span class="s2">&quot;technical&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">model_sheets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sheets</span><span class="p">[</span><span class="n">sheet_corres</span><span class="p">[</span><span class="n">sheet_name</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_crop_tab</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>

            <span class="n">target_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_path</span><span class="p">,</span> <span class="s2">&quot;pre_gen&quot;</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Crée les dossiers si besoin</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">.xlsx&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;openpyxl&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">sheets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="scenario.generate_scenario_excel">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.scenario.generate_scenario_excel">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_scenario_excel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">function_name</span><span class="o">=</span><span class="s2">&quot;Linear&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a full scenario Excel file for a given region and year.</span>

<span class="sd">        This method populates all scenario sheets (documentation, main variables, area distribution, technical parameters)</span>
<span class="sd">        using historical data, regional projections (e.g., population), livestock structure, and crop productivity fits.</span>

<span class="sd">        The output file includes default values for &quot;Business as usual&quot; configurations, which serve as a baseline</span>
<span class="sd">        for future simulations in prospective mode.</span>

<span class="sd">        :param year: The future year for which to generate the scenario.</span>
<span class="sd">        :type year: int</span>
<span class="sd">        :param region: The region to generate the scenario for.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :param name: File name (without extension) of the output Excel scenario.</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param function_name: Name of the yield model used for projection (e.g., &#39;Linear&#39;, &#39;Exponential&#39;).</span>
<span class="sd">        :type function_name: str</span>

<span class="sd">        :return: None. The Excel file is saved to the configured scenario path.</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_data_year</span> <span class="o">=</span> <span class="n">annees_disponibles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">pre_process_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_data_year</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">pre_process_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_data_year</span><span class="p">,</span> <span class="s2">&quot;France&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No region named </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2"> in the data&quot;</span><span class="p">)</span>

        <span class="n">model_sheets</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;scenario_region&quot;</span><span class="p">,</span> <span class="n">function_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">+</span> <span class="s2">&quot;.xlsx&quot;</span><span class="p">),</span> <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>

        <span class="n">sheets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># sheet_corres = {</span>
        <span class="c1">#     &quot;doc&quot;: &quot;doc&quot;,</span>
        <span class="c1">#     &quot;main scenario&quot;: &quot;main&quot;,</span>
        <span class="c1">#     &quot;Surface changes&quot;: &quot;area&quot;,</span>
        <span class="c1">#     &quot;technical scenario&quot;: &quot;technical&quot;,</span>
        <span class="c1"># }</span>

        <span class="n">sheet_corres</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;doc&quot;</span><span class="p">:</span> <span class="s2">&quot;doc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;main&quot;</span><span class="p">:</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area&quot;</span><span class="p">:</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span>
            <span class="s2">&quot;technical&quot;</span><span class="p">:</span> <span class="s2">&quot;technical&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">model_sheets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sheets</span><span class="p">[</span><span class="n">sheet_corres</span><span class="p">[</span><span class="n">sheet_name</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span>
        <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">][</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">14</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span>
        <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">year</span>
        <span class="c1"># Du à une mauvaise construction des fiches scenar...</span>
        <span class="k">if</span> <span class="n">function_name</span> <span class="o">==</span> <span class="s2">&quot;Exponential&quot;</span><span class="p">:</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">])]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Production function&quot;</span><span class="p">,</span> <span class="n">function_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_name</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">format_dep</span><span class="p">(</span><span class="n">dep_series</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot; + &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dep_series</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="n">regions_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Ile de France&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;Paris&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Seine-et-Marne&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Yvelines&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Essonne&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Hauts-de-Seine&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Seine-Saint-Denis&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Val-de-Marne&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Val-d&#39;Oise&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;Eure&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Eure&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Eure-et-Loir&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Eure-et-Loir&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Picardie&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Aisne&quot;</span><span class="p">,</span> <span class="s2">&quot;Oise&quot;</span><span class="p">,</span> <span class="s2">&quot;Somme&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Calvados-Orne&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Calvados&quot;</span><span class="p">,</span> <span class="s2">&quot;Orne&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Seine Maritime&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Seine-Maritime&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Manche&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Manche&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Nord Pas de Calais&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Nord&quot;</span><span class="p">,</span> <span class="s2">&quot;Pas-de-Calais&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Champ-Ard-Yonne&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Ardennes&quot;</span><span class="p">,</span> <span class="s2">&quot;Aube&quot;</span><span class="p">,</span> <span class="s2">&quot;Marne&quot;</span><span class="p">,</span> <span class="s2">&quot;Yonne&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Bourgogne&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Côte-d&#39;Or&quot;</span><span class="p">,</span> <span class="s2">&quot;Haute-Marne&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Grande Lorraine&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Meurthe-et-Moselle&quot;</span><span class="p">,</span> <span class="s2">&quot;Meuse&quot;</span><span class="p">,</span> <span class="s2">&quot;Moselle&quot;</span><span class="p">,</span> <span class="s2">&quot;Vosges&quot;</span><span class="p">,</span> <span class="s2">&quot;Haute-Saône&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Alsace&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Bas-Rhin&quot;</span><span class="p">,</span> <span class="s2">&quot;Haut-Rhin&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Bretagne&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Côtes-d&#39;Armor&quot;</span><span class="p">,</span> <span class="s2">&quot;Finistère&quot;</span><span class="p">,</span> <span class="s2">&quot;Ille-et-Vilaine&quot;</span><span class="p">,</span> <span class="s2">&quot;Morbihan&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Vendée-Charente&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Vendée&quot;</span><span class="p">,</span> <span class="s2">&quot;Charente&quot;</span><span class="p">,</span> <span class="s2">&quot;Charente-Maritime&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Loire aval&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Loire-Atlantique&quot;</span><span class="p">,</span> <span class="s2">&quot;Maine-et-Loire&quot;</span><span class="p">,</span> <span class="s2">&quot;Deux-Sèvres&quot;</span><span class="p">,</span> <span class="s2">&quot;Mayenne&quot;</span><span class="p">,</span> <span class="s2">&quot;Sarthe&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Loire Centrale&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Loir-et-Cher&quot;</span><span class="p">,</span> <span class="s2">&quot;Indre-et-Loire&quot;</span><span class="p">,</span> <span class="s2">&quot;Cher&quot;</span><span class="p">,</span> <span class="s2">&quot;Loiret&quot;</span><span class="p">,</span> <span class="s2">&quot;Indre&quot;</span><span class="p">,</span> <span class="s2">&quot;Vienne&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Loire Amont&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;Saône-et-Loire&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Nièvre&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Loire&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Haute-Loire&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Allier&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Puy-de-Dôme&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Creuse&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Haute-Vienne&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;Grand Jura&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Doubs&quot;</span><span class="p">,</span> <span class="s2">&quot;Jura&quot;</span><span class="p">,</span> <span class="s2">&quot;Territoire-de-Belfort&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Savoie&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Savoie&quot;</span><span class="p">,</span> <span class="s2">&quot;Haute-Savoie&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Ain-Rhône&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Ain&quot;</span><span class="p">,</span> <span class="s2">&quot;Rhône&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Alpes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Alpes-de-Haute-Provence&quot;</span><span class="p">,</span> <span class="s2">&quot;Hautes-Alpes&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Isère-Drôme Ardèche&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Isère&quot;</span><span class="p">,</span> <span class="s2">&quot;Drôme&quot;</span><span class="p">,</span> <span class="s2">&quot;Ardèche&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Aveyron-Lozère&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Aveyron&quot;</span><span class="p">,</span> <span class="s2">&quot;Lozère&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Garonne&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Haute-Garonne&quot;</span><span class="p">,</span> <span class="s2">&quot;Lot-et-Garonne&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarn-et-Garonne&quot;</span><span class="p">,</span> <span class="s2">&quot;Gers&quot;</span><span class="p">,</span> <span class="s2">&quot;Aude&quot;</span><span class="p">,</span> <span class="s2">&quot;Tarn&quot;</span><span class="p">,</span> <span class="s2">&quot;Ariège&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Gironde&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Gironde&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Pyrénées occid&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Pyrénées-Atlantiques&quot;</span><span class="p">,</span> <span class="s2">&quot;Hautes-Pyrénées&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Landes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Landes&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Dor-Lot&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Dordogne&quot;</span><span class="p">,</span> <span class="s2">&quot;Lot&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Cantal-Corrèze&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Cantal&quot;</span><span class="p">,</span> <span class="s2">&quot;Corrèze&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Grand Marseille&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Bouches-du-Rhône&quot;</span><span class="p">,</span> <span class="s2">&quot;Vaucluse&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Côte d&#39;Azur&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Alpes-Maritimes&quot;</span><span class="p">,</span> <span class="s2">&quot;Var&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Gard-Hérault&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Gard&quot;</span><span class="p">,</span> <span class="s2">&quot;Hérault&quot;</span><span class="p">],</span>
            <span class="s2">&quot;Pyrénées Orient&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Pyrénées-Orientales&quot;</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="c1"># Create a mapping dictionary {Department: Region}</span>
        <span class="n">department_to_region</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">department</span><span class="p">:</span> <span class="n">region</span> <span class="k">for</span> <span class="n">region</span><span class="p">,</span> <span class="n">departments</span> <span class="ow">in</span> <span class="n">regions_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">department</span> <span class="ow">in</span> <span class="n">departments</span>
        <span class="p">}</span>

        <span class="n">proj_pop</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;projections_pop.xlsx&quot;</span><span class="p">),</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s2">&quot;Population_DEP&quot;</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">5</span>
        <span class="p">)</span>

        <span class="n">proj_pop</span><span class="p">[</span><span class="s2">&quot;Region&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj_pop</span><span class="p">[</span><span class="s2">&quot;LIBDEP&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">department_to_region</span><span class="p">)</span>
        <span class="n">proj_pop</span> <span class="o">=</span> <span class="n">proj_pop</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Region&quot;</span><span class="p">])</span>

        <span class="n">grouped_proj_pop</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">proj_pop</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Region&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;DEP&quot;</span><span class="p">:</span> <span class="n">format_dep</span><span class="p">,</span>  <span class="c1"># Format DEP column as &quot;DEP1 + DEP2 + ...&quot;</span>
                    <span class="o">**</span><span class="p">{</span>
                        <span class="n">col</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">proj_pop</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
                    <span class="p">},</span>  <span class="c1"># Sum all numerical columns</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">region</span> <span class="o">==</span> <span class="s2">&quot;France&quot;</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
                <span class="n">proj</span> <span class="o">+=</span> <span class="n">grouped_proj_pop</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grouped_proj_pop</span><span class="p">[</span><span class="s2">&quot;Region&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">r</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;POP_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">grouped_proj_pop</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">grouped_proj_pop</span><span class="p">[</span><span class="s2">&quot;Region&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">region</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;POP_</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Population&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">proj</span> <span class="o">/</span> <span class="mi">1000</span>
        <span class="p">)</span>  <span class="c1"># to be in thousands, not in millions !</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Total per capita protein ingestion&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="mi">8</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Vegetal per capita protein ingestion&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="mi">9</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Edible animal per capita protein ingestion (excl fish)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="mi">10</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Edible animal per capita protein ingestion (excl fish)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="mi">10</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Synth N fertilizer application to cropland&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="mi">27</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Synth N fertilizer application to grassland&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="mi">29</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;N recycling rate of human excretion in urban area&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="mi">49</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;N recycling rate of human excretion in rural area&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="mi">50</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NH3 volatilization coefficient for synthetic nitrogen&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="mi">31</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Indirect N2O volatilization coefficient for synthetic nitrogen&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="mi">32</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">excel_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;bovines&quot;</span><span class="p">:</span> <span class="mi">1250</span><span class="p">,</span>
                <span class="s2">&quot;ovines&quot;</span><span class="p">:</span> <span class="mi">1264</span><span class="p">,</span>
                <span class="s2">&quot;caprines&quot;</span><span class="p">:</span> <span class="mi">1278</span><span class="p">,</span>
                <span class="s2">&quot;porcines&quot;</span><span class="p">:</span> <span class="mi">1292</span><span class="p">,</span>
                <span class="s2">&quot;poultry&quot;</span><span class="p">:</span> <span class="mi">1306</span><span class="p">,</span>
                <span class="s2">&quot;equines&quot;</span><span class="p">:</span> <span class="mi">1320</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># Excretion managment</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">betail</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;equine&quot;</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;equines&quot;</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> % excretion on grassland&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">excel_dict</span><span class="p">[</span><span class="n">t</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> % excretion in the barn as litter manure&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">excel_dict</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> % excretion in the barn as other manure&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">excel_dict</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> % excretion in the barn as slurry&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">excel_dict</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># LU prop</span>
            <span class="n">LU_prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">livestock_LU</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)[</span><span class="n">annees_disponibles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">LU_prop_tot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">LU_prop</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">LU_prop</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="o">/</span> <span class="n">LU_prop_tot</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">LU_prop</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">betail</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;equine&quot;</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="s2">&quot;equines&quot;</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> LU&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">LU_prop</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>

            <span class="c1"># Historical trend</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Feed nitrogen net import&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrapolate_recent_trend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="mi">1009</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">seuil_bas</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">betail</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;equine&quot;</span><span class="p">:</span>
                    <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;equines&quot;</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;kgN excreted by </span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2"> LU&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrapolate_recent_trend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LU_excretion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="nb">type</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span>
                    <span class="o">-</span><span class="mi">1</span>
                <span class="p">]</span>

            <span class="k">for</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">betail</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;equine&quot;</span><span class="p">:</span>
                    <span class="nb">type</span> <span class="o">=</span> <span class="s2">&quot;equines&quot;</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> productivity&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LU_prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2"> productivity&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bovines&quot;</span><span class="p">,</span> <span class="s2">&quot;ovines&quot;</span><span class="p">,</span> <span class="s2">&quot;caprines&quot;</span><span class="p">,</span> <span class="s2">&quot;poultry&quot;</span><span class="p">]:</span>
                    <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> dairy productivity&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LU_prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2"> dairy productivity&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">tot_LU</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">LU_prop_hist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">livestock_LU</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">yr</span> <span class="ow">in</span> <span class="n">annees_disponibles</span><span class="p">:</span>
                <span class="n">tot_LU</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">LU_prop_hist</span><span class="p">[</span><span class="n">yr</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Total LU&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrapolate_recent_trend</span><span class="p">(</span><span class="n">tot_LU</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">seuil_bas</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Arable area&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrapolate_recent_trend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">seuil_bas</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Permanent grassland area&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrapolate_recent_trend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">historic_trend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">seuil_bas</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Import (need GRAFS)</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Net import of vegetal pdcts&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extrapolate_recent_trend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_import_net</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">seuil_bas</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Proportion urbaine</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">][</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Urban population&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logistic_urb_pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>

            <span class="c1"># surface prop tab</span>
            <span class="c1"># sheets[&quot;area&quot;] = self.generate_crop_tab(self.region)</span>

        <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenario_path</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.xlsx&quot;</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;openpyxl&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">sheets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># 👉 Récupérer le workbook ouvert via le writer pour ajouter une case pour vérifier la somme des proportions.</span>
            <span class="n">wb</span> <span class="o">=</span> <span class="n">writer</span><span class="o">.</span><span class="n">book</span>

            <span class="c1"># ✅ Insérer une formule après l&#39;écriture dans la feuille &quot;area&quot;</span>
            <span class="n">sheet</span> <span class="o">=</span> <span class="n">wb</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span>

            <span class="c1"># ✅ Trouver la dernière ligne (max_row donne la dernière ligne non vide)</span>
            <span class="n">last_row</span> <span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">max_row</span> <span class="o">+</span> <span class="mi">2</span>

            <span class="c1"># ✅ Insérer le texte et la formule Excel directement</span>
            <span class="n">sheet</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;A</span><span class="si">{</span><span class="n">last_row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Proportion area sum correct ?&quot;</span>
            <span class="n">sheet</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;B</span><span class="si">{</span><span class="n">last_row</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;=IF(SUM(B2:B</span><span class="si">{</span><span class="n">last_row</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">3</span><span class="si">}</span><span class="s1">)=100, &quot;✅ OK&quot;, &quot;❌ Erreur&quot;)&#39;</span></div>


<div class="viewcode-block" id="scenario.generate_base_scenar">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.scenario.generate_base_scenar">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_base_scenar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prod_func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates baseline scenario Excel files for all regions, containing only the crop area distribution sheet.</span>

<span class="sd">        This method is used to create an initial batch of region-specific scenario templates,</span>
<span class="sd">        filled with yield model projections for each crop, but without demand-side or technical assumptions.</span>

<span class="sd">        :param prod_func: Name of the crop production function to apply (e.g., &#39;Linear&#39;, &#39;Exponential&#39;).</span>
<span class="sd">        :type prod_func: str</span>

<span class="sd">        :return: None. Excel files are saved to the default scenario directory.</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create scenar for all regions with only area filled</span>
        <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Calcul des Ymax et k&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;region&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">pre_process_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_data_year</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="o">.</span><span class="n">pre_process_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_data_year</span><span class="p">,</span> <span class="s2">&quot;France&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No region named </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2"> in the data&quot;</span><span class="p">)</span>

            <span class="n">model_sheets</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;scenario.xlsx&quot;</span><span class="p">),</span> <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="n">sheets</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">sheet_corres</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;doc&quot;</span><span class="p">:</span> <span class="s2">&quot;doc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;main scenario&quot;</span><span class="p">:</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Surface changes&quot;</span><span class="p">:</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span>
                <span class="s2">&quot;technical scenario&quot;</span><span class="p">:</span> <span class="s2">&quot;technical&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">model_sheets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">sheets</span><span class="p">[</span><span class="n">sheet_corres</span><span class="p">[</span><span class="n">sheet_name</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df</span>
            <span class="n">sheets</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_crop_tab</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">prod_func</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">ExcelWriter</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;scenario_region&quot;</span><span class="p">,</span> <span class="n">region</span> <span class="o">+</span> <span class="s2">&quot;.xlsx&quot;</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;openpyxl&quot;</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">sheet_name</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">sheets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">df</span><span class="o">.</span><span class="n">to_excel</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="n">sheet_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Y">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Y</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for modeling and fitting nitrogen yield response curves based on historical data.</span>

<span class="sd">    This class extracts yield and fertilization data from NitrogenFlowModel instances,</span>
<span class="sd">    and provides a suite of theoretical models (e.g., Mitscherlich, exponential, linear) to fit production curves.</span>

<span class="sd">    :param dataloader: Optional instance of DataLoader to use. If None, a default one is initialized.</span>
<span class="sd">    :type dataloader: DataLoader, optional</span>

<span class="sd">    :ivar dataloader: DataLoader instance used for retrieving regional crop data.</span>
<span class="sd">    :vartype dataloader: DataLoader</span>
<span class="sd">    :ivar int_yr: List of integer years available in the dataset.</span>
<span class="sd">    :vartype int_yr: list[int]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataloader</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dataloader</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span> <span class="o">=</span> <span class="n">dataloader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_yr</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">annees_disponibles</span><span class="p">]</span>

<div class="viewcode-block" id="Y.get_Y">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.get_Y">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_Y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts historical fertilization and yield data for a given crop and region.</span>

<span class="sd">        Optionally displays a scatter plot of the data.</span>

<span class="sd">        :param culture: The name of the crop (index in the NitrogenFlowModel).</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: The name of the region.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :param plot: Whether to plot the data (default is False).</span>
<span class="sd">        :type plot: bool</span>
<span class="sd">        :return: Tuple of arrays (F, Y), fertilization and yield values.</span>
<span class="sd">        :rtype: tuple[np.ndarray, np.ndarray]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">YR</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">region</span> <span class="o">==</span> <span class="s2">&quot;Savoie&quot;</span><span class="p">:</span>
            <span class="n">years</span> <span class="o">=</span> <span class="n">annees_disponibles</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">years</span> <span class="o">=</span> <span class="n">annees_disponibles</span>
        <span class="k">for</span> <span class="n">yr</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">NitrogenFlowModel</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">yr</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Ftot</span><span class="p">(</span><span class="n">culture</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">Y</span><span class="p">(</span><span class="n">culture</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">f</span> <span class="o">!=</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="mi">350</span>  <span class="c1"># On supprime les valeur délirantes (pb données) de ferti et Y</span>
                <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">350</span>
                <span class="c1"># and y &lt; f*0.9 # Condition NUE&lt;90%</span>
            <span class="p">):</span>
                <span class="n">F</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">Y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="n">YR</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">yr</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Historic Data&quot;</span><span class="p">)</span>  <span class="c1"># Points et ligne</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Fertilization (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Yield (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="c1"># plt.title(&quot;Relation entre Fertilisation et Rendement&quot;, fontsize=14, fontweight=&#39;bold&#39;)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>  <span class="c1"># Grille discrète</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">YR</span><span class="p">)</span></div>


<div class="viewcode-block" id="Y.Y_th">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.Y_th">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Y_th</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">y_max</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mitscherlich-type yield response: Y = f * y_max / (f + y_max)</span>

<span class="sd">        :param f: Fertilization input (kgN/ha).</span>
<span class="sd">        :type f: float or np.ndarray</span>
<span class="sd">        :param y_max: Maximum attainable yield (kgN/ha).</span>
<span class="sd">        :type y_max: float</span>
<span class="sd">        :return: Estimated yield.</span>
<span class="sd">        :rtype: float or np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="n">y_max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">f</span> <span class="o">*</span> <span class="n">y_max</span> <span class="o">/</span> <span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="n">y_max</span><span class="p">)</span></div>


<div class="viewcode-block" id="Y.Y_th_exp">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.Y_th_exp">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Y_th_exp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exponential growth model without cap.</span>

<span class="sd">        Computes yield as:</span>
<span class="sd">            Y(f) = y_max * (1 - exp(-f / k))</span>

<span class="sd">        :param f: Fertilization input (kgN/ha).</span>
<span class="sd">        :type f: float or np.ndarray</span>
<span class="sd">        :param y_max: Maximum yield asymptote (kgN/ha).</span>
<span class="sd">        :type y_max: float</span>
<span class="sd">        :param k: Growth curvature parameter (kgN/ha).</span>
<span class="sd">        :type k: float</span>
<span class="sd">        :return: Yield response Y(f).</span>
<span class="sd">        :rtype: float or np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">y_max</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">f</span> <span class="o">/</span> <span class="n">k</span><span class="p">))</span></div>


<div class="viewcode-block" id="Y.Y_th_exp_cap">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.Y_th_exp_cap">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Y_th_exp_cap</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exponential response with physical cap at 99% of fertilization.</span>

<span class="sd">        Formula:</span>
<span class="sd">            Y(f) = min(y_max * (1 - exp(-f / k)), 0.99 * f)</span>

<span class="sd">        :param f: Fertilization input (kgN/ha).</span>
<span class="sd">        :type f: float or np.ndarray</span>
<span class="sd">        :param y_max: Maximum yield asymptote (kgN/ha).</span>
<span class="sd">        :type y_max: float</span>
<span class="sd">        :param k: Growth curvature parameter (kgN/ha).</span>
<span class="sd">        :type k: float</span>
<span class="sd">        :return: Capped yield response Y(f).</span>
<span class="sd">        :rtype: float or np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">y_max</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">f</span> <span class="o">/</span> <span class="n">k</span><span class="p">)),</span> <span class="mf">0.99</span> <span class="o">*</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="Y.Y_th_lin">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.Y_th_lin">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Y_th_lin</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple linear yield response with a saturation cap.</span>

<span class="sd">        Formula:</span>
<span class="sd">            Y(f) = min(a * f, b)</span>

<span class="sd">        :param f: Fertilization input (kgN/ha).</span>
<span class="sd">        :type f: float or np.ndarray</span>
<span class="sd">        :param a: Linear coefficient.</span>
<span class="sd">        :type a: float</span>
<span class="sd">        :param b: Maximum yield threshold.</span>
<span class="sd">        :type b: float</span>
<span class="sd">        :return: Capped linear yield.</span>
<span class="sd">        :rtype: float or np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span></div>


<div class="viewcode-block" id="Y.Y_th_lin_2">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.Y_th_lin_2">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Y_th_lin_2</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Piecewise linear yield function with break at `xb`.</span>

<span class="sd">        Formula:</span>
<span class="sd">            - If f ≤ xb: Y = a * f</span>
<span class="sd">            - If f &gt; xb: Y = c * (f - xb) + xb * a</span>

<span class="sd">        :param f: Fertilization input (kgN/ha).</span>
<span class="sd">        :type f: float or np.ndarray</span>
<span class="sd">        :param a: Initial slope before breakpoint.</span>
<span class="sd">        :type a: float</span>
<span class="sd">        :param xb: Breakpoint fertilization value.</span>
<span class="sd">        :type xb: float</span>
<span class="sd">        :param c: Slope after breakpoint.</span>
<span class="sd">        :type c: float</span>
<span class="sd">        :return: Yield response Y(f).</span>
<span class="sd">        :rtype: float or np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">xb</span><span class="p">)</span> <span class="o">+</span> <span class="n">xb</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span></div>


<div class="viewcode-block" id="Y.Y_th_poly">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.Y_th_poly">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Y_th_poly</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Second-order polynomial yield response.</span>

<span class="sd">        Formula:</span>
<span class="sd">            Y(f) = a * f² + b * f</span>

<span class="sd">        :param f: Fertilization input.</span>
<span class="sd">        :type f: float or np.ndarray</span>
<span class="sd">        :param a: Quadratic coefficient.</span>
<span class="sd">        :type a: float</span>
<span class="sd">        :param b: Linear coefficient.</span>
<span class="sd">        :type b: float</span>
<span class="sd">        :return: Polynomial yield response.</span>
<span class="sd">        :rtype: float or np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">f</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">f</span></div>


<div class="viewcode-block" id="Y.Y_th_poly_cap">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.Y_th_poly_cap">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Y_th_poly_cap</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Polynomial yield response capped at 99% of fertilization.</span>

<span class="sd">        Formula:</span>
<span class="sd">            Y(f) = min(a * f² + b * f, 0.99 * f)</span>

<span class="sd">        :param f: Fertilization input.</span>
<span class="sd">        :type f: float or np.ndarray</span>
<span class="sd">        :param a: Quadratic coefficient.</span>
<span class="sd">        :type a: float</span>
<span class="sd">        :param b: Linear coefficient.</span>
<span class="sd">        :type b: float</span>
<span class="sd">        :return: Capped polynomial yield response.</span>
<span class="sd">        :rtype: float or np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mf">0.99</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">a</span> <span class="o">*</span> <span class="n">f</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="Y.Y_th_sigmoid">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.Y_th_sigmoid">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Y_th_sigmoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Ymax</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sigmoidal yield response function.</span>

<span class="sd">        Formula:</span>
<span class="sd">            Y(f) = Ymax / (1 + exp(-k * (f - x0)))</span>

<span class="sd">        :param f: Fertilization input.</span>
<span class="sd">        :type f: float or np.ndarray</span>
<span class="sd">        :param Ymax: Maximum yield.</span>
<span class="sd">        :type Ymax: float</span>
<span class="sd">        :param k: Growth steepness.</span>
<span class="sd">        :type k: float</span>
<span class="sd">        :param x0: Midpoint of the sigmoid.</span>
<span class="sd">        :type x0: float</span>
<span class="sd">        :return: Sigmoidal yield response.</span>
<span class="sd">        :rtype: float or np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Ymax</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)))</span></div>


<div class="viewcode-block" id="Y.Y_th_sigmoid_cap">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.Y_th_sigmoid_cap">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Y_th_sigmoid_cap</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Ymax</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sigmoidal yield function with upper cap at 99% of fertilization input.</span>

<span class="sd">        Formula:</span>
<span class="sd">            Y(f) = min(Ymax / (1 + exp(-k * (f - x0))), 0.99 * f)</span>

<span class="sd">        :param f: Fertilization input.</span>
<span class="sd">        :type f: float or np.ndarray</span>
<span class="sd">        :param Ymax: Maximum yield.</span>
<span class="sd">        :type Ymax: float</span>
<span class="sd">        :param k: Growth steepness.</span>
<span class="sd">        :type k: float</span>
<span class="sd">        :param x0: Inflection point.</span>
<span class="sd">        :type x0: float</span>
<span class="sd">        :return: Capped sigmoidal yield response.</span>
<span class="sd">        :rtype: float or np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mf">0.99</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">Ymax</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">x0</span><span class="p">))))</span></div>


<div class="viewcode-block" id="Y.Y_th_lin_2_smooth">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.Y_th_lin_2_smooth">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">Y_th_lin_2_smooth</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Smooth piecewise linear function using logistic blending near the breakpoint.</span>

<span class="sd">        Formula:</span>
<span class="sd">            transition = 1 / (1 + exp(-s * (f - xb)))</span>
<span class="sd">            Y(f) = (1 - transition) * a * f + transition * (c * (f - xb) + xb * a)</span>

<span class="sd">        :param f: Fertilization input (kgN/ha).</span>
<span class="sd">        :type f: float or np.ndarray</span>
<span class="sd">        :param a: Initial slope.</span>
<span class="sd">        :type a: float</span>
<span class="sd">        :param xb: Breakpoint.</span>
<span class="sd">        :type xb: float</span>
<span class="sd">        :param c: Post-breakpoint slope.</span>
<span class="sd">        :type c: float</span>
<span class="sd">        :param s: Sharpness of transition (higher = sharper).</span>
<span class="sd">        :type s: float</span>
<span class="sd">        :return: Smoothed yield response Y(f).</span>
<span class="sd">        :rtype: float or np.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">transition</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">s</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">xb</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">transition</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">xb</span><span class="p">)</span> <span class="o">+</span> <span class="n">xb</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">*</span> <span class="n">transition</span></div>


<div class="viewcode-block" id="Y.fit_Y">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.fit_Y">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_Y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits a Mitscherlich-type yield curve (Y_th) to historical fertilization/yield data for a given crop and region.</span>

<span class="sd">        Returns the optimal `y_max` value and the fitted curve.</span>

<span class="sd">        :param culture: The name of the crop.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: The name of the region.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: Tuple of (y_max, fitted_yield_values).</span>
<span class="sd">        :rtype: tuple[float or None, np.ndarray or None]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">Y_max_init</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_th</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="n">Y_max_init</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
            <span class="n">Y_max_opt</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 📌 Paramètre ajusté Y_max</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Ajustement impossible pour&quot;</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
            <span class="n">Y_max_opt</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Retourne None en cas d&#39;échec</span>

        <span class="n">Y_th_fitted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Y_max_opt</span><span class="p">)</span> <span class="k">if</span> <span class="n">Y_max_opt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">Y_max_opt</span><span class="p">,</span> <span class="n">Y_th_fitted</span></div>


<div class="viewcode-block" id="Y.fit_Y_exp">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.fit_Y_exp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_Y_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit an exponential yield curve (Y = Y_max(1-exp(F/k))) to historical data</span>
<span class="sd">        for a given crop (culture) and region using non-linear least squares.</span>

<span class="sd">        :param culture: Name of the crop.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Region identifier.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: Tuple containing optimal parameters Y_max and k, and the fitted curve.</span>
<span class="sd">        :rtype: Tuple[float, float, np.ndarray | None]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">Y_max_init</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_exp</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="n">Y_max_init</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">F</span><span class="p">)],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">Y_max_opt</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 📌 Paramètre ajusté Y_max</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Ajustement impossible pour&quot;</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
            <span class="n">Y_max_opt</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Retourne None en cas d&#39;échec</span>
            <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">Y_th_fitted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_exp</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Y_max_opt</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="n">Y_max_opt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">Y_max_opt</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">Y_th_fitted</span></div>


<div class="viewcode-block" id="Y.fit_Y_exp_2">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.fit_Y_exp_2">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_Y_exp_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit an exponential yield curve using a constrained optimization method (SLSQP).</span>
<span class="sd">        Ensures that k &gt; Y_max for interpretability.</span>

<span class="sd">        :param culture: Name of the crop.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Region identifier.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: Tuple with Y_max, k, and the fitted yield curve.</span>
<span class="sd">        :rtype: Tuple[float, float, np.ndarray | None]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">Y_max_init</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span>
        <span class="n">k_init</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="n">y_max</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">params</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_th_exp</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">Y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Contraintes : k &gt; y_max</span>
        <span class="n">constraint</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ineq&quot;</span><span class="p">,</span> <span class="s2">&quot;fun&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">params</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>  <span class="c1"># k - y_max &gt; 0</span>

        <span class="c1"># Bornes : y_max &gt; 0, k &gt; 0</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
            <span class="n">objective</span><span class="p">,</span>
            <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="n">Y_max_init</span><span class="p">,</span> <span class="n">k_init</span><span class="p">],</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">constraint</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="n">y_max_opt</span><span class="p">,</span> <span class="n">k_opt</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
            <span class="n">y_th_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_exp</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">y_max_opt</span><span class="p">,</span> <span class="n">k_opt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">y_max_opt</span><span class="p">,</span> <span class="n">k_opt</span><span class="p">,</span> <span class="n">y_th_fit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Ajustement impossible pour&quot;</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Y.fit_Y_lin">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.fit_Y_lin">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_Y_lin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a simple linear model (Y = a * F + b) to yield data.</span>

<span class="sd">        :param culture: Name of the crop.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Region identifier.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: Fitted slope and intercept with predicted yield.</span>
<span class="sd">        :rtype: Tuple[float, float, np.ndarray | None]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_th_lin</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 📌 Paramètre ajusté Y_max</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Ajustement impossible pour&quot;</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Retourne None en cas d&#39;échec</span>
            <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">Y_th_fitted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_lin</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">Y_th_fitted</span></div>


<div class="viewcode-block" id="Y.fit_Y_lin_2">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.fit_Y_lin_2">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_Y_lin_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a piecewise linear model with two slopes to capture yield response.</span>

<span class="sd">        :param culture: Name of the crop.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Region identifier.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: Parameters a, xb (threshold), c (second slope), and the fitted curve.</span>
<span class="sd">        :rtype: Tuple[float, float, float, np.ndarray | None]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">midpoint</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">p01</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="n">midpoint</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_th_lin_2</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p01</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 📌 Paramètre ajusté Y_max</span>
            <span class="n">xb</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Ajustement impossible pour&quot;</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Retourne None en cas d&#39;échec</span>
            <span class="n">xb</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">Y_th_fitted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_lin_2</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">Y_th_fitted</span></div>


<div class="viewcode-block" id="Y.fit_Y_lin_2_scipy">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.fit_Y_lin_2_scipy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_Y_lin_2_scipy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit the same piecewise linear model as fit_Y_lin_2 but using SLSQP optimizer.</span>

<span class="sd">        :param culture: Name of the crop.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Region identifier.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: Optimized parameters a, xb, c and the yield prediction.</span>
<span class="sd">        :rtype: Tuple[float, float, float, np.ndarray | None]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">params</span>
            <span class="n">Y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_lin_2</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Y</span> <span class="o">-</span> <span class="n">Y_pred</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># ➕ Bornes pour a, xb, c</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">)),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span>

        <span class="c1"># 🔹 Point initial (à ajuster selon le domaine)</span>
        <span class="n">midpoint</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="n">midpoint</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;SLSQP&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="n">a_opt</span><span class="p">,</span> <span class="n">xb_opt</span><span class="p">,</span> <span class="n">c_opt</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
            <span class="n">Y_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_lin_2</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a_opt</span><span class="p">,</span> <span class="n">xb_opt</span><span class="p">,</span> <span class="n">c_opt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">a_opt</span><span class="p">,</span> <span class="n">xb_opt</span><span class="p">,</span> <span class="n">c_opt</span><span class="p">,</span> <span class="n">Y_fit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Ajustement impossible pour </span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Y.fit_Y_poly">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.fit_Y_poly">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_Y_poly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a 2nd-degree polynomial (Y = aF^2 + bF + c) to the data without constraints.</span>

<span class="sd">        :param culture: Crop name.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Region identifier.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: Parameters a, b, c and the fitted values.</span>
<span class="sd">        :rtype: Tuple[float, float, float, np.ndarray | None]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_th_poly</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">([</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">],</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">]))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># 📌 Paramètre ajusté Y_max</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ Ajustement impossible pour&quot;</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Retourne None en cas d&#39;échec</span>
            <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">Y_th_fitted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_poly</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">Y_th_fitted</span></div>


<div class="viewcode-block" id="Y.fit_Y_poly_constrained">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.fit_Y_poly_constrained">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_Y_poly_constrained</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a constrained 2nd-degree polynomial to ensure concavity and meaningful shape (P(F)&lt;F).</span>

<span class="sd">        :param culture: Crop name.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Region identifier.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: Fitted parameters a, b and predicted yield values.</span>
<span class="sd">        :rtype: Tuple[float, float, np.ndarray | None]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Initialisation</span>
        <span class="n">a_init</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.002</span>
        <span class="n">b_init</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="c1"># c_init = 0</span>

        <span class="n">max_F</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">params</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_th_poly</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">Y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># ➕ 1ère contrainte : sommet après max(F) → -b / (2a) &gt; max(F)</span>
        <span class="c1"># ⇔ -b - 2a * max(F) &gt; 0</span>
        <span class="c1"># constraint1 = {&quot;type&quot;: &quot;ineq&quot;, &quot;fun&quot;: lambda p: -p[1] - 2 * p[0] * max_F}</span>

        <span class="c1"># ➕ 2ème contrainte : pente à max(F) &gt; 0 → 2a * max(F) + b &gt; 0</span>
        <span class="n">constraint2</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ineq&quot;</span><span class="p">,</span> <span class="s2">&quot;fun&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">max_F</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>  <span class="c1"># a &lt; 0 pour avoir une parabole concave</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
            <span class="n">objective</span><span class="p">,</span>
            <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="n">a_init</span><span class="p">,</span> <span class="n">b_init</span><span class="p">],</span>
            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;trust-constr&quot;</span><span class="p">,</span>
            <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">constraint2</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="n">a_opt</span><span class="p">,</span> <span class="n">b_opt</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
            <span class="n">y_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_poly</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a_opt</span><span class="p">,</span> <span class="n">b_opt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">a_opt</span><span class="p">,</span> <span class="n">b_opt</span><span class="p">,</span> <span class="n">y_fit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Ajustement impossible pour </span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Y.fit_Y_sigmoid">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.fit_Y_sigmoid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_Y_sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a logistic sigmoid function (Y = Ymax / (1 + exp(-k(x - x0)))) to yield data.</span>

<span class="sd">        :param culture: Name of the crop.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Region identifier.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: Parameters Ymax, k, x0 and fitted yield curve.</span>
<span class="sd">        :rtype: Tuple[float, float, float, np.ndarray | None]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Fonction à minimiser (erreur quadratique)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="n">Ymax</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">params</span>
            <span class="n">Y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_sigmoid</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Ymax</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Y</span> <span class="o">-</span> <span class="n">Y_pred</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Bornes réalistes pour les paramètres</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)),</span> <span class="p">(</span><span class="mf">1e-10</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">))]</span>  <span class="c1"># Ymax, k, x0</span>

        <span class="c1"># Initialisation</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">F</span><span class="p">)]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="n">Ymax</span><span class="p">,</span> <span class="n">k_opt</span><span class="p">,</span> <span class="n">x0_opt</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
            <span class="n">Y_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_sigmoid</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Ymax</span><span class="p">,</span> <span class="n">k_opt</span><span class="p">,</span> <span class="n">x0_opt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Ymax</span><span class="p">,</span> <span class="n">k_opt</span><span class="p">,</span> <span class="n">x0_opt</span><span class="p">,</span> <span class="n">Y_fit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Ajustement impossible pour </span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Y.fit_Y_lin_2_smooth">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.fit_Y_lin_2_smooth">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_Y_lin_2_smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a smoothed two-slope model (sigmoid transition) for yield response.</span>

<span class="sd">        :param culture: Crop name.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Region identifier.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: Parameters a, xb, c, s (smoothness), and predicted yield.</span>
<span class="sd">        :rtype: Tuple[float, float, float, float, np.ndarray | None]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">params</span>
            <span class="n">Y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_lin_2_smooth</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Y</span> <span class="o">-</span> <span class="n">Y_pred</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># ➕ Bornes pour a, xb, c, s</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">)),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e6</span><span class="p">)]</span>

        <span class="c1"># 🔹 Point initial (à ajuster selon le domaine)</span>
        <span class="c1"># midpoint = (min(F) + max(F)) / 2</span>
        <span class="c1"># p0 = [max(Y) / max(F), midpoint, 0.1, 1]</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_Y_lin_2_scipy</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">p0</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;Nelder-Mead&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="n">a_opt</span><span class="p">,</span> <span class="n">xb_opt</span><span class="p">,</span> <span class="n">c_opt</span><span class="p">,</span> <span class="n">s_opt</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span>
            <span class="n">Y_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_lin_2_smooth</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a_opt</span><span class="p">,</span> <span class="n">xb_opt</span><span class="p">,</span> <span class="n">c_opt</span><span class="p">,</span> <span class="n">s_opt</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">a_opt</span><span class="p">,</span> <span class="n">xb_opt</span><span class="p">,</span> <span class="n">c_opt</span><span class="p">,</span> <span class="n">s_opt</span><span class="p">,</span> <span class="n">Y_fit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Ajustement impossible pour </span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Y.plot_Y">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.plot_Y">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_Y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the fitted Mitscherlich-type yield curve and historical data points</span>
<span class="sd">        for a specific crop and region.</span>

<span class="sd">        :param culture: Name of the crop.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Region identifier.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: None. The plot is displayed with matplotlib.</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">int_yr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no </span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2"> found in </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">Y_max</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="n">F_th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">Y_th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th</span><span class="p">(</span><span class="n">F_th</span><span class="p">,</span> <span class="n">Y_max</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2_score</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Y_max</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="c1"># 1. Utiliser plt.scatter pour permettre la coloration par point</span>
        <span class="c1"># c=int_yr mappe les couleurs aux valeurs de la liste d&#39;années</span>
        <span class="c1"># cmap=&#39;viridis&#39; est une palette de couleurs, vous pouvez en choisir d&#39;autres (&#39;plasma&#39;, &#39;coolwarm&#39;, etc.)</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">int_yr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Historical data&quot;</span><span class="p">)</span>

        <span class="c1"># 2. Ajouter une barre de couleur pour servir de légende pour les années</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="c1"># --- Fin des modifications ---</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ligne 1:1&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">F_th</span><span class="p">,</span>
            <span class="n">Y_th</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Theoric curve, Y_max = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">Y_max</span><span class="p">)</span><span class="si">}</span><span class="s2">, $r^2$ = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">F_th</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="c1"># plt.gca().set_aspect(&quot;equal&quot;) # Peut déformer le graphique, à utiliser avec précaution</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Fertilization (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Yield (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="c1"># plt.title(f&quot;Relation Fertilisation-Rendement\n($r^2$ = {r2})&quot;, fontsize=14, fontweight=&#39;bold&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Y.plot_Y_lin">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.plot_Y_lin">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_Y_lin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the fitted linear yield curve (Y = aF + b) and historical data for a crop.</span>

<span class="sd">        :param culture: Crop name.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Region identifier.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: None. Displays the matplotlib plot.</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">int_yr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no </span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2"> found in </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_Y_lin</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="c1"># a, b = 0.75, 160</span>
        <span class="n">F_th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">Y_th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_lin</span><span class="p">(</span><span class="n">F_th</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2_score</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_lin</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">int_yr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Historical data&quot;</span><span class="p">)</span>

        <span class="c1"># 2. Ajouter une barre de couleur pour servir de légende pour les années</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="c1"># --- Fin des modifications ---</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ligne 1:1&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">F_th</span><span class="p">,</span>
            <span class="n">Y_th</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Theoric curve, Y_max = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="s2">, $r^2$ = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">F_th</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="c1"># plt.gca().set_aspect(&quot;equal&quot;) # Peut déformer le graphique, à utiliser avec précaution</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Fertilization (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Yield (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="c1"># plt.title(f&quot;Relation Fertilisation-Rendement\n($r^2$ = {r2})&quot;, fontsize=14, fontweight=&#39;bold&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Y.plot_Y_lin_2">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.plot_Y_lin_2">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_Y_lin_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the fitted piecewise linear yield curve with two slopes and the historical data.</span>

<span class="sd">        :param culture: Crop name.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Region identifier.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: None. The plot is rendered using matplotlib.</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">int_yr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no </span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2"> found in </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_Y_lin_2_scipy</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="c1"># a, b = 0.75, 160</span>
        <span class="n">F_th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">Y_th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_lin_2</span><span class="p">(</span><span class="n">F_th</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2_score</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_lin_2</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">int_yr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Historical data&quot;</span><span class="p">)</span>

        <span class="c1"># 2. Ajouter une barre de couleur pour servir de légende pour les années</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="c1"># --- Fin des modifications ---</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ligne 1:1&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">F_th</span><span class="p">,</span>
            <span class="n">Y_th</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Theoric curve, $r^2$ = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">F_th</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="c1"># plt.gca().set_aspect(&quot;equal&quot;) # Peut déformer le graphique, à utiliser avec précaution</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Fertilization (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Yield (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="c1"># plt.title(f&quot;Relation Fertilisation-Rendement\n($r^2$ = {r2})&quot;, fontsize=14, fontweight=&#39;bold&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Y.plot_Y_poly">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.plot_Y_poly">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_Y_poly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the fitted constrained polynomial yield curve and the actual data.</span>

<span class="sd">        :param culture: Crop name.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Region identifier.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: None. Displays the curve and points.</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">int_yr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no </span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2"> found in </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_Y_poly_constrained</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="c1"># a, b, c = -0.002, 0.90226, 0</span>
        <span class="n">F_th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">Y_th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_poly_cap</span><span class="p">(</span><span class="n">F_th</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2_score</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_poly_cap</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">int_yr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Historical data&quot;</span><span class="p">)</span>

        <span class="c1"># 2. Ajouter une barre de couleur pour servir de légende pour les années</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="c1"># --- Fin des modifications ---</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ligne 1:1&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">F_th</span><span class="p">,</span>
            <span class="n">Y_th</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Theoric curve, Y_max = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="p">))</span><span class="si">}</span><span class="s2">, $r^2$ = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">F_th</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="c1"># plt.gca().set_aspect(&quot;equal&quot;) # Peut déformer le graphique, à utiliser avec précaution</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Fertilization (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Yield (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="c1"># plt.title(f&quot;Relation Fertilisation-Rendement\n($r^2$ = {r2})&quot;, fontsize=14, fontweight=&#39;bold&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Y.plot_Y_exp">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.plot_Y_exp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_Y_exp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the fitted exponential yield curve (capped) with the data for the specified crop.</span>

<span class="sd">        :param culture: Name of the crop.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Target region.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: None. Plot appears inline.</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">int_yr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no </span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2"> found in </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">Y_max</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_Y_exp_2</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="n">F_th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">Y_th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_exp_cap</span><span class="p">(</span><span class="n">F_th</span><span class="p">,</span> <span class="n">Y_max</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2_score</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_exp_cap</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Y_max</span><span class="p">,</span> <span class="n">k</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">int_yr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Historical data&quot;</span><span class="p">)</span>

        <span class="c1"># 2. Ajouter une barre de couleur pour servir de légende pour les années</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="c1"># --- Fin des modifications ---</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ligne 1:1&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">F_th</span><span class="p">,</span>
            <span class="n">Y_th</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Theoric curve, Y_max = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Y_max</span><span class="p">)</span><span class="si">}</span><span class="s2">, $r^2$ = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">F_th</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="c1"># plt.gca().set_aspect(&quot;equal&quot;) # Peut déformer le graphique, à utiliser avec précaution</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Fertilization (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Yield (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="c1"># plt.title(f&quot;Relation Fertilisation-Rendement\n($r^2$ = {r2})&quot;, fontsize=14, fontweight=&#39;bold&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Y.plot_Y_sigmoid">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.plot_Y_sigmoid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_Y_sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the fitted sigmoid yield curve and compare with observed fertilization-yield data.</span>

<span class="sd">        :param culture: Name of the crop.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Region identifier.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: None. Shows the matplotlib plot.</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">int_yr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no </span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2"> found in </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Fit sigmoïde</span>
        <span class="n">Ymax</span><span class="p">,</span> <span class="n">k_opt</span><span class="p">,</span> <span class="n">x0_opt</span><span class="p">,</span> <span class="n">Y_th_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_Y_sigmoid</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="n">F_th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">Y_th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_sigmoid_cap</span><span class="p">(</span><span class="n">F_th</span><span class="p">,</span> <span class="n">Ymax</span><span class="p">,</span> <span class="n">k_opt</span><span class="p">,</span> <span class="n">x0_opt</span><span class="p">)</span>

        <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2_score</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_sigmoid_cap</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Ymax</span><span class="p">,</span> <span class="n">k_opt</span><span class="p">,</span> <span class="n">x0_opt</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">int_yr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Historical data&quot;</span><span class="p">)</span>

        <span class="c1"># 2. Ajouter une barre de couleur pour servir de légende pour les années</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="c1"># --- Fin des modifications ---</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ligne 1:1&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">F_th</span><span class="p">,</span>
            <span class="n">Y_th</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Theoric curve, Y_max = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Ymax</span><span class="p">)</span><span class="si">}</span><span class="s2">, $r^2$ = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">F_th</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="c1"># plt.gca().set_aspect(&quot;equal&quot;) # Peut déformer le graphique, à utiliser avec précaution</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Fertilization (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Yield (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="c1"># plt.title(f&quot;Relation Fertilisation-Rendement\n($r^2$ = {r2})&quot;, fontsize=14, fontweight=&#39;bold&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Y.plot_Y_lin_2_smooth">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.plot_Y_lin_2_smooth">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_Y_lin_2_smooth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the smooth transition linear-2 slope yield model and observed data points.</span>

<span class="sd">        :param culture: Name of the crop.</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :param region: Region code.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: None. Generates a yield vs fertilization curve.</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">int_yr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no </span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2"> found in </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Fit sigmoïde</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">Y_th_fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_Y_lin_2_smooth</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="n">F_th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">F</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
        <span class="n">Y_th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_lin_2_smooth</span><span class="p">(</span><span class="n">F_th</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

        <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2_score</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_th_lin_2_smooth</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">xb</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">scatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">int_yr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Historical data&quot;</span><span class="p">)</span>

        <span class="c1"># 2. Ajouter une barre de couleur pour servir de légende pour les années</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="c1"># --- Fin des modifications ---</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ligne 1:1&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">F_th</span><span class="p">,</span>
            <span class="n">Y_th</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Theoric curve, $r^2$ = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">F_th</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="c1"># plt.gca().set_aspect(&quot;equal&quot;) # Peut déformer le graphique, à utiliser avec précaution</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Fertilization (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Yield (kgN/ha/yr)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="c1"># plt.title(f&quot;Relation Fertilisation-Rendement\n($r^2$ = {r2})&quot;, fontsize=14, fontweight=&#39;bold&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="Y.compare_r2">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.Y.compare_r2">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compare_r2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare fitted yield model results across crop types for a given region.</span>

<span class="sd">        Evaluates and visualizes the yield ceiling (Ymax) or R² for multiple curve-fitting models:</span>
<span class="sd">        - Ratio-based (Mitscherlich)</span>
<span class="sd">        - Exponential</span>
<span class="sd">        - Linear (1 slope)</span>
<span class="sd">        - Linear (2 slopes)</span>
<span class="sd">        - Polynomial</span>
<span class="sd">        - Sigmoid</span>

<span class="sd">        Results are displayed in a heatmap per culture for the selected region.</span>

<span class="sd">        :param region: Region name or code.</span>
<span class="sd">        :type region: str</span>
<span class="sd">        :return: Tuple of NumPy array with values and dictionary of model outputs.</span>
<span class="sd">        :rtype: Tuple[np.ndarray, dict]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r2_values</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Ratio&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;Exponential&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;Linear 1 slope&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;Linear 2 slopes&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;Polynomial&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;Sigmoid&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>

        <span class="c1"># Barre de progression avec tqdm</span>
        <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">cultures</span> <span class="o">+</span> <span class="n">prairies</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Calcul des R²&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;culture&quot;</span><span class="p">):</span>
            <span class="n">F</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Y</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">F</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1"># r2_values[&quot;Ratio&quot;][culture] = np.nan</span>
                <span class="c1"># r2_values[&quot;Exponential&quot;][culture] = np.nan</span>
                <span class="c1"># r2_values[&quot;Linear 1 slope&quot;][culture] = np.nan</span>
                <span class="c1"># r2_values[&quot;Linear 2 slopes&quot;][culture] = np.nan</span>
                <span class="c1"># r2_values[&quot;Polynomial&quot;][culture] = np.nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Ajustement avec la première fonction (Y_th)</span>
                <span class="n">Y_max_th</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_Y</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Y_max_th</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Ratio&quot;</span><span class="p">][</span><span class="n">culture</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y_max_th</span>
                    <span class="c1"># r2_values[&quot;Ratio&quot;][culture] = np.round(r2_score(Y, self.Y_th(F, Y_max_th)), 2)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Ratio&quot;</span><span class="p">][</span><span class="n">culture</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># Ajustement avec la seconde fonction (Y_th_exp)</span>
                <span class="n">Y_max_exp</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_Y_exp</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Y_max_exp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Exponential&quot;</span><span class="p">][</span><span class="n">culture</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Y_max_exp</span><span class="p">)</span>
                    <span class="c1"># r2_values[&quot;Exponential&quot;][culture] = np.round(r2_score(Y, self.Y_th_exp(F, Y_max_exp, k)), 2)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Exponential&quot;</span><span class="p">][</span><span class="n">culture</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Ajustement avec la troisieme fonction (Y_th_lin)</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_Y_lin</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Linear 1 slope&quot;</span><span class="p">][</span><span class="n">culture</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="c1"># r2_values[&quot;Linear 1 slope&quot;][culture] = np.round(r2_score(Y, self.Y_th_lin(F, a, b)), 2)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Linear 1 slope&quot;</span><span class="p">][</span><span class="n">culture</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Ajustement avec la quatrième fonction (Y_th_lin_2)</span>
                <span class="c1"># a, xb, c, _ = self.fit_Y_lin_2(culture, region)</span>
                <span class="c1"># if a is not None:</span>
                <span class="c1">#     r2_values[&quot;Linear 2 slopes&quot;][culture] = np.round(r2_score(Y, self.Y_th_lin_2(F, a, xb, c)), 2)</span>
                <span class="c1"># else:</span>
                <span class="c1">#     r2_values[&quot;Linear 2 slopes&quot;][culture] = 0</span>
                <span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Linear 2 slopes&quot;</span><span class="p">][</span><span class="n">culture</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                <span class="c1"># Ajustement avec la cinquième fonction (Y_th_poly)</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_Y_poly_constrained</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Polynomial&quot;</span><span class="p">][</span><span class="n">culture</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">))</span>
                    <span class="c1"># r2_values[&quot;Polynomial&quot;][culture] = np.round(r2_score(Y, self.Y_th_poly(F, a, b)), 2)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Polynomial&quot;</span><span class="p">][</span><span class="n">culture</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># Ajustement avec la cinquième fonction (Y_th_poly)</span>
                <span class="n">Ymax</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_Y_sigmoid</span><span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">Ymax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Sigmoid&quot;</span><span class="p">][</span><span class="n">culture</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Ymax</span><span class="p">)</span>
                    <span class="c1"># r2_values[&quot;Sigmoid&quot;][culture] = np.round(r2_score(Y, self.Y_th_sigmoid_cap(F, Ymax, k, x0)), 2)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Sigmoid&quot;</span><span class="p">][</span><span class="n">culture</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Création d&#39;un DataFrame pour la heatmap</span>
        <span class="n">r2_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Ratio&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Exponential&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Linear 1 slope&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Linear 2 slopes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Polynomial&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Sigmoid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Création de la heatmap</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cultures</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
            <span class="n">r2_df</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">,</span>  <span class="c1"># &quot;coolwarm&quot;,</span>
            <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Ymax&quot;</span><span class="p">},</span>
            <span class="c1"># cbar_kws={&quot;label&quot;: &quot;R² Score&quot;},</span>
            <span class="n">xticklabels</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;Exponential&quot;</span><span class="p">,</span> <span class="s2">&quot;Linear 1 slope&quot;</span><span class="p">,</span> <span class="s2">&quot;Linear 2 slopes&quot;</span><span class="p">,</span> <span class="s2">&quot;Polynomial&quot;</span><span class="p">,</span> <span class="s2">&quot;Sigmoid&quot;</span><span class="p">],</span>
            <span class="n">yticklabels</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">r2_values</span><span class="p">[</span><span class="s2">&quot;Ratio&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
            <span class="n">vmax</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
            <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Comparaison des Ymax (kgN/ha) pour </span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># R² Ymax</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Modèle&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Culture&quot;</span><span class="p">)</span>

        <span class="c1"># Affichage de la heatmap</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">r2_df</span><span class="p">,</span> <span class="n">r2_values</span></div>
</div>



<span class="c1">## % Prospective classes</span>


<div class="viewcode-block" id="CultureData_prospect">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.CultureData_prospect">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CultureData_prospect</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare and structure crop data required for prospective scenarios in the NitrogenFlowModel.</span>

<span class="sd">    This class constructs a DataFrame (`df_cultures`) that includes area, fertilization spread ratio,</span>
<span class="sd">    nitrogen content, and yield function parameters (depending on the selected model).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">data_path</span><span class="p">,</span> <span class="n">categories_mapping</span><span class="p">,</span> <span class="n">func_prod</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the CultureData_prospect instance.</span>

<span class="sd">        :param main: DataFrame containing aggregate area information (e.g. &quot;Arable area&quot;, &quot;Permanent grassland area&quot;).</span>
<span class="sd">        :type main: pd.DataFrame</span>
<span class="sd">        :param area: DataFrame with crop-specific area and yield function parameters.</span>
<span class="sd">        :type area: pd.DataFrame</span>
<span class="sd">        :param data_path: Path to the Excel file containing additional crop data.</span>
<span class="sd">        :type data_path: str</span>
<span class="sd">        :param categories_mapping: Mapping dictionary for crop categorization (not directly used here).</span>
<span class="sd">        :type categories_mapping: dict</span>
<span class="sd">        :param func_prod: Production function name (&quot;Linear&quot;, &quot;Ratio&quot;, or &quot;Exponential&quot;).</span>
<span class="sd">        :type func_prod: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="n">main</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">area</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">data_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">categories_mapping</span> <span class="o">=</span> <span class="n">categories_mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_prod</span> <span class="o">=</span> <span class="n">func_prod</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_culture_dataframe</span><span class="p">()</span>

<div class="viewcode-block" id="CultureData_prospect.create_culture_dataframe">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.CultureData_prospect.create_culture_dataframe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_culture_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the `df_cultures` DataFrame combining area, fertilization spreading ratio,</span>
<span class="sd">        nitrogen content, and yield function parameters for each crop.</span>

<span class="sd">        The structure and included parameters depend on the selected yield function model.</span>

<span class="sd">        :return: A pandas DataFrame with all necessary parameters for crop modeling.</span>
<span class="sd">        :rtype: pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">crops_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">area</span><span class="p">[</span><span class="s2">&quot;Crops&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># Extraire les données de surface</span>
        <span class="n">arable_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Arable area&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">grassland_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Permanent grassland area&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">area</span><span class="p">[</span><span class="s2">&quot;Area proportion (%)&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">arable_area</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">area</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">=</span> <span class="n">grassland_area</span>
        <span class="n">area</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">crops_index</span>

        <span class="c1"># Extraire les taux de surface avec épendage et la teneur en azote des cultures</span>
        <span class="n">epend</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;GRAFS_data.xlsx&quot;</span><span class="p">),</span>
            <span class="n">sheet_name</span><span class="o">=</span><span class="s2">&quot;crops&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">epend</span> <span class="o">=</span> <span class="n">epend</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Note&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">epend</span> <span class="o">=</span> <span class="n">epend</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Culture&quot;</span><span class="p">)</span>
        <span class="n">epend</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">area</span>

        <span class="c1"># Ajouter les paramètres des fonctions de production</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_prod</span> <span class="o">==</span> <span class="s2">&quot;Linear&quot;</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">area</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">a</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">crops_index</span>

            <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">area</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">b</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">crops_index</span>

            <span class="n">epend</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
            <span class="n">epend</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_prod</span> <span class="o">==</span> <span class="s2">&quot;Ratio&quot;</span><span class="p">:</span>
            <span class="n">Ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">area</span><span class="p">[</span><span class="s2">&quot;Ymax (kgN/ha)&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">Ymax</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">crops_index</span>

            <span class="n">epend</span><span class="p">[</span><span class="s2">&quot;Ymax (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ymax</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_prod</span> <span class="o">==</span> <span class="s2">&quot;Exponential&quot;</span><span class="p">:</span>
            <span class="n">Ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">area</span><span class="p">[</span><span class="s2">&quot;Ymax (kgN/ha)&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">Ymax</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">crops_index</span>
            <span class="n">epend</span><span class="p">[</span><span class="s2">&quot;Ymax (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ymax</span>

            <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">area</span><span class="p">[</span><span class="s2">&quot;k (kgN/ha)&quot;</span><span class="p">][:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">k</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">crops_index</span>
            <span class="n">epend</span><span class="p">[</span><span class="s2">&quot;k (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>

        <span class="k">return</span> <span class="n">epend</span></div>
</div>



<div class="viewcode-block" id="ElevageData_prospect">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.ElevageData_prospect">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ElevageData_prospect</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare and structure livestock data required for prospective scenarios in the NitrogenFlowModel.</span>

<span class="sd">    This class aggregates technical coefficients and main livestock statistics to compute nitrogen flows,</span>
<span class="sd">    production outputs, and excretion routes by species.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main</span><span class="p">,</span> <span class="n">technical</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the ElevageData_prospect instance.</span>

<span class="sd">        :param main: DataFrame with general livestock variables (e.g., total LU).</span>
<span class="sd">        :type main: pd.DataFrame</span>
<span class="sd">        :param technical: DataFrame with technical coefficients by animal type.</span>
<span class="sd">        :type technical: pd.DataFrame</span>
<span class="sd">        :param data_path: Path to the Excel file with volatilisation and nitrogen content.</span>
<span class="sd">        :type data_path: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="n">main</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">technical</span> <span class="o">=</span> <span class="n">technical</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_elevage_dataframe</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">technical</span><span class="p">,</span> <span class="n">data_path</span><span class="p">)</span>

<div class="viewcode-block" id="ElevageData_prospect.create_elevage_dataframe">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.ElevageData_prospect.create_elevage_dataframe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_elevage_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">main</span><span class="p">,</span> <span class="n">technical</span><span class="p">,</span> <span class="n">data_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the `df_elevage` DataFrame containing:</span>
<span class="sd">        - livestock units (LU) per species</span>
<span class="sd">        - productivity indicators (carcass and dairy)</span>
<span class="sd">        - excretion distributions</span>
<span class="sd">        - volatilisation rates</span>
<span class="sd">        - ingestion and nitrogen partitioning (edible, non-edible, excreted)</span>

<span class="sd">        :param main: General livestock statistics.</span>
<span class="sd">        :type main: pd.DataFrame</span>
<span class="sd">        :param technical: Technical coefficients for livestock management.</span>
<span class="sd">        :type technical: pd.DataFrame</span>
<span class="sd">        :param data_path: Path to nitrogen content Excel file.</span>
<span class="sd">        :type data_path: str</span>
<span class="sd">        :return: A pandas DataFrame with livestock nitrogen and productivity balances.</span>
<span class="sd">        :rtype: pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Bovines&quot;</span><span class="p">,</span> <span class="s2">&quot;Ovines&quot;</span><span class="p">,</span> <span class="s2">&quot;Caprines&quot;</span><span class="p">,</span> <span class="s2">&quot;Equines&quot;</span><span class="p">,</span> <span class="s2">&quot;Poultry&quot;</span><span class="p">,</span> <span class="s2">&quot;Porcines&quot;</span><span class="p">]</span>
        <span class="n">LU_tot</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Total LU&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="n">LU</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">prod</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dairy</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">excr</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">manure</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">o_liter</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">slurry</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">grass</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="n">LU</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">technical</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">technical</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> LU&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">LU_tot</span>
            <span class="n">prod</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">technical</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">technical</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> productivity&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">excr</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">technical</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">technical</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;kgN excreted by </span><span class="si">{</span><span class="n">t</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2"> LU&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">manure</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">technical</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">technical</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> % excretion in the barn as litter manure&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">o_liter</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">technical</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">technical</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> % excretion in the barn as other manure&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">slurry</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">technical</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">technical</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> % excretion in the barn as slurry&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">grass</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">technical</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">technical</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> % excretion on grassland&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Bovines&quot;</span><span class="p">,</span> <span class="s2">&quot;Ovines&quot;</span><span class="p">,</span> <span class="s2">&quot;Poultry&quot;</span><span class="p">,</span> <span class="s2">&quot;Caprines&quot;</span><span class="p">]:</span>
                <span class="n">dairy</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">technical</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">technical</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> dairy productivity&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dairy</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">gas_em</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;GRAFS_data.xlsx&quot;</span><span class="p">),</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s2">&quot;Volatilisation&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
            <span class="s2">&quot;Elevage&quot;</span>
        <span class="p">)</span>

        <span class="n">combined_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;LU&quot;</span><span class="p">:</span> <span class="n">LU</span><span class="p">,</span>
            <span class="s2">&quot;Productivity (kgcarcass/LU)&quot;</span><span class="p">:</span> <span class="n">prod</span><span class="p">,</span>
            <span class="s2">&quot;Dairy Productivity (kg/LU)&quot;</span><span class="p">:</span> <span class="n">dairy</span><span class="p">,</span>
            <span class="s2">&quot;Excretion per LU (kgN/LU)&quot;</span><span class="p">:</span> <span class="n">excr</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted on grassland&quot;</span><span class="p">:</span> <span class="n">grass</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as manure&quot;</span><span class="p">:</span> <span class="n">manure</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as other manure&quot;</span><span class="p">:</span> <span class="n">o_liter</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as slurry&quot;</span><span class="p">:</span> <span class="n">slurry</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span>
        <span class="n">combined_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">combined_df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;equines&quot;</span><span class="p">:</span> <span class="s2">&quot;equine&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gas_em</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted on grassland&quot;</span><span class="p">]</span>
        <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;Production (ktcarcass)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;LU&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;Productivity (kgcarcass/LU)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-6</span>
        <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;Dairy Production (kt)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;LU&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;Dairy Productivity (kg/LU)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-6</span>

        <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;Production (ktcarcass)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">dible&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;Dairy Production (kt)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;%N dairy&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;Non Edible Nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;Production (ktcarcass)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;% non edible&quot;</span><span class="p">]</span>

        <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;Excretion per LU (kgN/LU)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;LU&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-6</span>

        <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;Ingestion (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">combined_df</span><span class="p">[</span><span class="s2">&quot;Non Edible Nitrogen (ktN)&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">combined_df</span></div>
</div>



<div class="viewcode-block" id="NitrogenFlowModel_prospect">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NitrogenFlowModel_prospect</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prospective extension of the NitrogenFlowModel for forward-looking nitrogen flow simulations.</span>

<span class="sd">    This class initializes and manages all components required for scenario-based nitrogen budgeting.</span>
<span class="sd">    It uses scenario-specific sheets for inputs (land use, livestock, technical parameters), and</span>
<span class="sd">    dynamically computes nitrogen fluxes between labeled system compartments using an adjacency matrix.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        scenar_path (str): Path to the Excel file containing scenario sheets.</span>
<span class="sd">        labels (list): List of nitrogen system compartments used to label the adjacency matrix.</span>
<span class="sd">        df_cultures (pd.DataFrame): Crop-related nitrogen flows and parameters.</span>
<span class="sd">        df_elevage (pd.DataFrame): Livestock-related nitrogen flows and parameters.</span>
<span class="sd">        adjacency_matrix (np.ndarray): Matrix of nitrogen fluxes between compartments (in ktN/year).</span>
<span class="sd">        label_to_index (dict): Mapping from compartment labels to matrix indices.</span>
<span class="sd">        year (int): Scenario year (extracted from metadata).</span>
<span class="sd">        region (str): Scenario region (extracted from metadata).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scenar_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scenar_path</span> <span class="o">=</span> <span class="n">scenar_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">categories_mapping</span> <span class="o">=</span> <span class="n">categories_mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cultures</span> <span class="o">=</span> <span class="n">cultures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legumineuses</span> <span class="o">=</span> <span class="n">legumineuses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prairies</span> <span class="o">=</span> <span class="n">prairies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">betail</span> <span class="o">=</span> <span class="n">betail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Pop</span> <span class="o">=</span> <span class="n">Pop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scenar_sheets</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenar_path</span><span class="p">),</span> <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenar_sheets</span><span class="p">[</span><span class="s2">&quot;doc&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenar_sheets</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenar_sheets</span><span class="p">[</span><span class="s2">&quot;area&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">technical</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scenar_sheets</span><span class="p">[</span><span class="s2">&quot;technical&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;excel sheet for scenario writing&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Production function&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">culture_data</span> <span class="o">=</span> <span class="n">CultureData_prospect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">area</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="n">categories_mapping</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevage_data</span> <span class="o">=</span> <span class="n">ElevageData_prospect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">technical</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux_generator</span> <span class="o">=</span> <span class="n">FluxGenerator</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">culture_data</span><span class="o">.</span><span class="n">df_cultures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elevage_data</span><span class="o">.</span><span class="n">df_elevage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_generator</span><span class="o">.</span><span class="n">adjacency_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_to_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_generator</span><span class="o">.</span><span class="n">label_to_index</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compute_fluxes</span><span class="p">()</span>

<div class="viewcode-block" id="NitrogenFlowModel_prospect.plot_heatmap">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.plot_heatmap">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_heatmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a static heatmap of the nitrogen flux adjacency matrix.</span>

<span class="sd">        The heatmap displays nitrogen transfers (in ktN/year) between system compartments, on a log scale.</span>
<span class="sd">        Axes are labeled with numerical indices, and a legend maps these indices to compartment names.</span>

<span class="sd">        Features:</span>
<span class="sd">            - Log-normalized color scale (&quot;plasma_r&quot;).</span>
<span class="sd">            - Axis ticks on top (X) and left (Y).</span>
<span class="sd">            - Custom colorbar and visual grid.</span>
<span class="sd">            - Aspect ratio constrained to &quot;equal&quot; for readability.</span>
<span class="sd">            - Compartment label legend placed on the right.</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="c1"># Créer la heatmap sans grille pour le moment</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">10</span><span class="o">**-</span><span class="mi">4</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">,</span>
            <span class="n">xticklabels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">yticklabels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma_r&quot;</span><span class="p">,</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;ktN/year&quot;</span><span class="p">,</span> <span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="s2">&quot;pad&quot;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Ajouter la grille en gris clair</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># Déplacer les labels de l&#39;axe x en haut</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>  <span class="c1"># Placer les ticks en haut</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>  <span class="c1"># Placer le label en haut</span>

        <span class="c1"># Rotation des labels de l&#39;axe x</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="c1"># Assurer que les axes sont égaux</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">)</span>
        <span class="c1"># Ajouter des labels et un titre</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Target&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Source&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="c1"># plt.title(f&#39;Heatmap of adjacency matrix for {region} in {year}&#39;)</span>

        <span class="n">legend_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mf">1.05</span><span class="p">,</span>
                <span class="mi">1</span> <span class="o">-</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">),</span>
                <span class="n">label</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">linespacing</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># Augmenter l&#39;espacement entre les lignes</span>

        <span class="c1"># plt.subplots_adjust(bottom=0.2, right=0.85)  # Réduire l&#39;espace vertical entre la heatmap et la colorbar</span>
        <span class="c1"># Afficher la heatmap</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.plot_heatmap_interactive">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.plot_heatmap_interactive">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_heatmap_interactive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate an interactive Plotly heatmap of the nitrogen flux adjacency matrix.</span>

<span class="sd">        This interactive version allows detailed inspection of each flux with tooltip information,</span>
<span class="sd">        uses a log10 transformation for the color scale, and supports hover interactivity and zooming.</span>

<span class="sd">        Features:</span>
<span class="sd">            - Simulated log-scale using log10.</span>
<span class="sd">            - Horizontal colorbar with real-world units (ktN/year).</span>
<span class="sd">            - Tooltip shows source, target, and value.</span>
<span class="sd">            - Index-to-label legend annotated on the right.</span>
<span class="sd">            - Matrix layout with reversed Y axis and axis ticks from 1 to N.</span>

<span class="sd">        :return: Plotly Figure object (can be shown with `fig.show()`).</span>
<span class="sd">        :rtype: plotly.graph_objs.Figure</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 1) Préparation des labels numériques</span>
        <span class="n">x_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">y_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Si vous ignorez la dernière ligne/colonne comme dans votre code :</span>
        <span class="n">adjacency_subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">),</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)]</span>

        <span class="c1"># 2) Gestion min/max et transformation log10</span>
        <span class="n">cmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">adjacency_subset</span><span class="p">[</span><span class="n">adjacency_subset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">cmax</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># np.max(adjacency_subset)</span>
        <span class="n">log_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">adjacency_subset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">adjacency_subset</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># 3) Construire un tableau 2D de chaînes pour le survol</span>
        <span class="c1">#    Même dimension que log_matrix</span>
        <span class="n">strings_matrix</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row_i</span><span class="p">,</span> <span class="n">y_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_labels</span><span class="p">):</span>
            <span class="n">row_texts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col_i</span><span class="p">,</span> <span class="n">x_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_labels</span><span class="p">):</span>
                <span class="c1"># Valeur réelle (non log) =&gt; adjacency_subset[row_i, col_i]</span>
                <span class="n">real_val</span> <span class="o">=</span> <span class="n">adjacency_subset</span><span class="p">[</span><span class="n">row_i</span><span class="p">,</span> <span class="n">col_i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">real_val</span><span class="p">):</span>
                    <span class="n">real_val_str</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">real_val_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">real_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># format décimal / exposant</span>
                <span class="c1"># Construire la chaîne pour la tooltip</span>
                <span class="c1"># y_val et x_val sont les indices 1..N</span>
                <span class="c1"># self.labels[y_val] = nom de la source, self.labels[x_val] = nom de la cible</span>
                <span class="n">tooltip_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Source : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">y_val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;br&gt;Target : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">x_val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;br&gt;Value  : </span><span class="si">{</span><span class="n">real_val_str</span><span class="si">}</span><span class="s2"> ktN/yr&quot;</span>
                <span class="n">row_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tooltip_str</span><span class="p">)</span>
            <span class="n">strings_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_texts</span><span class="p">)</span>

        <span class="c1"># 3) Tracé Heatmap avec go.Figure + go.Heatmap</span>
        <span class="c1">#    On règle &quot;zmin&quot; et &quot;zmax&quot; en valeurs log10</span>
        <span class="c1">#    pour contrôler la gamme de couleurs</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span>
            <span class="n">z</span><span class="o">=</span><span class="n">log_matrix</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_labels</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_labels</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Plasma_r&quot;</span><span class="p">,</span>
            <span class="n">zmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cmin</span><span class="p">),</span>
            <span class="n">zmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cmax</span><span class="p">),</span>
            <span class="n">text</span><span class="o">=</span><span class="n">strings_matrix</span><span class="p">,</span>  <span class="c1"># tableau 2D de chaînes</span>
            <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>  <span class="c1"># on n&#39;affiche plus x, y, z bruts</span>
            <span class="c1"># Colorbar horizontale</span>
            <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ktN/year&quot;</span><span class="p">,</span>
                <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># centré horizontalement</span>
                <span class="n">xanchor</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=-</span><span class="mf">0.15</span><span class="p">,</span>  <span class="c1"># en dessous de la figure</span>
                <span class="n">thickness</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>  <span class="c1"># épaisseur</span>
                <span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># longueur en fraction de la largeur</span>
            <span class="p">),</span>
            <span class="c1"># Valeurs de survol -&gt; vous verrez log10(...) par défaut</span>
            <span class="c1"># Pour afficher la valeur réelle, on peut plus tard utiliser &quot;customdata&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Créer la figure et y ajouter le trace</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">trace</span><span class="p">])</span>

        <span class="c1"># 4) Discrétisation manuelle des ticks sur la colorbar</span>
        <span class="c1">#    On veut afficher l&#39;échelle réelle (et pas log10)</span>
        <span class="c1">#    =&gt; calcul de tickvals en log10, et ticktext en 10^(tickvals)</span>
        <span class="n">tickvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cmin</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cmax</span><span class="p">)),</span> <span class="n">num</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">ticktext</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>  <span class="c1"># [f&quot;{10**v:.2e}&quot; for v in tickvals]</span>
        <span class="c1"># Mettre à jour le trace pour forcer l&#39;affichage</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ktN/year&quot;</span><span class="p">,</span>
                <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">xanchor</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=-</span><span class="mf">0.15</span><span class="p">,</span>
                <span class="n">thickness</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                <span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">tickmode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
                <span class="n">tickvals</span><span class="o">=</span><span class="n">tickvals</span><span class="p">,</span>
                <span class="n">ticktext</span><span class="o">=</span><span class="n">ticktext</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 5) Configuration de la mise en page</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">1980</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">150</span><span class="p">),</span>  <span class="c1"># espace à droite pour la légende</span>
        <span class="p">)</span>

        <span class="c1"># Axe X en haut</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Target&quot;</span><span class="p">,</span>
            <span class="n">side</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>  <span class="c1"># place les ticks en haut</span>
            <span class="n">tickangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>  <span class="c1"># rotation</span>
            <span class="n">tickmode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
            <span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
            <span class="n">tickvals</span><span class="o">=</span><span class="n">x_labels</span><span class="p">,</span>  <span class="c1"># forcer l&#39;affichage 1..N</span>
            <span class="n">ticktext</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_labels</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Axe Y : inverser l&#39;ordre pour un style &quot;matriciel&quot; standard</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Source&quot;</span><span class="p">,</span>
            <span class="n">autorange</span><span class="o">=</span><span class="s2">&quot;reversed&quot;</span><span class="p">,</span>
            <span class="n">tickmode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
            <span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
            <span class="n">tickvals</span><span class="o">=</span><span class="n">y_labels</span><span class="p">,</span>
            <span class="n">ticktext</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">y_labels</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># 6) Ajouter la légende à droite</span>
        <span class="c1">#    Format : &quot;1: label[0]&quot; ... vertical</span>
        <span class="n">legend_text</span> <span class="o">=</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">lbl</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span>  <span class="c1"># un peu à droite</span>
            <span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># centré en hauteur</span>
            <span class="n">xref</span><span class="o">=</span><span class="s2">&quot;paper&quot;</span><span class="p">,</span>
            <span class="n">yref</span><span class="o">=</span><span class="s2">&quot;paper&quot;</span><span class="p">,</span>
            <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="n">legend_text</span><span class="p">,</span>
            <span class="n">align</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;middle&quot;</span><span class="p">,</span>
            <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span>
            <span class="n">bordercolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
            <span class="n">borderwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">borderpad</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.compute_fluxes">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.compute_fluxes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_fluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute nitrogen flows across all compartments for the given scenario.</span>

<span class="sd">        This method:</span>
<span class="sd">            - Retrieves key scenario inputs (year, region, crop and livestock data).</span>
<span class="sd">            - Initializes the flux generator using crop and livestock data.</span>
<span class="sd">            - Updates the adjacency matrix accordingly.</span>

<span class="sd">        Must be called during initialization to populate model outputs.</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extraire les variables nécessaires</span>
        <span class="n">df_cultures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span>
        <span class="n">df_elevage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span>
        <span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span>
        <span class="n">label_to_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_to_index</span>
        <span class="n">main</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main</span>
        <span class="n">technical</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">technical</span>
        <span class="n">area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">area</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;excel sheet for scenario writing&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;excel sheet for scenario writing&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Region name&quot;</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>
        <span class="n">flux_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_generator</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Linear&quot;</span><span class="p">:</span>
            <span class="n">ym</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;Exponential&quot;</span><span class="p">]:</span>
            <span class="n">ym</span> <span class="o">=</span> <span class="s2">&quot;Ymax (kgN/ha)&quot;</span>

        <span class="c1"># Gestion du cas particulier pour &#39;Straw&#39;</span>
        <span class="n">cereales</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;Rye&quot;</span><span class="p">,</span> <span class="s2">&quot;Barley&quot;</span><span class="p">,</span> <span class="s2">&quot;Oat&quot;</span><span class="p">,</span> <span class="s2">&quot;Grain maize&quot;</span><span class="p">,</span> <span class="s2">&quot;Other cereals&quot;</span><span class="p">]</span>
        <span class="n">somme_surface_cereales</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">][</span><span class="n">cereales</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Straw&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">somme_surface_cereales</span>
            <span class="o">*</span> <span class="mf">0.1</span>  <span class="c1"># On attribue 10% des surfaces de céréales à la paille. A changer avec les coproduits TODO</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">cereal</span> <span class="ow">in</span> <span class="n">cereales</span><span class="p">:</span>
            <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cereal</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span>
                <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Straw&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cereal</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">somme_surface_cereales</span>
            <span class="p">)</span>

        <span class="c1"># Flux depuis &#39;other sectors&#39; vers les cibles sélectionnées</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;Exponential&quot;</span><span class="p">]:</span>
            <span class="c1"># Pour éviter des valeur délirante, on interprète ymax comme un niveau de fertilisation caractéristique (Y(Ymax) = Ymax/2)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Seed input (kt seeds/kt Ymax)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="p">[</span><span class="n">ym</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-6</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Seed input (kt seeds/kt Ymax)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="p">[</span><span class="n">ym</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-6</span>
            <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;other sectors&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Fixation symbiotique</span>
        <span class="n">target_fixation</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;N fixation coef (kgN/kgN)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="p">[</span><span class="n">ym</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e-6</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">source_fixation</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source_fixation</span><span class="p">,</span> <span class="n">target_fixation</span><span class="p">)</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Symbiotic fixation (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">target_fixation</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">## Épandage de boue sur les champs</span>
        <span class="n">FE_N_N02_em</span> <span class="o">=</span> <span class="mf">0.002</span>
        <span class="n">FE_N_NH3_em</span> <span class="o">=</span> <span class="mf">0.118</span>
        <span class="n">FE_N_N2_em</span> <span class="o">=</span> <span class="mf">0.425</span>
        <span class="n">pop</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Population&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">prop_urb</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Urban population&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">N_cons_cap</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Total per capita protein ingestion&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">N_cap_vege</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Vegetal per capita protein ingestion&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">N_cap_viande</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">main</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Edible animal per capita protein ingestion (excl fish)&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">N_boue</span> <span class="o">=</span> <span class="n">pop</span> <span class="o">*</span> <span class="n">N_cons_cap</span>
        <span class="n">N_vege</span> <span class="o">=</span> <span class="n">pop</span> <span class="o">*</span> <span class="n">N_cap_vege</span>
        <span class="n">N_viande</span> <span class="o">=</span> <span class="n">pop</span> <span class="o">*</span> <span class="n">N_cap_viande</span>
        <span class="c1"># Et calcul rapide sur les ingestions de produits de la pêche</span>
        <span class="n">N_fish</span> <span class="o">=</span> <span class="n">N_boue</span> <span class="o">-</span> <span class="n">N_vege</span> <span class="o">-</span> <span class="n">N_viande</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fishery products&quot;</span><span class="p">:</span> <span class="n">N_fish</span><span class="p">}</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">prop_urb</span><span class="p">,</span> <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">}</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Revenons aux boues</span>
        <span class="n">prop_recy_urb</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">technical</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">technical</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;N recycling rate of human excretion in urban area&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="o">/</span> <span class="mi">100</span>
        <span class="p">)</span>
        <span class="n">prop_recy_rur</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">technical</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">technical</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;N recycling rate of human excretion in rural area&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="o">/</span> <span class="mi">100</span>
        <span class="p">)</span>

        <span class="n">Norm</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Spreading Rate (%)&quot;</span><span class="p">])</span>
        <span class="c1"># Création du dictionnaire target</span>
        <span class="n">target_ependage</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">culture</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Spreading Rate (%)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">Norm</span> <span class="k">for</span> <span class="n">culture</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">source_boue</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">prop_urb</span> <span class="o">*</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="n">prop_recy_urb</span><span class="p">,</span>
            <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span> <span class="o">*</span> <span class="n">prop_recy_rur</span> <span class="o">*</span> <span class="n">N_boue</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source_boue</span><span class="p">,</span> <span class="n">target_ependage</span><span class="p">)</span>

        <span class="c1"># Le reste est perdu dans l&#39;environnement</span>
        <span class="c1"># Ajouter les fuites de N2O</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="n">prop_urb</span> <span class="o">*</span> <span class="n">FE_N_N02_em</span><span class="p">,</span>
            <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span> <span class="o">*</span> <span class="n">FE_N_N02_em</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Ajouter les fuites de NH3</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="n">prop_urb</span> <span class="o">*</span> <span class="n">FE_N_NH3_em</span><span class="p">,</span>
            <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span> <span class="o">*</span> <span class="n">FE_N_NH3_em</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Ajouter les fuites de N2</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="n">prop_urb</span> <span class="o">*</span> <span class="n">FE_N_N2_em</span><span class="p">,</span>
            <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span> <span class="o">*</span> <span class="n">FE_N_N2_em</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Le reste est perdu dans l&#39;hydroshere</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hydro-system&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="n">prop_urb</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_recy_urb</span> <span class="o">-</span> <span class="n">FE_N_N02_em</span> <span class="o">-</span> <span class="n">FE_N_NH3_em</span> <span class="o">-</span> <span class="n">FE_N_N2_em</span><span class="p">),</span>
            <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_recy_rur</span> <span class="o">-</span> <span class="n">FE_N_NH3_em</span> <span class="o">-</span> <span class="n">FE_N_N02_em</span> <span class="o">-</span> <span class="n">FE_N_N2_em</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="c1"># Remplir la matrice d&#39;adjacence</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Azote excrété sur les prairies</span>
        <span class="c1"># Calculer les poids pour chaque cible</span>
        <span class="c1"># Calcul de la surface totale pour les prairies</span>
        <span class="n">total_surface</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Alfalfa and clover&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Non-legume temporary meadow&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Création du dictionnaire target</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Alfalfa and clover&quot;</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Alfalfa and clover&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_surface</span><span class="p">,</span>
            <span class="s2">&quot;Non-legume temporary meadow&quot;</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Non-legume temporary meadow&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_surface</span><span class="p">,</span>
            <span class="s2">&quot;Natural meadow &quot;</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_surface</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted on grassland&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-NH3 EM. outdoor&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2O EM. outdoor&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2 EM. outdoor&quot;</span><span class="p">])</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Le reste est émit dans l&#39;atmosphere</span>
        <span class="c1"># N2</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted on grassland&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2 EM. outdoor&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># NH3</span>
        <span class="c1"># 1 % est volatilisée de manière indirecte sous forme de N2O</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">:</span> <span class="mf">0.99</span><span class="p">,</span> <span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted on grassland&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-NH3 EM. outdoor&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># volat_N2O = (</span>
        <span class="c1">#     0.01</span>
        <span class="c1">#     * df_elevage[&quot;Excreted nitrogen (ktN)&quot;]</span>
        <span class="c1">#     * df_elevage[&quot;% excreted on grassland&quot;]</span>
        <span class="c1">#     / 100</span>
        <span class="c1">#     * df_elevage[&quot;N-NH3 EM. outdoor&quot;]</span>
        <span class="c1"># )</span>
        <span class="c1"># # N2O</span>
        <span class="c1"># target = {&quot;N2O emission&quot;: 1}</span>
        <span class="c1"># source = (</span>
        <span class="c1">#     volat_N2O</span>
        <span class="c1">#     + df_elevage[&quot;Excreted nitrogen (ktN)&quot;]</span>
        <span class="c1">#     * df_elevage[&quot;% excreted on grassland&quot;]</span>
        <span class="c1">#     / 100</span>
        <span class="c1">#     * df_elevage[&quot;N-N2O EM. outdoor&quot;]</span>
        <span class="c1"># ).to_dict()</span>

        <span class="c1"># flux_generator.generate_flux(source, target)</span>

        <span class="c1">## Epandage sur champs</span>

        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as manure&quot;</span><span class="p">]</span>
                <span class="o">/</span> <span class="mi">100</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="mi">1</span>
                    <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-NH3 EM. manure indoor&quot;</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2O EM. manure indoor&quot;</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2 EM. manure indoor&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as slurry&quot;</span><span class="p">]</span>
                <span class="o">/</span> <span class="mi">100</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="mi">1</span>
                    <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-NH3 EM. slurry indoor&quot;</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2O EM. slurry indoor&quot;</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2 EM. slurry indoor&quot;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target_ependage</span><span class="p">)</span>

        <span class="c1"># Le reste part dans l&#39;atmosphere</span>

        <span class="c1"># N2</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as slurry&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2 EM. slurry indoor&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as manure&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2 EM. manure indoor&quot;</span><span class="p">]</span>
                <span class="c1"># + other manure emission ?? TODO</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># NH3</span>
        <span class="c1"># 1 % est volatilisée de manière indirecte sous forme de N2O</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">:</span> <span class="mf">0.99</span><span class="p">,</span> <span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as slurry&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-NH3 EM. slurry indoor&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as manure&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-NH3 EM. manure indoor&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># volat_N2O = (</span>
        <span class="c1">#     0.01</span>
        <span class="c1">#     * df_elevage[&quot;Excreted nitrogen (ktN)&quot;]</span>
        <span class="c1">#     * df_elevage[&quot;% excreted indoors&quot;]</span>
        <span class="c1">#     / 100</span>
        <span class="c1">#     * (</span>
        <span class="c1">#         df_elevage[&quot;% excreted indoors as slurry&quot;] / 100 * df_elevage[&quot;N-NH3 EM. slurry indoor&quot;]</span>
        <span class="c1">#         + df_elevage[&quot;% excreted indoors as manure&quot;] / 100 * df_elevage[&quot;N-NH3 EM. manure indoor&quot;]</span>
        <span class="c1">#     )</span>
        <span class="c1"># )</span>
        <span class="c1"># # N2O</span>
        <span class="c1"># target = {&quot;N2O emission&quot;: 1}</span>
        <span class="c1"># source = (</span>
        <span class="c1">#     volat_N2O</span>
        <span class="c1">#     + df_elevage[&quot;Excreted nitrogen (ktN)&quot;]</span>
        <span class="c1">#     * df_elevage[&quot;% excreted indoors&quot;]</span>
        <span class="c1">#     / 100</span>
        <span class="c1">#     * (</span>
        <span class="c1">#         df_elevage[&quot;% excreted indoors as slurry&quot;] / 100 * df_elevage[&quot;N-N2O EM. slurry indoor&quot;]</span>
        <span class="c1">#         + df_elevage[&quot;% excreted indoors as manure&quot;] / 100 * df_elevage[&quot;N-N2O EM. manure indoor&quot;]</span>
        <span class="c1">#     )</span>
        <span class="c1"># ).to_dict()</span>

        <span class="c1"># flux_generator.generate_flux(source, target)</span>

        <span class="c1"># Dépôt atmosphérique : proportionel aux emmission de gaz azoté. A voir après l&#39;élevage !</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>  <span class="c1"># Dépôt proportionnel aux surface</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">adjacency_matrix</span><span class="p">[:,</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">:</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">adjacency_matrix</span><span class="p">[:,</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="c1"># TODO réfléchir à comment intégrer les retombées de la volatilisation des engrais synthétiques</span>
        <span class="n">adjacency_matrix</span><span class="p">[:,</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">]]</span> <span class="o">*=</span> <span class="mf">0.99</span>
        <span class="n">adjacency_matrix</span><span class="p">[:,</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">]]</span> <span class="o">*=</span> <span class="mf">0.9</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="n">df_cultures</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Calcul de l&#39;azote épendu par hectare</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">calculer_azote_ependu</span><span class="p">(</span><span class="n">culture</span><span class="p">):</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">betail</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pop</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">,</span> <span class="s2">&quot;other sectors&quot;</span><span class="p">,</span> <span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">,</span> <span class="s2">&quot;N2O emission&quot;</span><span class="p">]</span>
            <span class="n">adj_matrix_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">adjacency_matrix</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">adj_matrix_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sources</span><span class="p">,</span> <span class="n">culture</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Total Non Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">calculer_azote_ependu</span><span class="p">)</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Surface Non Synthetic Fertilizer Use (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Total Non Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Total Non Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Yield (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Les légumineuses ne reçoivent pas d&#39;azote synthétique. On peut déjà calculer leur rendement</span>
        <span class="k">for</span> <span class="n">leg</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;leguminous&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Alfalfa and clover&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Linear&quot;</span><span class="p">:</span>
                <span class="n">Yield</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">Y_th_lin</span><span class="p">(</span>
                    <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">leg</span><span class="p">,</span> <span class="s2">&quot;Surface Non Synthetic Fertilizer Use (kgN/ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                    <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">leg</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                    <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">leg</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Ratio&quot;</span><span class="p">:</span>
                <span class="n">Yield</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">Y_th</span><span class="p">(</span>
                    <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">leg</span><span class="p">,</span> <span class="s2">&quot;Surface Non Synthetic Fertilizer Use (kgN/ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                    <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">leg</span><span class="p">,</span> <span class="s2">&quot;Ymax (kgN/ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Exponential&quot;</span><span class="p">:</span>
                <span class="n">Yield</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">Y_th_exp_cap</span><span class="p">(</span>
                    <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">leg</span><span class="p">,</span> <span class="s2">&quot;Surface Non Synthetic Fertilizer Use (kgN/ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                    <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">leg</span><span class="p">,</span> <span class="s2">&quot;Ymax (kgN/ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                    <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">leg</span><span class="p">,</span> <span class="s2">&quot;k (kgN/ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span>
                <span class="p">)</span>
            <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">leg</span><span class="p">,</span> <span class="s2">&quot;Yield (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Yield</span>

        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Yield (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span>
        <span class="c1"># Mécanisme d&#39;héritage de l&#39;azote en surplus des légumineuses</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Leguminous Nitrogen Surplus (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">leg_with_alfalfa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">legumineuses</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Alfalfa and clover&quot;</span><span class="p">]</span>

        <span class="n">surplus</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">leg_with_alfalfa</span><span class="p">,</span> <span class="s2">&quot;Total Non Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="o">-</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">leg_with_alfalfa</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="p">)</span>

        <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">leg_with_alfalfa</span><span class="p">,</span> <span class="s2">&quot;Leguminous Nitrogen Surplus (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">surplus</span>

        <span class="c1"># Distribution du surplus aux céréales</span>
        <span class="n">total_surplus_azote</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Leguminous Nitrogen Surplus (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">total_surface_cereales</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;cereals (excluding rice)&quot;</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;Straw&quot;</span><span class="p">,</span> <span class="s2">&quot;Forage maize&quot;</span><span class="p">]))</span>
            <span class="p">),</span>
            <span class="s2">&quot;Area (ha)&quot;</span><span class="p">,</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Leguminous heritage (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">mask_cereales</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;cereals (excluding rice)&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;Straw&quot;</span><span class="p">,</span> <span class="s2">&quot;Forage maize&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># Extraire les surfaces concernées</span>
        <span class="n">surface_vals</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_cereales</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Calcul du surplus hérité à répartir</span>
        <span class="n">heritage_vals</span> <span class="o">=</span> <span class="n">surface_vals</span> <span class="o">/</span> <span class="n">total_surface_cereales</span> <span class="o">*</span> <span class="n">total_surplus_azote</span>

        <span class="c1"># Affecter proprement sans mismatch</span>
        <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask_cereales</span><span class="p">,</span> <span class="s2">&quot;Leguminous heritage (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">heritage_vals</span>

        <span class="c1"># Mise à jour de la fertilisation non synthétique</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="c1"># Calcul en numpy pour éviter le mismatch d&#39;index</span>
        <span class="n">heritage</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;Leguminous heritage (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="n">area</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">heritage</span> <span class="o">/</span> <span class="n">area</span> <span class="o">*</span> <span class="mf">1e6</span>

        <span class="c1"># Mise à jour avec des valeurs bien typées et bien alignées</span>
        <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;Surface Non Synthetic Fertilizer Use (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">delta</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Total Non Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Leguminous heritage (ktN)&quot;</span><span class="p">]</span>

        <span class="c1"># Génération des flux pour l&#39;héritage des légumineuses</span>
        <span class="n">source_leg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Leguminous Nitrogen Surplus (ktN)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Leguminous Nitrogen Surplus (ktN)&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Leguminous Nitrogen Surplus (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">target_leg</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Leguminous heritage (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source_leg</span><span class="p">,</span> <span class="n">target_leg</span><span class="p">)</span>

        <span class="n">net_import</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Net import of vegetal pdcts&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">Import</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">net_import</span><span class="p">)</span>

        <span class="n">N_synth_crop</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">main</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Synth N fertilizer application to cropland&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="o">*</span> <span class="n">main</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Arable area&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="o">/</span> <span class="mf">1e6</span>
        <span class="p">)</span>

        <span class="n">N_synth_grass</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">main</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Synth N fertilizer application to grassland&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="o">*</span> <span class="n">main</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">main</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Permanent grassland area&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="o">/</span> <span class="mf">1e6</span>
        <span class="p">)</span>

        <span class="n">w_diet</span> <span class="o">=</span> <span class="n">technical</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">technical</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Weight diet&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">w_Nsyn</span> <span class="o">=</span> <span class="n">technical</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">technical</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Weight synthetic fertilizer use&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">w_imp</span> <span class="o">=</span> <span class="n">technical</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">technical</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Weight import/export balance&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="n">df_elevage_comp</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_cons_vege</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Ingestion (ktN)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;Ingestion (ktN)&quot;</span><span class="p">]</span>

        <span class="c1"># On ajoute l&#39;ingestion humaine</span>
        <span class="c1"># Une ligne urban, une ligne rural. Cela simplifiera la distinction de regime si un jour c&#39;est pertinent</span>

        <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;urban&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N_vege</span> <span class="o">*</span> <span class="n">prop_urb</span>
        <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;rural&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N_vege</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_cons_vege</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">CROPS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>  <span class="c1"># par exemple</span>
            <span class="n">CONSUMERS</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

            <span class="c1"># --------------------------------------------------------------------------</span>
            <span class="c1"># 1) Collect data from your DataFrames (example placeholders)</span>
            <span class="c1"># --------------------------------------------------------------------------</span>
            <span class="n">area</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Ratio&quot;</span><span class="p">:</span>
                <span class="n">Ymax</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Ymax (kgN/ha)&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">}</span>
            <span class="c1"># kparam = {c: df_cultures.at[c, &quot;k (kgN/ha)&quot;] for c in CROPS}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Linear&quot;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">}</span>
                <span class="n">b</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Exponential&quot;</span><span class="p">:</span>
                <span class="n">Ymax</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Ymax (kgN/ha)&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">}</span>
                <span class="n">k_param</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;k (kgN/ha)&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">}</span>
            <span class="n">nonSynthFert</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Surface Non Synthetic Fertilizer Use (kgN/ha)&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">}</span>
            <span class="n">ingestion</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CONSUMERS</span><span class="p">}</span>

            <span class="c1"># Filter out any (c,k) pairs not in the diet. We&#39;ll build an &quot;allowed&quot; pair list:</span>
            <span class="n">allowed_ck</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CONSUMERS</span><span class="p">:</span>
                <span class="c1"># Gather all crops that appear in any sub-list of regimes[k]</span>
                <span class="n">authorized_crops</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">p_ideal</span><span class="p">,</span> <span class="n">c_list</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">authorized_crops</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">c_list</span><span class="p">)</span>
                <span class="c1"># We&#39;ll keep only these (c, k) pairs</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">authorized_crops</span><span class="p">:</span>
                        <span class="n">allowed_ck</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>

            <span class="c1"># --------------------------------------------------------------------------</span>
            <span class="c1"># 2) Create indexing for decision variables</span>
            <span class="c1"># --------------------------------------------------------------------------</span>

            <span class="n">idx_synth</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">:</span>
                <span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">idx_alloc</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">allowed_ck</span><span class="p">:</span>
                <span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">offset</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">idx_import</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">allowed_ck</span><span class="p">:</span>
                <span class="n">idx_import</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">offset</span>
                <span class="n">offset</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">n_vars</span> <span class="o">=</span> <span class="n">offset</span>  <span class="c1"># total number of decision variables</span>

            <span class="n">w_spread_fixed</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">fixed_availability_proportion</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dict: {(k, tuple(group_crops), c): proportion}</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-9</span>

            <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="n">CONSUMERS</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">group_crops</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">k_</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_crops</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
                        <span class="k">continue</span>

                    <span class="c1"># Use Area (ha) as the basis for fixed availability weight</span>
                    <span class="n">group_total_area</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">area</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">group_crops</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">group_total_area</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
                        <span class="k">continue</span>  <span class="c1"># Skip if group has no area</span>

                    <span class="n">group_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">group_crops</span><span class="p">))</span>  <span class="c1"># Use a consistent key for the group</span>

                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">group_crops</span><span class="p">:</span>
                        <span class="n">crop_area</span> <span class="o">=</span> <span class="n">area</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">proportion</span> <span class="o">=</span> <span class="n">crop_area</span> <span class="o">/</span> <span class="n">group_total_area</span>
                        <span class="n">fixed_availability_proportion</span><span class="p">[(</span><span class="n">k_</span><span class="p">,</span> <span class="n">group_key</span><span class="p">,</span> <span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">proportion</span>

            <span class="c1"># --------------------------------------------------------------------------</span>
            <span class="c1"># 3) Define the objective function</span>
            <span class="c1"># --------------------------------------------------------------------------</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">Y_th_lin</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">Y_th_ratio</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">ymax</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">f</span> <span class="o">+</span> <span class="n">ymax</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">0</span>
                <span class="k">return</span> <span class="n">f</span> <span class="o">*</span> <span class="n">ymax</span> <span class="o">/</span> <span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="n">ymax</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">objective</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Return the scalar value of the objective:</span>
<span class="sd">                w_diet * diet_deviation</span>
<span class="sd">                + w_Nsyn * fertilizer_deviation</span>
<span class="sd">                + w_imp * import_export_deviation</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="c1"># 3.a) diet_deviation</span>
                <span class="n">total_dev</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="n">CONSUMERS</span><span class="p">:</span>
                    <span class="c1"># 1) Somme totale allouée (local + imports) pour le consommateur k_</span>
                    <span class="n">denom_k</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">:</span>
                        <span class="c1"># Allocation locale</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                            <span class="n">denom_k</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>
                        <span class="c1"># Allocation via import</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_import</span><span class="p">:</span>
                            <span class="n">denom_k</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_import</span><span class="p">[(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>

                    <span class="c1"># 2) Pour chaque proportion idéale, calculez la somme des cultures du groupe</span>
                    <span class="k">for</span> <span class="n">p_ideal</span><span class="p">,</span> <span class="n">c_list</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">k_</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">group_alloc</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">c_list</span><span class="p">:</span>
                            <span class="c1"># Ajout part locale</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                                <span class="n">group_alloc</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>
                            <span class="c1"># Ajout part importée</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_import</span><span class="p">:</span>
                                <span class="n">group_alloc</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_import</span><span class="p">[(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>

                        <span class="k">if</span> <span class="n">denom_k</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                            <span class="n">proportion_real</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">proportion_real</span> <span class="o">=</span> <span class="n">group_alloc</span> <span class="o">/</span> <span class="n">denom_k</span>

                        <span class="c1"># Ecart diététique</span>
                        <span class="n">total_dev</span> <span class="o">+=</span> <span class="p">(</span><span class="n">proportion_real</span> <span class="o">-</span> <span class="n">p_ideal</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

                <span class="c1"># 3.b) fertilizer_deviation</span>
                <span class="c1"># sum of synthetic fertilizers in ktN</span>
                <span class="n">total_synth</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">:</span>
                    <span class="c1"># x[idx_synth[c]] is in kgN/ha</span>
                    <span class="n">fert_per_ha</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">+</span> <span class="n">nonSynthFert</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                    <span class="n">total_synth</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">*</span> <span class="n">area</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>  <span class="c1"># only the synthetic part</span>
                <span class="c1"># Convert from kgN to ktN</span>
                <span class="n">total_synth_kt</span> <span class="o">=</span> <span class="n">total_synth</span> <span class="o">/</span> <span class="mf">1e6</span>
                <span class="c1"># desired total = (N_synth_crop + N_synth_grass)</span>
                <span class="k">if</span> <span class="n">N_synth_crop</span> <span class="o">+</span> <span class="n">N_synth_grass</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="n">N_synth_crop</span> <span class="o">+</span> <span class="n">N_synth_grass</span>
                <span class="n">fert_dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">total_synth_kt</span> <span class="o">-</span> <span class="p">(</span><span class="n">N_synth_crop</span> <span class="o">+</span> <span class="n">N_synth_grass</span><span class="p">))</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="c1"># fert_dev = ((total_synth_kt - (N_synth_crop + N_synth_grass)) / scale) ** 2</span>
                <span class="c1"># 3.c) import_export_deviation</span>
                <span class="c1"># sum import</span>
                <span class="n">sum_imp</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">allowed_ck</span><span class="p">:</span>
                    <span class="n">sum_imp</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_import</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)]]</span>

                <span class="c1"># Calcul de la production &quot;non allouée&quot; =&gt; export</span>
                <span class="n">export_total</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">:</span>
                    <span class="c1"># Production locale (ktN) ; on suppose qu&#39;elle est déjà correcte/à jour :</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Ratio&quot;</span><span class="p">:</span>
                        <span class="n">production_c</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">Y_th_ratio</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">+</span> <span class="n">nonSynthFert</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">Ymax</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
                            <span class="o">*</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
                            <span class="o">/</span> <span class="mf">1e6</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Linear&quot;</span><span class="p">:</span>
                        <span class="n">production_c</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">Y_th_lin</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">+</span> <span class="n">nonSynthFert</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
                            <span class="o">*</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
                            <span class="o">/</span> <span class="mf">1e6</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Exponential&quot;</span><span class="p">:</span>
                        <span class="n">production_c</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">Y</span><span class="o">.</span><span class="n">Y_th_exp_cap</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">+</span> <span class="n">nonSynthFert</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">Ymax</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">k_param</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
                            <span class="o">*</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
                            <span class="o">/</span> <span class="mf">1e6</span>
                        <span class="p">)</span>

                    <span class="c1"># Somme des allocations locales sur c</span>
                    <span class="n">allocated_c</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="c1"># idx_alloc[(c,k)] = indice pour allocate(c,k)</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CONSUMERS</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                            <span class="n">allocated_c</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)]]</span>

                    <span class="c1"># leftover = production - allocated</span>
                    <span class="c1"># S&#39;il est &gt; 0 =&gt; export, s&#39;il est &lt; 0 =&gt; on a sur-alloué (besoin d&#39;import net)</span>
                    <span class="n">leftover_c</span> <span class="o">=</span> <span class="n">production_c</span> <span class="o">-</span> <span class="n">allocated_c</span>
                    <span class="n">export_total</span> <span class="o">+=</span> <span class="n">leftover_c</span>

                <span class="c1"># Net import du modèle</span>
                <span class="n">net_import_model</span> <span class="o">=</span> <span class="n">sum_imp</span> <span class="o">-</span> <span class="n">export_total</span>

                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">net_import</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">imp_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">net_import_model</span> <span class="o">-</span> <span class="n">net_import</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">imp_dev</span> <span class="o">=</span> <span class="p">((</span><span class="n">net_import_model</span> <span class="o">-</span> <span class="n">net_import</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">net_import</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>

                <span class="c1"># --- NEW: Allocation Spread Penalty based on Fixed Proportions ---</span>
                <span class="n">spread_penalty_fixed</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-9</span>

                <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="n">CONSUMERS</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">group_crops</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">k_</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>  <span class="c1"># Iterate over the crop lists defining groups</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_crops</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
                            <span class="k">continue</span>

                        <span class="n">group_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">group_crops</span><span class="p">))</span>  <span class="c1"># Match key used in pre-calculation</span>

                        <span class="c1"># --- Calculate group total allocation for consumer k_ ---</span>
                        <span class="n">group_alloc_kG</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">group_crops</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                                <span class="n">group_alloc_kG</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c2</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_import</span><span class="p">:</span>
                                <span class="n">group_alloc_kG</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_import</span><span class="p">[(</span><span class="n">c2</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>

                        <span class="c1"># If total allocation to group is negligible, skip penalty</span>
                        <span class="k">if</span> <span class="n">group_alloc_kG</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c1"># --- Calculate penalty for each crop in the group ---</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">group_crops</span><span class="p">:</span>
                            <span class="c1"># Get the pre-calculated fixed proportion</span>
                            <span class="n">target_proportion</span> <span class="o">=</span> <span class="n">fixed_availability_proportion</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">k_</span><span class="p">,</span> <span class="n">group_key</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">target_proportion</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>  <span class="c1"># Skip if this crop had no area in pre-calc</span>
                                <span class="k">continue</span>

                            <span class="c1"># Calculate target allocation based on fixed proportion</span>
                            <span class="n">target_alloc_c</span> <span class="o">=</span> <span class="n">target_proportion</span> <span class="o">*</span> <span class="n">group_alloc_kG</span>

                            <span class="c1"># Calculate this specific crop&#39;s actual allocation for consumer k_</span>
                            <span class="n">alloc_ck</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                                <span class="n">alloc_ck</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_import</span><span class="p">:</span>
                                <span class="n">alloc_ck</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_import</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>

                            <span class="c1"># Penalize squared deviation from the target allocation</span>
                            <span class="n">deviation</span> <span class="o">=</span> <span class="n">alloc_ck</span> <span class="o">-</span> <span class="n">target_alloc_c</span>
                            <span class="n">spread_penalty_fixed</span> <span class="o">+=</span> <span class="n">deviation</span><span class="o">**</span><span class="mi">2</span>
                            <span class="c1"># Note: This penalizes both over- and under-allocation relative to the fixed proportion.</span>
                            <span class="c1"># If you ONLY want to penalize under-allocation (concentration), use:</span>
                            <span class="c1"># if deviation &lt; 0: # i.e., alloc_ck &lt; target_alloc_c</span>
                            <span class="c1">#     spread_penalty_fixed += deviation**2</span>

                <span class="k">return</span> <span class="n">w_diet</span> <span class="o">*</span> <span class="n">total_dev</span> <span class="o">+</span> <span class="n">w_Nsyn</span> <span class="o">*</span> <span class="n">fert_dev</span> <span class="o">+</span> <span class="n">w_imp</span> <span class="o">*</span> <span class="n">imp_dev</span> <span class="o">+</span> <span class="n">w_spread_fixed</span> <span class="o">*</span> <span class="n">spread_penalty_fixed</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">objective_gradient</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Computes the gradient of the objective function.</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">area</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>  <span class="c1"># Faster access than .loc inside loops</span>
                <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_vars</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">epsilon</span> <span class="o">=</span> <span class="mf">1e-12</span>  <span class="c1"># For safe division</span>

                <span class="c1"># --- Part 1: Import Deviation Gradient ---</span>
                <span class="c1"># dDi/dx[j] = 1 if x[j] is an import variable, 0 otherwise</span>
                <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">allowed_ck</span><span class="p">:</span>  <span class="c1"># Assuming allowed_ck contains all keys for idx_import</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_import</span><span class="p">:</span>  <span class="c1"># Check if the import variable exists for this combo</span>
                        <span class="n">import_idx</span> <span class="o">=</span> <span class="n">idx_import</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span>
                        <span class="n">grad</span><span class="p">[</span><span class="n">import_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">w_imp</span> <span class="o">*</span> <span class="mf">1.0</span>

                <span class="c1"># --- Part 2: Fertilizer Deviation Gradient ---</span>
                <span class="n">total_synth_kg</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">synth_indices</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Store indices of synth vars for later gradient update</span>
                <span class="n">synth_crop_map</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Map index back to crop</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">idx_synth</span><span class="p">:</span>  <span class="c1"># Make sure the crop has a synth variable</span>
                        <span class="n">synth_idx</span> <span class="o">=</span> <span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                        <span class="n">total_synth_kg</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">synth_idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">area</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Use .get for safety</span>
                        <span class="n">synth_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">synth_idx</span><span class="p">)</span>
                        <span class="n">synth_crop_map</span><span class="p">[</span><span class="n">synth_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>

                <span class="n">total_synth_kt</span> <span class="o">=</span> <span class="n">total_synth_kg</span> <span class="o">/</span> <span class="mf">1e6</span>
                <span class="n">Target</span> <span class="o">=</span> <span class="n">N_synth_crop</span> <span class="o">+</span> <span class="n">N_synth_grass</span>
                <span class="n">Scale</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">Target</span><span class="p">)</span>  <span class="c1"># Ensure scale is at least 1 and float</span>
                <span class="n">Z</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_synth_kt</span> <span class="o">-</span> <span class="n">Target</span><span class="p">)</span> <span class="o">/</span> <span class="n">Scale</span>

                <span class="k">if</span> <span class="n">Z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Base derivative factor d(Df)/d(total_synth_kt)</span>
                    <span class="n">base_fert_deriv</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">Z</span><span class="p">)</span> <span class="o">/</span> <span class="n">Scale</span>
                    <span class="k">for</span> <span class="n">synth_idx</span> <span class="ow">in</span> <span class="n">synth_indices</span><span class="p">:</span>
                        <span class="n">c_syn</span> <span class="o">=</span> <span class="n">synth_crop_map</span><span class="p">[</span><span class="n">synth_idx</span><span class="p">]</span>
                        <span class="c1"># d(total_synth_kt)/dx[j] = area[c_syn] / 1e6</span>
                        <span class="n">deriv_contrib</span> <span class="o">=</span> <span class="n">base_fert_deriv</span> <span class="o">*</span> <span class="p">(</span><span class="n">area</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c_syn</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span>
                        <span class="n">grad</span><span class="p">[</span><span class="n">synth_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">w_Nsyn</span> <span class="o">*</span> <span class="n">deriv_contrib</span>

                <span class="c1"># --- Part 3: Diet Deviation Gradient ---</span>
                <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="n">CONSUMERS</span><span class="p">:</span>
                    <span class="c1"># Calculate denom_k (total allocation for consumer k) *once*</span>
                    <span class="n">denom_k</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="c1"># Store indices and type relevant to this consumer for quick lookup</span>
                    <span class="n">alloc_indices_k</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Map index to crop</span>
                    <span class="n">import_indices_k</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Map index to crop</span>
                    <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">:</span>
                        <span class="n">alloc_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">alloc_key</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                            <span class="n">idx</span> <span class="o">=</span> <span class="n">idx_alloc</span><span class="p">[</span><span class="n">alloc_key</span><span class="p">]</span>
                            <span class="n">denom_k</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                            <span class="n">alloc_indices_k</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_</span>
                        <span class="k">if</span> <span class="n">alloc_key</span> <span class="ow">in</span> <span class="n">idx_import</span><span class="p">:</span>
                            <span class="n">idx</span> <span class="o">=</span> <span class="n">idx_import</span><span class="p">[</span><span class="n">alloc_key</span><span class="p">]</span>
                            <span class="n">denom_k</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                            <span class="n">import_indices_k</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_</span>

                    <span class="k">if</span> <span class="n">denom_k</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>  <span class="c1"># If total allocation is near zero, derivative is zero</span>
                        <span class="k">continue</span>  <span class="c1"># Skip this consumer</span>

                    <span class="c1"># Calculate contributions for each group in the regime</span>
                    <span class="k">for</span> <span class="n">p_ideal</span><span class="p">,</span> <span class="n">c_list</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">k_</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="c1"># Calculate group_alloc *once* for this group</span>
                        <span class="n">group_alloc</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">group_alloc_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># Indices contributing to this group_alloc</span>
                        <span class="n">group_import_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

                        <span class="k">for</span> <span class="n">c_in_list</span> <span class="ow">in</span> <span class="n">c_list</span><span class="p">:</span>
                            <span class="n">alloc_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_in_list</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">alloc_key</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                                <span class="n">idx</span> <span class="o">=</span> <span class="n">idx_alloc</span><span class="p">[</span><span class="n">alloc_key</span><span class="p">]</span>
                                <span class="n">group_alloc</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                                <span class="n">group_alloc_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">alloc_key</span> <span class="ow">in</span> <span class="n">idx_import</span><span class="p">:</span>
                                <span class="n">idx</span> <span class="o">=</span> <span class="n">idx_import</span><span class="p">[</span><span class="n">alloc_key</span><span class="p">]</span>
                                <span class="n">group_alloc</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                                <span class="n">group_import_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

                        <span class="c1"># Calculate proportion_real and the base deviation factor</span>
                        <span class="n">prop_real</span> <span class="o">=</span> <span class="n">group_alloc</span> <span class="o">/</span> <span class="n">denom_k</span>
                        <span class="n">base_diet_deriv</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">prop_real</span> <span class="o">-</span> <span class="n">p_ideal</span><span class="p">)</span>

                        <span class="c1"># Calculate d(prop_real)/d(x_j) contributions using the quotient rule components</span>
                        <span class="c1"># Derivative Factor = base_diet_deriv * (1 / denom_k**2)</span>
                        <span class="c1"># This avoids repeated division inside the loops below</span>
                        <span class="n">quotient_deriv_factor</span> <span class="o">=</span> <span class="n">base_diet_deriv</span> <span class="o">/</span> <span class="p">(</span><span class="n">denom_k</span> <span class="o">*</span> <span class="n">denom_k</span><span class="p">)</span>  <span class="c1"># denom_k**2 can be large</span>

                        <span class="c1"># Term 1: + denom_k * d(group_alloc)/dx[j]</span>
                        <span class="c1"># Term 2: - group_alloc * d(denom_k)/dx[j]</span>

                        <span class="c1"># Apply derivative contributions to relevant grad entries</span>

                        <span class="c1"># d(group_alloc)/dx[j] is 1 ONLY for alloc/import vars in this c_list</span>
                        <span class="c1"># Contribution: quotient_deriv_factor * denom_k * (+1)</span>
                        <span class="k">for</span> <span class="n">group_idx</span> <span class="ow">in</span> <span class="n">group_alloc_indices</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">group_import_indices</span><span class="p">):</span>
                            <span class="n">grad</span><span class="p">[</span><span class="n">group_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="n">w_diet</span> <span class="o">*</span> <span class="n">quotient_deriv_factor</span> <span class="o">*</span> <span class="n">denom_k</span>  <span class="c1"># * (+1 is implicit)</span>

                        <span class="c1"># d(denom_k)/dx[j] is 1 for ALL alloc/import vars for this consumer k</span>
                        <span class="c1"># Contribution: quotient_deriv_factor * (-group_alloc) * (+1)</span>
                        <span class="n">neg_group_alloc_term</span> <span class="o">=</span> <span class="o">-</span><span class="n">group_alloc</span>  <span class="c1"># Precompute</span>
                        <span class="k">for</span> <span class="n">k_alloc_idx</span> <span class="ow">in</span> <span class="n">alloc_indices_k</span><span class="p">:</span>  <span class="c1"># Indices of alloc vars for consumer k</span>
                            <span class="n">grad</span><span class="p">[</span><span class="n">k_alloc_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">w_diet</span> <span class="o">*</span> <span class="n">quotient_deriv_factor</span> <span class="o">*</span> <span class="n">neg_group_alloc_term</span>
                            <span class="p">)</span>  <span class="c1"># * (+1 implicit)</span>
                        <span class="k">for</span> <span class="n">k_import_idx</span> <span class="ow">in</span> <span class="n">import_indices_k</span><span class="p">:</span>  <span class="c1"># Indices of import vars for consumer k</span>
                            <span class="n">grad</span><span class="p">[</span><span class="n">k_import_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">w_diet</span> <span class="o">*</span> <span class="n">quotient_deriv_factor</span> <span class="o">*</span> <span class="n">neg_group_alloc_term</span>
                            <span class="p">)</span>  <span class="c1"># * (+1 implicit)</span>

                <span class="k">return</span> <span class="n">grad</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">compute_objective_terms</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Return the scalar value of the objective:</span>
<span class="sd">                w_diet * diet_deviation</span>
<span class="sd">                + w_Nsyn * fertilizer_deviation</span>
<span class="sd">                + w_imp * import_export_deviation</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="c1"># 3.a) diet_deviation</span>
                <span class="n">total_dev</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="n">CONSUMERS</span><span class="p">:</span>
                    <span class="c1"># 1) Somme totale allouée (local + imports) pour le consommateur k_</span>
                    <span class="n">denom_k</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">:</span>
                        <span class="c1"># Allocation locale</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                            <span class="n">denom_k</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>
                        <span class="c1"># Allocation via import</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_import</span><span class="p">:</span>
                            <span class="n">denom_k</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_import</span><span class="p">[(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>

                    <span class="c1"># 2) Pour chaque proportion idéale, calculez la somme des cultures du groupe</span>
                    <span class="k">for</span> <span class="n">p_ideal</span><span class="p">,</span> <span class="n">c_list</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">k_</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">group_alloc</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">c_list</span><span class="p">:</span>
                            <span class="c1"># Ajout part locale</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                                <span class="n">group_alloc</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>
                            <span class="c1"># Ajout part importée</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_import</span><span class="p">:</span>
                                <span class="n">group_alloc</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_import</span><span class="p">[(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>

                        <span class="k">if</span> <span class="n">denom_k</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                            <span class="n">proportion_real</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">proportion_real</span> <span class="o">=</span> <span class="n">group_alloc</span> <span class="o">/</span> <span class="n">denom_k</span>

                        <span class="c1"># Ecart diététique</span>
                        <span class="n">total_dev</span> <span class="o">+=</span> <span class="p">(</span><span class="n">proportion_real</span> <span class="o">-</span> <span class="n">p_ideal</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

                <span class="c1"># 3.b) fertilizer_deviation</span>
                <span class="c1"># sum of synthetic fertilizers in ktN</span>
                <span class="n">total_synth</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">:</span>
                    <span class="c1"># x[idx_synth[c]] is in kgN/ha</span>
                    <span class="n">fert_per_ha</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">+</span> <span class="n">nonSynthFert</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                    <span class="n">total_synth</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">*</span> <span class="n">area</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>  <span class="c1"># only the synthetic part</span>
                <span class="c1"># Convert from kgN to ktN</span>
                <span class="n">total_synth_kt</span> <span class="o">=</span> <span class="n">total_synth</span> <span class="o">/</span> <span class="mf">1e6</span>
                <span class="c1"># desired total = (N_synth_crop + N_synth_grass)</span>
                <span class="k">if</span> <span class="n">N_synth_crop</span> <span class="o">+</span> <span class="n">N_synth_grass</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scale</span> <span class="o">=</span> <span class="n">N_synth_crop</span> <span class="o">+</span> <span class="n">N_synth_grass</span>
                <span class="n">fert_dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">total_synth_kt</span> <span class="o">-</span> <span class="p">(</span><span class="n">N_synth_crop</span> <span class="o">+</span> <span class="n">N_synth_grass</span><span class="p">))</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="c1"># fert_dev = ((total_synth_kt - (N_synth_crop + N_synth_grass)) / scale) ** 2</span>
                <span class="c1"># 3.c) import_export_deviation</span>
                <span class="c1"># sum import</span>
                <span class="n">sum_imp</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">allowed_ck</span><span class="p">:</span>
                    <span class="n">sum_imp</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_import</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)]]</span>

                <span class="c1"># Calcul de la production &quot;non allouée&quot; =&gt; export</span>
                <span class="n">export_total</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">:</span>
                    <span class="c1"># Production locale (ktN) ; on suppose qu&#39;elle est déjà correcte/à jour :</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Ratio&quot;</span><span class="p">:</span>
                        <span class="n">production_c</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">Y_th_ratio</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">+</span> <span class="n">nonSynthFert</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">Ymax</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
                            <span class="o">*</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
                            <span class="o">/</span> <span class="mf">1e6</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Linear&quot;</span><span class="p">:</span>
                        <span class="n">production_c</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">Y_th_lin</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">+</span> <span class="n">nonSynthFert</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
                            <span class="o">*</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
                            <span class="o">/</span> <span class="mf">1e6</span>
                        <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Exponential&quot;</span><span class="p">:</span>
                        <span class="n">production_c</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">Y</span><span class="o">.</span><span class="n">Y_th_exp_cap</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">+</span> <span class="n">nonSynthFert</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">Ymax</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">k_param</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
                            <span class="o">*</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
                            <span class="o">/</span> <span class="mf">1e6</span>
                        <span class="p">)</span>

                    <span class="c1"># Somme des allocations locales sur c</span>
                    <span class="n">allocated_c</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="c1"># idx_alloc[(c,k)] = indice pour allocate(c,k)</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CONSUMERS</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                            <span class="n">allocated_c</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">)]]</span>

                    <span class="c1"># leftover = production - allocated</span>
                    <span class="c1"># S&#39;il est &gt; 0 =&gt; export, s&#39;il est &lt; 0 =&gt; on a sur-alloué (besoin d&#39;import net)</span>
                    <span class="n">leftover_c</span> <span class="o">=</span> <span class="n">production_c</span> <span class="o">-</span> <span class="n">allocated_c</span>
                    <span class="n">export_total</span> <span class="o">+=</span> <span class="n">leftover_c</span>

                <span class="c1"># Net import du modèle</span>
                <span class="n">net_import_model</span> <span class="o">=</span> <span class="n">sum_imp</span> <span class="o">-</span> <span class="n">export_total</span>

                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">net_import</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">imp_dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">net_import_model</span> <span class="o">-</span> <span class="n">net_import</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">imp_dev</span> <span class="o">=</span> <span class="p">((</span><span class="n">net_import_model</span> <span class="o">-</span> <span class="n">net_import</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">net_import</span> <span class="o">+</span> <span class="mf">1e-6</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>

                <span class="k">return</span> <span class="n">total_dev</span><span class="p">,</span> <span class="n">fert_dev</span><span class="p">,</span> <span class="n">imp_dev</span><span class="p">,</span> <span class="n">net_import</span><span class="p">,</span> <span class="n">net_import_model</span><span class="p">,</span> <span class="n">sum_imp</span><span class="p">,</span> <span class="n">export_total</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">my_callback</span><span class="p">(</span><span class="n">xk</span><span class="p">):</span>
                <span class="c1"># xk is the current solution vector at iteration k</span>
                <span class="c1"># Evaluate any terms you want here, e.g.:</span>
                <span class="n">f_val</span> <span class="o">=</span> <span class="n">objective</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span>
                <span class="c1"># Possibly store separate sub-terms:</span>
                <span class="n">diet_dev_term</span><span class="p">,</span> <span class="n">fertilizer_term</span><span class="p">,</span> <span class="n">imp_term</span><span class="p">,</span> <span class="n">net_imp</span><span class="p">,</span> <span class="n">net_import_model</span><span class="p">,</span> <span class="n">sum_imp</span><span class="p">,</span> <span class="n">export_total</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">compute_objective_terms</span><span class="p">(</span><span class="n">xk</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># Append them to some global or nonlocal list</span>
                <span class="n">iteration_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="c1"># &quot;x&quot;: xk.copy(),</span>
                        <span class="s2">&quot;objective&quot;</span><span class="p">:</span> <span class="n">f_val</span><span class="p">,</span>
                        <span class="s2">&quot;diet_dev&quot;</span><span class="p">:</span> <span class="n">diet_dev_term</span><span class="p">,</span>
                        <span class="s2">&quot;fert_dev&quot;</span><span class="p">:</span> <span class="n">fertilizer_term</span><span class="p">,</span>
                        <span class="s2">&quot;import term&quot;</span><span class="p">:</span> <span class="n">imp_term</span><span class="p">,</span>
                        <span class="s2">&quot;net import target&quot;</span><span class="p">:</span> <span class="n">net_imp</span><span class="p">,</span>
                        <span class="s2">&quot;net import model&quot;</span><span class="p">:</span> <span class="n">net_import_model</span><span class="p">,</span>
                        <span class="s2">&quot;Import model&quot;</span><span class="p">:</span> <span class="n">sum_imp</span><span class="p">,</span>
                        <span class="s2">&quot;Export model&quot;</span><span class="p">:</span> <span class="n">export_total</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="c1"># --------------------------------------------------------------------------</span>
            <span class="c1"># 4) Define constraints as a list of dicts (SLSQP form)</span>
            <span class="c1"># --------------------------------------------------------------------------</span>
            <span class="c1"># We&#39;ll have:</span>
            <span class="c1">#   (i) production_balance(c) = sum_{k} allocate(c,k) + import_export(c) - prod_c == 0</span>
            <span class="c1">#   (ii) consumption_rule(k) = sum_{c} allocate(c,k) - ingestion[k] == 0</span>
            <span class="c1">#</span>
            <span class="c1"># The “(iii) if not authorized =&gt; allocate=0” we already excluded from x.</span>
            <span class="c1"># --------------------------------------------------------------------------</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">build_min_fraction_constraints_reformulated</span><span class="p">(</span><span class="n">BETA</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Returns constraint dict for SciPy using a reformulated inequality</span>
<span class="sd">                to avoid direct division within the constraint function.</span>

<span class="sd">                Constraint Logic: We want the allocation of a crop &#39;c&#39; within a group &#39;G&#39;</span>
<span class="sd">                for consumer &#39;k&#39; (alloc_ck) to be at least a certain fraction (BETA)</span>
<span class="sd">                of what its proportional production (prod_c / sum_prod_g) would suggest</span>
<span class="sd">                applied to the total allocation for that group (group_alloc_kG).</span>

<span class="sd">                Original Form: alloc_ck - BETA * (prod_c / sum_prod_g) * group_alloc_kG &gt;= 0</span>
<span class="sd">                Reformulated : alloc_ck * sum_prod_g - BETA * prod_c * group_alloc_kG &gt;= 0</span>
<span class="sd">                            (for sum_prod_g &gt; 0)</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="c1"># --- Helper function to calculate production ---</span>
                <span class="c1"># (Avoid recalculating this repeatedly inside the constraint function if possible,</span>
                <span class="c1"># but here we need it dependent on x_synth which changes)</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">calculate_production</span><span class="p">(</span><span class="n">x_synth_val</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
                    <span class="c1"># Make sure idx_synth[c] exists if you use it here, or adjust logic</span>
                    <span class="n">fert_tot</span> <span class="o">=</span> <span class="n">x_synth_val</span> <span class="o">+</span> <span class="n">nonSynthFert</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>  <span class="c1"># Assuming x_ maps directly for synth</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Ratio&quot;</span><span class="p">:</span>
                        <span class="n">y_ha</span> <span class="o">=</span> <span class="n">Y_th_ratio</span><span class="p">(</span><span class="n">fert_tot</span><span class="p">,</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Ymax (kgN/ha)&quot;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Linear&quot;</span><span class="p">:</span>
                        <span class="n">y_ha</span> <span class="o">=</span> <span class="n">Y_th_lin</span><span class="p">(</span><span class="n">fert_tot</span><span class="p">,</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">],</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Exponential&quot;</span><span class="p">:</span>
                        <span class="n">y_ha</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">Y_th_exp_cap</span><span class="p">(</span>
                            <span class="n">fert_tot</span><span class="p">,</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Ymax (kgN/ha)&quot;</span><span class="p">],</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;k (kgN/ha)&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="c1"># Production in ktN (consistent units assumed)</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">y_ha</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e6</span>

                <span class="c1"># We still need to determine the list of constraints to evaluate consistently</span>
                <span class="n">constraint_tuples</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="n">CONSUMERS</span><span class="p">:</span>
                    <span class="c1"># regimes[k_] has format {proportion: [crop_list]}</span>
                    <span class="c1"># We need the groups (crop_lists) themselves. Using values() is fine.</span>
                    <span class="k">for</span> <span class="n">group_crops</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">k_</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="c1"># Ensure group_crops is actually a list/iterable of crop names</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_crops</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
                            <span class="c1"># Handle potential errors in regimes structure if needed</span>
                            <span class="c1"># print(f&quot;Warning: Expected list of crops for consumer {k_}, got {group_crops}&quot;)</span>
                            <span class="k">continue</span>
                        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">group_crops</span><span class="p">:</span>
                            <span class="c1"># Only add constraints for crops that *can* be allocated (locally or imported)</span>
                            <span class="c1"># This avoids creating constraints for crops that can never meet the condition.</span>
                            <span class="n">can_be_allocated</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_alloc</span> <span class="ow">or</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_import</span>
                            <span class="k">if</span> <span class="n">can_be_allocated</span><span class="p">:</span>
                                <span class="c1"># Store (consumer, list_of_crops_in_group, specific_crop)</span>
                                <span class="n">constraint_tuples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">(</span><span class="n">k_</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">group_crops</span><span class="p">),</span> <span class="n">c</span><span class="p">)</span>
                                <span class="p">)</span>  <span class="c1"># Use tuple for hashability if needed</span>

                <span class="n">num_constraints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraint_tuples</span><span class="p">)</span>
                <span class="c1"># print(f&quot;Building {num_constraints} min_fraction constraints.&quot;)</span>

                <span class="c1"># --- The actual constraint function passed to SciPy ---</span>
                <span class="k">def</span><span class="w"> </span><span class="nf">min_fraction_fn</span><span class="p">(</span><span class="n">x_</span><span class="p">):</span>
                    <span class="n">constraints_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_constraints</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                    <span class="n">calculated_productions</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Cache production calc within one function call</span>

                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k_</span><span class="p">,</span> <span class="n">group_crops</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">constraint_tuples</span><span class="p">):</span>
                        <span class="c1"># 1) Calculate production values for the group</span>
                        <span class="n">sum_prod_g</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">prod_values</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">group_crops</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">c2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calculated_productions</span><span class="p">:</span>
                                <span class="c1"># Ensure c2 is a valid crop index/name</span>
                                <span class="k">if</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">idx_synth</span><span class="p">:</span>
                                    <span class="n">prod_c2_val</span> <span class="o">=</span> <span class="n">calculate_production</span><span class="p">(</span><span class="n">x_</span><span class="p">[</span><span class="n">idx_synth</span><span class="p">[</span><span class="n">c2</span><span class="p">]],</span> <span class="n">c2</span><span class="p">)</span>
                                    <span class="n">calculated_productions</span><span class="p">[</span><span class="n">c2</span><span class="p">]</span> <span class="o">=</span> <span class="n">prod_c2_val</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># Handle case where crop might be in regimes but not synthesizable (maybe fixed production?)</span>
                                    <span class="c1"># For now, assume 0 production if no synth variable</span>
                                    <span class="n">prod_c2_val</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="n">calculated_productions</span><span class="p">[</span><span class="n">c2</span><span class="p">]</span> <span class="o">=</span> <span class="n">prod_c2_val</span>

                            <span class="n">prod_c2_val</span> <span class="o">=</span> <span class="n">calculated_productions</span><span class="p">[</span><span class="n">c2</span><span class="p">]</span>
                            <span class="n">prod_values</span><span class="p">[</span><span class="n">c2</span><span class="p">]</span> <span class="o">=</span> <span class="n">prod_c2_val</span>
                            <span class="n">sum_prod_g</span> <span class="o">+=</span> <span class="n">prod_c2_val</span>

                        <span class="c1"># The specific production for the crop &#39;c&#39; we&#39;re constraining</span>
                        <span class="c1"># Use the value already computed and stored in prod_values</span>
                        <span class="n">prod_c_val</span> <span class="o">=</span> <span class="n">prod_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="n">c</span><span class="p">,</span> <span class="mf">0.0</span>
                        <span class="p">)</span>  <span class="c1"># Default to 0 if c wasn&#39;t calculable (shouldn&#39;t happen based on loop structure)</span>

                        <span class="c1"># 2) Calculate total allocation to the group for this consumer</span>
                        <span class="n">group_alloc_kG</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">group_crops</span><span class="p">:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                                <span class="n">group_alloc_kG</span> <span class="o">+=</span> <span class="n">x_</span><span class="p">[</span><span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c2</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_import</span><span class="p">:</span>
                                <span class="n">group_alloc_kG</span> <span class="o">+=</span> <span class="n">x_</span><span class="p">[</span><span class="n">idx_import</span><span class="p">[(</span><span class="n">c2</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>

                        <span class="c1"># 3) Calculate this specific crop&#39;s allocation</span>
                        <span class="n">alloc_ck</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                            <span class="n">alloc_ck</span> <span class="o">+=</span> <span class="n">x_</span><span class="p">[</span><span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_import</span><span class="p">:</span>
                            <span class="n">alloc_ck</span> <span class="o">+=</span> <span class="n">x_</span><span class="p">[</span><span class="n">idx_import</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>

                        <span class="c1"># 4) Apply the reformulated constraint</span>
                        <span class="c1"># If total production in the group is negligible, the concept</span>
                        <span class="c1"># of proportional allocation breaks down. Make constraint trivially true (&gt;=0).</span>
                        <span class="c1"># Also handle the case where there&#39;s no allocation to the group.</span>
                        <span class="k">if</span> <span class="n">sum_prod_g</span> <span class="o">&lt;</span> <span class="mf">1e-9</span> <span class="ow">or</span> <span class="n">group_alloc_kG</span> <span class="o">&lt;</span> <span class="mf">1e-9</span><span class="p">:</span>
                            <span class="c1"># LHS must be &gt;= 0. Setting to 0 or a small positive value is safe.</span>
                            <span class="n">constraints_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Or 0.0, ensures &gt;= 0 is met</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Reformulated: alloc_ck * sum_prod_g - BETA * prod_c * group_alloc_kG &gt;= 0</span>
                            <span class="n">lhs</span> <span class="o">=</span> <span class="n">alloc_ck</span> <span class="o">*</span> <span class="n">sum_prod_g</span> <span class="o">-</span> <span class="n">BETA</span> <span class="o">*</span> <span class="n">prod_c_val</span> <span class="o">*</span> <span class="n">group_alloc_kG</span>
                            <span class="n">constraints_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lhs</span>

                    <span class="k">return</span> <span class="n">constraints_array</span>

                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ineq&quot;</span><span class="p">,</span> <span class="s2">&quot;fun&quot;</span><span class="p">:</span> <span class="n">min_fraction_fn</span><span class="p">}</span>

            <span class="c1"># We will define them in a wrapper that references a global or closure “x_current”</span>
            <span class="c1"># so that SLSQP can evaluate.</span>
            <span class="c1"># One standard pattern is to define a single function that returns an array of</span>
            <span class="c1"># constraints. However, SLSQP (via scipy) also supports a list of constraint dicts.</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">build_constraints</span><span class="p">():</span>
                <span class="n">cons</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># Production &gt;= allocations (ineq)</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">:</span>
                    <span class="n">cons</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ineq&quot;</span><span class="p">,</span> <span class="s2">&quot;fun&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x_</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">:</span> <span class="n">production_balance_expr</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">c</span><span class="p">)})</span>

                <span class="c1"># Ingestion = local + import (eq)</span>
                <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="n">CONSUMERS</span><span class="p">:</span>
                    <span class="n">cons</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;eq&quot;</span><span class="p">,</span> <span class="s2">&quot;fun&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x_</span><span class="p">,</span> <span class="n">k_</span><span class="o">=</span><span class="n">k_</span><span class="p">:</span> <span class="n">consumption_rule_expr</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)})</span>
                <span class="k">return</span> <span class="n">cons</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">production_balance_expr</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
                <span class="n">sum_local</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="n">CONSUMERS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                        <span class="n">sum_local</span> <span class="o">+=</span> <span class="n">x_</span><span class="p">[</span><span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>

                <span class="c1"># production c</span>
                <span class="n">fert_tot</span> <span class="o">=</span> <span class="n">x_</span><span class="p">[</span><span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">+</span> <span class="n">nonSynthFert</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Ratio&quot;</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">Y_th_ratio</span><span class="p">(</span><span class="n">fert_tot</span><span class="p">,</span> <span class="n">Ymax</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Linear&quot;</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">Y_th_lin</span><span class="p">(</span><span class="n">fert_tot</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Exponential&quot;</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">Y_th_exp_cap</span><span class="p">(</span><span class="n">fert_tot</span><span class="p">,</span> <span class="n">Ymax</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">k_param</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>
                <span class="n">prod_c</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="n">area</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="o">/</span> <span class="mf">1e6</span>

                <span class="k">return</span> <span class="n">prod_c</span> <span class="o">-</span> <span class="n">sum_local</span>  <span class="c1"># doit être &gt;= 0</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">consumption_rule_expr</span><span class="p">(</span><span class="n">x_</span><span class="p">,</span> <span class="n">k_</span><span class="p">):</span>
                <span class="n">sum_local</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">sum_import</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                        <span class="n">sum_local</span> <span class="o">+=</span> <span class="n">x_</span><span class="p">[</span><span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_import</span><span class="p">:</span>  <span class="c1"># si vous stockez les imports sous (culture, cons)</span>
                        <span class="n">sum_import</span> <span class="o">+=</span> <span class="n">x_</span><span class="p">[</span><span class="n">idx_import</span><span class="p">[(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>

                <span class="k">return</span> <span class="n">sum_local</span> <span class="o">+</span> <span class="n">sum_import</span> <span class="o">-</span> <span class="n">ingestion</span><span class="p">[</span><span class="n">k_</span><span class="p">]</span>

            <span class="c1"># --------------------------------------------------------------------------</span>
            <span class="c1"># 5) Build bounds</span>
            <span class="c1"># --------------------------------------------------------------------------</span>
            <span class="c1">#  - synth_fert[c] &gt;= 0</span>
            <span class="c1">#  - allocate[c,k] &gt;= 0</span>
            <span class="c1">#  - import_export[c] unbounded</span>
            <span class="c1"># We must create a bounds array for each variable in x</span>
            <span class="c1"># --------------------------------------------------------------------------</span>

            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_vars</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">:</span>
                <span class="c1"># For synth_fert[c]</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Category&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;leguminous&quot;</span><span class="p">:</span>
                    <span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>  <span class="c1"># null</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># nonnegative</span>

            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">k_</span> <span class="ow">in</span> <span class="n">allowed_ck</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]</span>
                <span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># nonnegative</span>

            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">k_</span> <span class="ow">in</span> <span class="n">allowed_ck</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">idx_import</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]</span>
                <span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># nonnegative</span>

            <span class="c1"># --------------------------------------------------------------------------</span>
            <span class="c1"># 6) Initial guess</span>
            <span class="c1"># --------------------------------------------------------------------------</span>
            <span class="c1"># You can choose a naive guess, e.g. 0 for everything</span>
            <span class="c1"># or some heuristic.</span>
            <span class="c1"># --------------------------------------------------------------------------</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.01</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_vars</span><span class="p">)])</span>  <span class="c1"># np.zeros(n_vars, dtype=float)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Ratio&quot;</span><span class="p">,</span> <span class="s2">&quot;Exponential&quot;</span><span class="p">]:</span>
                <span class="n">x0</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_cultures</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Ymax (kgN/ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Linear&quot;</span><span class="p">:</span>
                <span class="n">x0</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_cultures</span><span class="p">)]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="c1"># --------------------------------------------------------------------------</span>
            <span class="c1"># 7) Call the optimizer</span>
            <span class="c1"># --------------------------------------------------------------------------</span>
            <span class="n">cons</span> <span class="o">=</span> <span class="n">build_constraints</span><span class="p">()</span>
            <span class="c1"># min_frac_cons = build_min_fraction_constraints_reformulated()</span>
            <span class="c1"># cons.append(min_frac_cons)</span>

            <span class="n">iteration_log</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Stage 1: quick approximate solve</span>
            <span class="c1"># res1 = minimize(</span>
            <span class="c1">#     fun=objective,</span>
            <span class="c1">#     x0=x0,</span>
            <span class="c1">#     method=&quot;SLSQP&quot;,</span>
            <span class="c1">#     bounds=bounds,</span>
            <span class="c1">#     constraints=cons,</span>
            <span class="c1">#     callback=my_callback,</span>
            <span class="c1">#     options={&quot;maxiter&quot;: 1000, &quot;ftol&quot;: 1e-5, &quot;disp&quot;: True},</span>
            <span class="c1"># )</span>

            <span class="c1"># from IPython import embed</span>

            <span class="c1"># embed()</span>
            <span class="c1"># Stage 2: refine from the stage 1 solution with a tighter tolerance</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
                <span class="n">fun</span><span class="o">=</span><span class="n">objective</span><span class="p">,</span>
                <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span>
                <span class="n">method</span><span class="o">=</span><span class="s2">&quot;SLSQP&quot;</span><span class="p">,</span>
                <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                <span class="n">constraints</span><span class="o">=</span><span class="n">cons</span><span class="p">,</span>
                <span class="n">callback</span><span class="o">=</span><span class="n">my_callback</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&quot;ftol&quot;</span><span class="p">:</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="s2">&quot;disp&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;eps&quot;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">},</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">iteration_log</span>

            <span class="n">x_opt</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>

            <span class="c1"># On crée les nouvelles colonnes à zéro par défaut</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Surface Synthetic Fertilizer Use (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="c1"># Parcours de toutes les cultures</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Category&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;leguminous&quot;</span><span class="p">:</span>
                    <span class="c1"># 1) Récupérer la fertilisation synthétique du solveur, en kgN/ha</span>
                    <span class="c1">#    -&gt; synth_fert_sol[c] = variable du solveur</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">idx_synth</span> <span class="ow">and</span> <span class="n">x_opt</span><span class="p">[</span><span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mf">1e-1</span><span class="p">:</span>
                        <span class="n">fert_synth</span> <span class="o">=</span> <span class="n">x_opt</span><span class="p">[</span><span class="n">idx_synth</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fert_synth</span> <span class="o">=</span> <span class="mf">0.0</span>

                    <span class="c1"># On met à jour la colonne &quot;Surface Synthetic Fertilizer Use (kgN/ha)&quot;</span>
                    <span class="n">fert_synth_with_volat</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">fert_synth</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.99</span> <span class="o">-</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span>
                    <span class="p">)</span>  <span class="c1"># Pour prendre en compte l&#39;azote synthétique volatilizé et non consommé par la plante</span>
                    <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Surface Synthetic Fertilizer Use (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fert_synth_with_volat</span>

                    <span class="c1"># 2) Calculer la fertilisation synthétique totale en ktN</span>
                    <span class="n">area_ha</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
                    <span class="n">total_synth_ktN</span> <span class="o">=</span> <span class="p">(</span><span class="n">fert_synth_with_volat</span> <span class="o">*</span> <span class="n">area_ha</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span>  <span class="c1"># (kgN/ha * ha) / 1e6 = ktN</span>
                    <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_synth_ktN</span>

                    <span class="c1"># 3) Mettre à jour rendement et production</span>
                    <span class="c1"># On calcule la fertilisation totale (synthétique + éventuel non-synthétique)</span>
                    <span class="n">non_synth_fert</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Surface Non Synthetic Fertilizer Use (kgN/ha)&quot;</span><span class="p">]</span>
                    <span class="n">fert_tot</span> <span class="o">=</span> <span class="n">fert_synth</span> <span class="o">+</span> <span class="n">non_synth_fert</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Ratio&quot;</span><span class="p">:</span>
                        <span class="n">y_max</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Ymax (kgN/ha)&quot;</span><span class="p">]</span>

                        <span class="n">new_yield</span> <span class="o">=</span> <span class="n">Y_th_ratio</span><span class="p">(</span><span class="n">fert_tot</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Linear&quot;</span><span class="p">:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">]</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]</span>
                        <span class="n">new_yield</span> <span class="o">=</span> <span class="n">Y_th_lin</span><span class="p">(</span><span class="n">fert_tot</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prod_func</span> <span class="o">==</span> <span class="s2">&quot;Exponential&quot;</span><span class="p">:</span>
                        <span class="n">y_max</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Ymax (kgN/ha)&quot;</span><span class="p">]</span>
                        <span class="n">k_param</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;k (kgN/ha)&quot;</span><span class="p">]</span>

                        <span class="n">new_yield</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">Y_th_exp_cap</span><span class="p">(</span><span class="n">fert_tot</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">k_param</span><span class="p">)</span>
                    <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Yield (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_yield</span>
                    <span class="c1"># Production en ktN</span>
                    <span class="n">nitro_prod_ktN</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_yield</span> <span class="o">*</span> <span class="n">area_ha</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span>
                    <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nitro_prod_ktN</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Pour les légumineuses, on ne touche pas Yield ni Nitrogen Production</span>
                    <span class="k">pass</span>

            <span class="c1">## Azote synthétique volatilisé par les terres</span>
            <span class="c1"># Est ce qu&#39;il n&#39;y a que l&#39;azote synthétique qui est volatilisé ?</span>
            <span class="n">coef_volat_NH3</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">technical</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">technical</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NH3 volatilization coefficient for synthetic nitrogen&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
                <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="o">/</span> <span class="mi">100</span>
            <span class="p">)</span>
            <span class="n">coef_volat_N2O</span> <span class="o">=</span> <span class="mf">0.01</span>

            <span class="c1"># 1 % des emissions de NH3 du aux fert. synth sont volatilisées sous forme de N2O</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Volatilized Nitrogen N-NH3 (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.99</span> <span class="o">*</span> <span class="n">coef_volat_NH3</span>
            <span class="p">)</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Volatilized Nitrogen N-N2O (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">coef_volat_N2O</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">coef_volat_NH3</span>
            <span class="p">)</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="mi">1</span> <span class="o">-</span> <span class="n">coef_volat_NH3</span> <span class="o">-</span> <span class="n">coef_volat_N2O</span>
            <span class="p">)</span>

            <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

            <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="n">source</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Volatilized Nitrogen N-NH3 (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

            <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="n">source</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Volatilized Nitrogen N-N2O (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

            <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="c1"># A cela on ajoute les emissions indirectes de N2O lors de la fabrication des engrais</span>
            <span class="c1"># epend_tot_synt = (</span>
            <span class="c1">#     df_cultures[&quot;Volatilized Nitrogen N-NH3 (ktN)&quot;]</span>
            <span class="c1">#     + df_cultures[&quot;Volatilized Nitrogen N-N2O (ktN)&quot;]</span>
            <span class="c1">#     + df_cultures[&quot;Adjusted Total Synthetic Fertilizer Use (ktN)&quot;]</span>
            <span class="c1"># ).sum()</span>
            <span class="n">epend_tot_synt</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">coef_emis_N_N2O</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">technical</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">technical</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Indirect N2O volatilization coefficient for synthetic nitrogen&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;Business as usual&quot;</span><span class="p">,</span>
                <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="o">/</span> <span class="mi">100</span>
            <span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">:</span> <span class="n">epend_tot_synt</span> <span class="o">*</span> <span class="n">coef_emis_N_N2O</span><span class="p">}</span>

            <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="c1"># Azote issu de la partie non comestible des carcasses</span>
            <span class="n">source_non_comestible</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Non Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">target_other_sectors</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;other sectors&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source_non_comestible</span><span class="p">,</span> <span class="n">target_other_sectors</span><span class="p">)</span>

            <span class="n">allocations</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">x_opt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                    <span class="c1"># Décider du &quot;Type&quot; (local feed vs local food)</span>
                    <span class="c1"># Par exemple, si &#39;k&#39; fait partie d&#39;un set df_elevage.index =&gt; feed</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="n">type_</span> <span class="o">=</span> <span class="s2">&quot;Local culture feed&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">type_</span> <span class="o">=</span> <span class="s2">&quot;Local culture food&quot;</span>

                    <span class="n">allocations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;Culture&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span>
                            <span class="s2">&quot;Consumer&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                            <span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">:</span> <span class="n">val</span><span class="p">,</span>
                            <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="n">type_</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

            <span class="c1"># Idem pour les imports (I, E).</span>
            <span class="c1"># Import feed:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">k</span><span class="p">),</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idx_import</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">x_opt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Feed&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Food&quot;</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                    <span class="n">allocations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;Culture&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span>
                            <span class="s2">&quot;Consumer&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
                            <span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">:</span> <span class="n">val</span><span class="p">,</span>
                            <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Imported </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

            <span class="n">allocations_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">allocations</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocations_df</span> <span class="o">=</span> <span class="n">allocations_df</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span> <span class="o">=</span> <span class="n">allocations_df</span>

            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Yield (qtl/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Yield (kgN/ha)&quot;</span><span class="p">]</span>
                <span class="o">/</span> <span class="p">(</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Content (%)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
                <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># Conversion de kg en qtl (100kg)</span>
            <span class="p">)</span>

            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen for Feed (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen for Food (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">group_sums</span> <span class="o">=</span> <span class="n">allocations_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Culture&quot;</span><span class="p">,</span> <span class="s2">&quot;Type&quot;</span><span class="p">])[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">table_sums</span> <span class="o">=</span> <span class="n">group_sums</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">table_sums</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;Local culture feed&quot;</span> <span class="ow">in</span> <span class="n">table_sums</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Nitrogen for Feed (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_sums</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Local culture feed&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;Local culture food&quot;</span> <span class="ow">in</span> <span class="n">table_sums</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">df_cultures</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Nitrogen for Food (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_sums</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;Local culture food&quot;</span><span class="p">]</span>

            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen for Feed (ktN)&quot;</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen for Food (ktN)&quot;</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Mise à jour de df_elevage</span>

            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Consummed Nitrogen from local feed (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Consummed Nitrogen from imported feed (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="n">group_sums</span> <span class="o">=</span> <span class="n">allocations_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Consumer&quot;</span><span class="p">,</span> <span class="s2">&quot;Type&quot;</span><span class="p">])[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">table_sums</span> <span class="o">=</span> <span class="n">group_sums</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;Local culture feed&quot;</span> <span class="ow">in</span> <span class="n">table_sums</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">df_elevage</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;Consummed Nitrogen from local feed (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_sums</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                        <span class="n">k</span><span class="p">,</span> <span class="s2">&quot;Local culture feed&quot;</span>
                    <span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;Imported Feed&quot;</span> <span class="ow">in</span> <span class="n">table_sums</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">df_elevage</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;Consummed Nitrogen from imported feed (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">table_sums</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;Imported Feed&quot;</span><span class="p">]</span>

            <span class="n">deviations_list</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">k_</span> <span class="ow">in</span> <span class="n">CONSUMERS</span><span class="p">:</span>
                <span class="c1"># Somme totale (local + import) pour le conso k_</span>
                <span class="n">denom_k</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">CROPS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                        <span class="n">denom_k</span> <span class="o">+=</span> <span class="n">x_opt</span><span class="p">[</span><span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_import</span><span class="p">:</span>
                        <span class="n">denom_k</span> <span class="o">+=</span> <span class="n">x_opt</span><span class="p">[</span><span class="n">idx_import</span><span class="p">[(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>

                <span class="k">for</span> <span class="n">p_ideal</span><span class="p">,</span> <span class="n">c_list</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">k_</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">group_alloc</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">for</span> <span class="n">c_</span> <span class="ow">in</span> <span class="n">c_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_alloc</span><span class="p">:</span>
                            <span class="n">group_alloc</span> <span class="o">+=</span> <span class="n">x_opt</span><span class="p">[</span><span class="n">idx_alloc</span><span class="p">[(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">idx_import</span><span class="p">:</span>
                            <span class="n">group_alloc</span> <span class="o">+=</span> <span class="n">x_opt</span><span class="p">[</span><span class="n">idx_import</span><span class="p">[(</span><span class="n">c_</span><span class="p">,</span> <span class="n">k_</span><span class="p">)]]</span>

                    <span class="k">if</span> <span class="n">denom_k</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                        <span class="n">proportion_real</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">proportion_real</span> <span class="o">=</span> <span class="n">group_alloc</span> <span class="o">/</span> <span class="n">denom_k</span>

                    <span class="n">deviation</span> <span class="o">=</span> <span class="n">proportion_real</span> <span class="o">-</span> <span class="n">p_ideal</span>

                    <span class="n">deviations_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;Consumer&quot;</span><span class="p">:</span> <span class="n">k_</span><span class="p">,</span>
                            <span class="s2">&quot;Cultures&quot;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c_list</span><span class="p">),</span>
                            <span class="s2">&quot;Expected Proportion (%)&quot;</span><span class="p">:</span> <span class="n">p_ideal</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                            <span class="s2">&quot;Allocated Proportion (%)&quot;</span><span class="p">:</span> <span class="n">proportion_real</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                            <span class="s2">&quot;Deviation (%)&quot;</span><span class="p">:</span> <span class="n">deviation</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

            <span class="n">df_deviation</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">deviations_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deviations_df</span> <span class="o">=</span> <span class="n">df_deviation</span>

            <span class="c1"># Génération des flux pour les cultures locales</span>
            <span class="n">allocations_locales</span> <span class="o">=</span> <span class="n">allocations_df</span><span class="p">[</span>
                <span class="n">allocations_df</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;Local culture food&quot;</span><span class="p">,</span> <span class="s2">&quot;Local culture feed&quot;</span><span class="p">])</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="n">cons</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">allocations_locales</span><span class="p">[</span><span class="n">allocations_locales</span><span class="p">[</span><span class="s2">&quot;Consumer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cons</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Culture&quot;</span><span class="p">)[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">source</span><span class="p">:</span>
                    <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="c1"># Génération des flux pour les importations</span>
            <span class="n">allocations_imports</span> <span class="o">=</span> <span class="n">allocations_df</span><span class="p">[</span>
                <span class="n">allocations_df</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;Imported Feed&quot;</span><span class="p">,</span> <span class="s2">&quot;Imported Food&quot;</span><span class="p">,</span> <span class="s2">&quot;Excess feed imports&quot;</span><span class="p">])</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="n">cons</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                <span class="n">cons_vege_imports</span> <span class="o">=</span> <span class="n">allocations_imports</span><span class="p">[</span><span class="n">allocations_imports</span><span class="p">[</span><span class="s2">&quot;Consumer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cons</span><span class="p">]</span>

                <span class="c1"># Initialisation d&#39;un dictionnaire pour collecter les flux par catégorie</span>
                <span class="n">flux</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cons_vege_imports</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">culture</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Culture&quot;</span><span class="p">]</span>
                    <span class="n">azote_alloue</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span>

                    <span class="c1"># Récupération de la catégorie de la culture</span>
                    <span class="n">categorie</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Category&quot;</span><span class="p">]</span>

                    <span class="c1"># Construction du label source pour l&#39;importation</span>
                    <span class="k">if</span> <span class="n">cons</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;urban&quot;</span><span class="p">,</span> <span class="s2">&quot;rural&quot;</span><span class="p">]:</span>
                        <span class="n">label_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">categorie</span><span class="si">}</span><span class="s2"> food trade&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">label_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">categorie</span><span class="si">}</span><span class="s2"> feed trade&quot;</span>

                    <span class="c1"># Accumuler les flux par catégorie</span>
                    <span class="k">if</span> <span class="n">label_source</span> <span class="ow">in</span> <span class="n">flux</span><span class="p">:</span>
                        <span class="n">flux</span><span class="p">[</span><span class="n">label_source</span><span class="p">]</span> <span class="o">+=</span> <span class="n">azote_alloue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">flux</span><span class="p">[</span><span class="n">label_source</span><span class="p">]</span> <span class="o">=</span> <span class="n">azote_alloue</span>

                <span class="c1"># Génération des flux pour l&#39;élevage</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">flux</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="c1"># On redonne à df_elevage sa forme d&#39;origine et à import_feed_net sa vraie valeur</span>
            <span class="c1"># Utiliser `infer_objects(copy=False)` pour éviter l&#39;avertissement sur le downcasting</span>
            <span class="n">df_elevage</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">df_elevage_comp</span><span class="p">)</span>

            <span class="c1"># Remplir les valeurs manquantes avec 0</span>
            <span class="n">df_elevage</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Inférer les types pour éviter le warning sur les colonnes object</span>
            <span class="n">df_elevage</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">infer_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># feed_export = import_feed - import_feed_net</span>

            <span class="c1"># flux_exported = {}</span>
            <span class="c1"># if feed_export &gt; 10**-6:  # On a importé plus que les imports net, la diff est l&#39;export de feed</span>
            <span class="c1">#     feed_export = min(</span>
            <span class="c1">#         feed_export,</span>
            <span class="c1">#         df_cultures[&quot;Available Nitrogen After Feed and Food (ktN)&quot;].sum(),</span>
            <span class="c1">#     )  # Patch pour gérer les cas où on a une surexportation (cf Bretagne 2010)</span>
            <span class="c1">#     # On distingue les exports de feed prioritaires (prairies et fourrages) au reste</span>
            <span class="c1">#     # On distingue le cas où il y a assez dans les exports prioritaires pour couvrir</span>
            <span class="c1">#     # les export de feed au cas où il faut en plus exporter les autres cultures (mais d&#39;abord les exports prio)</span>
            <span class="c1">#     if (</span>
            <span class="c1">#         feed_export</span>
            <span class="c1">#         &gt; df_cultures.loc[</span>
            <span class="c1">#             df_cultures[&quot;Category&quot;].isin([&quot;forages&quot;, &quot;temporary meadows&quot;]),</span>
            <span class="c1">#             &quot;Available Nitrogen After Feed and Food (ktN)&quot;,</span>
            <span class="c1">#         ].sum()</span>
            <span class="c1">#     ):</span>
            <span class="c1">#         feed_export_prio = df_cultures.loc[</span>
            <span class="c1">#             df_cultures[&quot;Category&quot;].isin([&quot;forages&quot;, &quot;temporary meadows&quot;]),</span>
            <span class="c1">#             &quot;Available Nitrogen After Feed and Food (ktN)&quot;,</span>
            <span class="c1">#         ].sum()</span>
            <span class="c1">#         feed_export_other = feed_export - feed_export_prio</span>
            <span class="c1">#     else:</span>
            <span class="c1">#         feed_export_prio = feed_export</span>
            <span class="c1">#         feed_export_other = 0</span>
            <span class="c1">#     # Répartition de l&#39;azote exporté inutilisé par catégorie</span>
            <span class="c1">#     # On fait un premier tour sur les cultures prioritaires</span>
            <span class="c1">#     for culture in df_cultures.loc[df_cultures[&quot;Category&quot;].isin([&quot;forages&quot;, &quot;temporary meadows&quot;])].index:</span>
            <span class="c1">#         categorie = df_cultures.loc[df_cultures.index == culture, &quot;Category&quot;].item()</span>
            <span class="c1">#         # On exporte pas en feed des catégories dédiées aux humains</span>
            <span class="c1">#         if categorie not in [&quot;rice&quot;, &quot;fruits and vegetables&quot;, &quot;roots&quot;]:</span>
            <span class="c1">#             # Calculer la quantité exportée par catégorie proportionnellement aux catégories présentes dans df_cultures</span>
            <span class="c1">#             culture_nitrogen_available = df_cultures.loc[df_cultures.index == culture][</span>
            <span class="c1">#                 &quot;Available Nitrogen After Feed and Food (ktN)&quot;</span>
            <span class="c1">#             ].item()</span>

            <span class="c1">#             if culture_nitrogen_available &gt; 0:</span>
            <span class="c1">#                 flux_exported[culture] = feed_export_prio * (</span>
            <span class="c1">#                     culture_nitrogen_available</span>
            <span class="c1">#                     / df_cultures[&quot;Available Nitrogen After Feed and Food (ktN)&quot;].sum()</span>
            <span class="c1">#                 )</span>

            <span class="c1">#     # On écoule le reste des export de feed (si il y en a) sur les autres cultures</span>
            <span class="c1">#     if feed_export_other &gt; 10**-6:</span>
            <span class="c1">#         for culture in df_cultures.loc[</span>
            <span class="c1">#             ~df_cultures[&quot;Category&quot;].isin([&quot;forages&quot;, &quot;temporary meadows&quot;])</span>
            <span class="c1">#         ].index:</span>
            <span class="c1">#             categorie = df_cultures.loc[df_cultures.index == culture, &quot;Category&quot;].item()</span>
            <span class="c1">#             # On exporte pas en feed des catégories dédiées aux humains</span>
            <span class="c1">#             if categorie not in [&quot;rice&quot;, &quot;fruits and vegetables&quot;, &quot;roots&quot;]:</span>
            <span class="c1">#                 # Calculer la quantité exportée par catégorie proportionnellement aux catégories présentes dans df_cultures</span>
            <span class="c1">#                 culture_nitrogen_available = df_cultures.loc[df_cultures.index == culture][</span>
            <span class="c1">#                     &quot;Available Nitrogen After Feed and Food (ktN)&quot;</span>
            <span class="c1">#                 ].item()</span>

            <span class="c1">#                 if culture_nitrogen_available &gt; 0:</span>
            <span class="c1">#                     flux_exported[culture] = feed_export_prio * (</span>
            <span class="c1">#                         culture_nitrogen_available</span>
            <span class="c1">#                         / df_cultures[&quot;Available Nitrogen After Feed and Food (ktN)&quot;].sum()</span>
            <span class="c1">#                     )</span>

            <span class="c1">#     # Générer des flux les exportations vers leur catégorie d&#39;origine</span>
            <span class="c1">#     for label_source, azote_exported in flux_exported.items():</span>
            <span class="c1">#         if azote_exported &gt; 0:</span>
            <span class="c1">#             categorie = df_cultures.loc[df_cultures.index == label_source, &quot;Category&quot;].item()</span>
            <span class="c1">#             label_target = f&quot;{categorie} feed trade&quot;</span>
            <span class="c1">#             target = {label_target: 1}</span>
            <span class="c1">#             source = {label_source: azote_exported}</span>
            <span class="c1">#             flux_generator.generate_flux(source, target)</span>

        <span class="c1"># # Mise à jour du DataFrame avec les quantités exportées</span>
        <span class="c1"># df_cultures[&quot;Nitrogen Exported For Feed (ktN)&quot;] = df_cultures.index.map(flux_exported).fillna(</span>
        <span class="c1">#     0</span>
        <span class="c1"># )  # df_cultures.index.map(source).fillna(0)</span>

        <span class="c1"># df_cultures[&quot;Available Nitrogen After Feed, Export Feed and Food (ktN)&quot;] = (</span>
        <span class="c1">#     df_cultures[&quot;Available Nitrogen After Feed and Food (ktN)&quot;]</span>
        <span class="c1">#     - df_cultures[&quot;Nitrogen Exported For Feed (ktN)&quot;]</span>
        <span class="c1"># ).apply(lambda x: 0 if abs(x) &lt; 1e-6 else x)</span>

        <span class="c1"># import/export food</span>
        <span class="c1"># Le surplus est food exporté (ou stocké mais cela ne nous regarde pas)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">culture</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
            <span class="n">categorie</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">categorie</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;temporary meadows&quot;</span><span class="p">,</span> <span class="s2">&quot;forages&quot;</span><span class="p">,</span> <span class="s2">&quot;natural meadows &quot;</span><span class="p">]:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">culture</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span>
                        <span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span><span class="p">,</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">categorie</span><span class="si">}</span><span class="s2"> food trade&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">culture</span> <span class="o">!=</span> <span class="s2">&quot;Natural meadow &quot;</span>
            <span class="p">):</span>  <span class="c1"># TODO Que faire des production de feed qui ne sont ni consommées ni exportées ? Pour l&#39;instant on les exporte....</span>
                <span class="c1"># NOOOON Il faut les laisser retourner en terre si c&#39;est une prairie naturelle (recommandation de JLN)</span>
                <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">culture</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span>
                        <span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span><span class="p">,</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">categorie</span><span class="si">}</span><span class="s2"> feed trade&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">culture</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">categorie</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">culture</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span>
                        <span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span><span class="p">,</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;soil stock&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Que faire d&#39;eventuel surplus de prairies ou forage ?</span>
        <span class="c1"># Sur recommandation de JLN c&#39;est retourné vers le sol pour les prairies permanentes et exporté pour tout le reste</span>

        <span class="c1">## Usage de l&#39;azote animal pour nourir la population, on pourrait améliorer en distinguant viande, oeufs et lait</span>

        <span class="n">viande_cap</span> <span class="o">=</span> <span class="n">main</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="n">main</span><span class="p">[</span><span class="s2">&quot;Variable&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Edible animal per capita protein ingestion (excl fish)&quot;</span><span class="p">,</span> <span class="s2">&quot;Business as usual&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">cons_viande</span> <span class="o">=</span> <span class="n">viande_cap</span> <span class="o">*</span> <span class="n">pop</span>

        <span class="c1"># Reflechir a considerer un regime alimentaire carne (national) apres 1960</span>
        <span class="k">if</span> <span class="n">cons_viande</span> <span class="o">&lt;</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>  <span class="c1"># Il y a assez de viande locale</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">prop_urb</span> <span class="o">*</span> <span class="n">cons_viande</span><span class="p">,</span>
                <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span> <span class="o">*</span> <span class="n">cons_viande</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="p">[</span>
                <span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span>
            <span class="p">]</span> <span class="o">-</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># On commence par consommer tout l&#39;azote disponible</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">prop_urb</span><span class="p">,</span> <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)}</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="n">cons_viande_import</span> <span class="o">=</span> <span class="n">cons_viande</span> <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">commerce_path</span> <span class="o">=</span> <span class="s2">&quot;FAOSTAT_data_fr_viande_import.csv&quot;</span>
            <span class="n">commerce</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="n">commerce_path</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1965</span>
            <span class="p">):</span>  <span class="c1"># Si on est avant 65, on se base sur les rations de 65. De toute façon ça concerne des import minoritaires...</span>
                <span class="n">year</span> <span class="o">=</span> <span class="s2">&quot;1965&quot;</span>
            <span class="n">commerce</span> <span class="o">=</span> <span class="n">commerce</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Année&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;Produit&quot;</span><span class="p">,</span> <span class="s2">&quot;Valeur&quot;</span><span class="p">]]</span>

            <span class="n">corresp_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Viande, bovine, fraîche ou réfrigérée&quot;</span><span class="p">:</span> <span class="s2">&quot;bovines&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Viande ovine, fraîche ou réfrigérée&quot;</span><span class="p">:</span> <span class="s2">&quot;ovines&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Viande, caprin, fraîche ou réfrigérée&quot;</span><span class="p">:</span> <span class="s2">&quot;caprines&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Viande, cheval, fraîche ou réfrigérée&quot;</span><span class="p">:</span> <span class="s2">&quot;equine&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Viande, porc, fraîche ou réfrigérée&quot;</span><span class="p">:</span> <span class="s2">&quot;porcines&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Viande, poulet, fraîche ou réfrigérée&quot;</span><span class="p">:</span> <span class="s2">&quot;poultry&quot;</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Produit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Produit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">corresp_dict</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Produit&quot;</span><span class="p">])</span>
            <span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Ratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Valeur&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Valeur&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">commerce</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Produit&quot;</span><span class="p">]</span>

            <span class="n">target</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">prop_urb</span> <span class="o">*</span> <span class="n">cons_viande_import</span><span class="p">,</span>
                <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span> <span class="o">*</span> <span class="n">cons_viande_import</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;animal trade&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>  <span class="c1"># commerce[&quot;Ratio&quot;].to_dict() On peut distinguer les différents types d&#39;azote importé</span>
            <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="c1"># Et on reporte ce qu&#39;il manque dans la colonne &quot;Azote animal exporté net&quot;</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Ratio&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cons_viande_import</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cons_viande</span> <span class="o">&lt;</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;animal trade&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Calcul des déséquilibres négatifs</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">cultures</span> <span class="o">+</span> <span class="n">legumineuses</span> <span class="o">+</span> <span class="n">prairies</span><span class="p">:</span>
            <span class="n">node_index</span> <span class="o">=</span> <span class="n">label_to_index</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="n">row_sum</span> <span class="o">=</span> <span class="n">adjacency_matrix</span><span class="p">[</span><span class="n">node_index</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">col_sum</span> <span class="o">=</span> <span class="n">adjacency_matrix</span><span class="p">[:,</span> <span class="n">node_index</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">imbalance</span> <span class="o">=</span> <span class="n">row_sum</span> <span class="o">-</span> <span class="n">col_sum</span>  <span class="c1"># Déséquilibre entre sorties et entrées</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">imbalance</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">4</span><span class="p">:</span>
                <span class="n">imbalance</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">imbalance</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>  <span class="c1"># Que conclure si il y a plus de sortie que d&#39;entrée ? Que l&#39;on détériore les réserves du sol ?</span>
                <span class="c1"># print(f&quot;pb de balance avec {label}&quot;)</span>
                <span class="c1"># Plus de sorties que d&#39;entrées, on augmente les entrées</span>
                <span class="c1"># new_adjacency_matrix[n, node_index] = imbalance  # Flux du nœud de balance vers la culture</span>
                <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">imbalance</span><span class="p">}</span>
                <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;soil stock&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">imbalance</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Plus d&#39;entrées que de sorties, on augmente les sorties</span>
                <span class="c1"># adjacency_matrix[node_index, n] = -imbalance  # Flux de la culture vers le nœud de balance</span>
                <span class="k">if</span> <span class="n">label</span> <span class="o">!=</span> <span class="s2">&quot;Natural meadow &quot;</span><span class="p">:</span>  <span class="c1"># 70% de l&#39;excès fini dans les ecosystèmes aquatiques</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="o">-</span><span class="n">imbalance</span><span class="p">}</span>
                    <span class="c1"># Ajouter soil stock parmis les surplus de fertilisation.</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;other losses&quot;</span><span class="p">:</span> <span class="mf">0.2925</span><span class="p">,</span>
                        <span class="s2">&quot;hydro-system&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
                        <span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mf">0.0075</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">imbalance</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span> <span class="o">/</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="s2">&quot;Natural meadow &quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                        <span class="o">&gt;</span> <span class="mi">100</span>
                    <span class="p">):</span>  <span class="c1"># Si c&#39;est une prairie, l&#39;azote est lessivé seulement au dela de 100 kgN/ha</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">label</span><span class="p">:</span> <span class="o">-</span><span class="n">imbalance</span>
                            <span class="o">-</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="s2">&quot;Natural meadow &quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
                        <span class="p">}</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;other losses&quot;</span><span class="p">:</span> <span class="mf">0.2925</span><span class="p">,</span>
                            <span class="s2">&quot;hydro-system&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
                            <span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mf">0.0075</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">label</span><span class="p">:</span> <span class="mi">100</span>
                            <span class="o">*</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="s2">&quot;Natural meadow &quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                            <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
                        <span class="p">}</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Autrement, l&#39;azote reste dans le sol (cas particulier, est ce que cela a du sens, quid des autres cultures ?)</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="o">-</span><span class="n">imbalance</span><span class="p">}</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;soil stock&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="c1"># Si imbalance == 0, aucun ajustement nécessaire</span>

        <span class="c1"># Calcul de imbalance dans df_cultures</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Balance (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Total Non Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Volatilized Nitrogen N-NH3 (ktN)&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Volatilized Nitrogen N-N2O (ktN)&quot;</span><span class="p">]</span>  <span class="c1"># Pas de volat sous forme de N2 ?</span>
        <span class="p">)</span>

        <span class="c1"># On équilibre Haber-Bosch avec atmospheric N2 pour le faire entrer dans le système</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span><span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Conversion factor (%)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Non Edible Nitrogen (ktN)&quot;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Ingestion (ktN)&quot;</span><span class="p">]</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">grafs_e.prospective</span><span class="w"> </span><span class="kn">import</span> <span class="n">scenario</span>

        <span class="n">LU</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">livestock_LU</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">]</span>
        <span class="n">LU</span><span class="p">[</span><span class="s2">&quot;equine&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LU</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;equines&quot;</span><span class="p">)</span>
        <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;LU&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LU</span>

        <span class="c1"># On ajoute une ligne total à df_cultures et df_elevage</span>
        <span class="n">colonnes_a_exclure</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Spreading Rate (%)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Nitrogen Content (%)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Seed input (kt seeds/kt Ymax)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Category&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N fixation coef (kgN/kgN)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Fertilization Need (kgN/qtl)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Surface Fertilization Need (kgN/ha)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Yield (qtl/ha)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Yield (kgN/ha)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Surface Non Synthetic Fertilizer Use (kgN/ha)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Raw Surface Synthetic Fertilizer Use (ktN/ha)&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">colonnes_a_sommer</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">colonnes_a_exclure</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="n">colonnes_a_sommer</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">total</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Total&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures_display</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_cultures</span><span class="p">,</span> <span class="n">total</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>

        <span class="n">colonnes_a_exclure</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;</span><span class="si">% e</span><span class="s2">dible&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as manure&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as slurry&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted on grassland&quot;</span><span class="p">,</span>
            <span class="s2">&quot;% non edible&quot;</span><span class="p">,</span>
            <span class="s2">&quot;%N dairy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-N2 EM. manure indoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-N2 EM. outdoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-N2 EM. slurry indoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-N2O EM. manure indoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-N2O EM. outdoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-N2O EM. slurry indoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-NH3 EM. manure indoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-NH3 EM. outdoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-NH3 EM. slurry indoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Conversion factor (%)&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">colonnes_a_sommer</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">colonnes_a_exclure</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="p">[</span><span class="n">colonnes_a_sommer</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">total</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Total&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage_display</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_elevage</span><span class="p">,</span> <span class="n">total</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span> <span class="o">=</span> <span class="n">df_cultures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span> <span class="o">=</span> <span class="n">df_elevage</span></div>

        <span class="c1"># self.adjacency_matrix = adjacency_matrix</span>

<div class="viewcode-block" id="NitrogenFlowModel_prospect.get_df_culture">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.get_df_culture">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_df_culture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the DataFrame containing crop-related data.</span>

<span class="sd">        :return: A pandas DataFrame with crop data used in the nitrogen model.</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.get_df_elevage">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.get_df_elevage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_df_elevage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the DataFrame containing livestock-related data.</span>

<span class="sd">        :return: A pandas DataFrame with livestock data used in the nitrogen model.</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.get_transition_matrix">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.get_transition_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_transition_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the full nitrogen transition matrix.</span>

<span class="sd">        This matrix represents all nitrogen fluxes between sectors, including core and external processes.</span>

<span class="sd">        :return: A 2D NumPy array representing nitrogen fluxes between all sectors.</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.get_core_matrix">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.get_core_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_core_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts and returns the core matrix of nitrogen fluxes between active sectors.</span>

<span class="sd">        This method filters out rows and columns with no flows and excludes external sectors.</span>
<span class="sd">        The result isolates the central dynamics of the system.</span>

<span class="sd">        :return: A 2D NumPy array of the filtered core matrix.</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calcul de la taille du noyau</span>
        <span class="n">core_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ext</span><span class="p">)</span>

        <span class="c1"># Extraire la matrice principale (noyau)</span>
        <span class="n">core_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[:</span><span class="n">core_size</span><span class="p">,</span> <span class="p">:</span><span class="n">core_size</span><span class="p">]</span>

        <span class="c1"># Calculer la somme des éléments sur chaque ligne</span>
        <span class="n">row_sums</span> <span class="o">=</span> <span class="n">core_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Identifier les indices des lignes où la somme est non nulle</span>
        <span class="n">non_zero_rows</span> <span class="o">=</span> <span class="n">row_sums</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="c1"># Identifier les indices des colonnes à garder (les mêmes indices que les lignes non nulles)</span>
        <span class="n">non_zero_columns</span> <span class="o">=</span> <span class="n">non_zero_rows</span>

        <span class="c1"># Filtrer les lignes et les colonnes avec une somme non nulle</span>
        <span class="n">core_matrix_filtered</span> <span class="o">=</span> <span class="n">core_matrix</span><span class="p">[</span><span class="n">non_zero_rows</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">non_zero_columns</span><span class="p">]</span>

        <span class="c1"># Retourner la matrice filtrée</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core_matrix</span> <span class="o">=</span> <span class="n">core_matrix_filtered</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_zero_rows</span> <span class="o">=</span> <span class="n">non_zero_rows</span>
        <span class="k">return</span> <span class="n">core_matrix_filtered</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.get_adjacency_matrix">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.get_adjacency_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_adjacency_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the binary adjacency matrix of nitrogen fluxes.</span>

<span class="sd">        This matrix has the same dimensions as the core matrix and indicates the presence</span>
<span class="sd">        (1) or absence (0) of nitrogen fluxes between sectors.</span>

<span class="sd">        :return: A binary adjacency matrix.</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_core_matrix</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">core_matrix</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.extract_input_output_matrixs">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.extract_input_output_matrixs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_input_output_matrixs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts input and output matrices (C and B blocks) from the full transition matrix.</span>

<span class="sd">        These matrices represent the nitrogen flows between core and external sectors:</span>
<span class="sd">        - B: Outputs from core to external sectors.</span>
<span class="sd">        - C: Inputs from external to core sectors.</span>

<span class="sd">        If `clean` is True, the method removes rows and columns corresponding to inactive sectors.</span>

<span class="sd">        :param clean: Whether to remove zero-flow sectors from the matrices.</span>
<span class="sd">        :type clean: bool</span>
<span class="sd">        :return: A tuple (B, C) of NumPy arrays.</span>
<span class="sd">        :rtype: tuple[numpy.ndarray, numpy.ndarray]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Fonction pour extraire la matrice entrée (C) et la matrice sortie (B) de la matrice complète.</span>
        <span class="c1"># Taille de la matrice coeur</span>
        <span class="n">core_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ext</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">)</span>
        <span class="c1"># Extraire la sous-matrice B (bloc haut-droit)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[:</span><span class="n">core_size</span><span class="p">,</span> <span class="n">core_size</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>

        <span class="c1"># Extraire la sous-matrice C (bloc bas-gauche)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span><span class="n">core_size</span><span class="p">:</span><span class="n">n</span><span class="p">,</span> <span class="p">:</span><span class="n">core_size</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">clean</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="p">[:][:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_zero_rows</span><span class="p">]</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">non_zero_rows</span><span class="p">,</span> <span class="p">:][:]</span>

        <span class="k">return</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.imported_nitrogen">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.imported_nitrogen">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">imported_nitrogen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the total amount of nitrogen imported into the system.</span>

<span class="sd">        Includes nitrogen in imported food, feed, and excess feed.</span>

<span class="sd">        :return: Total imported nitrogen (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;Imported Food&quot;</span><span class="p">,</span> <span class="s2">&quot;Imported Feed&quot;</span><span class="p">,</span> <span class="s2">&quot;Excess feed imports&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">,</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.net_imported_plant">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.net_imported_plant">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_imported_plant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the net nitrogen imports for plant sectors.</span>

<span class="sd">        Calculated as the difference between total nitrogen imports and plant sector availability after local uses (feed and food).</span>

<span class="sd">        :return: Net nitrogen import for plant-based products (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">importations_df</span><span class="p">[</span><span class="s2">&quot;Imported Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.net_imported_animal">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.net_imported_animal">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_imported_animal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the net nitrogen export for animal sectors.</span>

<span class="sd">        :return: Total nitrogen exported via animal products (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.total_plant_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.total_plant_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_plant_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the total nitrogen production from all crop categories.</span>

<span class="sd">        :return: Total nitrogen produced by crops (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.stacked_plant_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.stacked_plant_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stacked_plant_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the vector of nitrogen production by crop category.</span>

<span class="sd">        :return: A pandas Series of nitrogen production per crop.</span>
<span class="sd">        :rtype: pandas.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.cereals_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.cereals_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cereals_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the nitrogen production from cereal crops.</span>

<span class="sd">        :return: Total nitrogen from cereals (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;cereals (excluding rice)&quot;</span><span class="p">,</span> <span class="s2">&quot;rice&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.leguminous_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.leguminous_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">leguminous_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the nitrogen production from leguminous crops.</span>

<span class="sd">        :return: Total nitrogen from leguminous (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;leguminous&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.oleaginous_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.oleaginous_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">oleaginous_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the nitrogen production from oleaginous crops.</span>

<span class="sd">        :return: Total nitrogen from oleaginous (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;oleaginous&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.grassland_and_forages_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.grassland_and_forages_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">grassland_and_forages_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the nitrogen production from grassland and forages crops.</span>

<span class="sd">        :return: Total nitrogen from grassland and forages (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;temporary meadows&quot;</span><span class="p">,</span> <span class="s2">&quot;natural meadows &quot;</span><span class="p">,</span> <span class="s2">&quot;forages&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">,</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.roots_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.roots_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">roots_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the nitrogen production from roots crops.</span>

<span class="sd">        :return: Total nitrogen from roots (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;roots&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.fruits_and_vegetable_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.fruits_and_vegetable_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fruits_and_vegetable_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the nitrogen production from fruits and vegetables crops.</span>

<span class="sd">        :return: Total nitrogen from fruits and vegetables (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;fruits and vegetables&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.cereals_production_r">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.cereals_production_r">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cereals_production_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the share of nitrogen production from cereals relative to total plant production.</span>

<span class="sd">        :return: Percentage of total plant nitrogen production from cereals.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;cereals (excluding rice)&quot;</span><span class="p">,</span> <span class="s2">&quot;rice&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plant_production</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.leguminous_production_r">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.leguminous_production_r">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">leguminous_production_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the share of nitrogen production from leguminous relative to total plant production.</span>

<span class="sd">        :return: Percentage of total plant nitrogen production from leguminous.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;leguminous&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plant_production</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.oleaginous_production_r">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.oleaginous_production_r">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">oleaginous_production_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the share of nitrogen production from oleaginous relative to total plant production.</span>

<span class="sd">        :return: Percentage of total plant nitrogen production from oleaginous.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;oleaginous&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plant_production</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.grassland_and_forages_production_r">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.grassland_and_forages_production_r">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">grassland_and_forages_production_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the share of nitrogen production from forages relative to total plant production.</span>

<span class="sd">        :return: Percentage of total plant nitrogen production from forages.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;temporary meadows&quot;</span><span class="p">,</span> <span class="s2">&quot;natural meadows&quot;</span><span class="p">,</span> <span class="s2">&quot;forages&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">,</span>
            <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plant_production</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.roots_production_r">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.roots_production_r">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">roots_production_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the share of nitrogen production from roots relative to total plant production.</span>

<span class="sd">        :return: Percentage of total plant nitrogen production from roots.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;roots&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plant_production</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.fruits_and_vegetable_production_r">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.fruits_and_vegetable_production_r">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fruits_and_vegetable_production_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the share of nitrogen production from fruits and vegetables relative to total plant production.</span>

<span class="sd">        :return: Percentage of total plant nitrogen production from fruits and vegetables.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;fruits and vegetables&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plant_production</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.animal_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.animal_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">animal_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the total edible nitrogen produced by livestock sectors.</span>

<span class="sd">        :return: Total nitrogen in edible animal products (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.emissions">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.emissions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">emissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the total nitrogen emissions from the system.</span>

<span class="sd">        Includes N₂O emissions, atmospheric N₂ release, and NH₃ volatilization, with unit conversions.</span>

<span class="sd">        :return: A pandas Series with nitrogen emission quantities.</span>
<span class="sd">        :rtype: pandas.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[:,</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="mi">14</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">14</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span>
                <span class="p">),</span>
                <span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[:,</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[:,</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">17</span> <span class="o">/</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">2</span>
                <span class="p">),</span>
            <span class="p">},</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Emission&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()[</span><span class="s2">&quot;Emission&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.surfaces">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.surfaces">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">surfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the cultivated area per crop.</span>

<span class="sd">        :return: A pandas Series with area per crop (in hectares).</span>
<span class="sd">        :rtype: pandas.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.surfaces_tot">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.surfaces_tot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">surfaces_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the total cultivated area in the model.</span>

<span class="sd">        :return: Total area (in hectares).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.N_eff">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.N_eff">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">N_eff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gr</span><span class="o">.</span><span class="n">GraphAnalyzer</span><span class="o">.</span><span class="n">calculate_Neff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.C_eff">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.C_eff">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">C_eff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gr</span><span class="o">.</span><span class="n">GraphAnalyzer</span><span class="o">.</span><span class="n">calculate_Ceff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.F_eff">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.F_eff">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">F_eff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gr</span><span class="o">.</span><span class="n">GraphAnalyzer</span><span class="o">.</span><span class="n">calculate_Feff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.R_eff">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.R_eff">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">R_eff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gr</span><span class="o">.</span><span class="n">GraphAnalyzer</span><span class="o">.</span><span class="n">calculate_Reff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.Ftot">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.Ftot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">Ftot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">):</span>
        <span class="n">area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">area</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Vérification pour éviter la division par zéro</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[:,</span> <span class="n">label_to_index</span><span class="p">[</span><span class="n">culture</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">/</span> <span class="n">area</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.Y">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.Y">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">Y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the nitrogen yield of a given crop.</span>

<span class="sd">        Yield is calculated as nitrogen production (kgN) per hectare for the specified crop.</span>

<span class="sd">        :param culture: The name of the crop (index of `df_cultures`).</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :return: Nitrogen yield in kgN/ha.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">area</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Vérification pour éviter la division par zéro</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">/</span> <span class="n">area</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.tot_fert">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.tot_fert">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">tot_fert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes total nitrogen inputs to the system, broken down by origin.</span>

<span class="sd">        Categories include animal and human excretion, atmospheric deposition, Haber-Bosch inputs, leguminous enrichment, etc.</span>

<span class="sd">        :return: A pandas Series of nitrogen inputs by source (in ktN).</span>
<span class="sd">        :rtype: pandas.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Mining&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span><span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;soil stock&quot;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;Seeds&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span><span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;other sectors&quot;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;Human excretion&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;urban&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;rural&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;Leguminous soil enrichment&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Horse beans and faba beans&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Alfalfa and clover&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span><span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;Atmospheric deposition&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">],</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">],</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">],</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;Animal excretion&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;bovines&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;equine&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.rel_fert">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.rel_fert">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rel_fert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the relative share (%) of each nitrogen input source.</span>

<span class="sd">        :return: A pandas Series with nitrogen input sources as percentage of the total.</span>
<span class="sd">        :rtype: pandas.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_fert</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.primXsec">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.primXsec">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">primXsec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the percentage of nitrogen from secondary sources (biological or recycled),</span>
<span class="sd">        compared to the total nitrogen inputs.</span>

<span class="sd">        Secondary sources include: human excretion, animal excretion, atmospheric inputs, seeds, and leguminous fixation.</span>

<span class="sd">        :return: Share of secondary sources in total nitrogen inputs (%).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_fert</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Human excretion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Animal excretion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Atmospheric deposition&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Seeds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Leguminous soil enrichment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.NUE">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.NUE">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">NUE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the crop-level nitrogen use efficiency (NUE).</span>

<span class="sd">        Defined as the ratio of nitrogen produced by crops over total nitrogen inputs.</span>

<span class="sd">        :return: NUE of crop systems (%).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_fert</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.NUE_system">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.NUE_system">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">NUE_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates system-wide nitrogen use efficiency, including crop and livestock production.</span>

<span class="sd">        Accounts for feed losses and nitrogen consumed via imported feed.</span>

<span class="sd">        :return: System-wide NUE (%).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N_NP</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen For Feed (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Non Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">df_fert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_fert</span><span class="p">()</span>
        <span class="n">N_tot</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;Atmospheric deposition&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Consummed Nitrogen from imported feed (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">N_NP</span> <span class="o">/</span> <span class="n">N_tot</span> <span class="o">*</span> <span class="mi">100</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.NUE_system_2">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.NUE_system_2">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">NUE_system_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Alternative NUE computation considering livestock conversion factors and feed inputs.</span>

<span class="sd">        Includes non-edible nitrogen outputs and imported feed consumption in the calculation.</span>

<span class="sd">        :return: Adjusted system-wide NUE (%).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N_NP</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">+</span> <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Non Edible Nitrogen (ktN)&quot;</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Conversion factor (%)&quot;</span><span class="p">])</span>
            <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Consummed Nitrogen from imported feed (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">df_fert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_fert</span><span class="p">()</span>
        <span class="n">N_tot</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;Atmospheric deposition&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Consummed Nitrogen from imported feed (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">N_NP</span> <span class="o">/</span> <span class="n">N_tot</span> <span class="o">*</span> <span class="mi">100</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.N_self_sufficient">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.N_self_sufficient">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">N_self_sufficient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimates nitrogen self-sufficiency of the system.</span>

<span class="sd">        Defined as the share of atmospheric (biological) nitrogen inputs relative to all external nitrogen sources.</span>

<span class="sd">        :return: Self-sufficiency ratio (%).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_fert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_fert</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;Atmospheric deposition&quot;</span><span class="p">])</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="p">(</span>
                <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;Atmospheric deposition&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Consummed Nitrogen from imported feed (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.env_footprint">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.env_footprint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">env_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the land footprint (in ha) of nitrogen flows linked to:</span>
<span class="sd">        - local food and feed production,</span>
<span class="sd">        - imported food and feed,</span>
<span class="sd">        - imported and exported livestock nitrogen,</span>
<span class="sd">        - crop exports for feed and food.</span>

<span class="sd">        This is expressed as theoretical land areas mobilized by the nitrogen content.</span>

<span class="sd">        :return: A pandas Series of land footprint values (in ha), positive for imports and local use, negative for exports.</span>
<span class="sd">        :rtype: pandas.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">local_surface_food</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen For Food (ktN)&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">local_surface_feed</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen For Feed (ktN)&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Food import</span>
        <span class="c1"># 1. Filtrer les allocations &quot;Imported food&quot;</span>
        <span class="n">alloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Imported Food&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Culture&quot;</span><span class="p">,</span> <span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># 2. Grouper par culture au cas où il y aurait plusieurs lignes par culture</span>
        <span class="n">alloc_grouped</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Culture&quot;</span><span class="p">)[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># 3. Créer un DataFrame aligné avec les index de df_cultures</span>
        <span class="n">alloc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_grouped</span>
        <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># 4. Calcul final : ratio * surface</span>
        <span class="c1"># Récupère les valeurs de &#39;Nitrogen Production (ktN)&#39; et de &#39;Allocated Nitrogen&#39;</span>
        <span class="n">nitrogen_production</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
        <span class="n">allocated_nitrogen</span> <span class="o">=</span> <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span>

        <span class="c1"># Si &#39;Nitrogen Production (ktN)&#39; est nul, se rabattre sur les valeurs du blé</span>
        <span class="c1"># En supposant que &quot;Wheat&quot; soit dans l&#39;index de df_cultures, sinon adapte-le</span>
        <span class="n">wheat_nitrogen_production</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
        <span class="n">wheat_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>

        <span class="c1"># Remplacer les valeurs de &#39;Nitrogen Production (ktN)&#39; par celles du blé si elles sont nulles</span>
        <span class="n">adjusted_nitrogen_production</span> <span class="o">=</span> <span class="n">nitrogen_production</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">wheat_nitrogen_production</span><span class="p">)</span>

        <span class="c1"># Utiliser la superficie du blé lorsque la production d&#39;azote est nulle, sans modifier df_cultures</span>
        <span class="n">adjusted_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nitrogen_production</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wheat_area</span><span class="p">)</span>

        <span class="c1"># Calcul du total des importations alimentaires</span>
        <span class="n">total_food_import</span> <span class="o">=</span> <span class="p">(</span><span class="n">allocated_nitrogen</span> <span class="o">/</span> <span class="n">adjusted_nitrogen_production</span> <span class="o">*</span> <span class="n">adjusted_area</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Feed import</span>
        <span class="c1"># 1. Filtrer les allocations &quot;Imported food&quot;</span>
        <span class="n">alloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Imported Feed&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Culture&quot;</span><span class="p">,</span> <span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># 2. Grouper par culture au cas où il y aurait plusieurs lignes par culture</span>
        <span class="n">alloc_grouped</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Culture&quot;</span><span class="p">)[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># 3. Créer un DataFrame aligné avec les index de df_cultures</span>
        <span class="n">alloc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_grouped</span>
        <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># 4. Calcul final : ratio * surface</span>
        <span class="c1"># Récupère les valeurs de &#39;Nitrogen Production (ktN)&#39; et de &#39;Allocated Nitrogen&#39;</span>
        <span class="n">nitrogen_production</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
        <span class="n">allocated_nitrogen</span> <span class="o">=</span> <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span>

        <span class="c1"># Si &#39;Nitrogen Production (ktN)&#39; est nul, se rabattre sur les valeurs du blé</span>
        <span class="c1"># En supposant que &quot;Wheat&quot; soit dans l&#39;index de df_cultures, sinon adapte-le</span>
        <span class="n">wheat_nitrogen_production</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
        <span class="n">wheat_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>

        <span class="c1"># Remplacer les valeurs de &#39;Nitrogen Production (ktN)&#39; par celles du blé si elles sont nulles</span>
        <span class="n">adjusted_nitrogen_production</span> <span class="o">=</span> <span class="n">nitrogen_production</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">wheat_nitrogen_production</span><span class="p">)</span>

        <span class="c1"># Utiliser la superficie du blé lorsque la production d&#39;azote est nulle, sans modifier df_cultures</span>
        <span class="n">adjusted_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nitrogen_production</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wheat_area</span><span class="p">)</span>

        <span class="c1"># Calcul du total des importations alimentaires</span>
        <span class="n">total_feed_import</span> <span class="o">=</span> <span class="p">(</span><span class="n">allocated_nitrogen</span> <span class="o">/</span> <span class="n">adjusted_nitrogen_production</span> <span class="o">*</span> <span class="n">adjusted_area</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1">## Importation de viande</span>
        <span class="c1"># 1. Sélectionner les animaux importés</span>
        <span class="n">elevage_importe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># 2. Pourcentage importé = |export net négatif| / production totale</span>
        <span class="n">elevage_importe</span><span class="p">[</span><span class="s2">&quot;fraction_importée&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">elevage_importe</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">elevage_importe</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># 3. Créer un DataFrame vide pour accumuler les contributions par culture</span>
        <span class="n">surface_par_culture</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># 4. Parcourir chaque type d&#39;élevage importé</span>
        <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">elevage_importe</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">animal</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="s2">&quot;Consumer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Si l&#39;animal n&#39;est pas dans les allocations, on passe</span>

            <span class="c1"># a. Calculer la part importée de l&#39;azote pour cet élevage</span>
            <span class="n">part_importee</span> <span class="o">=</span> <span class="n">elevage_importe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">animal</span><span class="p">,</span> <span class="s2">&quot;fraction_importée&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">elevage_importe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">elevage_importe</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">animal</span><span class="p">,</span> <span class="s2">&quot;fraction_importée&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                <span class="c1"># Calculer l&#39;azote végétal nécessaire (N_feed=Azote importé/0.12)</span>
                <span class="n">N_animal_imported</span> <span class="o">=</span> <span class="o">-</span><span class="n">elevage_importe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">animal</span><span class="p">,</span> <span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span>
                <span class="n">N_feed_total_required</span> <span class="o">=</span> <span class="n">N_animal_imported</span> <span class="o">/</span> <span class="mf">0.12</span>
                <span class="c1"># Aller chercher dans régimes[animal] les cultures consommées et en quelles proportion</span>
                <span class="c1"># Dans chaque catégories, prendre la première culture avec un rendement non nul ou nan de la liste (df_cultures[&quot;Nitrogen Production (ktN)&quot;]/df_culture[&quot;Area (ha)&quot;])</span>
                <span class="c1"># En déduire la surface théoriquement utilisée pour le nourrir (surface_par_culture[culture] = N_feed/rendement)</span>
                <span class="c1"># Si aucune culture de la catégorie n&#39;a de rendement, passer cette catégorie</span>

                <span class="c1"># Parcourir les catégories du régime de l&#39;animal</span>
                <span class="k">for</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">culture_list</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">animal</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">N_feed_for_category</span> <span class="o">=</span> <span class="n">N_feed_total_required</span> <span class="o">*</span> <span class="n">proportion</span>

                    <span class="c1"># Chercher la *première* culture valide dans la liste de la catégorie</span>
                    <span class="k">for</span> <span class="n">culture_name</span> <span class="ow">in</span> <span class="n">culture_list</span><span class="p">:</span>
                        <span class="c1"># Vérifier si la culture existe dans df_cultures</span>
                        <span class="k">if</span> <span class="n">culture_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                            <span class="n">prod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture_name</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
                            <span class="n">surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture_name</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>

                            <span class="c1"># Calculer le rendement si possible (surface &gt; 0 et prod &gt; 0)</span>
                            <span class="k">if</span> <span class="n">surface</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">prod</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">rendement</span> <span class="o">=</span> <span class="n">prod</span> <span class="o">/</span> <span class="n">surface</span>
                                <span class="c1"># Calculer la surface nécessaire pour cette catégorie via cette culture</span>
                                <span class="n">surface_needed</span> <span class="o">=</span> <span class="n">N_feed_for_category</span> <span class="o">/</span> <span class="n">rendement</span>
                                <span class="c1"># Ajouter à la surface totale pour cette culture</span>
                                <span class="n">surface_par_culture</span><span class="p">[</span><span class="n">culture_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">surface_par_culture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">culture_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">surface_needed</span>
                                <span class="p">)</span>
                                <span class="k">break</span>  <span class="c1"># On a trouvé la première culture valide, on passe à la catégorie suivante du régime</span>
                            <span class="c1"># else: rendement invalide (0 ou NaN), on essaie la culture suivante dans la liste</span>
                        <span class="c1"># else: la culture n&#39;est pas dans df_cultures, on essaie la suivante dans la liste</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># b. Extraire les allocations d&#39;azote de chaque culture pour cet élevage</span>
                <span class="n">aliments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="s2">&quot;Consumer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">aliments</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">culture</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Culture&quot;</span><span class="p">]</span>
                    <span class="n">azote</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">part_importee</span>  <span class="c1"># Quantité d&#39;azote importée pour cette culture</span>

                    <span class="k">if</span> <span class="n">culture</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="n">culture</span> <span class="o">=</span> <span class="s2">&quot;Wheat&quot;</span>  <span class="c1"># Si la culture n&#39;est pas dans df_cultures, on remplace par du blé</span>

                    <span class="c1"># c. Récupérer la production d&#39;azote et la surface de la culture</span>
                    <span class="n">prod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
                    <span class="n">surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
                    <span class="c1"># if prod == 0:</span>
                    <span class="c1">#     culture = &quot;Wheat&quot;</span>
                    <span class="c1">#     prod = self.df_cultures.loc[culture, &quot;Nitrogen Production (ktN)&quot;]</span>
                    <span class="c1">#     surface = self.df_cultures.loc[culture, &quot;Area (ha)&quot;]</span>
                    <span class="c1"># d. Calculer la surface nécessaire pour produire l&#39;azote consommé</span>
                    <span class="k">if</span> <span class="n">prod</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">surface_equivalente</span> <span class="o">=</span> <span class="n">azote</span> <span class="o">/</span> <span class="n">prod</span> <span class="o">*</span> <span class="n">surface</span>
                        <span class="n">surface_par_culture</span><span class="p">[</span><span class="n">culture</span><span class="p">]</span> <span class="o">+=</span> <span class="n">surface_equivalente</span>
        <span class="n">import_animal</span> <span class="o">=</span> <span class="n">surface_par_culture</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1">## Export animaux</span>
        <span class="c1"># 1. Sélectionner les animaux exportés (ceux qui ont un exportation nette positive)</span>
        <span class="n">elevage_exporte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># 2. Calculer la fraction exportée pour chaque animal (en proportion de la production totale)</span>
        <span class="n">elevage_exporte</span><span class="p">[</span><span class="s2">&quot;fraction_exportée&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">elevage_exporte</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">elevage_exporte</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># 3. Créer un dictionnaire pour accumuler les résultats par culture</span>
        <span class="n">surface_par_culture_exporte</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="n">culture</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">})</span>

        <span class="c1"># 4. Parcourir chaque type d&#39;élevage exporté</span>
        <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">elevage_exporte</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">animal</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="s2">&quot;Consumer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Si l&#39;animal n&#39;est pas dans les allocations, on passe</span>

            <span class="c1"># a. Calculer la part exportée de l&#39;azote pour cet élevage</span>
            <span class="n">part_exportee</span> <span class="o">=</span> <span class="n">elevage_exporte</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">animal</span><span class="p">,</span> <span class="s2">&quot;fraction_exportée&quot;</span><span class="p">]</span>

            <span class="c1"># b. Extraire les allocations d&#39;azote de chaque culture pour cet élevage</span>
            <span class="n">aliments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="s2">&quot;Consumer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">aliments</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">culture</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Culture&quot;</span><span class="p">]</span>
                <span class="n">azote</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">part_exportee</span>  <span class="c1"># Quantité d&#39;azote exportée pour cette culture</span>

                <span class="k">if</span> <span class="n">culture</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">culture</span> <span class="o">=</span> <span class="s2">&quot;Wheat&quot;</span>  <span class="c1"># Si la culture n&#39;est pas dans df_cultures, on remplace par du blé</span>

                <span class="c1"># c. Récupérer la production d&#39;azote et la surface de la culture</span>
                <span class="n">prod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
                <span class="n">surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>

                <span class="c1"># d. Calculer la surface nécessaire pour produire l&#39;azote consommé</span>
                <span class="k">if</span> <span class="n">prod</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">surface_equivalente</span> <span class="o">=</span> <span class="n">azote</span> <span class="o">/</span> <span class="n">prod</span> <span class="o">*</span> <span class="n">surface</span>
                    <span class="n">surface_par_culture_exporte</span><span class="p">[</span><span class="n">culture</span><span class="p">]</span> <span class="o">+=</span> <span class="n">surface_equivalente</span>
        <span class="n">export_animal</span> <span class="o">=</span> <span class="n">surface_par_culture_exporte</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Export culture</span>
        <span class="c1"># Feed</span>
        <span class="n">export_surface_feed</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Exported For Feed (ktN)&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1"># Food</span>
        <span class="n">export_surface_food</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Available Nitrogen After Feed, Export Feed and Food (ktN)&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Local Food&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">local_surface_food</span><span class="p">),</span>
                <span class="s2">&quot;Local Feed&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">local_surface_feed</span><span class="p">),</span>
                <span class="s2">&quot;Import Food&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_food_import</span><span class="p">),</span>
                <span class="s2">&quot;Import Feed&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_feed_import</span><span class="p">),</span>
                <span class="s2">&quot;Import Livestock&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">import_animal</span><span class="p">),</span>
                <span class="s2">&quot;Export Livestock&quot;</span><span class="p">:</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">export_animal</span><span class="p">),</span>
                <span class="s2">&quot;Export Feed&quot;</span><span class="p">:</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">export_surface_feed</span><span class="p">),</span>
                <span class="s2">&quot;Export Food&quot;</span><span class="p">:</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">export_surface_food</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.net_footprint">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.net_footprint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the net nitrogen land footprint of the region (in Mha).</span>

<span class="sd">        Aggregates all imports and exports to yield a net balance of nitrogen-dependent land use.</span>

<span class="sd">        :return: Net land footprint (in million hectares).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_footprint</span><span class="p">()</span>
        <span class="n">df_total_import</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;Import Food&quot;</span><span class="p">,</span> <span class="s2">&quot;Import Feed&quot;</span><span class="p">,</span> <span class="s2">&quot;Import Livestock&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df_total_export</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;Export Food&quot;</span><span class="p">,</span> <span class="s2">&quot;Export Feed&quot;</span><span class="p">,</span> <span class="s2">&quot;Export Livestock&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">net_import_export</span> <span class="o">=</span> <span class="n">df_total_import</span> <span class="o">+</span> <span class="n">df_total_export</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">net_import_export</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.LU_density">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.LU_density">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">LU_density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the livestock unit density over the agricultural area.</span>

<span class="sd">        :return: Livestock unit per hectare (LU/ha).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;LU&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.NH3_vol">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.NH3_vol">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">NH3_vol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the total NH₃ volatilization in the system.</span>

<span class="sd">        :return: NH₃ emissions in kt.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">emissions</span><span class="p">()[</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="NitrogenFlowModel_prospect.N2O_em">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.prospective.NitrogenFlowModel_prospect.N2O_em">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">N2O_em</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the total N₂O emissions in the system.</span>

<span class="sd">        :return: N₂O emissions in kt.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">emissions</span><span class="p">()[</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">]</span></div>
</div>

</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025, Adrien Fauste-Gay.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>