
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>grafs_e.N_class &#8212; GRAFS-E 01/02/25 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=390ba95b"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/grafs_e/N_class';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">GRAFS-E 01/02/25 documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    
    <li class="breadcrumb-item"><a href="../grafs_e.html" class="nav-link">grafs_e</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">grafs_e.N_class</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for grafs_e.N_class</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogNorm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pulp</span><span class="w"> </span><span class="kn">import</span> <span class="n">LpContinuous</span><span class="p">,</span> <span class="n">LpMinimize</span><span class="p">,</span> <span class="n">LpProblem</span><span class="p">,</span> <span class="n">LpVariable</span><span class="p">,</span> <span class="n">lpSum</span>

<span class="c1"># Afficher toutes les colonnes</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_columns&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># Afficher toutes les lignes</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;display.max_rows&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s2">&quot;future.no_silent_downcasting&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">grafs_e.graphes_objet</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grafs_e.donnees</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="DataLoader">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.DataLoader">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DataLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load the GRAFS Excel file (written by Julia Le Noë).</span>

<span class="sd">    This class makes it possible to access all the data stored in the Excel file.</span>
<span class="sd">    Currently, only yearly data (area, production, etc.) are accessed.</span>
<span class="sd">    Stable data is stored in the &#39;GRAFS_data.xlsx&#39; file.</span>

<span class="sd">    This class will become obsolete once a proper database is built.</span>

<span class="sd">    No arguments are required; the script automatically finds the Excel sheet.</span>
<span class="sd">    Loading time: approximately 40 seconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># , year, region):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sheets_dict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;data/full_grafs.xlsx&quot;</span><span class="p">),</span> <span class="n">sheet_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="DataLoader.pre_process_df">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.DataLoader.pre_process_df">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">pre_process_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select the data sheet for a specific year and region.</span>

<span class="sd">        Args:</span>
<span class="sd">            year (str): The year for which to select the data.</span>
<span class="sd">            region (str): The region for which to select the data. Not used (deprecated). To access ta data of a specific region, use df[[&quot;nom&quot;, region]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheets_dict</span><span class="p">[</span><span class="s2">&quot;pvar&quot;</span> <span class="o">+</span> <span class="n">year</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Primary data, parameters, pre-treatments &quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;nom&quot;</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="DataLoader.get_import_feed">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.DataLoader.get_import_feed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_import_feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select in the GRAFS excel the nitrogen import feed.</span>
<span class="sd">        Args:</span>
<span class="sd">            year (str): The year for which to select the data.</span>
<span class="sd">            region (str): The region for which to select the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sheets_dict</span><span class="p">[</span><span class="s2">&quot;GRAFS&quot;</span> <span class="o">+</span> <span class="n">year</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">correct_region</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Pyrénées occid&quot;</span><span class="p">:</span> <span class="s2">&quot;Pyrénées occidentales&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Pyrénées Orient&quot;</span><span class="p">:</span> <span class="s2">&quot;Pyrénées Orientales&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">correct_region</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">correct_region</span><span class="p">[</span><span class="n">region</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="CultureData">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.CultureData">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CultureData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class processes and creates a dataframe with crop data for a specific year and region.</span>

<span class="sd">    The class uses the provided DataLoader instance to load and preprocess the data. It extracts relevant crop-related</span>
<span class="sd">    information such as surface area, crop production, nitrogen production, and fertilization needs, and combines them into</span>
<span class="sd">    a comprehensive dataframe.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_loader (DataLoader): An instance of the DataLoader class used to load and preprocess the data.</span>
<span class="sd">        region (str): The region for which to create the crop dataframe.</span>
<span class="sd">        year (str): The year for which to create the crop dataframe.</span>
<span class="sd">        categories_mapping (dict): A dictionary used to classify each crop, mapping crop names to categories.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        region (str): The region for which the crop data is processed.</span>
<span class="sd">        year (str): The year for which the crop data is processed.</span>
<span class="sd">        df (pandas.DataFrame): A dataframe containing the preprocessed data for the specified year and region.</span>
<span class="sd">        data_path (str): The path to the directory containing the data files.</span>
<span class="sd">        categories_mapping (dict): A dictionary mapping crop names to their respective categories.</span>
<span class="sd">        df_cultures (pandas.DataFrame): The final dataframe containing the processed crop data, including surface area,</span>
<span class="sd">                                        crop production, nitrogen production, yield, and fertilization needs.</span>

<span class="sd">    Methods:</span>
<span class="sd">        create_culture_dataframe():</span>
<span class="sd">            Processes the raw data to create the crop dataframe. This dataframe includes:</span>
<span class="sd">            - Crop surface area (in hectares).</span>
<span class="sd">            - Crop production (in kton DFW).</span>
<span class="sd">            - Nitrogen production (in kton N).</span>
<span class="sd">            - Yield per hectare (in qtl/ha).</span>
<span class="sd">            - Fertilization needs per hectare (in kgN/ha).</span>
<span class="sd">            The method performs various data transformations and calculations, including filling missing values with zero.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">categories_mapping</span><span class="o">=</span><span class="n">categories_mapping</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the CultureData class by preprocessing the data for the given year, region, and categories.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_loader (DataLoader): An instance of the DataLoader class used to load and preprocess the data.</span>
<span class="sd">            year (str): The year for which to create the crop dataframe.</span>
<span class="sd">            region (str): The region for which to create the crop dataframe.</span>
<span class="sd">            categories_mapping (dict): A dictionary used to classify each crop, mapping crop names to categories.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">pre_process_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">data_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">categories_mapping</span> <span class="o">=</span> <span class="n">categories_mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_culture_dataframe</span><span class="p">()</span>

<div class="viewcode-block" id="CultureData.create_culture_dataframe">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.CultureData.create_culture_dataframe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_culture_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Processes the raw data to create the crop dataframe.</span>

<span class="sd">        The dataframe includes:</span>
<span class="sd">        - Crop surface area (in hectares).</span>
<span class="sd">        - Crop production (in kton DFW).</span>
<span class="sd">        - Nitrogen production (in kton N).</span>
<span class="sd">        - Yield per hectare (in qtl/ha).</span>
<span class="sd">        - Fertilization needs per hectare (in kgN/ha).</span>

<span class="sd">        This method performs the following steps:</span>
<span class="sd">        - Extracts crop surface and production data from the main dataframe.</span>
<span class="sd">        - Reads additional crop-specific data (fertilization and nitrogen content) from an external Excel file.</span>
<span class="sd">        - Calculates the nitrogen production and yield based on crop production and surface area.</span>
<span class="sd">        - Computes fertilization needs per hectare based on crop yield.</span>
<span class="sd">        - Fills missing values with zero.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: A dataframe containing the processed crop data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span>
        <span class="n">data_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span>

        <span class="c1"># Extraire les données de surface</span>
        <span class="n">surface_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">259</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">294</span><span class="p">)][[</span><span class="s2">&quot;nom&quot;</span><span class="p">,</span> <span class="n">region</span><span class="p">]]</span>
        <span class="n">surface_dict</span> <span class="o">=</span> <span class="n">surface_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;nom&quot;</span><span class="p">)[</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">surface_dict</span><span class="p">[</span><span class="s2">&quot;Rice&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">surface_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;rice&quot;</span><span class="p">)</span>
        <span class="n">surface_dict</span><span class="p">[</span><span class="s2">&quot;Forage cabbages&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">surface_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;Forage cabbages &amp; roots&quot;</span><span class="p">)</span>

        <span class="c1"># Extraire les données de production végétale</span>
        <span class="n">vege_prod_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">183</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">218</span><span class="p">)][[</span><span class="s2">&quot;nom&quot;</span><span class="p">,</span> <span class="n">region</span><span class="p">]]</span>
        <span class="n">vege_prod_dict</span> <span class="o">=</span> <span class="n">vege_prod_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;nom&quot;</span><span class="p">)[</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># Extraire les taux de surface avec épendage</span>
        <span class="n">epend</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;GRAFS_data.xlsx&quot;</span><span class="p">),</span>
            <span class="n">sheet_name</span><span class="o">=</span><span class="s2">&quot;crops&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">epend</span> <span class="o">=</span> <span class="n">epend</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;Note&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">epend</span> <span class="o">=</span> <span class="n">epend</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Culture&quot;</span><span class="p">)</span>
        <span class="n">epend</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">surface_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">])</span>
        <span class="n">epend</span><span class="p">[</span><span class="s2">&quot;Crop Production (ktonDFW)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
            <span class="n">vege_prod_dict</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Crop Production (ktonDFW)&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># Calcul de l&#39;azote disponible pour les cultures</span>
        <span class="n">epend</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epend</span><span class="p">[</span><span class="s2">&quot;Crop Production (ktonDFW)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">epend</span><span class="p">[</span><span class="s2">&quot;Nitrogen Content (%)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">epend</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="n">epend</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;Yield (qtl/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">epend</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;Crop Production (ktonDFW)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e4</span> <span class="o">/</span> <span class="n">epend</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">epend</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;Yield (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">epend</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">epend</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>
        <span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">epend</span><span class="p">[</span><span class="s2">&quot;Fertilization Need (kgN/qtl)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">epend</span><span class="p">[</span><span class="s2">&quot;Surface Fertilization Need (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">epend</span><span class="p">[</span><span class="s2">&quot;Surface Fertilization Need (kgN/ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="s2">&quot;float64&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">epend</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;Surface Fertilization Need (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">epend</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;Fertilization Need (kgN/qtl)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">epend</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="s2">&quot;Yield (qtl/ha)&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">epend</span> <span class="o">=</span> <span class="n">epend</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">epend</span></div>
</div>



<div class="viewcode-block" id="ElevageData">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.ElevageData">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ElevageData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class processes and creates a dataframe containing livestock data for a specific year and region.</span>

<span class="sd">    The class uses data from the provided DataLoader instance, filters and processes it to generate</span>
<span class="sd">    a dataframe containing livestock production and emissions data.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_loader (DataLoader): An instance of the DataLoader class used to load and preprocess the data.</span>
<span class="sd">        year (str): The year for which to generate the livestock dataframe.</span>
<span class="sd">        region (str): The region for which to generate the livestock dataframe.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        region (str): The region for which the livestock data is processed.</span>
<span class="sd">        year (str): The year for which the livestock data is processed.</span>
<span class="sd">        df (pandas.DataFrame): A dataframe containing the preprocessed data for the specified year and region.</span>
<span class="sd">        data_path (str): The path to the directory containing the data files.</span>
<span class="sd">        dataloader (DataLoader): The instance of the DataLoader used to load the data.</span>
<span class="sd">        df_elevage (pandas.DataFrame): The final dataframe containing livestock production and emissions data.</span>

<span class="sd">    Methods:</span>
<span class="sd">        create_elevage_dataframe():</span>
<span class="sd">            Processes the pre-loaded data to create the livestock dataframe, which includes both production data</span>
<span class="sd">            and associated emission data. The production data is filtered and matched with gas emission data</span>
<span class="sd">            for the specified region, and missing values are filled with zero.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_loader</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the ElevageData class by preprocessing the data for the given year and region.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_loader (DataLoader): An instance of the DataLoader class used to load and preprocess the data.</span>
<span class="sd">            year (str): The year for which to generate the livestock dataframe.</span>
<span class="sd">            region (str): The region for which to generate the livestock dataframe.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">pre_process_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">data_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataloader</span> <span class="o">=</span> <span class="n">data_loader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_elevage_dataframe</span><span class="p">()</span>

<div class="viewcode-block" id="ElevageData.create_elevage_dataframe">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.ElevageData.create_elevage_dataframe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_elevage_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Processes the raw data to create the livestock dataframe.</span>

<span class="sd">        The dataframe includes the following:</span>
<span class="sd">        - Livestock production data (in kton carcass) for the specified region.</span>
<span class="sd">        - Gas emissions data related to livestock (volatilisation) linked by the &#39;Elevage&#39; index.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pandas.DataFrame: A dataframe containing the processed livestock production data and gas emissions data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span>
        <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span>
        <span class="n">data_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_path</span>

        <span class="c1"># Production animale, attention, contrairement au reste, ici on est en kton carcasse</span>
        <span class="n">production_data</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1017</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1022</span><span class="p">)][[</span><span class="s2">&quot;nom&quot;</span><span class="p">,</span> <span class="n">region</span><span class="p">]]</span>
        <span class="n">production_dict</span> <span class="o">=</span> <span class="n">production_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;nom&quot;</span><span class="p">)[</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">gas_em</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s2">&quot;GRAFS_data.xlsx&quot;</span><span class="p">),</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s2">&quot;Volatilisation&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
            <span class="s2">&quot;Elevage&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Construction du dictionnaire combined_data</span>
        <span class="n">combined_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Production&quot;</span><span class="p">:</span> <span class="n">production_dict</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">combined_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span>

        <span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gas_em</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

        <span class="n">combined_df</span> <span class="o">=</span> <span class="n">combined_df</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">combined_df</span></div>
</div>



<div class="viewcode-block" id="FluxGenerator">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.FluxGenerator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FluxGenerator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class generates and manages the transition matrix of fluxes between various sectors (e.g., agriculture, livestock, industry, trade).</span>

<span class="sd">    The transition matrix is used to model the flow of resources or interactions between sectors, where each entry in the matrix represents the relationship or flow between a source sector and a target sector.</span>

<span class="sd">    Args:</span>
<span class="sd">        labels (list): A list of labels representing the sectors (e.g., [&#39;agriculture&#39;, &#39;livestock&#39;, &#39;industry&#39;, &#39;trade&#39;]) in the model. These labels are used to index the transition matrix and identify the sectors in the flux calculations.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        labels (list): The list of labels (sectors) that are used to define the transition matrix.</span>
<span class="sd">        label_to_index (dict): A dictionary mapping each label (sector) to its corresponding index in the adjacency matrix.</span>
<span class="sd">        n (int): The number of sectors (i.e., the length of the labels list).</span>
<span class="sd">        adjacency_matrix (numpy.ndarray): A square matrix of size n x n representing the fluxes between sectors. Each element in the matrix holds the transition coefficient between a source and a target sector.</span>

<span class="sd">    Methods:</span>
<span class="sd">        generate_flux(source, target):</span>
<span class="sd">            Generates and updates the transition matrix by calculating flux coefficients between the source and target sectors. The coefficients are based on the provided `source` and `target` dictionaries.</span>

<span class="sd">        get_coef(source_label, target_label):</span>
<span class="sd">            Retrieves the transition coefficient for the flux between two sectors (identified by their labels) from the transition matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the FluxGenerator with a list of sector labels.</span>

<span class="sd">        Args:</span>
<span class="sd">            labels (list): List of labels representing sectors in the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_to_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">))</span>

<div class="viewcode-block" id="FluxGenerator.generate_flux">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.FluxGenerator.generate_flux">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generates and updates the transition matrix by calculating the flux coefficients between the source and target sectors.</span>

<span class="sd">        Args:</span>
<span class="sd">            source (dict): A dictionary representing the source sector, where keys are sector labels and values are the corresponding flux values.</span>
<span class="sd">            target (dict): A dictionary representing the target sector, where keys are sector labels and values are the corresponding flux values.</span>

<span class="sd">        This method updates the adjacency matrix by computing the flux between all pairs of source and target sectors.</span>
<span class="sd">        A flux coefficient is calculated as the product of the corresponding values from the `source` and `target` dictionaries.</span>
<span class="sd">        If the coefficient exceeds a small threshold (10^-7), it is added to the matrix at the corresponding position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">source_label</span><span class="p">,</span> <span class="n">source_value</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">source_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_to_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_label</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">target_label</span><span class="p">,</span> <span class="n">target_value</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">coefficient</span> <span class="o">=</span> <span class="n">source_value</span> <span class="o">*</span> <span class="n">target_value</span>
                <span class="n">target_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_to_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target_label</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">target_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">coefficient</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">7</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span><span class="n">source_index</span><span class="p">,</span> <span class="n">target_index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">coefficient</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_label</span><span class="si">}</span><span class="s2"> not found in label_to_index&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FluxGenerator.get_coef">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.FluxGenerator.get_coef">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_coef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_label</span><span class="p">,</span> <span class="n">target_label</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieves the transition coefficient between two sectors from the adjacency matrix.</span>

<span class="sd">        Args:</span>
<span class="sd">            source_label (str): The label of the source sector.</span>
<span class="sd">            target_label (str): The label of the target sector.</span>

<span class="sd">        Returns:</span>
<span class="sd">            float or None: The transition coefficient between the source and target sectors. Returns None if either sector is not found in the matrix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_to_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source_label</span><span class="p">)</span>
        <span class="n">target_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_to_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target_label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">source_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">target_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span><span class="n">source_index</span><span class="p">][</span><span class="n">target_index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>
</div>



<div class="viewcode-block" id="NitrogenFlowModel">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">NitrogenFlowModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class models the nitrogen flow in an agricultural system, calculating fluxes and nitrogen dynamics</span>
<span class="sd">    for different sectors (e.g., crops, livestock) over a given year and region.</span>

<span class="sd">    The model incorporates various processes, including crop production, animal production, nitrogen emissions,</span>
<span class="sd">    and fertilization, and computes the corresponding nitrogen fluxes between sectors using transition matrices.</span>

<span class="sd">    This class provides methods to compute fluxes, generate heatmaps, and access matrices such as the transition matrix,</span>
<span class="sd">    core matrix, and adjacency matrix.</span>

<span class="sd">    For a detailed explanation of the model&#39;s methodology and mathematical foundations, please refer to the associated</span>
<span class="sd">    scientific paper: Tracking Nitrogen Dynamics: A Disaggregated Approach for French Agro-Food Systems, 2025, Adrien Fauste-Gay (pre-print).</span>

<span class="sd">    Args:</span>
<span class="sd">        data (DataLoader): An instance of the DataLoader class to load and preprocess the data.</span>
<span class="sd">        year (str): The year for which to compute the nitrogen flow model.</span>
<span class="sd">        region (str): The region for which to compute the nitrogen flow model.</span>
<span class="sd">        categories_mapping (dict, optional): A dictionary used to classify each crop. Defaults to categories_mapping.</span>
<span class="sd">        labels (list, optional): A list of labels representing the sectors in the model. Defaults to labels.</span>
<span class="sd">        cultures (CultureData, optional): An instance of the CultureData class for crop data processing.</span>
<span class="sd">        legumineuses (list, optional): A list representing leguminous crops in the model.</span>
<span class="sd">        prairies (list, optional): A list representing grasslands and prairies in the model.</span>
<span class="sd">        betail (list, optional): A list representing livestock categories in the model.</span>
<span class="sd">        Pop (list, optional): A list representing the population data.</span>
<span class="sd">        ext (list, optional): A list representing external data or processes affecting nitrogen fluxes.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        year (str): The year for which the nitrogen flow model is computed.</span>
<span class="sd">        region (str): The region for which the nitrogen flow model is computed.</span>
<span class="sd">        categories_mapping (dict): The dictionary used to classify crops.</span>
<span class="sd">        labels (list): The list of labels representing the sectors in the model.</span>
<span class="sd">        data_loader (DataLoader): The instance of the DataLoader used to load the data.</span>
<span class="sd">        culture_data (CultureData): An instance of the CultureData class for crop data.</span>
<span class="sd">        elevage_data (ElevageData): An instance of the ElevageData class for livestock data.</span>
<span class="sd">        flux_generator (FluxGenerator): An instance of the FluxGenerator class to generate flux coefficients.</span>
<span class="sd">        df_cultures (pandas.DataFrame): The dataframe containing crop data.</span>
<span class="sd">        df_elevage (pandas.DataFrame): The dataframe containing livestock data.</span>
<span class="sd">        adjacency_matrix (numpy.ndarray): The matrix representing nitrogen fluxes between sectors.</span>
<span class="sd">        label_to_index (dict): A dictionary mapping sector labels to matrix indices.</span>

<span class="sd">    Methods:</span>
<span class="sd">        compute_fluxes():</span>
<span class="sd">            Computes the nitrogen fluxes between the sectors of the model. This method populates the adjacency matrix</span>
<span class="sd">            with flux coefficients based on the interactions between crops, livestock, emissions, and fertilization.</span>

<span class="sd">        plot_heatmap():</span>
<span class="sd">            Generates a heatmap visualization of the transition matrix for nitrogen fluxes.</span>

<span class="sd">        plot_heatmap_interactive():</span>
<span class="sd">            Generates an interactive heatmap for the nitrogen fluxes.</span>

<span class="sd">        get_df_culture():</span>
<span class="sd">            Returns the dataframe containing crop data.</span>

<span class="sd">        get_df_elevage():</span>
<span class="sd">            Returns the dataframe containing livestock data.</span>

<span class="sd">        get_transition_matrix():</span>
<span class="sd">            Returns the transition matrix representing nitrogen fluxes between sectors.</span>

<span class="sd">        get_core_matrix():</span>
<span class="sd">            Returns the core matrix representing the primary fluxes in the system.</span>

<span class="sd">        get_adjacency_matrix():</span>
<span class="sd">            Returns the adjacency matrix, which is used to represent the complete set of nitrogen fluxes between sectors.</span>

<span class="sd">        extract_input_output_matrixs():</span>
<span class="sd">            Extracts and returns the input-output matrices of nitrogen fluxes.</span>

<span class="sd">        imported_nitrogen():</span>
<span class="sd">            Returns the total amount of imported nitrogen in the system.</span>

<span class="sd">        net_imported_plant():</span>
<span class="sd">            Returns the net imported nitrogen for plants.</span>

<span class="sd">        net_imported_animal():</span>
<span class="sd">            Returns the net imported nitrogen for livestock.</span>

<span class="sd">        total_plant_production():</span>
<span class="sd">            Returns the total plant production in the model.</span>

<span class="sd">        stacked_plant_production():</span>
<span class="sd">            Returns a stacked representation of plant production data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">year</span><span class="p">,</span>
        <span class="n">region</span><span class="p">,</span>
        <span class="n">categories_mapping</span><span class="o">=</span><span class="n">categories_mapping</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">cultures</span><span class="o">=</span><span class="n">cultures</span><span class="p">,</span>
        <span class="n">legumineuses</span><span class="o">=</span><span class="n">legumineuses</span><span class="p">,</span>
        <span class="n">prairies</span><span class="o">=</span><span class="n">prairies</span><span class="p">,</span>
        <span class="n">betail</span><span class="o">=</span><span class="n">betail</span><span class="p">,</span>
        <span class="n">Pop</span><span class="o">=</span><span class="n">Pop</span><span class="p">,</span>
        <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the NitrogenFlowModel class with the necessary data and model parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (DataLoader): An instance of the DataLoader class to load and preprocess the data.</span>
<span class="sd">            year (str): The year for which to compute the nitrogen flow model.</span>
<span class="sd">            region (str): The region for which to compute the nitrogen flow model.</span>
<span class="sd">            categories_mapping (dict, optional): A dictionary used to classify each crop. Defaults to categories_mapping.</span>
<span class="sd">            labels (list, optional): A list of labels representing the sectors in the model. Defaults to labels.</span>
<span class="sd">            cultures (CultureData, optional): An instance of the CultureData class for crop data processing.</span>
<span class="sd">            legumineuses (list, optional): A list representing leguminous crops in the model.</span>
<span class="sd">            prairies (list, optional): A list representing grasslands and prairies in the model.</span>
<span class="sd">            betail (list, optional): A list representing livestock categories in the model.</span>
<span class="sd">            Pop (list, optional): A list representing the population data.</span>
<span class="sd">            ext (list, optional): A list representing external data or processes affecting nitrogen fluxes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">categories_mapping</span> <span class="o">=</span> <span class="n">categories_mapping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cultures</span> <span class="o">=</span> <span class="n">cultures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">legumineuses</span> <span class="o">=</span> <span class="n">legumineuses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prairies</span> <span class="o">=</span> <span class="n">prairies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">betail</span> <span class="o">=</span> <span class="n">betail</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Pop</span> <span class="o">=</span> <span class="n">Pop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_loader</span> <span class="o">=</span> <span class="n">data</span>  <span class="c1"># DataLoader(year, region)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">culture_data</span> <span class="o">=</span> <span class="n">CultureData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">categories_mapping</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevage_data</span> <span class="o">=</span> <span class="n">ElevageData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux_generator</span> <span class="o">=</span> <span class="n">FluxGenerator</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">culture_data</span><span class="o">.</span><span class="n">df_cultures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elevage_data</span><span class="o">.</span><span class="n">df_elevage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_generator</span><span class="o">.</span><span class="n">adjacency_matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_to_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_generator</span><span class="o">.</span><span class="n">label_to_index</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compute_fluxes</span><span class="p">()</span>

<div class="viewcode-block" id="NitrogenFlowModel.plot_heatmap">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.plot_heatmap">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_heatmap</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a static heatmap to visualize the nitrogen flux transition matrix.</span>

<span class="sd">        The heatmap displays the nitrogen fluxes between sectors using a logarithmic color scale. It provides a visual representation</span>
<span class="sd">        of the relative magnitudes of nitrogen fluxes, where each cell in the matrix corresponds to a transition from one sector</span>
<span class="sd">        (source) to another (target).</span>

<span class="sd">        Features of the heatmap:</span>
<span class="sd">        - **Logarithmic scale** for better visualization of fluxes with wide value ranges (`LogNorm` is used with `vmin=10^-4` and `vmax` set to the maximum value in the adjacency matrix).</span>
<span class="sd">        - **Color palette** is reversed &quot;plasma&quot; (`plasma_r`), with the color bar indicating flux magnitudes in kton/year.</span>
<span class="sd">        - **Grid**: A light gray grid is added for visual separation of cells.</span>
<span class="sd">        - **Labels**: Axis labels are moved to the top of the heatmap, with tick labels rotated for better readability.</span>
<span class="sd">        - **Legend**: Each sector is labeled with its corresponding index (e.g., &quot;1: Agriculture&quot;), positioned next to the heatmap.</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            None: Displays the heatmap plot on screen.</span>

<span class="sd">        Note:</span>
<span class="sd">            This method uses `matplotlib` and `seaborn` for visualization. Make sure these libraries are installed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="c1"># Créer la heatmap sans grille pour le moment</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">10</span><span class="o">**-</span><span class="mi">4</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">,</span>
            <span class="n">xticklabels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">yticklabels</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma_r&quot;</span><span class="p">,</span>
            <span class="n">annot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
            <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;ktN/year&quot;</span><span class="p">,</span> <span class="s2">&quot;orientation&quot;</span><span class="p">:</span> <span class="s2">&quot;horizontal&quot;</span><span class="p">,</span> <span class="s2">&quot;pad&quot;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Ajouter la grille en gris clair</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgray&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># Déplacer les labels de l&#39;axe x en haut</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>  <span class="c1"># Placer les ticks en haut</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>  <span class="c1"># Placer le label en haut</span>

        <span class="c1"># Rotation des labels de l&#39;axe x</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="c1"># Assurer que les axes sont égaux</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">)</span>
        <span class="c1"># Ajouter des labels et un titre</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Target&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Source&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="c1"># plt.title(f&#39;Heatmap of adjacency matrix for {region} in {year}&#39;)</span>

        <span class="n">legend_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mf">1.05</span><span class="p">,</span>
                <span class="mi">1</span> <span class="o">-</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">),</span>
                <span class="n">label</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">linespacing</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
            <span class="p">)</span>  <span class="c1"># Augmenter l&#39;espacement entre les lignes</span>

        <span class="c1"># plt.subplots_adjust(bottom=0.2, right=0.85)  # Réduire l&#39;espace vertical entre la heatmap et la colorbar</span>
        <span class="c1"># Afficher la heatmap</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.plot_heatmap_interactive">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.plot_heatmap_interactive">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_heatmap_interactive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates an interactive heatmap using Plotly to visualize the nitrogen flux transition matrix.</span>

<span class="sd">        The heatmap has the following features:</span>
<span class="sd">        - Logarithmic scale (simulated via log10(z)) to handle wide-ranging values.</span>
<span class="sd">        - A horizontal colorbar placed at the bottom of the plot.</span>
<span class="sd">        - A legend that maps matrix indices to sector labels, positioned on the right, ensuring no overlap.</span>
<span class="sd">        - The X-axis is displayed at the top of the plot, and the title is centered above the plot.</span>

<span class="sd">        This visualization helps to understand the relative magnitudes of the nitrogen fluxes between sectors</span>
<span class="sd">        in a clear and interactive manner.</span>

<span class="sd">        Returns:</span>
<span class="sd">            plotly.graph_objects.Figure: An interactive Plotly figure containing the heatmap.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 1) Préparation des labels numériques</span>
        <span class="n">x_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">y_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Si vous ignorez la dernière ligne/colonne comme dans votre code :</span>
        <span class="c1"># adjacency_subset = self.adjacency_matrix[: len(self.labels), : len(self.labels)]</span>

        <span class="n">adj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">)</span>  <span class="c1"># ou .copy()</span>
        <span class="n">adjacency_subset</span> <span class="o">=</span> <span class="n">adj</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">),</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># 2) Gestion min/max et transformation log10</span>
        <span class="n">cmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">adjacency_subset</span><span class="p">[</span><span class="n">adjacency_subset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]))</span>
        <span class="n">cmax</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># np.max(adjacency_subset)</span>
        <span class="n">log_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">adjacency_subset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">adjacency_subset</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># 3) Construire un tableau 2D de chaînes pour le survol</span>
        <span class="c1">#    Même dimension que log_matrix</span>
        <span class="n">strings_matrix</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row_i</span><span class="p">,</span> <span class="n">y_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y_labels</span><span class="p">):</span>
            <span class="n">row_texts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col_i</span><span class="p">,</span> <span class="n">x_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_labels</span><span class="p">):</span>
                <span class="c1"># Valeur réelle (non log) =&gt; adjacency_subset[row_i, col_i]</span>
                <span class="n">real_val</span> <span class="o">=</span> <span class="n">adjacency_subset</span><span class="p">[</span><span class="n">row_i</span><span class="p">,</span> <span class="n">col_i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">real_val</span><span class="p">):</span>
                    <span class="n">real_val_str</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">real_val_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">real_val</span><span class="si">:</span><span class="s2">.2e</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># format décimal / exposant</span>
                <span class="c1"># Construire la chaîne pour la tooltip</span>
                <span class="c1"># y_val et x_val sont les indices 1..N</span>
                <span class="c1"># self.labels[y_val] = nom de la source, self.labels[x_val] = nom de la cible</span>
                <span class="n">tooltip_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Source : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">y_val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;br&gt;Target : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">x_val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;br&gt;Value  : </span><span class="si">{</span><span class="n">real_val_str</span><span class="si">}</span><span class="s2"> ktN/yr&quot;</span>
                <span class="n">row_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tooltip_str</span><span class="p">)</span>
            <span class="n">strings_matrix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_texts</span><span class="p">)</span>

        <span class="c1"># 3) Tracé Heatmap avec go.Figure + go.Heatmap</span>
        <span class="c1">#    On règle &quot;zmin&quot; et &quot;zmax&quot; en valeurs log10</span>
        <span class="c1">#    pour contrôler la gamme de couleurs</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span>
            <span class="n">z</span><span class="o">=</span><span class="n">log_matrix</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x_labels</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">y_labels</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Plasma_r&quot;</span><span class="p">,</span>
            <span class="n">zmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cmin</span><span class="p">),</span>
            <span class="n">zmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cmax</span><span class="p">),</span>
            <span class="n">text</span><span class="o">=</span><span class="n">strings_matrix</span><span class="p">,</span>  <span class="c1"># tableau 2D de chaînes</span>
            <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>  <span class="c1"># on n&#39;affiche plus x, y, z bruts</span>
            <span class="c1"># Colorbar horizontale</span>
            <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ktN/year&quot;</span><span class="p">,</span>
                <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>  <span class="c1"># centré horizontalement</span>
                <span class="n">xanchor</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=-</span><span class="mf">0.15</span><span class="p">,</span>  <span class="c1"># en dessous de la figure</span>
                <span class="n">thickness</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>  <span class="c1"># épaisseur</span>
                <span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># longueur en fraction de la largeur</span>
            <span class="p">),</span>
            <span class="c1"># Valeurs de survol -&gt; vous verrez log10(...) par défaut</span>
            <span class="c1"># Pour afficher la valeur réelle, on peut plus tard utiliser &quot;customdata&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Créer la figure et y ajouter le trace</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">trace</span><span class="p">])</span>

        <span class="c1"># 4) Discrétisation manuelle des ticks sur la colorbar</span>
        <span class="c1">#    On veut afficher l&#39;échelle réelle (et pas log10)</span>
        <span class="c1">#    =&gt; calcul de tickvals en log10, et ticktext en 10^(tickvals)</span>
        <span class="n">tickvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cmin</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">cmax</span><span class="p">)),</span> <span class="n">num</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">ticktext</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>  <span class="c1"># [f&quot;{10**v:.2e}&quot; for v in tickvals]</span>
        <span class="c1"># Mettre à jour le trace pour forcer l&#39;affichage</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ktN/year&quot;</span><span class="p">,</span>
                <span class="n">orientation</span><span class="o">=</span><span class="s2">&quot;h&quot;</span><span class="p">,</span>
                <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">xanchor</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=-</span><span class="mf">0.15</span><span class="p">,</span>
                <span class="n">thickness</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                <span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">tickmode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
                <span class="n">tickvals</span><span class="o">=</span><span class="n">tickvals</span><span class="p">,</span>
                <span class="n">ticktext</span><span class="o">=</span><span class="n">ticktext</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># 5) Configuration de la mise en page</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
            <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">l</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">220</span><span class="p">),</span>  <span class="c1"># espace à droite pour la légende</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">yaxis_scaleanchor</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>

        <span class="c1"># Axe X en haut</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Target&quot;</span><span class="p">,</span>
            <span class="n">side</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>  <span class="c1"># place les ticks en haut</span>
            <span class="n">tickangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>  <span class="c1"># rotation</span>
            <span class="n">tickmode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
            <span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
            <span class="n">tickvals</span><span class="o">=</span><span class="n">x_labels</span><span class="p">,</span>  <span class="c1"># forcer l&#39;affichage 1..N</span>
            <span class="n">ticktext</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_labels</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Axe Y : inverser l&#39;ordre pour un style &quot;matriciel&quot; standard</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Source&quot;</span><span class="p">,</span>
            <span class="n">autorange</span><span class="o">=</span><span class="s2">&quot;reversed&quot;</span><span class="p">,</span>
            <span class="n">tickmode</span><span class="o">=</span><span class="s2">&quot;array&quot;</span><span class="p">,</span>
            <span class="n">tickfont</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span>
            <span class="n">tickvals</span><span class="o">=</span><span class="n">y_labels</span><span class="p">,</span>
            <span class="n">ticktext</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">y_labels</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># 6) Ajouter la légende à droite</span>
        <span class="c1">#    Format : &quot;1: label[0]&quot; ... vertical</span>
        <span class="n">legend_text</span> <span class="o">=</span> <span class="s2">&quot;&lt;br&gt;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">lbl</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">lbl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_annotation</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">1.25</span><span class="p">,</span>  <span class="c1"># un peu à droite</span>
            <span class="n">y</span><span class="o">=</span><span class="mf">0.45</span><span class="p">,</span>  <span class="c1"># centré en hauteur</span>
            <span class="n">xref</span><span class="o">=</span><span class="s2">&quot;paper&quot;</span><span class="p">,</span>
            <span class="n">yref</span><span class="o">=</span><span class="s2">&quot;paper&quot;</span><span class="p">,</span>
            <span class="n">showarrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="n">legend_text</span><span class="p">,</span>
            <span class="n">align</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">valign</span><span class="o">=</span><span class="s2">&quot;middle&quot;</span><span class="p">,</span>
            <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">),</span>
            <span class="n">bordercolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
            <span class="n">borderwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">borderpad</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">bgcolor</span><span class="o">=</span><span class="s2">&quot;rgba(0,0,0,0)&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.compute_fluxes">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.compute_fluxes">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_fluxes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Computes the nitrogen fluxes for all sectors in the model.</span>

<span class="sd">        This method populates the adjacency matrix with flux coefficients based on sector interactions. These interactions</span>
<span class="sd">        include crop production, livestock production, nitrogen emissions, and fertilization. The coefficients are used to</span>
<span class="sd">        model the flow of nitrogen between sectors over the specified year and region.</span>

<span class="sd">        The computation involves complex mathematical processes, which are detailed in the associated scientific methodology</span>
<span class="sd">        paper: Tracking Nitrogen Dynamics: A Disaggregated Approach for French Agro-Food Systems, 2025, Adrien Fauste-Gay (pre-print).</span>

<span class="sd">        For an in-depth explanation of the model&#39;s functioning, please refer to the accompanying paper.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extraire les variables nécessaires</span>
        <span class="n">df_cultures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span>
        <span class="n">df_elevage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span>
        <span class="n">adjacency_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span>
        <span class="n">label_to_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_to_index</span>
        <span class="n">year</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span>
        <span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span>
        <span class="n">data_loader</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_loader</span>
        <span class="n">flux_generator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flux_generator</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data_loader</span><span class="o">.</span><span class="n">pre_process_df</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>

        <span class="c1"># Gestion du cas particulier pour &#39;Straw&#39;</span>
        <span class="n">cereales</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;Rye&quot;</span><span class="p">,</span> <span class="s2">&quot;Barley&quot;</span><span class="p">,</span> <span class="s2">&quot;Oat&quot;</span><span class="p">,</span> <span class="s2">&quot;Grain maize&quot;</span><span class="p">,</span> <span class="s2">&quot;Other cereals&quot;</span><span class="p">]</span>
        <span class="n">somme_azote_produit_cereales</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">][</span><span class="n">cereales</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">somme_surface_cereales</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">][</span><span class="n">cereales</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Straw&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">somme_surface_cereales</span>
            <span class="o">*</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Straw&quot;</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="n">somme_azote_produit_cereales</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">cereal</span> <span class="ow">in</span> <span class="n">cereales</span><span class="p">:</span>
            <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cereal</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Straw&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cereal</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">somme_surface_cereales</span>
            <span class="p">)</span>
        <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Straw&quot;</span><span class="p">,</span> <span class="s2">&quot;Yield (qtl/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Crop Production (ktonDFW)&quot;</span><span class="p">][</span><span class="s2">&quot;Straw&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">][</span><span class="s2">&quot;Straw&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="p">)</span>

        <span class="c1">## Flux depuis &#39;other sectors&#39; (seeds) vers les cibles sélectionnées</span>
        <span class="c1"># selected_data = data[(data[&quot;index_excel&quot;] &gt;= 106) &amp; (data[&quot;index_excel&quot;] &lt;= 139)]</span>
        <span class="c1"># target = selected_data.set_index(&quot;nom&quot;)[region].to_dict()</span>
        <span class="c1"># source = {&quot;other sectors&quot;: 1}</span>
        <span class="c1"># flux_generator.generate_flux(source, target)</span>

        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Seed input (kt seeds/kt Ymax)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;other sectors&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1">## Dépôt atmosphérique</span>
        <span class="n">coef_surf</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">41</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">}</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">coef_surf</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>  <span class="c1"># Dépôt proportionnel aux surface</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1">## Fixation symbiotique</span>
        <span class="n">target_fixation</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;N fixation coef (kgN/kgN)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">source_fixation</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source_fixation</span><span class="p">,</span> <span class="n">target_fixation</span><span class="p">)</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Symbiotic fixation (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">target_fixation</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">## Épandage de boue sur les champs</span>
        <span class="c1"># Fonction pour calculer la redistribution de boues autour de Paris</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">compute_N_supp</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Eure&quot;</span><span class="p">,</span> <span class="s2">&quot;Ile de France&quot;</span><span class="p">,</span> <span class="s2">&quot;Eure-et-Loir&quot;</span><span class="p">,</span> <span class="s2">&quot;Picardie&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">==</span> <span class="s2">&quot;Ile de France&quot;</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Eure&quot;</span><span class="p">,</span> <span class="s2">&quot;Eure-et-Loir&quot;</span><span class="p">]:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.15</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">==</span> <span class="s2">&quot;Picardie&quot;</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.2</span>
            <span class="n">data_IDF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">pre_process_df</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="s2">&quot;Ile de France&quot;</span><span class="p">)</span>
            <span class="n">pop_IDF</span> <span class="o">=</span> <span class="n">data_IDF</span><span class="p">[</span><span class="n">data_IDF</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">][</span><span class="s2">&quot;Ile de France&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">prop_urb_IDF</span> <span class="o">=</span> <span class="n">data_IDF</span><span class="p">[</span><span class="n">data_IDF</span><span class="p">[</span><span class="s2">&quot;nom&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Urban population&quot;</span><span class="p">][</span><span class="s2">&quot;Ile de France&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span>
            <span class="n">N_cons_cap_IDF</span> <span class="o">=</span> <span class="n">data_IDF</span><span class="p">[</span><span class="n">data_IDF</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">][</span><span class="s2">&quot;Ile de France&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">N_prop_recy_urb_IDF</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">data_IDF</span><span class="p">[</span><span class="n">data_IDF</span><span class="p">[</span><span class="s2">&quot;nom&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;N recycling rate of human excretion in urban area&quot;</span><span class="p">][</span><span class="s2">&quot;Ile de France&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="o">/</span> <span class="mi">100</span>
            <span class="p">)</span>
            <span class="n">N_prop_recy_rur_IDF</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">data_IDF</span><span class="p">[</span><span class="n">data_IDF</span><span class="p">[</span><span class="s2">&quot;nom&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;N recycling rate of human excretion in rural area&quot;</span><span class="p">][</span><span class="s2">&quot;Ile de France&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="o">/</span> <span class="mi">100</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">factor</span> <span class="o">*</span> <span class="n">pop_IDF</span> <span class="o">*</span> <span class="n">N_cons_cap_IDF</span> <span class="o">*</span> <span class="n">prop_urb_IDF</span> <span class="o">*</span> <span class="n">N_prop_recy_urb_IDF</span><span class="p">,</span>
                <span class="n">factor</span> <span class="o">*</span> <span class="n">pop_IDF</span> <span class="o">*</span> <span class="n">N_cons_cap_IDF</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb_IDF</span><span class="p">)</span> <span class="o">*</span> <span class="n">N_prop_recy_rur_IDF</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">FE_N_N02_em</span> <span class="o">=</span> <span class="mf">0.002</span>
        <span class="n">FE_N_NH3_em</span> <span class="o">=</span> <span class="mf">0.118</span>
        <span class="n">FE_N_N2_em</span> <span class="o">=</span> <span class="mf">0.425</span>
        <span class="n">pop</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">prop_urb</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;nom&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Urban population&quot;</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">N_cons_cap</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">N_cap_vege</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">N_cap_viande</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">N_boue</span> <span class="o">=</span> <span class="n">pop</span> <span class="o">*</span> <span class="n">N_cons_cap</span>
        <span class="n">N_vege</span> <span class="o">=</span> <span class="n">pop</span> <span class="o">*</span> <span class="n">N_cap_vege</span>
        <span class="n">N_viande</span> <span class="o">=</span> <span class="n">pop</span> <span class="o">*</span> <span class="n">N_cap_viande</span>
        <span class="c1"># Et calcul rapide sur les ingestions de produits de la pêche</span>
        <span class="n">N_fish</span> <span class="o">=</span> <span class="n">N_boue</span> <span class="o">-</span> <span class="n">N_vege</span> <span class="o">-</span> <span class="n">N_viande</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;fishery products&quot;</span><span class="p">:</span> <span class="n">N_fish</span><span class="p">}</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">prop_urb</span><span class="p">,</span> <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">}</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Revenons aux boues</span>
        <span class="c1"># data[data[&quot;nom&quot;] == &quot;Total per capita protein ingestion&quot;][region].item() * pop Formule fausse dans PVAR</span>
        <span class="c1"># data[data[&quot;nom&quot;] == &quot;N Sludges to cropland&quot;][region].item()</span>
        <span class="n">prop_recy_urb</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;nom&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;N recycling rate of human excretion in urban area&quot;</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">prop_recy_rur</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;nom&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;N recycling rate of human excretion in rural area&quot;</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span>

        <span class="n">Norm</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Spreading Rate (%)&quot;</span><span class="p">])</span>
        <span class="c1"># Création du dictionnaire target</span>
        <span class="n">target_ependage</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">culture</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Spreading Rate (%)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">Norm</span> <span class="k">for</span> <span class="n">culture</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">N_supp_urb</span><span class="p">,</span> <span class="n">N_supp_rur</span> <span class="o">=</span> <span class="n">compute_N_supp</span><span class="p">()</span>

        <span class="n">source_boue</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">prop_urb</span> <span class="o">*</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="n">prop_recy_urb</span> <span class="o">+</span> <span class="n">N_supp_urb</span><span class="p">,</span>
            <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span> <span class="o">*</span> <span class="n">prop_recy_rur</span> <span class="o">*</span> <span class="n">N_boue</span> <span class="o">+</span> <span class="n">N_supp_rur</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source_boue</span><span class="p">,</span> <span class="n">target_ependage</span><span class="p">)</span>

        <span class="c1"># Le reste est perdu dans l&#39;environnement</span>
        <span class="c1"># Ajouter les fuites de N2O</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="n">prop_urb</span> <span class="o">*</span> <span class="n">FE_N_N02_em</span><span class="p">,</span>
            <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span> <span class="o">*</span> <span class="n">FE_N_N02_em</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Ajouter les fuites de NH3</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="n">prop_urb</span> <span class="o">*</span> <span class="n">FE_N_NH3_em</span><span class="p">,</span>
            <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span> <span class="o">*</span> <span class="n">FE_N_NH3_em</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Ajouter les fuites de N2</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="n">prop_urb</span> <span class="o">*</span> <span class="n">FE_N_N2_em</span><span class="p">,</span>
            <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span> <span class="o">*</span> <span class="n">FE_N_N2_em</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Le reste est perdu dans l&#39;hydroshere</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hydro-system&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="n">prop_urb</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_recy_urb</span> <span class="o">-</span> <span class="n">FE_N_N02_em</span> <span class="o">-</span> <span class="n">FE_N_NH3_em</span> <span class="o">-</span> <span class="n">FE_N_N2_em</span><span class="p">),</span>
            <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="n">N_boue</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_recy_rur</span> <span class="o">-</span> <span class="n">FE_N_NH3_em</span> <span class="o">-</span> <span class="n">FE_N_N02_em</span> <span class="o">-</span> <span class="n">FE_N_N2_em</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="c1"># Remplir la matrice d&#39;adjacence</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Azote excrété sur prairies</span>
        <span class="c1"># Production d&#39;azote</span>

        <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Production&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">dible&quot;</span><span class="p">]</span>
        <span class="n">df_elevage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;poultry&quot;</span><span class="p">,</span> <span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1023</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1067</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="p">)</span>  <span class="c1"># ajout des oeufs</span>
        <span class="n">df_elevage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;bovines&quot;</span><span class="p">,</span> <span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1024</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1068</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="p">)</span>  <span class="c1"># ajout du lait de vache</span>

        <span class="c1"># Plus délicat pour les ovins/caprins car la production de lait est mélangée</span>
        <span class="n">tete_ovins_femelle</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1171</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">tete_caprins_femelle</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1167</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">production_par_tete_caprins</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># kg/tete vu sur internet</span>
        <span class="n">production_par_tete_ovins</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># kg/tete vu sur internet</span>
        <span class="n">df_elevage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;ovines&quot;</span><span class="p">,</span> <span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">production_par_tete_ovins</span> <span class="o">*</span> <span class="n">tete_ovins_femelle</span> <span class="o">+</span> <span class="n">production_par_tete_caprins</span> <span class="o">*</span> <span class="n">tete_caprins_femelle</span><span class="p">)</span>
            <span class="o">==</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1025</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1069</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="n">production_par_tete_ovins</span>
            <span class="o">*</span> <span class="n">tete_ovins_femelle</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">production_par_tete_ovins</span> <span class="o">*</span> <span class="n">tete_ovins_femelle</span> <span class="o">+</span> <span class="n">production_par_tete_caprins</span> <span class="o">*</span> <span class="n">tete_caprins_femelle</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># ajout du lait de brebis</span>
        <span class="n">df_elevage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;caprines&quot;</span><span class="p">,</span> <span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">production_par_tete_ovins</span> <span class="o">*</span> <span class="n">tete_ovins_femelle</span> <span class="o">+</span> <span class="n">production_par_tete_caprins</span> <span class="o">*</span> <span class="n">tete_caprins_femelle</span><span class="p">)</span>
            <span class="o">==</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1025</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1069</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="n">production_par_tete_caprins</span>
            <span class="o">*</span> <span class="n">tete_caprins_femelle</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">production_par_tete_ovins</span> <span class="o">*</span> <span class="n">tete_ovins_femelle</span> <span class="o">+</span> <span class="n">production_par_tete_caprins</span> <span class="o">*</span> <span class="n">tete_caprins_femelle</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># ajout du lait de brebis</span>

        <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Non Edible Nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Production&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;% non edible&quot;</span><span class="p">]</span>

        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1241</span> <span class="o">+</span> <span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">selected_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span>
        <span class="n">selected_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;nom&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_data</span><span class="p">[</span><span class="s2">&quot;nom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">selected_data</span> <span class="o">=</span> <span class="n">selected_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;nom&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="n">region</span><span class="p">:</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;index_excel&quot;</span><span class="p">:</span> <span class="s2">&quot;first&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;nom&quot;</span><span class="p">)[</span><span class="n">region</span><span class="p">]</span>
        <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Ingestion (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Non Edible Nitrogen (ktN)&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1250</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">14</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">selected_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">index</span><span class="p">)][</span><span class="n">region</span><span class="p">]</span>
        <span class="n">selected_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span>

        <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted on grassland&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_data</span>

        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1251</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">14</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">selected_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">index</span><span class="p">)][</span><span class="n">region</span><span class="p">]</span>
        <span class="n">selected_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span>

        <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_data</span>

        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1252</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">14</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">selected_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">index</span><span class="p">)][</span><span class="n">region</span><span class="p">]</span>
        <span class="n">selected_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span>

        <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as slurry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_data</span>

        <span class="c1"># On ajouter la catégorie other manure dans la catégorie liter manure</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1253</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">14</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">selected_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">index</span><span class="p">)][</span><span class="n">region</span><span class="p">]</span>
        <span class="n">selected_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span>

        <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as slurry&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">selected_data</span>

        <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1254</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">14</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span>
        <span class="n">selected_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">index</span><span class="p">)][</span><span class="n">region</span><span class="p">]</span>
        <span class="n">selected_data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span>

        <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as manure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_data</span>

        <span class="c1"># Calculer les poids pour chaque cible</span>
        <span class="c1"># Calcul de la surface totale pour les prairies</span>
        <span class="n">total_surface</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Alfalfa and clover&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Non-legume temporary meadow&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Création du dictionnaire target</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Alfalfa and clover&quot;</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Alfalfa and clover&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_surface</span><span class="p">,</span>
            <span class="s2">&quot;Non-legume temporary meadow&quot;</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Non-legume temporary meadow&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_surface</span><span class="p">,</span>
            <span class="s2">&quot;Natural meadow &quot;</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">total_surface</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted on grassland&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-NH3 EM. outdoor&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2O EM. outdoor&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2 EM. outdoor&quot;</span><span class="p">])</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Le reste est émit dans l&#39;atmosphere</span>
        <span class="c1"># N2</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted on grassland&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2 EM. outdoor&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># NH3</span>
        <span class="c1"># 1 % est volatilisée de manière indirecte sous forme de N2O</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">:</span> <span class="mf">0.99</span><span class="p">,</span> <span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted on grassland&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-NH3 EM. outdoor&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># volat_N2O = (</span>
        <span class="c1">#     0.01</span>
        <span class="c1">#     * df_elevage[&quot;Excreted nitrogen (ktN)&quot;]</span>
        <span class="c1">#     * df_elevage[&quot;% excreted on grassland&quot;]</span>
        <span class="c1">#     / 100</span>
        <span class="c1">#     * df_elevage[&quot;N-NH3 EM. outdoor&quot;]</span>
        <span class="c1"># )</span>
        <span class="c1"># N2O</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted on grassland&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2O EM. outdoor&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1">## Epandage sur champs</span>

        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as manure&quot;</span><span class="p">]</span>
                <span class="o">/</span> <span class="mi">100</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="mi">1</span>
                    <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-NH3 EM. manure indoor&quot;</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2O EM. manure indoor&quot;</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2 EM. manure indoor&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as slurry&quot;</span><span class="p">]</span>
                <span class="o">/</span> <span class="mi">100</span>
                <span class="o">*</span> <span class="p">(</span>
                    <span class="mi">1</span>
                    <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-NH3 EM. slurry indoor&quot;</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2O EM. slurry indoor&quot;</span><span class="p">]</span>
                    <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2 EM. slurry indoor&quot;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target_ependage</span><span class="p">)</span>

        <span class="c1"># Le reste part dans l&#39;atmosphere</span>

        <span class="c1"># N2</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as slurry&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2 EM. slurry indoor&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as manure&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2 EM. manure indoor&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># NH3</span>
        <span class="c1"># 1 % est volatilisée de manière indirecte sous forme de N2O</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">:</span> <span class="mf">0.99</span><span class="p">,</span> <span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as slurry&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-NH3 EM. slurry indoor&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as manure&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-NH3 EM. manure indoor&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># volat_N2O = (</span>
        <span class="c1">#     0.01</span>
        <span class="c1">#     * df_elevage[&quot;Excreted nitrogen (ktN)&quot;]</span>
        <span class="c1">#     * df_elevage[&quot;% excreted indoors&quot;]</span>
        <span class="c1">#     / 100</span>
        <span class="c1">#     * (</span>
        <span class="c1">#         df_elevage[&quot;% excreted indoors as slurry&quot;] / 100 * df_elevage[&quot;N-NH3 EM. slurry indoor&quot;]</span>
        <span class="c1">#         + df_elevage[&quot;% excreted indoors as manure&quot;] / 100 * df_elevage[&quot;N-NH3 EM. manure indoor&quot;]</span>
        <span class="c1">#     )</span>
        <span class="c1"># )</span>
        <span class="c1"># N2O</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Excreted nitrogen (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="mi">100</span>
            <span class="o">*</span> <span class="p">(</span>
                <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as slurry&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2O EM. slurry indoor&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as manure&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;N-N2O EM. manure indoor&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1">## Azote synthétique</span>
        <span class="c1"># Calcul de l&#39;azote épendu par hectare</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">calculer_azote_ependu</span><span class="p">(</span><span class="n">culture</span><span class="p">):</span>
            <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">betail</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Pop</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">,</span> <span class="s2">&quot;N2O emission&quot;</span><span class="p">,</span> <span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">,</span> <span class="s2">&quot;other sectors&quot;</span><span class="p">]</span>
            <span class="n">adj_matrix_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">adj_matrix_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">sources</span><span class="p">,</span> <span class="n">culture</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Total Non Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">calculer_azote_ependu</span><span class="p">)</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Surface Non Synthetic Fertilizer Use (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Total Non Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Total Non Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Mécanisme d&#39;héritage de l&#39;azote en surplus des légumineuses</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Leguminous Nitrogen Surplus (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">legumineuses</span><span class="p">,</span> <span class="s2">&quot;Leguminous Nitrogen Surplus (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">legumineuses</span><span class="p">,</span> <span class="s2">&quot;Total Non Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">legumineuses</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Distribution du surplus aux céréales</span>
        <span class="n">total_surplus_azote</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">legumineuses</span><span class="p">,</span> <span class="s2">&quot;Leguminous Nitrogen Surplus (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">total_surface_cereales</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;cereals (excluding rice)&quot;</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;Straw&quot;</span><span class="p">,</span> <span class="s2">&quot;Forage maize&quot;</span><span class="p">]))</span>
            <span class="p">),</span>
            <span class="s2">&quot;Area (ha)&quot;</span><span class="p">,</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Leguminous heritage (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span>
                <span class="p">(</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;cereals (excluding rice)&quot;</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;Straw&quot;</span><span class="p">,</span> <span class="s2">&quot;Forage maize&quot;</span><span class="p">]))</span>
            <span class="p">),</span>
            <span class="s2">&quot;Leguminous heritage (ktN)&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span>
                    <span class="p">(</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;cereals (excluding rice)&quot;</span><span class="p">)</span>
                    <span class="o">|</span> <span class="p">(</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;Straw&quot;</span><span class="p">,</span> <span class="s2">&quot;Forage maize&quot;</span><span class="p">]))</span>
                <span class="p">),</span>
                <span class="s2">&quot;Area (ha)&quot;</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="o">/</span> <span class="n">total_surface_cereales</span>
            <span class="o">*</span> <span class="n">total_surplus_azote</span>
        <span class="p">)</span>

        <span class="c1"># Génération des flux pour l&#39;héritage des légumineuses</span>
        <span class="n">source_leg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Leguminous Nitrogen Surplus (ktN)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Leguminous Nitrogen Surplus (ktN)&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Leguminous Nitrogen Surplus (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">target_leg</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Leguminous heritage (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source_leg</span><span class="p">,</span> <span class="n">target_leg</span><span class="p">)</span>

        <span class="c1"># Calcul de l&#39;azote à épendre</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Raw Surface Synthetic Fertilizer Use (ktN/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Surface Fertilization Need (kgN/ha)&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Surface Non Synthetic Fertilizer Use (kgN/ha)&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Leguminous heritage (ktN)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Surface Fertilization Need (kgN/ha)&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Surface Non Synthetic Fertilizer Use (kgN/ha)&quot;</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Raw Surface Synthetic Fertilizer Use (ktN/ha)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span>
            <span class="s2">&quot;Raw Surface Synthetic Fertilizer Use (ktN/ha)&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Raw Total Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Raw Surface Synthetic Fertilizer Use (ktN/ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span>
        <span class="p">)</span>

        <span class="c1"># Calcul de la quantité moyenne (kgN) d&#39;azote synthétique épendu par hectare</span>
        <span class="c1"># Séparer les données en prairies et champs</span>
        <span class="n">df_prairies</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">prairies</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_champs</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cultures</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">moyenne_ponderee_prairies</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_prairies</span><span class="p">[</span><span class="s2">&quot;Raw Surface Synthetic Fertilizer Use (ktN/ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_prairies</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># / df_prairies[&#39;Surface&#39;].sum()</span>
        <span class="n">moyenne_ponderee_champs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_champs</span><span class="p">[</span><span class="s2">&quot;Raw Surface Synthetic Fertilizer Use (ktN/ha)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df_champs</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># / df_champs[&#39;Surface&#39;].sum()</span>

        <span class="n">moyenne_reel_champs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">27</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">23</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">moyenne_reel_prairies</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">29</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">22</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
        <span class="p">)</span>

        <span class="n">df_prairies</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Adjusted Total Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">moyenne_reel_prairies</span>
        <span class="n">df_champs</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Adjusted Total Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_champs</span><span class="p">[</span><span class="s2">&quot;Raw Total Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">moyenne_reel_champs</span> <span class="o">/</span> <span class="n">moyenne_ponderee_champs</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">moyenne_reel_champs</span> <span class="o">/</span> <span class="n">moyenne_ponderee_champs</span>

        <span class="c1"># Mise à jour de df_cultures</span>

        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Adjusted Total Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_champs</span><span class="p">[</span><span class="s2">&quot;Adjusted Total Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">df_prairies</span><span class="p">[</span><span class="s2">&quot;Adjusted Total Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Remplissage des clés manquantes (les légumineuses) avec 0</span>
        <span class="p">)</span>

        <span class="c1">## Azote synthétique volatilisé par les terres</span>
        <span class="c1"># Est ce qu&#39;il n&#39;y a que l&#39;azote synthétique qui est volatilisé ?</span>
        <span class="n">coef_volat_NH3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">31</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">coef_volat_N2O</span> <span class="o">=</span> <span class="mf">0.01</span>

        <span class="c1"># 1 % des emissions de NH3 du aux fert. synth sont volatilisées sous forme de N2O</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Volatilized Nitrogen N-NH3 (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Adjusted Total Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.99</span> <span class="o">*</span> <span class="n">coef_volat_NH3</span>
        <span class="p">)</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Volatilized Nitrogen N-N2O (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span>
            <span class="s2">&quot;Adjusted Total Synthetic Fertilizer Use (ktN)&quot;</span>
        <span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">coef_volat_N2O</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">coef_volat_NH3</span><span class="p">)</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Adjusted Total Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span>
            <span class="s2">&quot;Adjusted Total Synthetic Fertilizer Use (ktN)&quot;</span>
        <span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">coef_volat_NH3</span> <span class="o">-</span> <span class="n">coef_volat_N2O</span><span class="p">)</span>
        <span class="c1"># La quantité d&#39;azote réellement épendue est donc un peu plus faible car une partie est volatilisée</span>

        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Adjusted Total Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="n">source</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Volatilized Nitrogen N-NH3 (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="n">source</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Volatilized Nitrogen N-N2O (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># A cela on ajoute les emissions indirectes de N2O lors de la fabrication des engrais</span>
        <span class="c1"># epend_tot_synt = (</span>
        <span class="c1">#     df_cultures[&quot;Volatilized Nitrogen N-NH3 (ktN)&quot;]</span>
        <span class="c1">#     + df_cultures[&quot;Volatilized Nitrogen N-N2O (ktN)&quot;]</span>
        <span class="c1">#     + df_cultures[&quot;Adjusted Total Synthetic Fertilizer Use (ktN)&quot;]</span>
        <span class="c1"># ).sum()</span>
        <span class="n">epend_tot_synt</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Adjusted Total Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">coef_emis_N_N2O</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">32</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">:</span> <span class="n">epend_tot_synt</span> <span class="o">*</span> <span class="n">coef_emis_N_N2O</span><span class="p">}</span>

        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Azote issu de la partie non comestible des carcasses</span>
        <span class="n">source_non_comestible</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Non Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">target_other_sectors</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;other sectors&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source_non_comestible</span><span class="p">,</span> <span class="n">target_other_sectors</span><span class="p">)</span>

        <span class="c1"># On va chercher les éventuelles corrections apportées par JLN (=0 si export, donc pas vraiment net...)</span>
        <span class="n">import_feed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">get_import_feed</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
        <span class="c1"># Et la valeur net</span>
        <span class="n">import_feed_net</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1009</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="n">df_elevage_comp</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_cons_vege</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Ingestion (ktN)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;Ingestion (ktN)&quot;</span><span class="p">]</span>

        <span class="c1"># On ajoute l&#39;ingestion humaine</span>
        <span class="c1"># Une ligne urban, une ligne rural. Cela simplifiera la distinction de regime si un jour c&#39;est pertinent</span>

        <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;urban&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N_vege</span> <span class="o">*</span> <span class="n">prop_urb</span>
        <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;rural&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N_vege</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span>

        <span class="c1"># On distingue les imports feed et food #TODO dans l&#39;optim</span>
        <span class="n">import_food_net</span> <span class="o">=</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="n">import_feed_net</span>
        <span class="n">import_food</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">import_food_net</span><span class="p">)</span>

        <span class="n">supp_export</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">import_feed_net</span> <span class="o">&gt;</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Ingestion (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
            <span class="n">supp_export</span> <span class="o">=</span> <span class="n">import_feed_net</span> <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Ingestion (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>  <span class="c1"># On augmentera d&#39;autant les exports</span>
            <span class="n">import_feed_net</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Ingestion (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_cons_vege</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Dictionnaire enregistrant toutes les cultures présentes dans le régime d&#39;un élevage</span>
            <span class="n">all_cultures_regime</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">cultures_name</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">cultures_liste</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">cultures_name</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cultures_liste</span><span class="p">)</span>
                <span class="n">all_cultures_regime</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span> <span class="o">=</span> <span class="n">cultures_name</span>

            <span class="c1"># Initialisation du problème</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">LpProblem</span><span class="p">(</span><span class="s2">&quot;Allocation_Azote_Animaux&quot;</span><span class="p">,</span> <span class="n">LpMinimize</span><span class="p">)</span>

            <span class="c1"># Variables de décision pour les allocations</span>
            <span class="n">x_vars</span> <span class="o">=</span> <span class="n">LpVariable</span><span class="o">.</span><span class="n">dicts</span><span class="p">(</span>
                <span class="s2">&quot;x&quot;</span><span class="p">,</span>
                <span class="p">[(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">],</span>
                <span class="n">lowBound</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">cat</span><span class="o">=</span><span class="s2">&quot;Continuous&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Variable de depassement des importations feed</span>
            <span class="n">E_vars_feed</span> <span class="o">=</span> <span class="n">LpVariable</span><span class="o">.</span><span class="n">dicts</span><span class="p">(</span>
                <span class="s2">&quot;E&quot;</span><span class="p">,</span>
                <span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)</span> <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">all_cultures_regime</span><span class="p">[</span><span class="n">cons</span><span class="p">]],</span>
                <span class="n">lowBound</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">cat</span><span class="o">=</span><span class="s2">&quot;Continuous&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Variables de déviation des régimes alimentaires</span>
            <span class="n">delta_vars</span> <span class="o">=</span> <span class="n">LpVariable</span><span class="o">.</span><span class="n">dicts</span><span class="p">(</span>
                <span class="s2">&quot;delta&quot;</span><span class="p">,</span>
                <span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">proportion</span><span class="p">)</span> <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">proportion</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span>
                <span class="n">lowBound</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">cat</span><span class="o">=</span><span class="n">LpContinuous</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Variables de pénalité pour la concentration des allocations</span>
            <span class="c1"># penalite_vars = LpVariable.dicts(</span>
            <span class="c1">#     &quot;penalite&quot;,</span>
            <span class="c1">#     [(culture, cons) for culture in df_cultures.index for cons in df_cons_vege.index],</span>
            <span class="c1">#     lowBound=0,</span>
            <span class="c1">#     cat=LpContinuous,</span>
            <span class="c1"># )</span>

            <span class="c1"># Variables de pénalité pour la distribution au sein des catégories</span>
            <span class="n">penalite_culture_vars</span> <span class="o">=</span> <span class="n">LpVariable</span><span class="o">.</span><span class="n">dicts</span><span class="p">(</span>
                <span class="s2">&quot;penalite_culture&quot;</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">culture</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span>
                    <span class="k">for</span> <span class="n">proportion</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">][</span><span class="n">proportion</span><span class="p">]</span>
                <span class="p">],</span>
                <span class="n">lowBound</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">cat</span><span class="o">=</span><span class="n">LpContinuous</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Variables d&#39;importation pour chaque élevage et catégorie</span>
            <span class="n">I_vars_feed</span> <span class="o">=</span> <span class="n">LpVariable</span><span class="o">.</span><span class="n">dicts</span><span class="p">(</span>
                <span class="s2">&quot;I&quot;</span><span class="p">,</span>
                <span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)</span> <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">all_cultures_regime</span><span class="p">[</span><span class="n">cons</span><span class="p">]],</span>
                <span class="n">lowBound</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">cat</span><span class="o">=</span><span class="s2">&quot;Continuous&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Variables d&#39;importation pour chaque population et catégorie</span>
            <span class="n">I_vars_food</span> <span class="o">=</span> <span class="n">LpVariable</span><span class="o">.</span><span class="n">dicts</span><span class="p">(</span>
                <span class="s2">&quot;I&quot;</span><span class="p">,</span>
                <span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)</span> <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">all_cultures_regime</span><span class="p">[</span><span class="n">cons</span><span class="p">]],</span>
                <span class="n">lowBound</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">cat</span><span class="o">=</span><span class="s2">&quot;Continuous&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># # Variables pour capturer les importations associées aux déviations négatives</span>
            <span class="c1"># delta_import_vars = LpVariable.dicts(</span>
            <span class="c1">#     &quot;delta_import&quot;,</span>
            <span class="c1">#     [(cons, proportion) for cons in df_cons_vege.index for proportion in regimes[cons].keys()],</span>
            <span class="c1">#     lowBound=0,</span>
            <span class="c1">#     cat=LpContinuous,</span>
            <span class="c1"># )</span>

            <span class="c1"># Pondération pour le terme de pénalité</span>
            <span class="n">poids_penalite_deviation</span> <span class="o">=</span> <span class="mi">10</span>

            <span class="c1"># poids_penalite = 0  # Ajustez ce poids selon vos préférences</span>

            <span class="c1"># Poids pour équilibrer la distribution des cultures dans les categories</span>
            <span class="n">poids_penalite_culture</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># À ajuster selon vos préférences</span>

            <span class="c1"># Définir un poids élevé pour pénaliser les importations</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1960</span><span class="p">:</span>
                <span class="n">poids_exces_import</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">poids_import_food</span> <span class="o">=</span> <span class="mf">1e-2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">poids_exces_import</span> <span class="o">=</span> <span class="mf">1000.0</span>  <span class="c1"># Ajustez ce poids selon vos préférences</span>
                <span class="n">poids_import_food</span> <span class="o">=</span> <span class="mf">1000.0</span>

            <span class="c1"># poids_delta_import = (</span>
            <span class="c1">#     0.5  # Poids supplémentaire pour orienter les importations pour minimiser les fortes déviations</span>
            <span class="c1"># )</span>

            <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">poids_penalite_deviation</span>
                <span class="o">*</span> <span class="n">lpSum</span><span class="p">(</span>
                    <span class="n">delta_vars</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">proportion</span><span class="p">)]</span> <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">proportion</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="c1"># + poids_delta_import</span>
                <span class="c1"># * lpSum(</span>
                <span class="c1">#     delta_import_vars[(cons, proportion)]</span>
                <span class="c1">#     for cons in df_cons_vege.index</span>
                <span class="c1">#     for proportion in regimes[cons].keys()</span>
                <span class="c1"># )</span>
                <span class="c1"># + poids_penalite</span>
                <span class="c1"># * lpSum(penalite_vars[(culture, cons)] for culture in df_cultures.index for cons in df_cons_vege.index)</span>
                <span class="o">+</span> <span class="n">poids_penalite_culture</span>
                <span class="o">*</span> <span class="n">lpSum</span><span class="p">(</span>
                    <span class="n">penalite_culture_vars</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span>
                    <span class="k">for</span> <span class="n">proportion</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">][</span><span class="n">proportion</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="n">poids_exces_import</span>
                <span class="o">*</span> <span class="n">lpSum</span><span class="p">(</span>
                    <span class="n">E_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">all_cultures_regime</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="n">poids_import_food</span>
                <span class="o">*</span> <span class="n">lpSum</span><span class="p">(</span>
                    <span class="n">I_vars_food</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
                    <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">all_cultures_regime</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="s2">&quot;Minimiser_Deviations_Penalties_Et_Excès_Importation&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Les besoins en feed sont complétés par la prod locale, l&#39;importation de feed (donnees GRAFS) et un eventuel import excedentaire</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">besoin</span> <span class="o">=</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span>
                <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">lpSum</span><span class="p">(</span><span class="n">x_vars</span><span class="p">[(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">lpSum</span><span class="p">(</span><span class="n">I_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">all_cultures_regime</span><span class="p">[</span><span class="n">cons</span><span class="p">])</span>
                    <span class="o">+</span> <span class="n">lpSum</span><span class="p">(</span><span class="n">E_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">all_cultures_regime</span><span class="p">[</span><span class="n">cons</span><span class="p">])</span>
                    <span class="o">==</span> <span class="n">besoin</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;Besoin_</span><span class="si">{</span><span class="n">cons</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Les besoins en food sont complétés par la production locale et les imports de food</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]:</span>
                <span class="n">besoin</span> <span class="o">=</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span>
                <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">lpSum</span><span class="p">(</span><span class="n">x_vars</span><span class="p">[(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">lpSum</span><span class="p">(</span><span class="n">I_vars_food</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">all_cultures_regime</span><span class="p">[</span><span class="n">cons</span><span class="p">])</span>
                    <span class="o">==</span> <span class="n">besoin</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;Besoin_</span><span class="si">{</span><span class="n">cons</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># Cette contrainte assure que la somme de l&#39;azote alloué de chaque culture aux différents types de consommateurs ne dépasse pas l&#39;azote disponible pour cette culture.</span>
            <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">azote_disponible</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
                <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="n">lpSum</span><span class="p">(</span><span class="n">x_vars</span><span class="p">[(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)]</span> <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">azote_disponible</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;Disponibilite_</span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># interdiction de consommation locale et d&#39;import pour des cultures qui ne sont pas dans le feed regime</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">cultures_autorisees</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">cultures_liste</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">cultures_autorisees</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cultures_liste</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">culture</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cultures_autorisees</span><span class="p">:</span>
                        <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="n">x_vars</span><span class="p">[(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;Culture_Non_Autorisee_</span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cons</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="c1"># Vérifier si la variable I_vars existe avant d&#39;ajouter la contrainte</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)</span> <span class="ow">in</span> <span class="n">I_vars_feed</span><span class="p">:</span>
                            <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">I_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s2">&quot;Import_Non_Autorise_</span><span class="si">{</span><span class="n">cons</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)</span> <span class="ow">in</span> <span class="n">E_vars_feed</span><span class="p">:</span>
                            <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">E_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s2">&quot;Import_excedentaire_Non_Autorise_</span><span class="si">{</span><span class="n">cons</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="p">)</span>

            <span class="c1"># même chose pour food</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]:</span>
                <span class="n">cultures_autorisees</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">cultures_liste</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">cultures_autorisees</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cultures_liste</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">culture</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cultures_autorisees</span><span class="p">:</span>
                        <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                            <span class="n">x_vars</span><span class="p">[(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="sa">f</span><span class="s2">&quot;Culture_Non_Autorisee_</span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">cons</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="c1"># Vérifier si la variable I_vars existe avant d&#39;ajouter la contrainte</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)</span> <span class="ow">in</span> <span class="n">I_vars_food</span><span class="p">:</span>
                            <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                                <span class="n">I_vars_food</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="sa">f</span><span class="s2">&quot;Import_Non_Autorise_</span><span class="si">{</span><span class="n">cons</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="p">)</span>

            <span class="c1"># Ces contraintes calculent les déviations entre les proportions effectives des catégories consommées par chaque élevage et les proportions initiales du régime alimentaire.</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">besoin</span> <span class="o">=</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">proportion_initiale</span><span class="p">,</span> <span class="n">cultures_liste</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># Azote total des cultures dans la liste</span>
                    <span class="n">azote_cultures</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">lpSum</span><span class="p">(</span><span class="n">x_vars</span><span class="p">[(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span> <span class="k">if</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">lpSum</span><span class="p">(</span><span class="n">I_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">lpSum</span><span class="p">(</span><span class="n">E_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">proportion_effective</span> <span class="o">=</span> <span class="n">azote_cultures</span> <span class="o">/</span> <span class="n">besoin</span>
                    <span class="c1"># Déviation par rapport à la proportion initiale</span>
                    <span class="n">delta_var</span> <span class="o">=</span> <span class="n">delta_vars</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">proportion_initiale</span><span class="p">)]</span>
                    <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="n">proportion_effective</span> <span class="o">-</span> <span class="n">proportion_initiale</span> <span class="o">&lt;=</span> <span class="n">delta_var</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;Deviation_Plus_</span><span class="si">{</span><span class="n">cons</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">proportion_initiale</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="n">proportion_initiale</span> <span class="o">-</span> <span class="n">proportion_effective</span> <span class="o">&lt;=</span> <span class="n">delta_var</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;Deviation_Moins_</span><span class="si">{</span><span class="n">cons</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">proportion_initiale</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="c1"># Pareil pour food</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]:</span>
                <span class="n">besoin</span> <span class="o">=</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">proportion_initiale</span><span class="p">,</span> <span class="n">cultures_liste</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># Azote total des cultures dans la liste</span>
                    <span class="n">azote_cultures</span> <span class="o">=</span> <span class="n">lpSum</span><span class="p">(</span>
                        <span class="n">x_vars</span><span class="p">[(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span> <span class="k">if</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span>
                    <span class="p">)</span> <span class="o">+</span> <span class="n">lpSum</span><span class="p">(</span><span class="n">I_vars_food</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span><span class="p">)</span>
                    <span class="n">proportion_effective</span> <span class="o">=</span> <span class="n">azote_cultures</span> <span class="o">/</span> <span class="n">besoin</span>
                    <span class="c1"># Déviation par rapport à la proportion initiale</span>
                    <span class="n">delta_var</span> <span class="o">=</span> <span class="n">delta_vars</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">proportion_initiale</span><span class="p">)]</span>
                    <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="n">proportion_effective</span> <span class="o">-</span> <span class="n">proportion_initiale</span> <span class="o">&lt;=</span> <span class="n">delta_var</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;Deviation_Plus_</span><span class="si">{</span><span class="n">cons</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">proportion_initiale</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="n">proportion_initiale</span> <span class="o">-</span> <span class="n">proportion_effective</span> <span class="o">&lt;=</span> <span class="n">delta_var</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;Deviation_Moins_</span><span class="si">{</span><span class="n">cons</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">proportion_initiale</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

            <span class="c1"># Les importations normales de feed sont égales aux données de GRAFS</span>
            <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">lpSum</span><span class="p">(</span>
                    <span class="n">I_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span>
                    <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">all_cultures_regime</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="o">==</span> <span class="n">import_feed</span><span class="p">,</span>
                <span class="s2">&quot;Limite_Imports_Normaux&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># # Calcul de l&#39;allocation cible (par exemple, allocation uniforme)</span>
            <span class="c1"># for culture in df_cultures.index:</span>
            <span class="c1">#     azote_disponible_culture = df_cultures.loc[culture, &quot;Azote disponible&quot;]</span>
            <span class="c1">#     allocation_cible = azote_disponible_culture / len(df_cons_vege.index)  # Allocation uniforme</span>
            <span class="c1">#     for cons in df_cons_vege.index:</span>
            <span class="c1">#         allocation_reelle = x_vars[(culture, cons)]</span>
            <span class="c1">#         # Pénalité est la valeur absolue de la différence entre l&#39;allocation réelle et l&#39;allocation cible</span>
            <span class="c1">#         prob += (</span>
            <span class="c1">#             allocation_reelle - allocation_cible &lt;= penalite_vars[(culture, cons)],</span>
            <span class="c1">#             f&quot;Penalite_Plus_{culture}_{cons}&quot;,</span>
            <span class="c1">#         )</span>
            <span class="c1">#         prob += (</span>
            <span class="c1">#             allocation_cible - allocation_reelle &lt;= penalite_vars[(culture, cons)],</span>
            <span class="c1">#             f&quot;Penalite_Moins_{culture}_{cons}&quot;,</span>
            <span class="c1">#         )</span>

            <span class="c1"># Pénaliser si on nourrit les animaux avec une seule culture dans chaque groupe de proportions</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                <span class="n">besoin</span> <span class="o">=</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">cultures_liste</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># Allocation totale pour ce groupe de cultures</span>
                    <span class="n">allocation_groupe</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">lpSum</span><span class="p">(</span><span class="n">x_vars</span><span class="p">[(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span> <span class="k">if</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">lpSum</span><span class="p">(</span><span class="n">I_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span><span class="p">)</span>
                        <span class="o">+</span> <span class="n">lpSum</span><span class="p">(</span><span class="n">E_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="c1"># Azote total disponible pour ce groupe de cultures</span>
                    <span class="n">azote_total_groupe</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cultures_liste</span><span class="p">),</span>
                        <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">,</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">azote_total_groupe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                                <span class="n">azote_disponible_culture</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
                                <span class="c1"># Calcul de l&#39;allocation cible proportionnelle à la disponibilité</span>
                                <span class="n">allocation_cible_culture</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">azote_disponible_culture</span> <span class="o">/</span> <span class="n">azote_total_groupe</span>
                                <span class="p">)</span> <span class="o">*</span> <span class="n">allocation_groupe</span>
                                <span class="c1"># Allocation réelle</span>
                                <span class="n">allocation_reelle_culture</span> <span class="o">=</span> <span class="n">x_vars</span><span class="p">[(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)]</span>
                                <span class="c1"># Pénalités pour la déviation</span>
                                <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                                    <span class="n">allocation_reelle_culture</span> <span class="o">-</span> <span class="n">allocation_cible_culture</span>
                                    <span class="o">&lt;=</span> <span class="n">penalite_culture_vars</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">culture</span><span class="p">)],</span>
                                    <span class="sa">f</span><span class="s2">&quot;Penalite_Culture_Plus_</span><span class="si">{</span><span class="n">cons</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">proportion</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="p">)</span>
                                <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                                    <span class="n">allocation_cible_culture</span> <span class="o">-</span> <span class="n">allocation_reelle_culture</span>
                                    <span class="o">&lt;=</span> <span class="n">penalite_culture_vars</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">culture</span><span class="p">)],</span>
                                    <span class="sa">f</span><span class="s2">&quot;Penalite_Culture_Moins_</span><span class="si">{</span><span class="n">cons</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">proportion</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="c1"># Pareil pour les humains</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]:</span>
                <span class="n">besoin</span> <span class="o">=</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">cultures_liste</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># Allocation totale pour ce groupe de cultures</span>
                    <span class="n">allocation_groupe</span> <span class="o">=</span> <span class="n">lpSum</span><span class="p">(</span>
                        <span class="n">x_vars</span><span class="p">[(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span> <span class="k">if</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span>
                    <span class="p">)</span> <span class="o">+</span> <span class="n">lpSum</span><span class="p">(</span><span class="n">I_vars_food</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span><span class="p">)</span>
                    <span class="c1"># Azote total disponible pour ce groupe de cultures</span>
                    <span class="n">azote_total_groupe</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cultures_liste</span><span class="p">),</span>
                        <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">,</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">azote_total_groupe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                                <span class="n">azote_disponible_culture</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
                                <span class="c1"># Calcul de l&#39;allocation cible proportionnelle à la disponibilité</span>
                                <span class="n">allocation_cible_culture</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">azote_disponible_culture</span> <span class="o">/</span> <span class="n">azote_total_groupe</span>
                                <span class="p">)</span> <span class="o">*</span> <span class="n">allocation_groupe</span>
                                <span class="c1"># Allocation réelle</span>
                                <span class="n">allocation_reelle_culture</span> <span class="o">=</span> <span class="n">x_vars</span><span class="p">[(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)]</span>
                                <span class="c1"># Pénalités pour la déviation</span>
                                <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                                    <span class="n">allocation_reelle_culture</span> <span class="o">-</span> <span class="n">allocation_cible_culture</span>
                                    <span class="o">&lt;=</span> <span class="n">penalite_culture_vars</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">culture</span><span class="p">)],</span>
                                    <span class="sa">f</span><span class="s2">&quot;Penalite_Culture_Plus_</span><span class="si">{</span><span class="n">cons</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">proportion</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="p">)</span>
                                <span class="n">prob</span> <span class="o">+=</span> <span class="p">(</span>
                                    <span class="n">allocation_cible_culture</span> <span class="o">-</span> <span class="n">allocation_reelle_culture</span>
                                    <span class="o">&lt;=</span> <span class="n">penalite_culture_vars</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">culture</span><span class="p">)],</span>
                                    <span class="sa">f</span><span class="s2">&quot;Penalite_Culture_Moins_</span><span class="si">{</span><span class="n">cons</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">proportion</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">culture</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="c1"># Contrainte pour importer le feed là où les déviations sont les plus importantes</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">cultures_liste</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># Total des importations pour cette proportion</span>
                    <span class="n">azote_importe</span> <span class="o">=</span> <span class="n">lpSum</span><span class="p">(</span>
                        <span class="n">I_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span> <span class="o">+</span> <span class="n">E_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span>
                        <span class="k">if</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span>
                    <span class="p">)</span>
                    <span class="c1"># # Lier aux variables de déviation</span>
                    <span class="c1"># prob += (</span>
                    <span class="c1">#     delta_import_vars[(cons, proportion)]</span>
                    <span class="c1">#     &gt;= azote_importe - delta_vars[(cons, proportion)] * df_cons_vege.loc[cons],</span>
                    <span class="c1">#     f&quot;Delta_Import_Lien_{cons}_{proportion}&quot;,</span>
                    <span class="c1"># )</span>

            <span class="c1"># Pareil pour les humains</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]:</span>
                <span class="k">for</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">cultures_liste</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="c1"># Total des importations pour cette proportion</span>
                    <span class="n">azote_importe</span> <span class="o">=</span> <span class="n">lpSum</span><span class="p">(</span>
                        <span class="n">I_vars_food</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span> <span class="k">if</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span>
                    <span class="p">)</span>
                    <span class="c1"># # Lier aux variables de déviation</span>
                    <span class="c1"># prob += (</span>
                    <span class="c1">#     delta_import_vars[(cons, proportion)]</span>
                    <span class="c1">#     &gt;= azote_importe - delta_vars[(cons, proportion)] * df_cons_vege.loc[cons],</span>
                    <span class="c1">#     f&quot;Delta_Import_Lien_{cons}_{proportion}&quot;,</span>
                    <span class="c1"># )</span>

            <span class="c1"># Résolution du problème</span>
            <span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

            <span class="n">allocations</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">prob</span><span class="o">.</span><span class="n">variables</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">varValue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Nom de la variable : x_(culture, cons)</span>
                    <span class="n">chaine</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&#39;([^&#39;]*)&#39;&quot;</span><span class="p">,</span> <span class="n">chaine</span><span class="p">)</span>
                    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]</span>
                    <span class="n">culture</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># Gestion du tiret dans le nom</span>
                    <span class="k">if</span> <span class="n">culture</span> <span class="o">==</span> <span class="s2">&quot;Non legume temporary meadow&quot;</span><span class="p">:</span>
                        <span class="n">culture</span> <span class="o">=</span> <span class="s2">&quot;Non-legume temporary meadow&quot;</span>
                    <span class="k">if</span> <span class="n">culture</span> <span class="o">==</span> <span class="s2">&quot;Natural meadow&quot;</span><span class="p">:</span>
                        <span class="n">culture</span> <span class="o">=</span> <span class="s2">&quot;Natural meadow &quot;</span>
                    <span class="n">cons</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">index</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
                        <span class="n">Type</span> <span class="o">=</span> <span class="s2">&quot;Local culture feed&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Type</span> <span class="o">=</span> <span class="s2">&quot;Local culture food&quot;</span>
                    <span class="n">allocations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;Culture&quot;</span><span class="p">:</span> <span class="n">culture</span><span class="p">,</span>
                            <span class="s2">&quot;Consumer&quot;</span><span class="p">:</span> <span class="n">cons</span><span class="p">,</span>
                            <span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">:</span> <span class="n">var</span><span class="o">.</span><span class="n">varValue</span><span class="p">,</span>
                            <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;I&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">varValue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Nom de la variable : I_(cons, culture)</span>
                    <span class="n">chaine</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&#39;([^&#39;]*)&#39;&quot;</span><span class="p">,</span> <span class="n">chaine</span><span class="p">)</span>
                    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]</span>
                    <span class="n">cons</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">culture</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">culture</span> <span class="o">==</span> <span class="s2">&quot;Non legume temporary meadow&quot;</span><span class="p">:</span>
                        <span class="n">culture</span> <span class="o">=</span> <span class="s2">&quot;Non-legume temporary meadow&quot;</span>
                    <span class="k">if</span> <span class="n">culture</span> <span class="o">==</span> <span class="s2">&quot;Natural meadow&quot;</span><span class="p">:</span>
                        <span class="n">culture</span> <span class="o">=</span> <span class="s2">&quot;Natural meadow &quot;</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">index</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
                        <span class="n">Type</span> <span class="o">=</span> <span class="s2">&quot;Imported Feed&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Type</span> <span class="o">=</span> <span class="s2">&quot;Imported Food&quot;</span>
                    <span class="n">allocations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;Culture&quot;</span><span class="p">:</span> <span class="n">culture</span><span class="p">,</span>
                            <span class="s2">&quot;Consumer&quot;</span><span class="p">:</span> <span class="n">cons</span><span class="p">,</span>
                            <span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">:</span> <span class="n">var</span><span class="o">.</span><span class="n">varValue</span><span class="p">,</span>
                            <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="n">Type</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

                <span class="k">elif</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">var</span><span class="o">.</span><span class="n">varValue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Nom de la variable : E_(cons, culture)</span>
                    <span class="n">chaine</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&#39;([^&#39;]*)&#39;&quot;</span><span class="p">,</span> <span class="n">chaine</span><span class="p">)</span>
                    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]</span>
                    <span class="n">cons</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">culture</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">culture</span> <span class="o">==</span> <span class="s2">&quot;Non legume temporary meadow&quot;</span><span class="p">:</span>
                        <span class="n">culture</span> <span class="o">=</span> <span class="s2">&quot;Non-legume temporary meadow&quot;</span>
                    <span class="k">if</span> <span class="n">culture</span> <span class="o">==</span> <span class="s2">&quot;Natural meadow&quot;</span><span class="p">:</span>
                        <span class="n">culture</span> <span class="o">=</span> <span class="s2">&quot;Natural meadow &quot;</span>
                    <span class="n">allocations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;Culture&quot;</span><span class="p">:</span> <span class="n">culture</span><span class="p">,</span>
                            <span class="s2">&quot;Consumer&quot;</span><span class="p">:</span> <span class="n">cons</span><span class="p">,</span>
                            <span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">:</span> <span class="n">var</span><span class="o">.</span><span class="n">varValue</span><span class="p">,</span>
                            <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="s2">&quot;Excess feed imports&quot;</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>

            <span class="n">allocations_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">allocations</span><span class="p">)</span>

            <span class="c1"># Filtrer les lignes en supprimant celles dont &#39;Allocated Nitrogen&#39; est très proche de zéro</span>
            <span class="n">allocations_df</span> <span class="o">=</span> <span class="n">allocations_df</span><span class="p">[</span><span class="n">allocations_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mf">1e-6</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span> <span class="o">=</span> <span class="n">allocations_df</span>

            <span class="c1"># Extraction des déviations avec le signe</span>
            <span class="n">deviations</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">proportion</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">proportion_rounded</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">proportion</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
                    <span class="n">delta_var_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="n">proportion_rounded</span><span class="p">)</span>
                    <span class="n">deviation</span> <span class="o">=</span> <span class="n">delta_vars</span><span class="p">[</span><span class="n">delta_var_key</span><span class="p">]</span><span class="o">.</span><span class="n">varValue</span>
                    <span class="k">if</span> <span class="n">deviation</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Récupérer la liste des cultures associées à cette proportion</span>
                        <span class="n">cultures_liste</span> <span class="o">=</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">][</span><span class="n">proportion</span><span class="p">]</span>
                        <span class="n">cultures_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cultures_liste</span><span class="p">)</span>

                        <span class="c1"># Calcul de l&#39;allocation totale (local et importée)</span>
                        <span class="n">azote_cultures_feed</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="nb">sum</span><span class="p">(</span>
                                <span class="n">x_vars</span><span class="p">[(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)]</span><span class="o">.</span><span class="n">varValue</span>
                                <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)</span> <span class="ow">in</span> <span class="n">x_vars</span>
                            <span class="p">)</span>
                            <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span>
                                <span class="n">I_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span><span class="o">.</span><span class="n">varValue</span>
                                <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)</span> <span class="ow">in</span> <span class="n">I_vars_feed</span>
                            <span class="p">)</span>
                            <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span>
                                <span class="n">E_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span><span class="o">.</span><span class="n">varValue</span>
                                <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)</span> <span class="ow">in</span> <span class="n">E_vars_feed</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">besoin_total</span> <span class="o">=</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span>

                        <span class="c1"># Calcul de la proportion effective</span>
                        <span class="n">proportion_effective</span> <span class="o">=</span> <span class="n">azote_cultures_feed</span> <span class="o">/</span> <span class="n">besoin_total</span> <span class="k">if</span> <span class="n">besoin_total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

                        <span class="c1"># Déterminer le signe</span>
                        <span class="n">signe</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">proportion_effective</span> <span class="o">&gt;</span> <span class="n">proportion</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

                        <span class="n">deviations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;Consumer&quot;</span><span class="p">:</span> <span class="n">cons</span><span class="p">,</span>
                                <span class="s2">&quot;Expected Proportion (%)&quot;</span><span class="p">:</span> <span class="n">proportion_rounded</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                                <span class="s2">&quot;Deviation (%)&quot;</span><span class="p">:</span> <span class="n">signe</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">deviation</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>  <span class="c1"># Convertir en pourcentage</span>
                                <span class="s2">&quot;Porportion Allocated (%)&quot;</span><span class="p">:</span> <span class="n">proportion_rounded</span> <span class="o">*</span> <span class="mi">100</span>
                                <span class="o">+</span> <span class="n">signe</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">deviation</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                                <span class="s2">&quot;Cultures&quot;</span><span class="p">:</span> <span class="n">cultures_str</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]:</span>
                <span class="k">for</span> <span class="n">proportion</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">proportion_rounded</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">proportion</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
                    <span class="n">delta_var_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="n">proportion_rounded</span><span class="p">)</span>
                    <span class="n">deviation</span> <span class="o">=</span> <span class="n">delta_vars</span><span class="p">[</span><span class="n">delta_var_key</span><span class="p">]</span><span class="o">.</span><span class="n">varValue</span>
                    <span class="k">if</span> <span class="n">deviation</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># Récupérer la liste des cultures associées à cette proportion</span>
                        <span class="n">cultures_liste</span> <span class="o">=</span> <span class="n">regimes</span><span class="p">[</span><span class="n">cons</span><span class="p">][</span><span class="n">proportion</span><span class="p">]</span>
                        <span class="n">cultures_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cultures_liste</span><span class="p">)</span>

                        <span class="c1"># Calcul de l&#39;allocation totale (local et importée)</span>
                        <span class="n">azote_cultures_food</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                            <span class="n">x_vars</span><span class="p">[(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)]</span><span class="o">.</span><span class="n">varValue</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span> <span class="k">if</span> <span class="p">(</span><span class="n">culture</span><span class="p">,</span> <span class="n">cons</span><span class="p">)</span> <span class="ow">in</span> <span class="n">x_vars</span>
                        <span class="p">)</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span>
                            <span class="n">I_vars_food</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span><span class="o">.</span><span class="n">varValue</span>
                            <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">cultures_liste</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)</span> <span class="ow">in</span> <span class="n">I_vars_food</span>
                        <span class="p">)</span>
                        <span class="n">besoin_total</span> <span class="o">=</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span>

                        <span class="c1"># Calcul de la proportion effective</span>
                        <span class="n">proportion_effective</span> <span class="o">=</span> <span class="n">azote_cultures_food</span> <span class="o">/</span> <span class="n">besoin_total</span> <span class="k">if</span> <span class="n">besoin_total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

                        <span class="c1"># Déterminer le signe</span>
                        <span class="n">signe</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">proportion_effective</span> <span class="o">&gt;</span> <span class="n">proportion</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

                        <span class="n">deviations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;Consumer&quot;</span><span class="p">:</span> <span class="n">cons</span><span class="p">,</span>
                                <span class="s2">&quot;Expected Proportion (%)&quot;</span><span class="p">:</span> <span class="n">proportion_rounded</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                                <span class="s2">&quot;Deviation (%)&quot;</span><span class="p">:</span> <span class="n">signe</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">deviation</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>  <span class="c1"># Convertir en pourcentage</span>
                                <span class="s2">&quot;Porportion Allocated (%)&quot;</span><span class="p">:</span> <span class="n">proportion_rounded</span> <span class="o">*</span> <span class="mi">100</span>
                                <span class="o">+</span> <span class="n">signe</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">deviation</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                                <span class="s2">&quot;Cultures&quot;</span><span class="p">:</span> <span class="n">cultures_str</span><span class="p">,</span>
                            <span class="p">}</span>
                        <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deviations_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">deviations</span><span class="p">)</span>

            <span class="c1"># Extraction des importations normales</span>
            <span class="n">importations</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">all_cultures_regime</span><span class="p">[</span><span class="n">cons</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)</span> <span class="ow">in</span> <span class="n">I_vars_feed</span><span class="p">:</span>
                        <span class="n">import_value</span> <span class="o">=</span> <span class="n">I_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span><span class="o">.</span><span class="n">varValue</span>
                        <span class="k">if</span> <span class="n">import_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">importations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;Consumer&quot;</span><span class="p">:</span> <span class="n">cons</span><span class="p">,</span>
                                    <span class="s2">&quot;Culture&quot;</span><span class="p">:</span> <span class="n">culture</span><span class="p">,</span>
                                    <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="s2">&quot;Normal feed&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;Imported Nitrogen (ktN)&quot;</span><span class="p">:</span> <span class="n">import_value</span><span class="p">,</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]:</span>
                <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">all_cultures_regime</span><span class="p">[</span><span class="n">cons</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)</span> <span class="ow">in</span> <span class="n">I_vars_food</span><span class="p">:</span>
                        <span class="n">import_value</span> <span class="o">=</span> <span class="n">I_vars_food</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span><span class="o">.</span><span class="n">varValue</span>
                        <span class="k">if</span> <span class="n">import_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">importations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;Consumer&quot;</span><span class="p">:</span> <span class="n">cons</span><span class="p">,</span>
                                    <span class="s2">&quot;Culture&quot;</span><span class="p">:</span> <span class="n">culture</span><span class="p">,</span>
                                    <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="s2">&quot;Normal food&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;Imported Nitrogen (ktN)&quot;</span><span class="p">:</span> <span class="n">import_value</span><span class="p">,</span>
                                <span class="p">}</span>
                            <span class="p">)</span>

            <span class="c1"># Extraction des imports excédentaires</span>
            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">all_cultures_regime</span><span class="p">[</span><span class="n">cons</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)</span> <span class="ow">in</span> <span class="n">E_vars_feed</span><span class="p">:</span>
                        <span class="n">excess_value</span> <span class="o">=</span> <span class="n">E_vars_feed</span><span class="p">[(</span><span class="n">cons</span><span class="p">,</span> <span class="n">culture</span><span class="p">)]</span><span class="o">.</span><span class="n">varValue</span>
                        <span class="k">if</span> <span class="n">excess_value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">importations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;Consumer&quot;</span><span class="p">:</span> <span class="n">cons</span><span class="p">,</span>
                                    <span class="s2">&quot;Culture&quot;</span><span class="p">:</span> <span class="n">culture</span><span class="p">,</span>
                                    <span class="s2">&quot;Type&quot;</span><span class="p">:</span> <span class="s2">&quot;Excédentaire feed&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;Imported Nitrogen (ktN)&quot;</span><span class="p">:</span> <span class="n">excess_value</span><span class="p">,</span>
                                <span class="p">}</span>
                            <span class="p">)</span>

            <span class="c1"># Convertir en DataFrame</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">importations_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">importations</span><span class="p">)</span>

            <span class="c1"># Calcul de la quantité d&#39;azote importé non utilisée</span>
            <span class="n">azote_importe_alloue</span> <span class="o">=</span> <span class="n">allocations_df</span><span class="p">[</span>
                <span class="n">allocations_df</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;Imported Feed&quot;</span><span class="p">,</span> <span class="s2">&quot;Imported Food&quot;</span><span class="p">,</span> <span class="s2">&quot;Excess feed imports&quot;</span><span class="p">])</span>
            <span class="p">][</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="c1"># Mise à jour de df_cultures</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">culture</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
                <span class="n">azote_alloue</span> <span class="o">=</span> <span class="n">allocations_df</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">allocations_df</span><span class="p">[</span><span class="s2">&quot;Culture&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">culture</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">allocations_df</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;Local culture food&quot;</span><span class="p">,</span> <span class="s2">&quot;Local culture feed&quot;</span><span class="p">]))</span>
                <span class="p">][</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">azote_alloue_feed</span> <span class="o">=</span> <span class="n">allocations_df</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">allocations_df</span><span class="p">[</span><span class="s2">&quot;Culture&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">culture</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">allocations_df</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Local culture feed&quot;</span><span class="p">)</span>
                <span class="p">][</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">azote_alloue_food</span> <span class="o">=</span> <span class="n">allocations_df</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">allocations_df</span><span class="p">[</span><span class="s2">&quot;Culture&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">culture</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">allocations_df</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Local culture food&quot;</span><span class="p">)</span>
                <span class="p">][</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">azote_alloue</span>
                <span class="p">)</span>
                <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;Nitrogen For Feed (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">azote_alloue_feed</span>
                <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;Nitrogen For Food (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">azote_alloue_food</span>
            <span class="c1"># Correction des valeurs proches de zéro</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span>
                <span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen For Feed (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen For Feed (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="n">x</span>
            <span class="p">)</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen For Food (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen For Food (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="n">x</span>
            <span class="p">)</span>

            <span class="c1"># Mise à jour de df_elevage</span>
            <span class="c1"># Calcul de l&#39;azote total alloué à chaque élevage</span>
            <span class="n">azote_alloue_elevage</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">allocations_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Consumer&quot;</span><span class="p">,</span> <span class="s2">&quot;Type&quot;</span><span class="p">])[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Sélectionner uniquement les élevages (présents dans la liste `betail`)</span>
            <span class="n">azote_alloue_elevage</span> <span class="o">=</span> <span class="n">azote_alloue_elevage</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">azote_alloue_elevage</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="s2">&quot;Consumer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">betail</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="c1"># Ajouter les colonnes d&#39;azote alloué dans df_elevage</span>
            <span class="n">df_elevage</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Consummed nitrogen from local feed (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="n">azote_alloue_elevage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Local culture feed&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">df_elevage</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Consummed Nitrogen from imported feed (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">elevage</span><span class="p">:</span> <span class="n">azote_alloue_elevage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Imported Feed&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">elevage</span><span class="p">,</span> <span class="mi">0</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="n">azote_alloue_elevage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Excess feed imports&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">elevage</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># df_elevage[&#39;Azote alloué importations&#39;] = df_elevage.index.map(azote_alloue_elevage[&#39;Importation&#39;])</span>

            <span class="c1"># Génération des flux pour les cultures locales</span>
            <span class="n">allocations_locales</span> <span class="o">=</span> <span class="n">allocations_df</span><span class="p">[</span>
                <span class="n">allocations_df</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;Local culture food&quot;</span><span class="p">,</span> <span class="s2">&quot;Local culture feed&quot;</span><span class="p">])</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="n">cons</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                <span class="n">source</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">allocations_locales</span><span class="p">[</span><span class="n">allocations_locales</span><span class="p">[</span><span class="s2">&quot;Consumer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cons</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Culture&quot;</span><span class="p">)[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span>
                    <span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">source</span><span class="p">:</span>
                    <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="c1"># Génération des flux pour les importations</span>
            <span class="n">allocations_imports</span> <span class="o">=</span> <span class="n">allocations_df</span><span class="p">[</span>
                <span class="n">allocations_df</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;Imported Feed&quot;</span><span class="p">,</span> <span class="s2">&quot;Imported Food&quot;</span><span class="p">,</span> <span class="s2">&quot;Excess feed imports&quot;</span><span class="p">])</span>
            <span class="p">]</span>

            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">df_cons_vege</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="n">cons</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                <span class="n">cons_vege_imports</span> <span class="o">=</span> <span class="n">allocations_imports</span><span class="p">[</span><span class="n">allocations_imports</span><span class="p">[</span><span class="s2">&quot;Consumer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cons</span><span class="p">]</span>

                <span class="c1"># Initialisation d&#39;un dictionnaire pour collecter les flux par catégorie</span>
                <span class="n">flux</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cons_vege_imports</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">culture</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Culture&quot;</span><span class="p">]</span>
                    <span class="n">azote_alloue</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span>

                    <span class="c1"># Récupération de la catégorie de la culture</span>
                    <span class="n">categorie</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Category&quot;</span><span class="p">]</span>

                    <span class="c1"># Construction du label source pour l&#39;importation</span>
                    <span class="k">if</span> <span class="n">cons</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;urban&quot;</span><span class="p">,</span> <span class="s2">&quot;rural&quot;</span><span class="p">]:</span>
                        <span class="n">label_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">categorie</span><span class="si">}</span><span class="s2"> food trade&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">label_source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">categorie</span><span class="si">}</span><span class="s2"> feed trade&quot;</span>

                    <span class="c1"># Accumuler les flux par catégorie</span>
                    <span class="k">if</span> <span class="n">label_source</span> <span class="ow">in</span> <span class="n">flux</span><span class="p">:</span>
                        <span class="n">flux</span><span class="p">[</span><span class="n">label_source</span><span class="p">]</span> <span class="o">+=</span> <span class="n">azote_alloue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">flux</span><span class="p">[</span><span class="n">label_source</span><span class="p">]</span> <span class="o">=</span> <span class="n">azote_alloue</span>

                <span class="c1"># Génération des flux pour l&#39;élevage</span>
                <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">flux</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="c1"># On redonne à df_elevage sa forme d&#39;origine et à import_feed_net sa vraie valeur</span>
            <span class="c1"># Utiliser `infer_objects(copy=False)` pour éviter l&#39;avertissement sur le downcasting</span>
            <span class="n">df_elevage</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">combine_first</span><span class="p">(</span><span class="n">df_elevage_comp</span><span class="p">)</span>

            <span class="c1"># Remplir les valeurs manquantes avec 0</span>
            <span class="n">df_elevage</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Inférer les types pour éviter le warning sur les colonnes object</span>
            <span class="n">df_elevage</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">infer_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">feed_export</span> <span class="o">=</span> <span class="n">import_feed</span> <span class="o">-</span> <span class="n">import_feed_net</span>

            <span class="n">flux_exported</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">feed_export</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">6</span><span class="p">:</span>  <span class="c1"># On a importé plus que les imports net, la diff est l&#39;export de feed</span>
                <span class="n">feed_export</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">feed_export</span><span class="p">,</span>
                    <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="p">)</span>  <span class="c1"># Patch pour gérer les cas où on a une surexportation (cf Bretagne 2010)</span>
                <span class="c1"># On distingue les exports de feed prioritaires (prairies et fourrages) au reste</span>
                <span class="c1"># On distingue le cas où il y a assez dans les exports prioritaires pour couvrir</span>
                <span class="c1"># les export de feed au cas où il faut en plus exporter les autres cultures (mais d&#39;abord les exports prio)</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">feed_export</span>
                    <span class="o">&gt;</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;forages&quot;</span><span class="p">,</span> <span class="s2">&quot;temporary meadows&quot;</span><span class="p">]),</span>
                        <span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span><span class="p">,</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="p">):</span>
                    <span class="n">feed_export_prio</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;forages&quot;</span><span class="p">,</span> <span class="s2">&quot;temporary meadows&quot;</span><span class="p">]),</span>
                        <span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span><span class="p">,</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                    <span class="n">feed_export_other</span> <span class="o">=</span> <span class="n">feed_export</span> <span class="o">-</span> <span class="n">feed_export_prio</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">feed_export_prio</span> <span class="o">=</span> <span class="n">feed_export</span>
                    <span class="n">feed_export_other</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># Répartition de l&#39;azote exporté inutilisé par catégorie</span>
                <span class="c1"># On fait un premier tour sur les cultures prioritaires</span>
                <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;forages&quot;</span><span class="p">,</span> <span class="s2">&quot;temporary meadows&quot;</span><span class="p">])]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">categorie</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                    <span class="c1"># On exporte pas en feed des catégories dédiées aux humains</span>
                    <span class="k">if</span> <span class="n">categorie</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;rice&quot;</span><span class="p">,</span> <span class="s2">&quot;fruits and vegetables&quot;</span><span class="p">,</span> <span class="s2">&quot;roots&quot;</span><span class="p">]:</span>
                        <span class="c1"># Calculer la quantité exportée par catégorie proportionnellement aux catégories présentes dans df_cultures</span>
                        <span class="n">culture_nitrogen_available</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">][</span>
                            <span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">culture_nitrogen_available</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">flux_exported</span><span class="p">[</span><span class="n">culture</span><span class="p">]</span> <span class="o">=</span> <span class="n">feed_export_prio</span> <span class="o">*</span> <span class="p">(</span>
                                <span class="n">culture_nitrogen_available</span>
                                <span class="o">/</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                            <span class="p">)</span>

                <span class="c1"># On écoule le reste des export de feed (si il y en a) sur les autres cultures</span>
                <span class="k">if</span> <span class="n">feed_export_other</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">6</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="o">~</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;forages&quot;</span><span class="p">,</span> <span class="s2">&quot;temporary meadows&quot;</span><span class="p">,</span> <span class="s2">&quot;natural meadows &quot;</span><span class="p">])</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="n">categorie</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                        <span class="c1"># On exporte pas en feed des catégories dédiées aux humains</span>
                        <span class="k">if</span> <span class="n">categorie</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;rice&quot;</span><span class="p">,</span> <span class="s2">&quot;fruits and vegetables&quot;</span><span class="p">,</span> <span class="s2">&quot;roots&quot;</span><span class="p">]:</span>
                            <span class="c1"># Calculer la quantité exportée par catégorie proportionnellement aux catégories présentes dans df_cultures</span>
                            <span class="n">culture_nitrogen_available</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">][</span>
                                <span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

                            <span class="k">if</span> <span class="n">culture_nitrogen_available</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">flux_exported</span><span class="p">[</span><span class="n">culture</span><span class="p">]</span> <span class="o">=</span> <span class="n">feed_export_prio</span> <span class="o">*</span> <span class="p">(</span>
                                    <span class="n">culture_nitrogen_available</span>
                                    <span class="o">/</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                                <span class="p">)</span>

                <span class="c1"># Générer des flux les exportations vers leur catégorie d&#39;origine</span>
                <span class="k">for</span> <span class="n">label_source</span><span class="p">,</span> <span class="n">azote_exported</span> <span class="ow">in</span> <span class="n">flux_exported</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">azote_exported</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">categorie</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">label_source</span><span class="p">,</span> <span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                        <span class="n">label_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">categorie</span><span class="si">}</span><span class="s2"> feed trade&quot;</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="n">label_target</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="n">label_source</span><span class="p">:</span> <span class="n">azote_exported</span><span class="p">}</span>
                        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Mise à jour du DataFrame avec les quantités exportées</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Exported For Feed (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">flux_exported</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="mi">0</span>
        <span class="p">)</span>  <span class="c1"># df_cultures.index.map(source).fillna(0)</span>

        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Available Nitrogen After Feed, Export Feed and Food (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Exported For Feed (ktN)&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>

        <span class="c1"># import/export food</span>
        <span class="c1"># Le surplus est food exporté (ou stocké mais cela ne nous regarde pas)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">culture</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span>
            <span class="n">categorie</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">categorie</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;temporary meadows&quot;</span><span class="p">,</span> <span class="s2">&quot;natural meadows &quot;</span><span class="p">,</span> <span class="s2">&quot;forages&quot;</span><span class="p">]:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">culture</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span>
                        <span class="s2">&quot;Available Nitrogen After Feed, Export Feed and Food (ktN)&quot;</span><span class="p">,</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">categorie</span><span class="si">}</span><span class="s2"> food trade&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">culture</span> <span class="o">!=</span> <span class="s2">&quot;Natural meadow &quot;</span>
            <span class="p">):</span>  <span class="c1"># TODO Que faire des production de feed qui ne sont ni consommées ni exportées ? Pour l&#39;instant on les exporte....</span>
                <span class="c1"># Il faut les laisser retourner en terre si c&#39;est une prairie naturelle (recommandation de JLN)</span>
                <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">culture</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span>
                        <span class="s2">&quot;Available Nitrogen After Feed, Export Feed and Food (ktN)&quot;</span><span class="p">,</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">categorie</span><span class="si">}</span><span class="s2"> feed trade&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">culture</span><span class="p">:</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span>
                        <span class="s2">&quot;Available Nitrogen After Feed, Export Feed and Food (ktN)&quot;</span><span class="p">,</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="p">}</span>
                <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;soil stock&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Que faire d&#39;eventuel surplus de prairies ou forage ? Pour l&#39;instant on les ignores... Ou alors vers soil stock ?</span>

        <span class="c1">## Usage de l&#39;azote animal pour nourir la population, on pourrait améliorer en distinguant viande, oeufs et lait</span>

        <span class="n">viande_cap</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;index_excel&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span><span class="p">][</span><span class="n">region</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">cons_viande</span> <span class="o">=</span> <span class="n">viande_cap</span> <span class="o">*</span> <span class="n">pop</span>

        <span class="c1"># Reflechir a considerer un regime alimentaire carne (national) apres 1960</span>
        <span class="k">if</span> <span class="n">cons_viande</span> <span class="o">&lt;</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>  <span class="c1"># Il y a assez de viande locale</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">prop_urb</span> <span class="o">*</span> <span class="n">cons_viande</span><span class="p">,</span>
                <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span> <span class="o">*</span> <span class="n">cons_viande</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="p">[</span>
                <span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span>
            <span class="p">]</span> <span class="o">-</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># On commence par consommer tout l&#39;azote disponible</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">prop_urb</span><span class="p">,</span> <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)}</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

            <span class="n">cons_viande_import</span> <span class="o">=</span> <span class="n">cons_viande</span> <span class="o">-</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">commerce_path</span> <span class="o">=</span> <span class="s2">&quot;FAOSTAT_data_fr_viande_import.csv&quot;</span>
            <span class="n">commerce</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loader</span><span class="o">.</span><span class="n">data_path</span><span class="p">,</span> <span class="n">commerce_path</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1965</span>
            <span class="p">):</span>  <span class="c1"># Si on est avant 65, on se base sur les rations de 65. De toute façon ça concerne des import minoritaires...</span>
                <span class="n">year</span> <span class="o">=</span> <span class="s2">&quot;1965&quot;</span>
            <span class="n">commerce</span> <span class="o">=</span> <span class="n">commerce</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Année&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="p">[</span><span class="s2">&quot;Produit&quot;</span><span class="p">,</span> <span class="s2">&quot;Valeur&quot;</span><span class="p">]]</span>

            <span class="n">corresp_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Viande, bovine, fraîche ou réfrigérée&quot;</span><span class="p">:</span> <span class="s2">&quot;bovines&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Viande ovine, fraîche ou réfrigérée&quot;</span><span class="p">:</span> <span class="s2">&quot;ovines&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Viande, caprin, fraîche ou réfrigérée&quot;</span><span class="p">:</span> <span class="s2">&quot;caprines&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Viande, cheval, fraîche ou réfrigérée&quot;</span><span class="p">:</span> <span class="s2">&quot;equine&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Viande, porc, fraîche ou réfrigérée&quot;</span><span class="p">:</span> <span class="s2">&quot;porcines&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Viande, poulet, fraîche ou réfrigérée&quot;</span><span class="p">:</span> <span class="s2">&quot;poultry&quot;</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Produit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Produit&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">corresp_dict</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Produit&quot;</span><span class="p">])</span>
            <span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Ratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Valeur&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Valeur&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">commerce</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Produit&quot;</span><span class="p">]</span>

            <span class="n">target</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;urban&quot;</span><span class="p">:</span> <span class="n">prop_urb</span> <span class="o">*</span> <span class="n">cons_viande_import</span><span class="p">,</span>
                <span class="s2">&quot;rural&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prop_urb</span><span class="p">)</span> <span class="o">*</span> <span class="n">cons_viande_import</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;animal trade&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>  <span class="c1"># commerce[&quot;Ratio&quot;].to_dict() On peut distinguer les différents types d&#39;azote importé</span>
            <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="c1"># Et on reporte ce qu&#39;il manque dans la colonne &quot;Azote animal exporté net&quot;</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">commerce</span><span class="p">[</span><span class="s2">&quot;Ratio&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cons_viande_import</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cons_viande</span> <span class="o">&lt;</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;animal trade&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="c1"># Calcul des déséquilibres négatifs</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">cultures</span> <span class="o">+</span> <span class="n">legumineuses</span> <span class="o">+</span> <span class="n">prairies</span><span class="p">:</span>
            <span class="n">node_index</span> <span class="o">=</span> <span class="n">label_to_index</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
            <span class="n">row_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span><span class="n">node_index</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">col_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[:,</span> <span class="n">node_index</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">imbalance</span> <span class="o">=</span> <span class="n">row_sum</span> <span class="o">-</span> <span class="n">col_sum</span>  <span class="c1"># Déséquilibre entre sorties et entrées</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">imbalance</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">6</span><span class="p">:</span>
                <span class="n">imbalance</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">imbalance</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>  <span class="c1"># Que conclure si il y a plus de sortie que d&#39;entrée ? Que l&#39;on détériore les réserves du sol ?</span>
                <span class="c1"># print(f&quot;pb de balance avec {label}&quot;)</span>
                <span class="c1"># Plus de sorties que d&#39;entrées, on augmente les entrées</span>
                <span class="c1"># new_adjacency_matrix[n, node_index] = imbalance  # Flux du nœud de balance vers la culture</span>
                <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">imbalance</span><span class="p">}</span>
                <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;soil stock&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">imbalance</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Plus d&#39;entrées que de sorties, on augmente les sorties</span>
                <span class="c1"># adjacency_matrix[node_index, n] = -imbalance  # Flux de la culture vers le nœud de balance</span>
                <span class="k">if</span> <span class="n">label</span> <span class="o">!=</span> <span class="s2">&quot;Natural meadow &quot;</span><span class="p">:</span>  <span class="c1"># 70% de l&#39;excès fini dans les ecosystèmes aquatiques</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="o">-</span><span class="n">imbalance</span><span class="p">}</span>
                    <span class="c1"># Ajouter soil stock parmis les surplus de fertilisation.</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;other losses&quot;</span><span class="p">:</span> <span class="mf">0.2925</span><span class="p">,</span>
                        <span class="s2">&quot;hydro-system&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
                        <span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mf">0.0075</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">imbalance</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span> <span class="o">/</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="s2">&quot;Natural meadow &quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                        <span class="o">&gt;</span> <span class="mi">100</span>
                    <span class="p">):</span>  <span class="c1"># Si c&#39;est une prairie, l&#39;azote est lessivé seulement au dela de 100 kgN/ha</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">label</span><span class="p">:</span> <span class="o">-</span><span class="n">imbalance</span>
                            <span class="o">-</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="s2">&quot;Natural meadow &quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
                        <span class="p">}</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;other losses&quot;</span><span class="p">:</span> <span class="mf">0.2925</span><span class="p">,</span>
                            <span class="s2">&quot;hydro-system&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
                            <span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="mf">0.0075</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">label</span><span class="p">:</span> <span class="mi">100</span>
                            <span class="o">*</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="s2">&quot;Natural meadow &quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                            <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
                        <span class="p">}</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Autrement, l&#39;azote reste dans le sol (cas particulier, est ce que cela a du sens, quid des autres cultures ?)</span>
                        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="o">-</span><span class="n">imbalance</span><span class="p">}</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;soil stock&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
            <span class="c1"># Si imbalance == 0, aucun ajustement nécessaire</span>

        <span class="c1"># Calcul de imbalance dans df_cultures</span>
        <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Balance (ktN)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Adjusted Total Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Total Non Synthetic Fertilizer Use (ktN)&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Leguminous heritage (ktN)&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Leguminous Nitrogen Surplus (ktN)&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Volatilized Nitrogen N-NH3 (ktN)&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Volatilized Nitrogen N-N2O (ktN)&quot;</span><span class="p">]</span>  <span class="c1"># Pas de volat sous forme de N2 ?</span>
        <span class="p">)</span>

        <span class="c1"># On équilibre Haber-Bosch avec atmospheric N2 pour le faire entrer dans le système</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span><span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()}</span>
        <span class="n">source</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">flux_generator</span><span class="o">.</span><span class="n">generate_flux</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

        <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Conversion factor (%)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Non Edible Nitrogen (ktN)&quot;</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Ingestion (ktN)&quot;</span><span class="p">]</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">grafs_e.prospective</span><span class="w"> </span><span class="kn">import</span> <span class="n">scenario</span>

        <span class="n">LU</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">livestock_LU</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_loader</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">]</span>
        <span class="n">LU</span><span class="p">[</span><span class="s2">&quot;equine&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LU</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;equines&quot;</span><span class="p">)</span>
        <span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;LU&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LU</span>

        <span class="c1"># On ajoute une ligne total à df_cultures et df_elevage</span>
        <span class="n">colonnes_a_exclure</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Spreading Rate (%)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Nitrogen Content (%)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Seed input (kt seeds/kt Ymax)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Category&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N fixation coef (kgN/kgN)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Fertilization Need (kgN/qtl)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Surface Fertilization Need (kgN/ha)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Yield (qtl/ha)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Yield (kgN/ha)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Surface Non Synthetic Fertilizer Use (kgN/ha)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Raw Surface Synthetic Fertilizer Use (ktN/ha)&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">colonnes_a_sommer</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">colonnes_a_exclure</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">df_cultures</span><span class="p">[</span><span class="n">colonnes_a_sommer</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">total</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Total&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures_display</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_cultures</span><span class="p">,</span> <span class="n">total</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>

        <span class="n">colonnes_a_exclure</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;</span><span class="si">% e</span><span class="s2">dible&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as manure&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted indoors as slurry&quot;</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">% e</span><span class="s2">xcreted on grassland&quot;</span><span class="p">,</span>
            <span class="s2">&quot;% non edible&quot;</span><span class="p">,</span>
            <span class="s2">&quot;%N dairy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-N2 EM. manure indoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-N2 EM. outdoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-N2 EM. slurry indoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-N2O EM. manure indoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-N2O EM. outdoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-N2O EM. slurry indoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-NH3 EM. manure indoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-NH3 EM. outdoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;N-NH3 EM. slurry indoor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Conversion factor (%)&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">colonnes_a_sommer</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">colonnes_a_exclure</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">df_elevage</span><span class="p">[</span><span class="n">colonnes_a_sommer</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">total</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Total&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage_display</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_elevage</span><span class="p">,</span> <span class="n">total</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span> <span class="o">=</span> <span class="n">df_cultures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span> <span class="o">=</span> <span class="n">df_elevage</span></div>

        <span class="c1"># self.adjacency_matrix = adjacency_matrix</span>

<div class="viewcode-block" id="NitrogenFlowModel.get_df_culture">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.get_df_culture">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_df_culture</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the DataFrame containing crop-related data.</span>

<span class="sd">        :return: A pandas DataFrame with crop data used in the nitrogen model.</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.get_df_elevage">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.get_df_elevage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_df_elevage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the DataFrame containing livestock-related data.</span>

<span class="sd">        :return: A pandas DataFrame with livestock data used in the nitrogen model.</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.get_transition_matrix">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.get_transition_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_transition_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the full nitrogen transition matrix.</span>

<span class="sd">        This matrix represents all nitrogen fluxes between sectors, including core and external processes.</span>

<span class="sd">        :return: A 2D NumPy array representing nitrogen fluxes between all sectors.</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.get_core_matrix">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.get_core_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_core_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts and returns the core matrix of nitrogen fluxes between active sectors.</span>

<span class="sd">        This method filters out rows and columns with no flows and excludes external sectors.</span>
<span class="sd">        The result isolates the central dynamics of the system.</span>

<span class="sd">        :return: A 2D NumPy array of the filtered core matrix.</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calcul de la taille du noyau</span>
        <span class="n">core_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ext</span><span class="p">)</span>

        <span class="c1"># Extraire la matrice principale (noyau)</span>
        <span class="n">core_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[:</span><span class="n">core_size</span><span class="p">,</span> <span class="p">:</span><span class="n">core_size</span><span class="p">]</span>

        <span class="c1"># Calculer la somme des éléments sur chaque ligne</span>
        <span class="n">row_sums</span> <span class="o">=</span> <span class="n">core_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Identifier les indices des lignes où la somme est non nulle</span>
        <span class="n">non_zero_rows</span> <span class="o">=</span> <span class="n">row_sums</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="c1"># Identifier les indices des colonnes à garder (les mêmes indices que les lignes non nulles)</span>
        <span class="n">non_zero_columns</span> <span class="o">=</span> <span class="n">non_zero_rows</span>

        <span class="c1"># Filtrer les lignes et les colonnes avec une somme non nulle</span>
        <span class="n">core_matrix_filtered</span> <span class="o">=</span> <span class="n">core_matrix</span><span class="p">[</span><span class="n">non_zero_rows</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">non_zero_columns</span><span class="p">]</span>

        <span class="c1"># Retourner la matrice filtrée</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">core_matrix</span> <span class="o">=</span> <span class="n">core_matrix_filtered</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_zero_rows</span> <span class="o">=</span> <span class="n">non_zero_rows</span>
        <span class="k">return</span> <span class="n">core_matrix_filtered</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.get_adjacency_matrix">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.get_adjacency_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_adjacency_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the binary adjacency matrix of nitrogen fluxes.</span>

<span class="sd">        This matrix has the same dimensions as the core matrix and indicates the presence</span>
<span class="sd">        (1) or absence (0) of nitrogen fluxes between sectors.</span>

<span class="sd">        :return: A binary adjacency matrix.</span>
<span class="sd">        :rtype: numpy.ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_core_matrix</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">core_matrix</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.extract_input_output_matrixs">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.extract_input_output_matrixs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_input_output_matrixs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clean</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts input and output matrices (C and B blocks) from the full transition matrix.</span>

<span class="sd">        These matrices represent the nitrogen flows between core and external sectors:</span>
<span class="sd">        - B: Outputs from core to external sectors.</span>
<span class="sd">        - C: Inputs from external to core sectors.</span>

<span class="sd">        If `clean` is True, the method removes rows and columns corresponding to inactive sectors.</span>

<span class="sd">        :param clean: Whether to remove zero-flow sectors from the matrices.</span>
<span class="sd">        :type clean: bool</span>
<span class="sd">        :return: A tuple (B, C) of NumPy arrays.</span>
<span class="sd">        :rtype: tuple[numpy.ndarray, numpy.ndarray]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Fonction pour extraire la matrice entrée (C) et la matrice sortie (B) de la matrice complète.</span>
        <span class="c1"># Taille de la matrice coeur</span>
        <span class="n">core_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ext</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">)</span>
        <span class="c1"># Extraire la sous-matrice B (bloc haut-droit)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[:</span><span class="n">core_size</span><span class="p">,</span> <span class="n">core_size</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>

        <span class="c1"># Extraire la sous-matrice C (bloc bas-gauche)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span><span class="n">core_size</span><span class="p">:</span><span class="n">n</span><span class="p">,</span> <span class="p">:</span><span class="n">core_size</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">clean</span><span class="p">:</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="p">[:][:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_zero_rows</span><span class="p">]</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">non_zero_rows</span><span class="p">,</span> <span class="p">:][:]</span>

        <span class="k">return</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.imported_nitrogen">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.imported_nitrogen">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">imported_nitrogen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the total amount of nitrogen imported into the system.</span>

<span class="sd">        Includes nitrogen in imported food, feed, and excess feed.</span>

<span class="sd">        :return: Total imported nitrogen (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;Imported Food&quot;</span><span class="p">,</span> <span class="s2">&quot;Imported Feed&quot;</span><span class="p">,</span> <span class="s2">&quot;Excess feed imports&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">,</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.net_imported_plant">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.net_imported_plant">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_imported_plant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the net nitrogen imports for plant sectors.</span>

<span class="sd">        Calculated as the difference between total nitrogen imports and plant sector availability after local uses (feed and food).</span>

<span class="sd">        :return: Net nitrogen import for plant-based products (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">importations_df</span><span class="p">[</span><span class="s2">&quot;Imported Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Available Nitrogen After Feed and Food (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.net_imported_animal">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.net_imported_animal">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_imported_animal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the net nitrogen export for animal sectors.</span>

<span class="sd">        :return: Total nitrogen exported via animal products (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.total_plant_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.total_plant_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_plant_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the total nitrogen production from all crop categories.</span>

<span class="sd">        :return: Total nitrogen produced by crops (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.stacked_plant_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.stacked_plant_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stacked_plant_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the vector of nitrogen production by crop category.</span>

<span class="sd">        :return: A pandas Series of nitrogen production per crop.</span>
<span class="sd">        :rtype: pandas.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.cereals_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.cereals_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cereals_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the nitrogen production from cereal crops.</span>

<span class="sd">        :return: Total nitrogen from cereals (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;cereals (excluding rice)&quot;</span><span class="p">,</span> <span class="s2">&quot;rice&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.leguminous_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.leguminous_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">leguminous_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the nitrogen production from leguminous crops.</span>

<span class="sd">        :return: Total nitrogen from leguminous (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;leguminous&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.oleaginous_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.oleaginous_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">oleaginous_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the nitrogen production from oleaginous crops.</span>

<span class="sd">        :return: Total nitrogen from oleaginous (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;oleaginous&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.grassland_and_forages_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.grassland_and_forages_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">grassland_and_forages_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the nitrogen production from grassland and forages crops.</span>

<span class="sd">        :return: Total nitrogen from grassland and forages (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;temporary meadows&quot;</span><span class="p">,</span> <span class="s2">&quot;natural meadows &quot;</span><span class="p">,</span> <span class="s2">&quot;forages&quot;</span><span class="p">]),</span>
            <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">,</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.roots_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.roots_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">roots_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the nitrogen production from roots crops.</span>

<span class="sd">        :return: Total nitrogen from roots (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;roots&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.fruits_and_vegetable_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.fruits_and_vegetable_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fruits_and_vegetable_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the nitrogen production from fruits and vegetables crops.</span>

<span class="sd">        :return: Total nitrogen from fruits and vegetables (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;fruits and vegetables&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.cereals_production_r">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.cereals_production_r">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">cereals_production_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the share of nitrogen production from cereals relative to total plant production.</span>

<span class="sd">        :return: Percentage of total plant nitrogen production from cereals.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;cereals (excluding rice)&quot;</span><span class="p">,</span> <span class="s2">&quot;rice&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plant_production</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.leguminous_production_r">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.leguminous_production_r">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">leguminous_production_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the share of nitrogen production from leguminous relative to total plant production.</span>

<span class="sd">        :return: Percentage of total plant nitrogen production from leguminous.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;leguminous&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plant_production</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.oleaginous_production_r">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.oleaginous_production_r">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">oleaginous_production_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the share of nitrogen production from oleaginous relative to total plant production.</span>

<span class="sd">        :return: Percentage of total plant nitrogen production from oleaginous.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;oleaginous&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plant_production</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.grassland_and_forages_production_r">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.grassland_and_forages_production_r">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">grassland_and_forages_production_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the share of nitrogen production from forages relative to total plant production.</span>

<span class="sd">        :return: Percentage of total plant nitrogen production from forages.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;temporary meadows&quot;</span><span class="p">,</span> <span class="s2">&quot;natural meadows&quot;</span><span class="p">,</span> <span class="s2">&quot;forages&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">,</span>
            <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plant_production</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.roots_production_r">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.roots_production_r">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">roots_production_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the share of nitrogen production from roots relative to total plant production.</span>

<span class="sd">        :return: Percentage of total plant nitrogen production from roots.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;roots&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plant_production</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.fruits_and_vegetable_production_r">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.fruits_and_vegetable_production_r">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fruits_and_vegetable_production_r</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the share of nitrogen production from fruits and vegetables relative to total plant production.</span>

<span class="sd">        :return: Percentage of total plant nitrogen production from fruits and vegetables.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s2">&quot;fruits and vegetables&quot;</span><span class="p">]),</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_plant_production</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.animal_production">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.animal_production">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">animal_production</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the total edible nitrogen produced by livestock sectors.</span>

<span class="sd">        :return: Total nitrogen in edible animal products (in ktN).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.emissions">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.emissions">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">emissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the total nitrogen emissions from the system.</span>

<span class="sd">        Includes N₂O emissions, atmospheric N₂ release, and NH₃ volatilization, with unit conversions.</span>

<span class="sd">        :return: A pandas Series with nitrogen emission quantities.</span>
<span class="sd">        :rtype: pandas.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;N2O emission&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[:,</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="mi">14</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">14</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span>
                <span class="p">),</span>
                <span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[:,</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[:,</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">17</span> <span class="o">/</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">2</span>
                <span class="p">),</span>
            <span class="p">},</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Emission&quot;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()[</span><span class="s2">&quot;Emission&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.surfaces">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.surfaces">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">surfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the cultivated area per crop.</span>

<span class="sd">        :return: A pandas Series with area per crop (in hectares).</span>
<span class="sd">        :rtype: pandas.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.surfaces_tot">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.surfaces_tot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">surfaces_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the total cultivated area in the model.</span>

<span class="sd">        :return: Total area (in hectares).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.N_eff">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.N_eff">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">N_eff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gr</span><span class="o">.</span><span class="n">GraphAnalyzer</span><span class="o">.</span><span class="n">calculate_Neff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.C_eff">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.C_eff">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">C_eff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gr</span><span class="o">.</span><span class="n">GraphAnalyzer</span><span class="o">.</span><span class="n">calculate_Ceff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.F_eff">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.F_eff">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">F_eff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gr</span><span class="o">.</span><span class="n">GraphAnalyzer</span><span class="o">.</span><span class="n">calculate_Feff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.R_eff">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.R_eff">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">R_eff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">gr</span><span class="o">.</span><span class="n">GraphAnalyzer</span><span class="o">.</span><span class="n">calculate_Reff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.Ftot">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.Ftot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">Ftot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">):</span>
        <span class="n">area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">area</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Vérification pour éviter la division par zéro</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[:,</span> <span class="n">label_to_index</span><span class="p">[</span><span class="n">culture</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">/</span> <span class="n">area</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.Y">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.Y">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">Y</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">culture</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the nitrogen yield of a given crop.</span>

<span class="sd">        Yield is calculated as nitrogen production (kgN) per hectare for the specified crop.</span>

<span class="sd">        :param culture: The name of the crop (index of `df_cultures`).</span>
<span class="sd">        :type culture: str</span>
<span class="sd">        :return: Nitrogen yield in kgN/ha.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">area</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Vérification pour éviter la division par zéro</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">/</span> <span class="n">area</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.tot_fert">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.tot_fert">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">tot_fert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes total nitrogen inputs to the system, broken down by origin.</span>

<span class="sd">        Categories include animal and human excretion, atmospheric deposition, Haber-Bosch inputs, leguminous enrichment, etc.</span>

<span class="sd">        :return: A pandas Series of nitrogen inputs by source (in ktN).</span>
<span class="sd">        :rtype: pandas.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Mining&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span><span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;soil stock&quot;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;Seeds&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span><span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;other sectors&quot;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;Human excretion&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;urban&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;rural&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;Leguminous soil enrichment&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Horse beans and faba beans&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Alfalfa and clover&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span><span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;Atmospheric deposition&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">],</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">],</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;atmospheric N2&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">],</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="s2">&quot;Animal excretion&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjacency_matrix</span><span class="p">[</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;bovines&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;equine&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">]</span> <span class="p">:</span> <span class="n">label_to_index</span><span class="p">[</span><span class="s2">&quot;Natural meadow &quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.rel_fert">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.rel_fert">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">rel_fert</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the relative share (%) of each nitrogen input source.</span>

<span class="sd">        :return: A pandas Series with nitrogen input sources as percentage of the total.</span>
<span class="sd">        :rtype: pandas.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_fert</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">df</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.primXsec">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.primXsec">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">primXsec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the percentage of nitrogen from secondary sources (biological or recycled),</span>
<span class="sd">        compared to the total nitrogen inputs.</span>

<span class="sd">        Secondary sources include: human excretion, animal excretion, atmospheric inputs, seeds, and leguminous fixation.</span>

<span class="sd">        :return: Share of secondary sources in total nitrogen inputs (%).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_fert</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Human excretion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Animal excretion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Atmospheric deposition&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Seeds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Leguminous soil enrichment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.NUE">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.NUE">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">NUE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the crop-level nitrogen use efficiency (NUE).</span>

<span class="sd">        Defined as the ratio of nitrogen produced by crops over total nitrogen inputs.</span>

<span class="sd">        :return: NUE of crop systems (%).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_fert</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.NUE_system">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.NUE_system">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">NUE_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates system-wide nitrogen use efficiency, including crop and livestock production.</span>

<span class="sd">        Accounts for feed losses and nitrogen consumed via imported feed.</span>

<span class="sd">        :return: System-wide NUE (%).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N_NP</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen For Feed (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Non Edible Nitrogen (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">df_fert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_fert</span><span class="p">()</span>
        <span class="n">N_tot</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;Atmospheric deposition&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Consummed Nitrogen from imported feed (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">N_NP</span> <span class="o">/</span> <span class="n">N_tot</span> <span class="o">*</span> <span class="mi">100</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.NUE_system_2">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.NUE_system_2">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">NUE_system_2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Alternative NUE computation considering livestock conversion factors and feed inputs.</span>

<span class="sd">        Includes non-edible nitrogen outputs and imported feed consumption in the calculation.</span>

<span class="sd">        :return: Adjusted system-wide NUE (%).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N_NP</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">+</span> <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Non Edible Nitrogen (ktN)&quot;</span><span class="p">])</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Conversion factor (%)&quot;</span><span class="p">])</span>
            <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Consummed Nitrogen from imported feed (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">df_fert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_fert</span><span class="p">()</span>
        <span class="n">N_tot</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;Atmospheric deposition&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Consummed Nitrogen from imported feed (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">N_NP</span> <span class="o">/</span> <span class="n">N_tot</span> <span class="o">*</span> <span class="mi">100</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.N_self_sufficient">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.N_self_sufficient">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">N_self_sufficient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimates nitrogen self-sufficiency of the system.</span>

<span class="sd">        Defined as the share of atmospheric (biological) nitrogen inputs relative to all external nitrogen sources.</span>

<span class="sd">        :return: Self-sufficiency ratio (%).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_fert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_fert</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;Atmospheric deposition&quot;</span><span class="p">])</span>
            <span class="o">*</span> <span class="mi">100</span>
            <span class="o">/</span> <span class="p">(</span>
                <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;atmospheric N2&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;Atmospheric deposition&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">df_fert</span><span class="p">[</span><span class="s2">&quot;Haber-Bosch&quot;</span><span class="p">]</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Consummed Nitrogen from imported feed (ktN)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.env_footprint">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.env_footprint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">env_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the land footprint (in ha) of nitrogen flows linked to:</span>
<span class="sd">        - local food and feed production,</span>
<span class="sd">        - imported food and feed,</span>
<span class="sd">        - imported and exported livestock nitrogen,</span>
<span class="sd">        - crop exports for feed and food.</span>

<span class="sd">        This is expressed as theoretical land areas mobilized by the nitrogen content.</span>

<span class="sd">        :return: A pandas Series of land footprint values (in ha), positive for imports and local use, negative for exports.</span>
<span class="sd">        :rtype: pandas.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">local_surface_food</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen For Food (ktN)&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">local_surface_feed</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen For Feed (ktN)&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Food import</span>
        <span class="c1"># 1. Filtrer les allocations &quot;Imported food&quot;</span>
        <span class="n">alloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Imported Food&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Culture&quot;</span><span class="p">,</span> <span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># 2. Grouper par culture au cas où il y aurait plusieurs lignes par culture</span>
        <span class="n">alloc_grouped</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Culture&quot;</span><span class="p">)[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># 3. Créer un DataFrame aligné avec les index de df_cultures</span>
        <span class="n">alloc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_grouped</span>
        <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># 4. Calcul final : ratio * surface</span>
        <span class="c1"># Récupère les valeurs de &#39;Nitrogen Production (ktN)&#39; et de &#39;Allocated Nitrogen&#39;</span>
        <span class="n">nitrogen_production</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
        <span class="n">allocated_nitrogen</span> <span class="o">=</span> <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span>

        <span class="c1"># Si &#39;Nitrogen Production (ktN)&#39; est nul, se rabattre sur les valeurs du blé</span>
        <span class="c1"># En supposant que &quot;Wheat&quot; soit dans l&#39;index de df_cultures, sinon adapte-le</span>
        <span class="n">wheat_nitrogen_production</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
        <span class="n">wheat_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>

        <span class="c1"># Remplacer les valeurs de &#39;Nitrogen Production (ktN)&#39; par celles du blé si elles sont nulles</span>
        <span class="n">adjusted_nitrogen_production</span> <span class="o">=</span> <span class="n">nitrogen_production</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">wheat_nitrogen_production</span><span class="p">)</span>

        <span class="c1"># Utiliser la superficie du blé lorsque la production d&#39;azote est nulle, sans modifier df_cultures</span>
        <span class="n">adjusted_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nitrogen_production</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wheat_area</span><span class="p">)</span>

        <span class="c1"># Calcul du total des importations alimentaires</span>
        <span class="n">total_food_import</span> <span class="o">=</span> <span class="p">(</span><span class="n">allocated_nitrogen</span> <span class="o">/</span> <span class="n">adjusted_nitrogen_production</span> <span class="o">*</span> <span class="n">adjusted_area</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Feed import</span>
        <span class="c1"># 1. Filtrer les allocations &quot;Imported food&quot;</span>
        <span class="n">alloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="s2">&quot;Type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Imported Feed&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Culture&quot;</span><span class="p">,</span> <span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># 2. Grouper par culture au cas où il y aurait plusieurs lignes par culture</span>
        <span class="n">alloc_grouped</span> <span class="o">=</span> <span class="n">alloc</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;Culture&quot;</span><span class="p">)[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># 3. Créer un DataFrame aligné avec les index de df_cultures</span>
        <span class="n">alloc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_grouped</span>
        <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># 4. Calcul final : ratio * surface</span>
        <span class="c1"># Récupère les valeurs de &#39;Nitrogen Production (ktN)&#39; et de &#39;Allocated Nitrogen&#39;</span>
        <span class="n">nitrogen_production</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
        <span class="n">allocated_nitrogen</span> <span class="o">=</span> <span class="n">alloc_df</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span>

        <span class="c1"># Si &#39;Nitrogen Production (ktN)&#39; est nul, se rabattre sur les valeurs du blé</span>
        <span class="c1"># En supposant que &quot;Wheat&quot; soit dans l&#39;index de df_cultures, sinon adapte-le</span>
        <span class="n">wheat_nitrogen_production</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
        <span class="n">wheat_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Wheat&quot;</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>

        <span class="c1"># Remplacer les valeurs de &#39;Nitrogen Production (ktN)&#39; par celles du blé si elles sont nulles</span>
        <span class="n">adjusted_nitrogen_production</span> <span class="o">=</span> <span class="n">nitrogen_production</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">wheat_nitrogen_production</span><span class="p">)</span>

        <span class="c1"># Utiliser la superficie du blé lorsque la production d&#39;azote est nulle, sans modifier df_cultures</span>
        <span class="n">adjusted_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">nitrogen_production</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wheat_area</span><span class="p">)</span>

        <span class="c1"># Calcul du total des importations alimentaires</span>
        <span class="n">total_feed_import</span> <span class="o">=</span> <span class="p">(</span><span class="n">allocated_nitrogen</span> <span class="o">/</span> <span class="n">adjusted_nitrogen_production</span> <span class="o">*</span> <span class="n">adjusted_area</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1">## Importation de viande</span>
        <span class="c1"># 1. Sélectionner les animaux importés</span>
        <span class="n">elevage_importe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># 2. Pourcentage importé = |export net négatif| / production totale</span>
        <span class="n">elevage_importe</span><span class="p">[</span><span class="s2">&quot;fraction_importée&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">elevage_importe</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">elevage_importe</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># 3. Créer un DataFrame vide pour accumuler les contributions par culture</span>
        <span class="n">surface_par_culture</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># 4. Parcourir chaque type d&#39;élevage importé</span>
        <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">elevage_importe</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">animal</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="s2">&quot;Consumer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Si l&#39;animal n&#39;est pas dans les allocations, on passe</span>

            <span class="c1"># a. Calculer la part importée de l&#39;azote pour cet élevage</span>
            <span class="n">part_importee</span> <span class="o">=</span> <span class="n">elevage_importe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">animal</span><span class="p">,</span> <span class="s2">&quot;fraction_importée&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">elevage_importe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">elevage_importe</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">animal</span><span class="p">,</span> <span class="s2">&quot;fraction_importée&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                <span class="c1"># Calculer l&#39;azote végétal nécessaire (N_feed=Azote importé/0.12)</span>
                <span class="n">N_animal_imported</span> <span class="o">=</span> <span class="o">-</span><span class="n">elevage_importe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">animal</span><span class="p">,</span> <span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span>
                <span class="n">N_feed_total_required</span> <span class="o">=</span> <span class="n">N_animal_imported</span> <span class="o">/</span> <span class="mf">0.12</span>
                <span class="c1"># Aller chercher dans régimes[animal] les cultures consommées et en quelles proportion</span>
                <span class="c1"># Dans chaque catégories, prendre la première culture avec un rendement non nul ou nan de la liste (df_cultures[&quot;Nitrogen Production (ktN)&quot;]/df_culture[&quot;Area (ha)&quot;])</span>
                <span class="c1"># En déduire la surface théoriquement utilisée pour le nourrir (surface_par_culture[culture] = N_feed/rendement)</span>
                <span class="c1"># Si aucune culture de la catégorie n&#39;a de rendement, passer cette catégorie</span>

                <span class="c1"># Parcourir les catégories du régime de l&#39;animal</span>
                <span class="k">for</span> <span class="n">proportion</span><span class="p">,</span> <span class="n">culture_list</span> <span class="ow">in</span> <span class="n">regimes</span><span class="p">[</span><span class="n">animal</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">N_feed_for_category</span> <span class="o">=</span> <span class="n">N_feed_total_required</span> <span class="o">*</span> <span class="n">proportion</span>

                    <span class="c1"># Chercher la *première* culture valide dans la liste de la catégorie</span>
                    <span class="k">for</span> <span class="n">culture_name</span> <span class="ow">in</span> <span class="n">culture_list</span><span class="p">:</span>
                        <span class="c1"># Vérifier si la culture existe dans df_cultures</span>
                        <span class="k">if</span> <span class="n">culture_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                            <span class="n">prod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture_name</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
                            <span class="n">surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture_name</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>

                            <span class="c1"># Calculer le rendement si possible (surface &gt; 0 et prod &gt; 0)</span>
                            <span class="k">if</span> <span class="n">surface</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">prod</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">rendement</span> <span class="o">=</span> <span class="n">prod</span> <span class="o">/</span> <span class="n">surface</span>
                                <span class="c1"># Calculer la surface nécessaire pour cette catégorie via cette culture</span>
                                <span class="n">surface_needed</span> <span class="o">=</span> <span class="n">N_feed_for_category</span> <span class="o">/</span> <span class="n">rendement</span>
                                <span class="c1"># Ajouter à la surface totale pour cette culture</span>
                                <span class="n">surface_par_culture</span><span class="p">[</span><span class="n">culture_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="n">surface_par_culture</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">culture_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">surface_needed</span>
                                <span class="p">)</span>
                                <span class="k">break</span>  <span class="c1"># On a trouvé la première culture valide, on passe à la catégorie suivante du régime</span>
                            <span class="c1"># else: rendement invalide (0 ou NaN), on essaie la culture suivante dans la liste</span>
                        <span class="c1"># else: la culture n&#39;est pas dans df_cultures, on essaie la suivante dans la liste</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># b. Extraire les allocations d&#39;azote de chaque culture pour cet élevage</span>
                <span class="n">aliments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="s2">&quot;Consumer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">aliments</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="n">culture</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Culture&quot;</span><span class="p">]</span>
                    <span class="n">azote</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">part_importee</span>  <span class="c1"># Quantité d&#39;azote importée pour cette culture</span>

                    <span class="k">if</span> <span class="n">culture</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="n">culture</span> <span class="o">=</span> <span class="s2">&quot;Wheat&quot;</span>  <span class="c1"># Si la culture n&#39;est pas dans df_cultures, on remplace par du blé</span>

                    <span class="c1"># c. Récupérer la production d&#39;azote et la surface de la culture</span>
                    <span class="n">prod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
                    <span class="n">surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
                    <span class="c1"># if prod == 0:</span>
                    <span class="c1">#     culture = &quot;Wheat&quot;</span>
                    <span class="c1">#     prod = self.df_cultures.loc[culture, &quot;Nitrogen Production (ktN)&quot;]</span>
                    <span class="c1">#     surface = self.df_cultures.loc[culture, &quot;Area (ha)&quot;]</span>
                    <span class="c1"># d. Calculer la surface nécessaire pour produire l&#39;azote consommé</span>
                    <span class="k">if</span> <span class="n">prod</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">surface_equivalente</span> <span class="o">=</span> <span class="n">azote</span> <span class="o">/</span> <span class="n">prod</span> <span class="o">*</span> <span class="n">surface</span>
                        <span class="n">surface_par_culture</span><span class="p">[</span><span class="n">culture</span><span class="p">]</span> <span class="o">+=</span> <span class="n">surface_equivalente</span>
        <span class="n">import_animal</span> <span class="o">=</span> <span class="n">surface_par_culture</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1">## Export animaux</span>
        <span class="c1"># 1. Sélectionner les animaux exportés (ceux qui ont un exportation nette positive)</span>
        <span class="n">elevage_exporte</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># 2. Calculer la fraction exportée pour chaque animal (en proportion de la production totale)</span>
        <span class="n">elevage_exporte</span><span class="p">[</span><span class="s2">&quot;fraction_exportée&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">elevage_exporte</span><span class="p">[</span><span class="s2">&quot;Net animal nitrogen exports (ktN)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">elevage_exporte</span><span class="p">[</span><span class="s2">&quot;Edible Nitrogen (ktN)&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># 3. Créer un dictionnaire pour accumuler les résultats par culture</span>
        <span class="n">surface_par_culture_exporte</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span><span class="n">culture</span><span class="p">:</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">culture</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">})</span>

        <span class="c1"># 4. Parcourir chaque type d&#39;élevage exporté</span>
        <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">elevage_exporte</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">animal</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="s2">&quot;Consumer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Si l&#39;animal n&#39;est pas dans les allocations, on passe</span>

            <span class="c1"># a. Calculer la part exportée de l&#39;azote pour cet élevage</span>
            <span class="n">part_exportee</span> <span class="o">=</span> <span class="n">elevage_exporte</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">animal</span><span class="p">,</span> <span class="s2">&quot;fraction_exportée&quot;</span><span class="p">]</span>

            <span class="c1"># b. Extraire les allocations d&#39;azote de chaque culture pour cet élevage</span>
            <span class="n">aliments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">allocation_vege</span><span class="p">[</span><span class="s2">&quot;Consumer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">aliments</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">culture</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Culture&quot;</span><span class="p">]</span>
                <span class="n">azote</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Allocated Nitrogen&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">part_exportee</span>  <span class="c1"># Quantité d&#39;azote exportée pour cette culture</span>

                <span class="k">if</span> <span class="n">culture</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">culture</span> <span class="o">=</span> <span class="s2">&quot;Wheat&quot;</span>  <span class="c1"># Si la culture n&#39;est pas dans df_cultures, on remplace par du blé</span>

                <span class="c1"># c. Récupérer la production d&#39;azote et la surface de la culture</span>
                <span class="n">prod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
                <span class="n">surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">culture</span><span class="p">,</span> <span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>

                <span class="c1"># d. Calculer la surface nécessaire pour produire l&#39;azote consommé</span>
                <span class="k">if</span> <span class="n">prod</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">surface_equivalente</span> <span class="o">=</span> <span class="n">azote</span> <span class="o">/</span> <span class="n">prod</span> <span class="o">*</span> <span class="n">surface</span>
                    <span class="n">surface_par_culture_exporte</span><span class="p">[</span><span class="n">culture</span><span class="p">]</span> <span class="o">+=</span> <span class="n">surface_equivalente</span>
        <span class="n">export_animal</span> <span class="o">=</span> <span class="n">surface_par_culture_exporte</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

        <span class="c1"># Export culture</span>
        <span class="c1"># Feed</span>
        <span class="n">export_surface_feed</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Exported For Feed (ktN)&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1"># Food</span>
        <span class="n">export_surface_food</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Available Nitrogen After Feed, Export Feed and Food (ktN)&quot;</span><span class="p">]</span>
            <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Nitrogen Production (ktN)&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;Local Food&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">local_surface_food</span><span class="p">),</span>
                <span class="s2">&quot;Local Feed&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">local_surface_feed</span><span class="p">),</span>
                <span class="s2">&quot;Import Food&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_food_import</span><span class="p">),</span>
                <span class="s2">&quot;Import Feed&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_feed_import</span><span class="p">),</span>
                <span class="s2">&quot;Import Livestock&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">import_animal</span><span class="p">),</span>
                <span class="s2">&quot;Export Livestock&quot;</span><span class="p">:</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">export_animal</span><span class="p">),</span>
                <span class="s2">&quot;Export Feed&quot;</span><span class="p">:</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">export_surface_feed</span><span class="p">),</span>
                <span class="s2">&quot;Export Food&quot;</span><span class="p">:</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">export_surface_food</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.net_footprint">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.net_footprint">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">net_footprint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the net nitrogen land footprint of the region (in Mha).</span>

<span class="sd">        Aggregates all imports and exports to yield a net balance of nitrogen-dependent land use.</span>

<span class="sd">        :return: Net land footprint (in million hectares).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env_footprint</span><span class="p">()</span>
        <span class="n">df_total_import</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;Import Food&quot;</span><span class="p">,</span> <span class="s2">&quot;Import Feed&quot;</span><span class="p">,</span> <span class="s2">&quot;Import Livestock&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df_total_export</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;Export Food&quot;</span><span class="p">,</span> <span class="s2">&quot;Export Feed&quot;</span><span class="p">,</span> <span class="s2">&quot;Export Livestock&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">net_import_export</span> <span class="o">=</span> <span class="n">df_total_import</span> <span class="o">+</span> <span class="n">df_total_export</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">net_import_export</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.LU_density">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.LU_density">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">LU_density</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the livestock unit density over the agricultural area.</span>

<span class="sd">        :return: Livestock unit per hectare (LU/ha).</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_elevage</span><span class="p">[</span><span class="s2">&quot;LU&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_cultures</span><span class="p">[</span><span class="s2">&quot;Area (ha)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.NH3_vol">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.NH3_vol">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">NH3_vol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the total NH₃ volatilization in the system.</span>

<span class="sd">        :return: NH₃ emissions in kt.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">emissions</span><span class="p">()[</span><span class="s2">&quot;NH3 volatilization&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="NitrogenFlowModel.N2O_em">
<a class="viewcode-back" href="../../docs/source/temps/grafs_e.html#grafs_e.N_class.NitrogenFlowModel.N2O_em">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">N2O_em</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the total N₂O emissions in the system.</span>

<span class="sd">        :return: N₂O emissions in kt.</span>
<span class="sd">        :rtype: float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">emissions</span><span class="p">()[</span><span class="s2">&quot;N2O emission&quot;</span><span class="p">]</span></div>
</div>



<span class="c1"># Créer une instance du modèle</span>
<span class="c1"># year = &quot;2010&quot;</span>
<span class="c1"># region = &quot;Bretagne&quot;</span>
<span class="c1"># data = DataLoader()</span>

<span class="c1"># nitrogen_model = NitrogenFlowModel(</span>
<span class="c1">#     data=data,</span>
<span class="c1">#     year=year,</span>
<span class="c1">#     region=region,</span>
<span class="c1">#     categories_mapping=categories_mapping,</span>
<span class="c1">#     labels=labels,</span>
<span class="c1">#     cultures=cultures,</span>
<span class="c1">#     legumineuses=legumineuses,</span>
<span class="c1">#     prairies=prairies,</span>
<span class="c1">#     betail=betail,</span>
<span class="c1">#     Pop=Pop,</span>
<span class="c1">#     ext=ext,</span>
<span class="c1"># )</span>

<span class="c1"># from IPython import embed</span>

<span class="c1"># embed()</span>

<span class="c1"># # Calculer les flux</span>
<span class="c1"># nitrogen_model.compute_fluxes()</span>

<span class="c1"># # Afficher la heatmap</span>
<span class="c1"># nitrogen_model.plot_heatmap()</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025, Adrien Fauste-Gay.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>